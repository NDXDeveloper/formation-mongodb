üîù Retour au [Sommaire](/SOMMAIRE.md)

# 2.5.3 updateOne() et updateMany()

## Introduction

Apr√®s avoir appris √† ins√©rer et rechercher des documents, d√©couvrons maintenant comment les **modifier**. La mise √† jour de documents est une op√©ration cruciale dans toute application.

> **üí° Analogie :** Si `insert` est comme √©crire dans un carnet et `find` comme lire, `update` est comme corriger ou modifier ce qui est d√©j√† √©crit.

Dans cette section, nous allons explorer :
- Comment modifier un document avec `updateOne()`
- Comment modifier plusieurs documents avec `updateMany()`
- Les op√©rateurs de mise √† jour essentiels
- Les op√©rateurs pour les tableaux
- Les options avanc√©es (upsert, arrayFilters)
- Les bonnes pratiques

---

## updateOne() : Modifier un Seul Document

### Syntaxe de Base

```javascript
db.collection.updateOne(filtre, mise_a_jour, options)
```

**Param√®tres :**
- `filtre` : Crit√®res pour trouver le document √† modifier
- `mise_a_jour` : Modifications √† appliquer
- `options` : Options facultatives (upsert, etc.)

**Retour :**
```javascript
{
  acknowledged: true,
  matchedCount: 1,    // Nombre de documents correspondants
  modifiedCount: 1,   // Nombre de documents modifi√©s
  upsertedId: null    // ID si upsert (nous verrons √ßa)
}
```

### Premier Exemple Simple

```javascript
// Modifier l'√¢ge d'un utilisateur
db.utilisateurs.updateOne(
  { nom: "Dupont" },           // Filtre : trouve "Dupont"
  { $set: { age: 31 } }        // Modification : age = 31
)
```

**R√©sultat :**
```javascript
{
  acknowledged: true,
  matchedCount: 1,
  modifiedCount: 1,
  upsertedId: null
}
```

**Explication :**
- `matchedCount: 1` ‚Üí Un document correspond au filtre
- `modifiedCount: 1` ‚Üí Un document a √©t√© modifi√©

### ‚ö†Ô∏è Important : Un Seul Document

**updateOne() modifie SEULEMENT le premier document qui correspond au filtre.**

```javascript
// Deux utilisateurs s'appellent "Dupont"
db.utilisateurs.insertMany([
  { nom: "Dupont", prenom: "Jean", age: 30 },
  { nom: "Dupont", prenom: "Marie", age: 28 }
])

// Modifier l'√¢ge
db.utilisateurs.updateOne(
  { nom: "Dupont" },
  { $set: { age: 35 } }
)

// R√©sultat : SEULEMENT Jean est modifi√© (le premier trouv√©)
```

**Pour modifier les deux, utilisez `updateMany()` (voir plus bas).**

---

## Op√©rateur $set : D√©finir des Valeurs

### Qu'est-ce que $set ?

> **üí° $set** : L'op√©rateur le plus utilis√©. Il d√©finit ou met √† jour la valeur d'un champ.

### Modifier un Champ Existant

```javascript
// Modifier l'email
db.utilisateurs.updateOne(
  { _id: ObjectId("...") },
  { $set: { email: "nouveau@example.com" } }
)

// Modifier plusieurs champs
db.utilisateurs.updateOne(
  { nom: "Martin" },
  {
    $set: {
      age: 26,
      ville: "Lyon",
      telephone: "0612345678"
    }
  }
)
```

### Ajouter un Nouveau Champ

**$set peut aussi cr√©er de nouveaux champs s'ils n'existent pas :**

```javascript
// Document actuel
{
  _id: 1,
  nom: "Dupont",
  email: "dupont@example.com"
}

// Ajouter le champ "telephone"
db.utilisateurs.updateOne(
  { _id: 1 },
  { $set: { telephone: "0612345678" } }
)

// Document apr√®s
{
  _id: 1,
  nom: "Dupont",
  email: "dupont@example.com",
  telephone: "0612345678"  // Nouveau champ !
}
```

### Modifier des Champs Imbriqu√©s

```javascript
// Document
{
  nom: "Dupont",
  adresse: {
    rue: "123 Rue Example",
    ville: "Paris",
    codePostal: "75001"
  }
}

// Modifier seulement la ville
db.utilisateurs.updateOne(
  { nom: "Dupont" },
  { $set: { "adresse.ville": "Lyon" } }
)

// R√©sultat
{
  nom: "Dupont",
  adresse: {
    rue: "123 Rue Example",
    ville: "Lyon",          // Modifi√©
    codePostal: "75001"
  }
}
```

**‚ö†Ô∏è Important :** Utilisez les guillemets pour la notation point√©e !

### Remplacer un Sous-Document Complet

```javascript
// Remplacer toute l'adresse
db.utilisateurs.updateOne(
  { nom: "Dupont" },
  {
    $set: {
      adresse: {
        rue: "456 Avenue Nouvelle",
        ville: "Marseille",
        codePostal: "13001",
        pays: "France"
      }
    }
  }
)
```

---

## Op√©rateur $unset : Supprimer des Champs

### Supprimer un Champ

```javascript
// Supprimer le champ "telephone"
db.utilisateurs.updateOne(
  { nom: "Dupont" },
  { $unset: { telephone: "" } }
)

// La valeur ("") n'a pas d'importance, seul le champ compte
```

**Avant :**
```javascript
{
  nom: "Dupont",
  email: "dupont@example.com",
  telephone: "0612345678"
}
```

**Apr√®s :**
```javascript
{
  nom: "Dupont",
  email: "dupont@example.com"
  // telephone a √©t√© supprim√©
}
```

### Supprimer Plusieurs Champs

```javascript
db.utilisateurs.updateOne(
  { nom: "Dupont" },
  {
    $unset: {
      telephone: "",
      adresseSecondaire: "",
      notes: ""
    }
  }
)
```

---

## Op√©rateur $inc : Incr√©menter/D√©cr√©menter

### Qu'est-ce que $inc ?

> **üí° $inc** : Incr√©mente (ou d√©cr√©mente) la valeur d'un champ num√©rique.

### Incr√©menter une Valeur

```javascript
// Augmenter l'√¢ge de 1
db.utilisateurs.updateOne(
  { nom: "Dupont" },
  { $inc: { age: 1 } }
)

// age: 30 devient age: 31
```

### D√©cr√©menter une Valeur

```javascript
// Diminuer le stock de 5
db.produits.updateOne(
  { _id: "PROD-001" },
  { $inc: { stock: -5 } }
)

// stock: 100 devient stock: 95
```

### Cas d'Usage Typiques

**1. Compteurs de vues :**
```javascript
// Incr√©menter le nombre de vues d'un article
db.articles.updateOne(
  { _id: ObjectId("...") },
  { $inc: { vues: 1 } }
)
```

**2. Likes :**
```javascript
// +1 like
db.posts.updateOne(
  { _id: ObjectId("...") },
  { $inc: { likes: 1 } }
)

// -1 like (unlike)
db.posts.updateOne(
  { _id: ObjectId("...") },
  { $inc: { likes: -1 } }
)
```

**3. Stock de produits :**
```javascript
// Apr√®s une vente
db.produits.updateOne(
  { _id: "PROD-001" },
  { $inc: { stock: -1, ventesTotales: 1 } }
)
```

### ‚ö†Ô∏è Si le Champ N'existe Pas

**$inc initialise √† 0 puis incr√©mente :**

```javascript
// Document sans champ "vues"
{ _id: 1, titre: "Article" }

// Premier $inc
db.articles.updateOne(
  { _id: 1 },
  { $inc: { vues: 1 } }
)

// R√©sultat : vues est cr√©√© et vaut 1
{ _id: 1, titre: "Article", vues: 1 }
```

---

## Op√©rateur $mul : Multiplier

### Multiplier une Valeur

```javascript
// Multiplier le prix par 1.1 (augmentation de 10%)
db.produits.updateOne(
  { _id: "PROD-001" },
  { $mul: { prix: 1.1 } }
)

// prix: 100 devient prix: 110
```

### Cas d'Usage

```javascript
// Appliquer une r√©duction de 20%
db.produits.updateOne(
  { _id: "PROD-001" },
  { $mul: { prix: 0.8 } }
)

// Doubler un montant
db.comptes.updateOne(
  { _id: ObjectId("...") },
  { $mul: { solde: 2 } }
)
```

---

## Op√©rateur $rename : Renommer un Champ

### Renommer

```javascript
// Renommer "prenom" en "firstName"
db.utilisateurs.updateOne(
  { _id: ObjectId("...") },
  { $rename: { prenom: "firstName" } }
)
```

**Avant :**
```javascript
{ _id: 1, nom: "Dupont", prenom: "Jean" }
```

**Apr√®s :**
```javascript
{ _id: 1, nom: "Dupont", firstName: "Jean" }
```

---

## Op√©rateur $min et $max

### $min : Garder le Minimum

**Met √† jour le champ SEULEMENT si la nouvelle valeur est INF√âRIEURE :**

```javascript
// Document actuel : { score: 100 }

// Essayer de mettre 80 (plus petit)
db.joueurs.updateOne(
  { _id: 1 },
  { $min: { score: 80 } }
)
// R√©sultat : score = 80 (80 < 100)

// Essayer de mettre 120 (plus grand)
db.joueurs.updateOne(
  { _id: 1 },
  { $min: { score: 120 } }
)
// R√©sultat : score reste √† 80 (120 > 80, pas de changement)
```

### $max : Garder le Maximum

**Met √† jour le champ SEULEMENT si la nouvelle valeur est SUP√âRIEURE :**

```javascript
// Document actuel : { meilleurScore: 100 }

// Essayer de mettre 150 (plus grand)
db.joueurs.updateOne(
  { _id: 1 },
  { $max: { meilleurScore: 150 } }
)
// R√©sultat : meilleurScore = 150 (150 > 100)

// Essayer de mettre 80 (plus petit)
db.joueurs.updateOne(
  { _id: 1 },
  { $max: { meilleurScore: 80 } }
)
// R√©sultat : meilleurScore reste √† 150 (80 < 150)
```

---

## Op√©rateur $currentDate : Date Actuelle

### D√©finir la Date Actuelle

```javascript
// Mettre √† jour la date de modification
db.articles.updateOne(
  { _id: ObjectId("...") },
  { $currentDate: { dateModification: true } }
)

// R√©sultat : dateModification = new Date()
```

### Avec Type Sp√©cifique

```javascript
// Date
db.documents.updateOne(
  { _id: 1 },
  {
    $currentDate: {
      derniereModification: true,
      // Ou explicitement
      dateUpdate: { $type: "date" }
    }
  }
)

// Timestamp
db.logs.updateOne(
  { _id: 1 },
  {
    $currentDate: {
      timestamp: { $type: "timestamp" }
    }
  }
)
```

---

## updateMany() : Modifier Plusieurs Documents

### Syntaxe

```javascript
db.collection.updateMany(filtre, mise_a_jour, options)
```

**La diff√©rence :** updateMany() modifie **TOUS** les documents qui correspondent au filtre.

### Exemple Simple

```javascript
// Activer tous les utilisateurs de Paris
db.utilisateurs.updateMany(
  { ville: "Paris" },
  { $set: { actif: true } }
)
```

**R√©sultat :**
```javascript
{
  acknowledged: true,
  matchedCount: 42,    // 42 documents trouv√©s
  modifiedCount: 42,   // 42 documents modifi√©s
  upsertedId: null
}
```

### Cas d'Usage Typiques

**1. Mise √† jour en masse :**
```javascript
// Appliquer une remise √† tous les produits d'une cat√©gorie
db.produits.updateMany(
  { categorie: "√âlectronique" },
  { $mul: { prix: 0.9 } }  // -10%
)
```

**2. Changement de statut :**
```javascript
// Archiver tous les anciens articles
db.articles.updateMany(
  { datePublication: { $lt: ISODate("2023-01-01") } },
  { $set: { archive: true } }
)
```

**3. Ajouter un champ manquant :**
```javascript
// Ajouter un champ "version" √† tous les documents qui n'en ont pas
db.documents.updateMany(
  { version: { $exists: false } },
  { $set: { version: 1 } }
)
```

**4. R√©initialiser des compteurs :**
```javascript
// Remettre √† z√©ro les vues de tous les articles
db.articles.updateMany(
  {},  // Filtre vide = tous les documents
  { $set: { vues: 0 } }
)
```

---

## Op√©rateurs pour les Tableaux

### $push : Ajouter √† un Tableau

**Ajoute un √©l√©ment √† la fin d'un tableau :**

```javascript
// Ajouter une comp√©tence
db.developpeurs.updateOne(
  { nom: "Alice" },
  { $push: { competences: "Docker" } }
)
```

**Avant :**
```javascript
{
  nom: "Alice",
  competences: ["JavaScript", "Python"]
}
```

**Apr√®s :**
```javascript
{
  nom: "Alice",
  competences: ["JavaScript", "Python", "Docker"]
}
```

### $push avec $each : Ajouter Plusieurs √âl√©ments

```javascript
// Ajouter plusieurs comp√©tences
db.developpeurs.updateOne(
  { nom: "Alice" },
  {
    $push: {
      competences: {
        $each: ["Kubernetes", "AWS", "MongoDB"]
      }
    }
  }
)
```

**R√©sultat :**
```javascript
{
  nom: "Alice",
  competences: ["JavaScript", "Python", "Docker", "Kubernetes", "AWS", "MongoDB"]
}
```

### $addToSet : Ajouter Sans Doublon

**Comme $push mais √©vite les doublons :**

```javascript
// Ajouter "JavaScript" (d√©j√† pr√©sent)
db.developpeurs.updateOne(
  { nom: "Alice" },
  { $addToSet: { competences: "JavaScript" } }
)
// Rien ne se passe (d√©j√† dans le tableau)

// Ajouter "Ruby" (pas pr√©sent)
db.developpeurs.updateOne(
  { nom: "Alice" },
  { $addToSet: { competences: "Ruby" } }
)
// Ruby est ajout√©
```

### $addToSet avec $each

```javascript
// Ajouter plusieurs √©l√©ments sans doublons
db.developpeurs.updateOne(
  { nom: "Alice" },
  {
    $addToSet: {
      competences: {
        $each: ["JavaScript", "Ruby", "Go"]
      }
    }
  }
)
// Seuls Ruby et Go sont ajout√©s (JavaScript existe d√©j√†)
```

### $pull : Retirer d'un Tableau

**Retire toutes les occurrences d'une valeur :**

```javascript
// Retirer "Docker"
db.developpeurs.updateOne(
  { nom: "Alice" },
  { $pull: { competences: "Docker" } }
)
```

**Avant :**
```javascript
{ competences: ["JavaScript", "Docker", "Python", "Docker"] }
```

**Apr√®s :**
```javascript
{ competences: ["JavaScript", "Python"] }
// Tous les "Docker" sont retir√©s
```

### $pull avec Condition

```javascript
// Retirer tous les scores < 50
db.etudiants.updateOne(
  { _id: 1 },
  {
    $pull: {
      scores: { $lt: 50 }
    }
  }
)
```

### $pop : Retirer le Premier ou Dernier √âl√©ment

```javascript
// Retirer le dernier √©l√©ment (-1 pour le premier)
db.listes.updateOne(
  { _id: 1 },
  { $pop: { items: 1 } }
)

// Retirer le premier √©l√©ment
db.listes.updateOne(
  { _id: 1 },
  { $pop: { items: -1 } }
)
```

### $pullAll : Retirer Plusieurs Valeurs

```javascript
// Retirer JavaScript, Ruby et Go
db.developpeurs.updateOne(
  { nom: "Alice" },
  {
    $pullAll: {
      competences: ["JavaScript", "Ruby", "Go"]
    }
  }
)
```

---

## Combiner Plusieurs Op√©rateurs

### Exemple Complet

```javascript
db.articles.updateOne(
  { _id: ObjectId("...") },
  {
    $set: {
      titre: "Nouveau titre",
      publie: true
    },
    $inc: {
      vues: 1
    },
    $currentDate: {
      dateModification: true
    },
    $push: {
      tags: "MongoDB"
    }
  }
)
```

**Cette mise √† jour fait tout en une fois :**
- Modifie le titre et le statut publi√©
- Incr√©mente les vues
- Met √† jour la date
- Ajoute un tag

---

## Option : upsert

### Qu'est-ce que upsert ?

> **üí° upsert** = **UP**date + in**SERT**

**Si le document existe ‚Üí le modifier**
**Si le document n'existe pas ‚Üí le cr√©er**

### Syntaxe

```javascript
db.collection.updateOne(
  filtre,
  mise_a_jour,
  { upsert: true }
)
```

### Exemple

```javascript
// Chercher un utilisateur avec cet email
db.utilisateurs.updateOne(
  { email: "nouveau@example.com" },
  {
    $set: {
      nom: "Nouveau",
      actif: true
    }
  },
  { upsert: true }
)
```

**Sc√©nario 1 : L'email existe**
```javascript
// Document existant est mis √† jour
{
  acknowledged: true,
  matchedCount: 1,
  modifiedCount: 1,
  upsertedId: null
}
```

**Sc√©nario 2 : L'email n'existe pas**
```javascript
// Nouveau document est cr√©√©
{
  acknowledged: true,
  matchedCount: 0,
  modifiedCount: 0,
  upsertedId: ObjectId("...")  // ID du nouveau document
}
```

### Cas d'Usage de upsert

**1. Statistiques :**
```javascript
// Incr√©menter le compteur de vues (cr√©er si inexistant)
db.statistiques.updateOne(
  { page: "/accueil", date: "2024-12-01" },
  { $inc: { vues: 1 } },
  { upsert: true }
)
```

**2. Profils utilisateurs :**
```javascript
// Mettre √† jour ou cr√©er le profil
db.profils.updateOne(
  { userId: ObjectId("...") },
  {
    $set: {
      nom: "Alice",
      preferences: { theme: "dark" }
    },
    $setOnInsert: {
      dateCreation: new Date()
    }
  },
  { upsert: true }
)
```

### Op√©rateur $setOnInsert

**D√©finit des valeurs SEULEMENT lors de l'insertion (pas lors de la mise √† jour) :**

```javascript
db.utilisateurs.updateOne(
  { email: "test@example.com" },
  {
    $set: {
      nom: "Test",
      actif: true
    },
    $setOnInsert: {
      dateInscription: new Date(),
      role: "user"
    }
  },
  { upsert: true }
)
```

**Si cr√©ation :** dateInscription et role sont d√©finis
**Si mise √† jour :** dateInscription et role ne changent pas

---

## Mise √† Jour Conditionnelle

### Modifier Seulement Si Condition

```javascript
// Augmenter le prix SEULEMENT si < 100
db.produits.updateMany(
  { prix: { $lt: 100 } },
  { $inc: { prix: 10 } }
)

// Activer SEULEMENT les utilisateurs non bannis
db.utilisateurs.updateMany(
  { banni: { $ne: true } },
  { $set: { actif: true } }
)
```

### Utiliser $expr pour Comparaisons entre Champs

```javascript
// Augmenter le prix des produits o√π prix < prixCoutant
db.produits.updateMany(
  {
    $expr: { $lt: ["$prix", "$prixCoutant"] }
  },
  {
    $set: { prix: "$prixCoutant" }
  }
)
```

---

## Cas d'Usage Pratiques

### Blog : Mise √† Jour d'Articles

```javascript
// Publier un article
db.articles.updateOne(
  { _id: ObjectId("...") },
  {
    $set: {
      publie: true,
      datePublication: new Date()
    }
  }
)

// Incr√©menter les vues
db.articles.updateOne(
  { slug: "introduction-mongodb" },
  { $inc: { vues: 1 } }
)

// Ajouter un commentaire
db.articles.updateOne(
  { _id: ObjectId("...") },
  {
    $push: {
      commentaires: {
        auteur: "Alice",
        texte: "Super article !",
        date: new Date()
      }
    },
    $inc: { nombreCommentaires: 1 }
  }
)

// Archiver les vieux articles
db.articles.updateMany(
  {
    datePublication: { $lt: ISODate("2023-01-01") },
    archive: { $ne: true }
  },
  {
    $set: { archive: true }
  }
)
```

### E-commerce : Gestion de Produits

```javascript
// R√©duire le stock apr√®s une vente
db.produits.updateOne(
  { _id: "PROD-001" },
  {
    $inc: {
      stock: -1,
      ventesTotales: 1
    },
    $currentDate: {
      derniereVente: true
    }
  }
)

// Mettre en promotion
db.produits.updateMany(
  { categorie: "√âlectronique" },
  {
    $set: {
      enPromotion: true,
      prixPromo: NumberDecimal("0.8")  // -20%
    }
  }
)

// Marquer comme rupture de stock
db.produits.updateMany(
  { stock: { $lte: 0 } },
  { $set: { disponible: false } }
)

// Ajouter un avis produit
db.produits.updateOne(
  { _id: "PROD-001" },
  {
    $push: {
      avis: {
        utilisateur: "Bob",
        note: 5,
        commentaire: "Excellent produit",
        date: new Date()
      }
    },
    $inc: { nombreAvis: 1 }
  }
)
```

### Application de T√¢ches

```javascript
// Marquer une t√¢che comme termin√©e
db.taches.updateOne(
  { _id: ObjectId("...") },
  {
    $set: {
      statut: "termine",
      dateTerminee: new Date()
    }
  }
)

// R√©assigner une t√¢che
db.taches.updateOne(
  { _id: ObjectId("...") },
  {
    $set: {
      assigneA: ObjectId("nouveau_user_id")
    },
    $push: {
      historique: {
        action: "reassignation",
        date: new Date(),
        de: ObjectId("ancien_user_id"),
        a: ObjectId("nouveau_user_id")
      }
    }
  }
)

// Ajouter une sous-t√¢che
db.taches.updateOne(
  { _id: ObjectId("...") },
  {
    $push: {
      sousTaches: {
        titre: "Nouvelle sous-t√¢che",
        termine: false
      }
    }
  }
)
```

### R√©seau Social : Gestion d'Utilisateurs

```javascript
// Suivre un utilisateur
db.utilisateurs.updateOne(
  { _id: ObjectId("user_id") },
  {
    $addToSet: { abonnements: ObjectId("autre_user_id") },
    $inc: { nombreAbonnements: 1 }
  }
)

// Se d√©sabonner
db.utilisateurs.updateOne(
  { _id: ObjectId("user_id") },
  {
    $pull: { abonnements: ObjectId("autre_user_id") },
    $inc: { nombreAbonnements: -1 }
  }
)

// Liker un post
db.posts.updateOne(
  { _id: ObjectId("post_id") },
  {
    $addToSet: { likes: ObjectId("user_id") },
    $inc: { nombreLikes: 1 }
  }
)
```

---

## Gestion des Erreurs

### Document Non Trouv√©

```javascript
let resultat = db.utilisateurs.updateOne(
  { email: "inexistant@example.com" },
  { $set: { actif: true } }
)

print(resultat.matchedCount)  // 0
print(resultat.modifiedCount)  // 0
```

**Gestion :**
```javascript
let resultat = db.utilisateurs.updateOne(
  { email: "test@example.com" },
  { $set: { actif: true } }
)

if (resultat.matchedCount === 0) {
  print("Utilisateur non trouv√©")
} else if (resultat.modifiedCount === 0) {
  print("Document trouv√© mais aucune modification n√©cessaire")
} else {
  print("Modification r√©ussie")
}
```

### Erreur de Type

```javascript
// ‚ùå Essayer d'incr√©menter une cha√Æne
db.users.updateOne(
  { _id: 1 },
  { $inc: { nom: 1 } }  // "nom" est une string !
)
// Erreur : Cannot apply $inc to a value of non-numeric type
```

### Try-Catch

```javascript
try {
  db.produits.updateOne(
    { _id: "PROD-001" },
    { $inc: { stock: -10 } }
  )
  print("Stock mis √† jour")
} catch (e) {
  print("Erreur : " + e.message)
}
```

---

## Bonnes Pratiques

### ‚úÖ √Ä Faire

1. **Utilisez des filtres sp√©cifiques**
   ```javascript
   // ‚úÖ Bon : Filtre pr√©cis
   db.users.updateOne({ _id: ObjectId("...") }, ...)

   // ‚ö†Ô∏è Risqu√© : Filtre vague
   db.users.updateOne({ nom: "Dupont" }, ...)  // Plusieurs "Dupont" ?
   ```

2. **V√©rifiez le r√©sultat**
   ```javascript
   let resultat = db.users.updateOne(
     { _id: ObjectId("...") },
     { $set: { actif: false } }
   )

   if (resultat.modifiedCount === 0) {
     print("Attention : Aucune modification")
   }
   ```

3. **Utilisez $inc pour les compteurs**
   ```javascript
   // ‚úÖ Bon : Atomique
   db.posts.updateOne(
     { _id: ObjectId("...") },
     { $inc: { vues: 1 } }
   )

   // ‚ùå Mauvais : Race condition
   let post = db.posts.findOne({ _id: ObjectId("...") })
   db.posts.updateOne(
     { _id: ObjectId("...") },
     { $set: { vues: post.vues + 1 } }
   )
   ```

4. **Utilisez $addToSet pour √©viter les doublons**
   ```javascript
   // ‚úÖ Bon : Pas de doublon
   db.users.updateOne(
     { _id: ObjectId("...") },
     { $addToSet: { tags: "mongodb" } }
   )

   // ‚ùå Risqu√© : Peut cr√©er des doublons
   db.users.updateOne(
     { _id: ObjectId("...") },
     { $push: { tags: "mongodb" } }
   )
   ```

5. **Tracez les modifications**
   ```javascript
   db.documents.updateOne(
     { _id: ObjectId("...") },
     {
       $set: { contenu: "Nouveau contenu" },
       $currentDate: { dateModification: true },
       $push: {
         historique: {
           date: new Date(),
           action: "modification",
           utilisateur: "user_id"
         }
       }
     }
   )
   ```

### ‚ùå √Ä √âviter

1. **Modifier sans filtre (updateMany)**
   ```javascript
   // ‚ùå DANGEREUX : Modifie TOUS les documents
   db.users.updateMany({}, { $set: { actif: false } })

   // ‚úÖ Bon : Filtre explicite
   db.users.updateMany(
     { dateInscription: { $lt: ISODate("2020-01-01") } },
     { $set: { actif: false } }
   )
   ```

2. **√âcraser un document complet par erreur**
   ```javascript
   // ‚ùå Mauvais : Remplace tout le document
   db.users.updateOne(
     { _id: 1 },
     { nom: "Nouveau nom" }  // Manque $set !
   )

   // ‚úÖ Bon : Utiliser $set
   db.users.updateOne(
     { _id: 1 },
     { $set: { nom: "Nouveau nom" } }
   )
   ```

3. **Modifications non atomiques**
   ```javascript
   // ‚ùå Race condition
   let user = db.users.findOne({ _id: 1 })
   user.solde = user.solde + 100
   db.users.updateOne({ _id: 1 }, { $set: { solde: user.solde } })

   // ‚úÖ Atomique
   db.users.updateOne({ _id: 1 }, { $inc: { solde: 100 } })
   ```

---

## Comparaison avec SQL

### SQL UPDATE

```sql
-- Modifier un enregistrement
UPDATE utilisateurs
SET age = 31, ville = 'Lyon'
WHERE id = 1;

-- Modifier plusieurs enregistrements
UPDATE produits
SET prix = prix * 0.9
WHERE categorie = '√âlectronique';

-- Incr√©menter
UPDATE articles
SET vues = vues + 1
WHERE id = 123;
```

### MongoDB UPDATE

```javascript
// Modifier un document
db.utilisateurs.updateOne(
  { _id: 1 },
  { $set: { age: 31, ville: "Lyon" } }
)

// Modifier plusieurs documents
db.produits.updateMany(
  { categorie: "√âlectronique" },
  { $mul: { prix: 0.9 } }
)

// Incr√©menter
db.articles.updateOne(
  { _id: 123 },
  { $inc: { vues: 1 } }
)
```

**Avantages MongoDB :**
- ‚úÖ Op√©rateurs riches ($inc, $push, $addToSet, etc.)
- ‚úÖ Modifications atomiques des tableaux
- ‚úÖ Mise √† jour de champs imbriqu√©s facile
- ‚úÖ upsert natif

---

## R√©sum√© des Op√©rateurs

### Op√©rateurs de Champs

| Op√©rateur | Description | Exemple |
|-----------|-------------|---------|
| `$set` | D√©finir/modifier une valeur | `{ $set: { age: 30 } }` |
| `$unset` | Supprimer un champ | `{ $unset: { telephone: "" } }` |
| `$inc` | Incr√©menter/d√©cr√©menter | `{ $inc: { vues: 1 } }` |
| `$mul` | Multiplier | `{ $mul: { prix: 1.1 } }` |
| `$rename` | Renommer un champ | `{ $rename: { old: "new" } }` |
| `$min` | Garder le minimum | `{ $min: { score: 50 } }` |
| `$max` | Garder le maximum | `{ $max: { record: 100 } }` |
| `$currentDate` | Date actuelle | `{ $currentDate: { date: true } }` |

### Op√©rateurs de Tableaux

| Op√©rateur | Description | Exemple |
|-----------|-------------|---------|
| `$push` | Ajouter √† un tableau | `{ $push: { tags: "new" } }` |
| `$addToSet` | Ajouter sans doublon | `{ $addToSet: { tags: "new" } }` |
| `$pull` | Retirer d'un tableau | `{ $pull: { tags: "old" } }` |
| `$pop` | Retirer premier/dernier | `{ $pop: { items: 1 } }` |
| `$pullAll` | Retirer plusieurs | `{ $pullAll: { tags: ["a", "b"] } }` |

---

## Points Cl√©s √† Retenir

### ‚úÖ Essentiel

1. **updateOne()** : Modifie le premier document correspondant
2. **updateMany()** : Modifie tous les documents correspondants
3. **$set** : Op√©rateur le plus utilis√© pour d√©finir des valeurs
4. **$inc** : Incr√©menter/d√©cr√©menter atomiquement
5. **Op√©rateurs de tableaux** : $push, $pull, $addToSet
6. **upsert** : Cr√©er si n'existe pas, modifier sinon
7. **Toujours v√©rifier le r√©sultat** : matchedCount et modifiedCount

### üéØ Syntaxe √† Retenir

```javascript
// Mise √† jour simple
db.collection.updateOne(
  { _id: ObjectId("...") },
  { $set: { champ: "valeur" } }
)

// Mise √† jour multiple
db.collection.updateMany(
  { filtre: "condition" },
  {
    $set: { champ1: "valeur1" },
    $inc: { compteur: 1 },
    $push: { tableau: "element" }
  }
)

// Avec upsert
db.collection.updateOne(
  { identifiant: "unique" },
  { $set: { donnees: "..." } },
  { upsert: true }
)
```

### ‚ö†Ô∏è Pi√®ges Courants

- Oublier $set et √©craser tout le document
- updateOne sur plusieurs documents (seul le premier est modifi√©)
- updateMany sans filtre (modifie TOUT)
- Race conditions avec find puis update (utiliser $inc √† la place)

---

## Prochaines √âtapes

Maintenant que vous savez modifier des documents, apprenons √† les supprimer :

‚û°Ô∏è **2.5.4 deleteOne() et deleteMany()** : Supprimer des documents

Vous ma√Ætrisez maintenant trois op√©rations CRUD sur quatre !

---

## Ressources Compl√©mentaires

### Documentation Officielle

- [updateOne() - MongoDB Manual](https://docs.mongodb.com/manual/reference/method/db.collection.updateOne/)
- [updateMany() - MongoDB Manual](https://docs.mongodb.com/manual/reference/method/db.collection.updateMany/)
- [Update Operators](https://docs.mongodb.com/manual/reference/operator/update/)
- [Array Update Operators](https://docs.mongodb.com/manual/reference/operator/update-array/)

### Pour Aller Plus Loin

- findOneAndUpdate() : modifier et retourner le document
- Bulk operations pour des mises √† jour optimis√©es
- arrayFilters pour modifier des √©l√©ments sp√©cifiques dans des tableaux
- Transactions pour garantir l'atomicit√© de plusieurs op√©rations

---


‚è≠Ô∏è [deleteOne() et deleteMany()](/02-fondamentaux-de-mongodb/05.4-delete.md)
