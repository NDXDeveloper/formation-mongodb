üîù Retour au [Sommaire](/SOMMAIRE.md)

# 5.3.2 Index G√©ospatial (2d, 2dsphere)

## Introduction

Les **index g√©ospatiaux** (ou **Geospatial Indexes**) sont des index sp√©cialis√©s dans MongoDB con√ßus pour effectuer des requ√™tes efficaces sur des **donn√©es g√©ographiques** (coordonn√©es GPS, localisations, formes g√©om√©triques, etc.).

Ces index permettent de r√©pondre √† des questions comme :
- "Quels sont les restaurants √† moins de 2 km de ma position ?"
- "Quels magasins se trouvent dans cette zone g√©ographique ?"
- "Quelle est la pharmacie la plus proche ?"
- "Quels v√©hicules sont actuellement dans ce rayon de 5 km ?"

MongoDB propose deux types d'index g√©ospatiaux principaux :
1. **Index 2d** : Pour des coordonn√©es planes (cartes plates)
2. **Index 2dsphere** : Pour des coordonn√©es sph√©riques (Terre r√©elle)

---

## Pourquoi les Index G√©ospatiaux ?

### Le Probl√®me sans Index G√©ospatial

Imaginons une collection de restaurants avec leurs coordonn√©es GPS :

```javascript
{
  name: "Restaurant Le Bon Go√ªt",
  address: "123 Rue de Paris",
  location: {
    latitude: 48.8566,
    longitude: 2.3522
  }
}
```

**Question** : Comment trouver les restaurants √† moins de 1 km d'une position donn√©e ?

**Sans index g√©ospatial** :
```javascript
// ‚ùå Approche na√Øve inefficace
db.restaurants.find().forEach(function(restaurant) {
  // Calculer manuellement la distance pour CHAQUE restaurant
  // Comparer avec 1 km
  // Filtrer
})
```

**Probl√®mes** :
- ‚ùå Doit examiner TOUS les restaurants
- ‚ùå Calculs de distance complexes et co√ªteux
- ‚ùå Tr√®s lent sur de grandes collections
- ‚ùå Pas de tri par distance

**Avec index g√©ospatial** :
```javascript
// ‚úÖ Rapide et efficace
db.restaurants.find({
  location: {
    $near: {
      $geometry: {
        type: "Point",
        coordinates: [2.3522, 48.8566]  // longitude, latitude
      },
      $maxDistance: 1000  // 1 km en m√®tres
    }
  }
})
```

**Avantages** :
- ‚úÖ Utilise l'index pour recherche rapide
- ‚úÖ Calculs de distance optimis√©s
- ‚úÖ R√©sultats automatiquement tri√©s par distance
- ‚úÖ Performance constante m√™me avec millions de points

---

## Comprendre les Coordonn√©es G√©ographiques

### Latitude et Longitude

**Latitude** (Lat) :
- Mesure la position **Nord-Sud**
- Valeurs : -90¬∞ (P√¥le Sud) √† +90¬∞ (P√¥le Nord)
- √âquateur = 0¬∞

**Longitude** (Lng/Lon) :
- Mesure la position **Est-Ouest**
- Valeurs : -180¬∞ √† +180¬∞
- M√©ridien de Greenwich = 0¬∞

**Exemple : Paris** üóº
- Latitude : 48.8566¬∞ N
- Longitude : 2.3522¬∞ E
- Notation : `[2.3522, 48.8566]` (longitude d'abord !)

### ‚ö†Ô∏è Ordre Important : [Longitude, Latitude]

Dans MongoDB et GeoJSON, l'ordre est **TOUJOURS** :

```javascript
[longitude, latitude]  // ‚úÖ Correct
[latitude, longitude]  // ‚ùå Invers√© - ERREUR COMMUNE !
```

**Moyen mn√©motechnique** : Longitude = X (horizontal), Latitude = Y (vertical)

---

## Format GeoJSON

### Qu'est-ce que GeoJSON ?

**GeoJSON** est un format standardis√© pour repr√©senter des donn√©es g√©ographiques en JSON. MongoDB utilise ce format pour les index 2dsphere.

### Structure de Base

```javascript
{
  type: "<type de g√©om√©trie>",
  coordinates: <coordonn√©es>
}
```

### Types de G√©om√©tries Support√©es

#### 1. Point (Point)

Un point unique sur la carte :

```javascript
{
  type: "Point",
  coordinates: [2.3522, 48.8566]  // [longitude, latitude]
}
```

**Exemple** : Restaurant, magasin, monument

#### 2. Ligne (LineString)

Une s√©rie de points connect√©s formant une ligne :

```javascript
{
  type: "LineString",
  coordinates: [
    [2.3522, 48.8566],  // Point 1
    [2.2945, 48.8584],  // Point 2
    [2.3387, 48.8606]   // Point 3
  ]
}
```

**Exemple** : Route, trajet, rivi√®re

#### 3. Polygone (Polygon)

Une zone ferm√©e :

```javascript
{
  type: "Polygon",
  coordinates: [
    [
      [2.25, 48.81],   // Point 1
      [2.42, 48.81],   // Point 2
      [2.42, 48.90],   // Point 3
      [2.25, 48.90],   // Point 4
      [2.25, 48.81]    // Retour au point 1 (fermeture)
    ]
  ]
}
```

‚ö†Ô∏è **Important** : Le premier et le dernier point doivent √™tre identiques pour fermer le polygone.

**Exemple** : Zone de livraison, quartier, parc

#### 4. Multi-Point (MultiPoint)

Plusieurs points distincts :

```javascript
{
  type: "MultiPoint",
  coordinates: [
    [2.3522, 48.8566],
    [2.2945, 48.8584],
    [2.3387, 48.8606]
  ]
}
```

**Exemple** : Succursales d'une cha√Æne

#### 5. Multi-Ligne (MultiLineString)

Plusieurs lignes :

```javascript
{
  type: "MultiLineString",
  coordinates: [
    [[2.25, 48.81], [2.42, 48.81]],  // Ligne 1
    [[2.30, 48.85], [2.35, 48.85]]   // Ligne 2
  ]
}
```

**Exemple** : R√©seau de m√©tro avec plusieurs lignes

#### 6. Multi-Polygone (MultiPolygon)

Plusieurs zones :

```javascript
{
  type: "MultiPolygon",
  coordinates: [
    [  // Polygone 1
      [[2.25, 48.81], [2.42, 48.81], [2.42, 48.90], [2.25, 48.90], [2.25, 48.81]]
    ],
    [  // Polygone 2
      [[2.50, 48.70], [2.60, 48.70], [2.60, 48.80], [2.50, 48.80], [2.50, 48.70]]
    ]
  ]
}
```

**Exemple** : Zones de livraison multiples, archipel d'√Æles

---

## Index 2dsphere vs Index 2d

### Comparaison des Deux Types

| Crit√®re | 2dsphere | 2d |
|---------|----------|-----|
| **Usage** | Coordonn√©es g√©ographiques r√©elles (Terre) | Coordonn√©es planes (cartes plates) |
| **Format** | GeoJSON obligatoire | Tableaux simples [x, y] |
| **Calculs** | Sph√©rique (Terre ronde) | Plan euclidien (plat) |
| **Pr√©cision** | ‚úÖ Haute (distances r√©elles) | ‚ö†Ô∏è Approximative |
| **Recommand√©** | ‚úÖ Oui (moderne) | ‚ö†Ô∏è Legacy (ancien) |
| **Cas d'usage** | GPS, cartes r√©elles, applications modernes | Jeux vid√©o, cartes fictives |

### Quand Utiliser Chacun ?

**Index 2dsphere** ‚úÖ (Recommand√©)
- Applications g√©olocalis√©es (restaurants, magasins, etc.)
- Donn√©es GPS r√©elles
- Calculs de distance pr√©cis sur Terre
- Applications modernes

**Index 2d** ‚ö†Ô∏è (Legacy)
- Cartes de jeux vid√©o (monde plat)
- Coordonn√©es arbitraires non g√©ographiques
- Syst√®mes h√©rit√©s existants

**Recommandation** : Utilisez **2dsphere** pour tous les nouveaux projets !

---

## Cr√©ation d'Index G√©ospatiaux

### Index 2dsphere (Recommand√©)

#### Syntaxe

```javascript
db.collection.createIndex({ champGeospatial: "2dsphere" })
```

#### Exemple avec Point

```javascript
// Collection restaurants
{
  _id: 1,
  name: "Restaurant Le Bon Go√ªt",
  address: "123 Rue de Paris, Paris",
  location: {
    type: "Point",
    coordinates: [2.3522, 48.8566]  // [longitude, latitude]
  }
}

// Cr√©er l'index 2dsphere
db.restaurants.createIndex({ location: "2dsphere" })
```

#### Exemple avec Polygon

```javascript
// Collection zones de livraison
{
  _id: 1,
  name: "Zone Centre Paris",
  area: {
    type: "Polygon",
    coordinates: [[
      [2.25, 48.81],
      [2.42, 48.81],
      [2.42, 48.90],
      [2.25, 48.90],
      [2.25, 48.81]
    ]]
  }
}

// Cr√©er l'index 2dsphere
db.delivery_zones.createIndex({ area: "2dsphere" })
```

### Index 2d (Legacy)

#### Syntaxe

```javascript
db.collection.createIndex({ champGeospatial: "2d" })
```

#### Exemple

```javascript
// Collection avec coordonn√©es planes
{
  _id: 1,
  name: "Personnage",
  position: [100, 200]  // [x, y]
}

// Cr√©er l'index 2d
db.characters.createIndex({ position: "2d" })
```

### Index Compos√© avec G√©ospatial

Vous pouvez combiner un index g√©ospatial avec d'autres champs :

```javascript
// Index compos√© : type + localisation
db.places.createIndex({
  type: 1,           // Champ classique
  location: "2dsphere"  // Champ g√©ospatial
})

// Requ√™te optimis√©e
db.places.find({
  type: "restaurant",
  location: {
    $near: {
      $geometry: { type: "Point", coordinates: [2.3522, 48.8566] },
      $maxDistance: 1000
    }
  }
})
```

---

## Op√©rateurs de Requ√™tes G√©ospatiales

### 1. $near - Proximit√©

Trouve les documents les plus proches d'un point, tri√©s par distance.

**Syntaxe** :
```javascript
db.collection.find({
  champGeospatial: {
    $near: {
      $geometry: {
        type: "Point",
        coordinates: [longitude, latitude]
      },
      $maxDistance: distanceEnMetres,  // Optionnel
      $minDistance: distanceEnMetres   // Optionnel
    }
  }
})
```

**Exemple** :
```javascript
// Restaurants √† moins de 2 km de la Tour Eiffel
db.restaurants.find({
  location: {
    $near: {
      $geometry: {
        type: "Point",
        coordinates: [2.2945, 48.8584]  // Tour Eiffel
      },
      $maxDistance: 2000  // 2 km en m√®tres
    }
  }
})
```

**R√©sultat** : Documents tri√©s automatiquement par distance croissante ‚úÖ

### 2. $nearSphere - Proximit√© Sph√©rique

Identique √† `$near` mais pour l'index 2d (legacy), calcule sur une sph√®re.

```javascript
db.collection.find({
  location: {
    $nearSphere: {
      $geometry: {
        type: "Point",
        coordinates: [2.2945, 48.8584]
      },
      $maxDistance: 2000
    }
  }
})
```

**Note** : Avec index 2dsphere, pr√©f√©rez `$near`.

### 3. $geoWithin - Int√©rieur d'une Zone

Trouve les documents situ√©s **√† l'int√©rieur** d'une zone g√©om√©trique.

**Syntaxe** :
```javascript
db.collection.find({
  champGeospatial: {
    $geoWithin: {
      $geometry: <g√©om√©trie>
    }
  }
})
```

#### Exemple : Points dans un Polygone

```javascript
// Restaurants dans un quartier (polygone)
db.restaurants.find({
  location: {
    $geoWithin: {
      $geometry: {
        type: "Polygon",
        coordinates: [[
          [2.25, 48.81],   // Sud-Ouest
          [2.42, 48.81],   // Sud-Est
          [2.42, 48.90],   // Nord-Est
          [2.25, 48.90],   // Nord-Ouest
          [2.25, 48.81]    // Fermeture
        ]]
      }
    }
  }
})
```

#### Exemple : Points dans un Cercle

```javascript
// Restaurants dans un rayon de 3 km
db.restaurants.find({
  location: {
    $geoWithin: {
      $centerSphere: [
        [2.3522, 48.8566],  // Centre [longitude, latitude]
        3 / 6378.1          // Rayon en radians (3 km / rayon Terre)
      ]
    }
  }
})
```

**Conversion** : `rayon_km / 6378.1` = rayon en radians

‚ö†Ô∏è **Diff√©rence avec $near** :
- `$near` : Trie par distance ‚úÖ
- `$geoWithin` : Ne trie pas (ordre arbitraire) ‚ùå

### 4. $geoIntersects - Intersection

Trouve les documents dont la g√©om√©trie **intersecte** avec une g√©om√©trie donn√©e.

**Syntaxe** :
```javascript
db.collection.find({
  champGeospatial: {
    $geoIntersects: {
      $geometry: <g√©om√©trie>
    }
  }
})
```

**Exemple** :
```javascript
// Zones de livraison qui intersectent une route
db.delivery_zones.find({
  area: {
    $geoIntersects: {
      $geometry: {
        type: "LineString",
        coordinates: [
          [2.3522, 48.8566],
          [2.2945, 48.8584]
        ]
      }
    }
  }
})
```

**Cas d'usage** :
- Routes traversant des zones
- Polygones se chevauchant
- V√©rification de couverture g√©ographique

---

## Calculer les Distances

### Obtenir la Distance avec $geoNear (Aggregation)

L'op√©rateur `$geoNear` dans le pipeline d'agr√©gation permet d'obtenir la distance calcul√©e :

```javascript
db.restaurants.aggregate([
  {
    $geoNear: {
      near: {
        type: "Point",
        coordinates: [2.3522, 48.8566]
      },
      distanceField: "distance",  // Nom du champ de distance
      maxDistance: 2000,           // 2 km
      spherical: true              // Calculs sph√©riques
    }
  }
])
```

**R√©sultat** :
```javascript
[
  {
    _id: 1,
    name: "Restaurant A",
    location: { type: "Point", coordinates: [2.3530, 48.8570] },
    distance: 120.5  // Distance en m√®tres
  },
  {
    _id: 2,
    name: "Restaurant B",
    location: { type: "Point", coordinates: [2.3600, 48.8600] },
    distance: 850.2
  }
]
```

### Options de $geoNear

```javascript
{
  $geoNear: {
    near: <point>,              // Point de r√©f√©rence (obligatoire)
    distanceField: <string>,    // Nom du champ distance (obligatoire)
    spherical: true,            // true pour 2dsphere
    maxDistance: <number>,      // Distance max en m√®tres
    minDistance: <number>,      // Distance min en m√®tres
    query: <filter>,            // Filtres additionnels
    distanceMultiplier: <number>, // Multiplicateur (ex: 0.001 pour km)
    limit: <number>             // Limite de r√©sultats
  }
}
```

**Exemple avec conversion en km** :
```javascript
db.restaurants.aggregate([
  {
    $geoNear: {
      near: { type: "Point", coordinates: [2.3522, 48.8566] },
      distanceField: "distanceKm",
      maxDistance: 5000,
      spherical: true,
      distanceMultiplier: 0.001  // Convertit m√®tres en km
    }
  }
])
```

---

## Cas d'Usage Pratiques

### 1. Application de Livraison de Nourriture

**Contexte** : Trouver les restaurants qui livrent √† une adresse

```javascript
// Collection restaurants
{
  _id: 1,
  name: "Pizza Express",
  location: {
    type: "Point",
    coordinates: [2.3522, 48.8566]
  },
  deliveryRadius: 3000  // 3 km
}

// Index
db.restaurants.createIndex({ location: "2dsphere" })

// Requ√™te : Restaurants livrant √† une position
db.restaurants.find({
  location: {
    $near: {
      $geometry: {
        type: "Point",
        coordinates: [2.3600, 48.8600]  // Position client
      },
      $maxDistance: 5000  // Chercher dans 5 km max
    }
  }
}).limit(10)
```

**Am√©lior√© avec distance** :
```javascript
db.restaurants.aggregate([
  {
    $geoNear: {
      near: { type: "Point", coordinates: [2.3600, 48.8600] },
      distanceField: "distance",
      maxDistance: 5000,
      spherical: true,
      query: { isOpen: true }  // Seulement les restaurants ouverts
    }
  },
  {
    $match: {
      $expr: { $lte: ["$distance", "$deliveryRadius"] }  // Distance <= rayon
    }
  },
  {
    $limit: 10
  }
])
```

### 2. Application de VTC (Taxi)

**Contexte** : Trouver les chauffeurs disponibles les plus proches

```javascript
// Collection drivers
{
  _id: "driver123",
  name: "Jean Dupont",
  currentLocation: {
    type: "Point",
    coordinates: [2.3522, 48.8566]
  },
  status: "available",
  rating: 4.8
}

// Index compos√©
db.drivers.createIndex({
  status: 1,
  currentLocation: "2dsphere"
})

// Requ√™te : 5 chauffeurs disponibles les plus proches
db.drivers.find({
  status: "available",
  currentLocation: {
    $near: {
      $geometry: {
        type: "Point",
        coordinates: [2.3600, 48.8600]  // Position client
      },
      $maxDistance: 3000  // Dans 3 km
    }
  }
}).limit(5)
```

### 3. Immobilier : Recherche de Biens

**Contexte** : Appartements dans un quartier sp√©cifique

```javascript
// Collection properties
{
  _id: 1,
  title: "Appartement 3 pi√®ces",
  price: 350000,
  location: {
    type: "Point",
    coordinates: [2.3522, 48.8566]
  },
  type: "apartment",
  rooms: 3
}

// Index
db.properties.createIndex({ location: "2dsphere" })

// Requ√™te : Appartements dans un polygone (quartier)
db.properties.find({
  type: "apartment",
  location: {
    $geoWithin: {
      $geometry: {
        type: "Polygon",
        coordinates: [[
          [2.34, 48.85],
          [2.36, 48.85],
          [2.36, 48.87],
          [2.34, 48.87],
          [2.34, 48.85]
        ]]
      }
    }
  },
  price: { $lte: 400000 }
})
```

### 4. Tourisme : Points d'Int√©r√™t

**Contexte** : Monuments et attractions touristiques

```javascript
// Collection attractions
{
  _id: 1,
  name: "Tour Eiffel",
  type: "monument",
  location: {
    type: "Point",
    coordinates: [2.2945, 48.8584]
  },
  category: "landmark"
}

// Index
db.attractions.createIndex({ location: "2dsphere" })

// Requ√™te : Top 10 attractions autour de l'h√¥tel
db.attractions.aggregate([
  {
    $geoNear: {
      near: { type: "Point", coordinates: [2.3522, 48.8566] },
      distanceField: "distanceKm",
      maxDistance: 10000,  // 10 km
      spherical: true,
      distanceMultiplier: 0.001,
      query: { category: "landmark" }
    }
  },
  {
    $limit: 10
  },
  {
    $project: {
      name: 1,
      type: 1,
      distanceKm: { $round: ["$distanceKm", 2] }
    }
  }
])
```

### 5. Gestion de Flotte (GPS Tracking)

**Contexte** : Suivre des v√©hicules en temps r√©el

```javascript
// Collection vehicles
{
  _id: "truck-42",
  driver: "Marie Martin",
  type: "truck",
  currentLocation: {
    type: "Point",
    coordinates: [2.3522, 48.8566]
  },
  status: "in-transit",
  lastUpdate: ISODate("2024-01-15T14:30:00Z")
}

// Index
db.vehicles.createIndex({ currentLocation: "2dsphere" })

// Requ√™te : V√©hicules dans une zone de 5 km
db.vehicles.find({
  status: "in-transit",
  currentLocation: {
    $near: {
      $geometry: {
        type: "Point",
        coordinates: [2.3600, 48.8600]  // Centre de contr√¥le
      },
      $maxDistance: 5000
    }
  }
})
```

### 6. Zones de Livraison

**Contexte** : V√©rifier si une adresse est dans la zone de livraison

```javascript
// Collection delivery_zones
{
  _id: 1,
  name: "Zone Paris Centre",
  storeId: "store-123",
  area: {
    type: "Polygon",
    coordinates: [[
      [2.25, 48.81],
      [2.42, 48.81],
      [2.42, 48.90],
      [2.25, 48.90],
      [2.25, 48.81]
    ]]
  }
}

// Index
db.delivery_zones.createIndex({ area: "2dsphere" })

// Requ√™te : Zones couvrant une adresse client
db.delivery_zones.find({
  area: {
    $geoIntersects: {
      $geometry: {
        type: "Point",
        coordinates: [2.3522, 48.8566]  // Adresse client
      }
    }
  }
})
```

---

## Performance et Optimisation

### Avantages des Index G√©ospatiaux

‚úÖ **Recherche rapide**
- Structures d'index optimis√©es (R-tree)
- Performance logarithmique O(log n)

‚úÖ **Calculs de distance efficaces**
- Algorithmes optimis√©s pour calculs sph√©riques
- Pas besoin de calculs manuels

‚úÖ **Tri automatique par distance**
- Avec `$near` et `$geoNear`
- R√©sultats ordonn√©s du plus proche au plus loin

‚úÖ **Support de formes complexes**
- Points, lignes, polygones
- Op√©rations g√©om√©triques (intersection, inclusion)

### Consid√©rations de Performance

#### Limite de R√©sultats

Utilisez `.limit()` pour limiter les r√©sultats et am√©liorer la performance :

```javascript
// ‚úÖ Limiter √† 20 r√©sultats
db.restaurants.find({
  location: {
    $near: {
      $geometry: { type: "Point", coordinates: [2.3522, 48.8566] },
      $maxDistance: 5000
    }
  }
}).limit(20)
```

#### Combiner avec d'Autres Filtres

Utilisez des index compos√©s pour des requ√™tes multi-crit√®res :

```javascript
// Index compos√©
db.restaurants.createIndex({
  cuisine: 1,
  rating: -1,
  location: "2dsphere"
})

// Requ√™te optimis√©e
db.restaurants.find({
  cuisine: "Italian",
  rating: { $gte: 4.0 },
  location: {
    $near: {
      $geometry: { type: "Point", coordinates: [2.3522, 48.8566] },
      $maxDistance: 2000
    }
  }
}).limit(10)
```

#### Pr√©cision vs Performance

Pour de tr√®s grandes collections, ajustez la pr√©cision si n√©cessaire :

```javascript
// Cr√©er un index avec pr√©cision sp√©cifique
db.places.createIndex(
  { location: "2dsphere" },
  { "2dsphereIndexVersion": 3 }  // Version 3 (plus r√©cente)
)
```

---

## Limitations et Contraintes

### Limites Techniques

‚ùå **Taille des polygones**
- Polygones tr√®s complexes peuvent ralentir les requ√™tes
- Limitez le nombre de points dans un polygone

‚ùå **Nombre de r√©sultats**
- `$near` retourne max 100 documents par d√©faut
- Utilisez `.limit()` explicitement si besoin

‚ùå **Pas de regex sur champs g√©ospatiaux**
```javascript
// ‚ùå Impossible
db.places.find({ location: { $regex: /.../ } })
```

‚ùå **Un seul champ g√©ospatial dans $near**
```javascript
// ‚ùå Impossible d'utiliser $near sur 2 champs simultan√©ment
```

### Pr√©cision des Calculs

- **2dsphere** : Pr√©cision ~1 m√®tre
- **2d** : Pr√©cision variable selon √©chelle

### Validations GeoJSON

MongoDB valide strictement le format GeoJSON :

```javascript
// ‚ùå ERREUR : Coordonn√©es invers√©es
{
  type: "Point",
  coordinates: [48.8566, 2.3522]  // latitude, longitude ‚ùå
}

// ‚úÖ CORRECT
{
  type: "Point",
  coordinates: [2.3522, 48.8566]  // longitude, latitude ‚úÖ
}

// ‚ùå ERREUR : Polygone non ferm√©
{
  type: "Polygon",
  coordinates: [[
    [2.25, 48.81],
    [2.42, 48.81],
    [2.42, 48.90]
    // Manque le retour au point initial !
  ]]
}
```

---

## Bonnes Pratiques

### ‚úÖ √Ä Faire

1. **Utiliser 2dsphere pour donn√©es GPS r√©elles**
   ```javascript
   // ‚úÖ Pour GPS, cartes, g√©olocalisation
   db.places.createIndex({ location: "2dsphere" })
   ```

2. **Respecter l'ordre [longitude, latitude]**
   ```javascript
   // ‚úÖ Toujours : [lon, lat]
   coordinates: [2.3522, 48.8566]
   ```

3. **Valider le format GeoJSON**
   ```javascript
   // ‚úÖ Structure correcte
   {
     type: "Point",
     coordinates: [2.3522, 48.8566]
   }
   ```

4. **Limiter les r√©sultats**
   ```javascript
   // ‚úÖ Toujours utiliser limit()
   db.places.find({ ... }).limit(20)
   ```

5. **Utiliser maxDistance**
   ```javascript
   // ‚úÖ D√©finir un rayon de recherche
   $maxDistance: 5000  // 5 km
   ```

6. **Index compos√©s pour filtres combin√©s**
   ```javascript
   // ‚úÖ Optimiser requ√™tes multi-crit√®res
   db.places.createIndex({
     category: 1,
     location: "2dsphere"
   })
   ```

7. **Utiliser $geoNear pour obtenir la distance**
   ```javascript
   // ‚úÖ Pour afficher la distance aux utilisateurs
   db.places.aggregate([{ $geoNear: { ... } }])
   ```

8. **Fermer les polygones**
   ```javascript
   // ‚úÖ Premier point = dernier point
   coordinates: [[
     [2.25, 48.81],
     [2.42, 48.81],
     [2.42, 48.90],
     [2.25, 48.90],
     [2.25, 48.81]  // ‚Üê Fermeture
   ]]
   ```

### ‚ùå √Ä √âviter

1. **Ne pas inverser latitude et longitude**
   ```javascript
   // ‚ùå ERREUR COMMUNE
   coordinates: [48.8566, 2.3522]  // lat, lon

   // ‚úÖ CORRECT
   coordinates: [2.3522, 48.8566]  // lon, lat
   ```

2. **Ne pas oublier maxDistance**
   ```javascript
   // ‚ö†Ô∏è Sans maxDistance, recherche globale (lent)
   db.places.find({
     location: {
       $near: {
         $geometry: { type: "Point", coordinates: [2.3522, 48.8566] }
         // Manque $maxDistance !
       }
     }
   })
   ```

3. **Ne pas cr√©er de polygones trop complexes**
   ```javascript
   // ‚ùå Polygone avec 10000 points = lent
   // ‚úÖ Simplifier les formes g√©om√©triques
   ```

4. **Ne pas utiliser 2d pour donn√©es GPS**
   ```javascript
   // ‚ùå 2d pour GPS = impr√©cis
   db.places.createIndex({ location: "2d" })

   // ‚úÖ 2dsphere pour GPS
   db.places.createIndex({ location: "2dsphere" })
   ```

5. **Ne pas oublier de limiter les r√©sultats**
   ```javascript
   // ‚ö†Ô∏è Peut retourner des millions de r√©sultats
   db.places.find({ location: { $geoWithin: ... } })

   // ‚úÖ Limiter
   db.places.find({ location: { $geoWithin: ... } }).limit(100)
   ```

---

## Outils et Ressources

### Validation GeoJSON

**Site web** : [geojson.io](http://geojson.io/)
- Visualiser et cr√©er du GeoJSON interactivement
- V√©rifier la validit√© de vos g√©om√©tries

### Conversion Coordonn√©es

**Formule : Kilom√®tres ‚Üí Radians**
```javascript
radiansRadius = kilometersRadius / 6378.1
```

**Formule : M√®tres ‚Üí Radians**
```javascript
radiansRadius = metersRadius / 6378100
```

### Outils MongoDB

```javascript
// V√©rifier l'index
db.collection.getIndexes()

// Analyser une requ√™te g√©ospatiale
db.collection.find({ location: { $near: ... } }).explain("executionStats")

// Statistiques de collection
db.collection.stats()
```

---

## Analyse et V√©rification

### V√©rifier l'Index G√©ospatial

```javascript
db.restaurants.getIndexes()
```

**R√©sultat** :
```json
[
  {
    "v": 2,
    "key": { "location": "2dsphere" },
    "name": "location_2dsphere",
    "2dsphereIndexVersion": 3
  }
]
```

### Analyser une Requ√™te

```javascript
db.restaurants.find({
  location: {
    $near: {
      $geometry: { type: "Point", coordinates: [2.3522, 48.8566] },
      $maxDistance: 2000
    }
  }
}).explain("executionStats")
```

**Points cl√©s** :
```javascript
{
  "winningPlan": {
    "stage": "GEO_NEAR_2DSPHERE",  // ‚úÖ Utilise l'index g√©ospatial
    "indexName": "location_2dsphere"
  },
  "executionStats": {
    "totalDocsExamined": 25,
    "executionTimeMillis": 3
  }
}
```

---

## Migration et Mise √† Jour

### Ajouter des Coordonn√©es √† des Documents Existants

```javascript
// Mettre √† jour un document avec localisation
db.restaurants.updateOne(
  { _id: 1 },
  {
    $set: {
      location: {
        type: "Point",
        coordinates: [2.3522, 48.8566]
      }
    }
  }
)

// Mise √† jour en masse avec adresses
db.restaurants.updateMany(
  { location: { $exists: false } },
  {
    $set: {
      location: {
        type: "Point",
        coordinates: [0, 0]  // Placeholder, √† g√©ocoder ensuite
      }
    }
  }
)
```

### G√©ocodage (Adresse ‚Üí Coordonn√©es)

Le g√©ocodage (conversion d'adresses en coordonn√©es) n√©cessite un service externe :

- **Google Maps Geocoding API**
- **OpenStreetMap Nominatim**
- **Mapbox Geocoding API**
- **Here Geocoding API**

**Exemple conceptuel** :
```javascript
// Pseudo-code (utiliser une vraie API)
const address = "Tour Eiffel, Paris, France";
const coordinates = await geocode(address);  // [2.2945, 48.8584]

db.places.updateOne(
  { _id: 1 },
  {
    $set: {
      location: {
        type: "Point",
        coordinates: coordinates
      }
    }
  }
)
```

---

## Conclusion

Les **index g√©ospatiaux** sont essentiels pour toute application n√©cessitant des fonctionnalit√©s de g√©olocalisation. MongoDB offre des outils puissants et performants pour g√©rer efficacement les donn√©es g√©ographiques, des simples recherches de proximit√© aux requ√™tes g√©om√©triques complexes.

### Points Cl√©s √† Retenir

- ‚úÖ **2dsphere** pour donn√©es GPS r√©elles (recommand√©)
- ‚úÖ **2d** pour coordonn√©es planes (legacy)
- ‚úÖ Format **GeoJSON** obligatoire pour 2dsphere
- ‚úÖ Ordre crucial : **[longitude, latitude]** (pas l'inverse !)
- ‚úÖ Op√©rateurs : `$near` (proximit√©), `$geoWithin` (zone), `$geoIntersects` (intersection)
- ‚úÖ `$geoNear` en agr√©gation pour obtenir la distance
- ‚úÖ Toujours utiliser `.limit()` pour performance
- ‚úÖ Index compos√©s pour requ√™tes multi-crit√®res
- ‚úÖ Valider strictement le format GeoJSON

### Cas d'Usage Typiques

- üçï Livraison de nourriture
- üöó Applications VTC/Taxi
- üè† Immobilier
- üìç Tourisme et POI
- üöö Gestion de flotte
- üì¶ Zones de livraison

### Prochaines √âtapes

Maintenant que vous ma√Ætrisez les index g√©ospatiaux, explorez :
- **[Index hach√©](./03.3-index-hache.md)** : Distribution uniforme pour sharding
- **[Index TTL](./03.5-index-ttl.md)** : Expiration automatique
- **[Requ√™tes g√©ospatiales avanc√©es](/16-fonctionnalites-avancees/06-requetes-geospatiales-avancees.md)** : Techniques avanc√©es
- **[Atlas Search](/16-fonctionnalites-avancees/08-atlas-search-lucene.md)** : Recherche combin√©e texte + g√©o

---

**üìö Ressources Compl√©mentaires**
- [Documentation officielle - Geospatial Indexes](https://docs.mongodb.com/manual/geospatial-queries/)
- [GeoJSON Specification](https://geojson.org/)
- [Geospatial Query Operators](https://docs.mongodb.com/manual/reference/operator/query-geospatial/)
- [GeoJSON.io - Outil de visualisation](http://geojson.io/)
- [Calculate Distances](https://docs.mongodb.com/manual/tutorial/calculate-distances-using-spherical-geometry-with-2d-geospatial-indexes/)

‚è≠Ô∏è [Index hach√© (Hashed)](/05-index-et-optimisation/03.3-index-hache.md)
