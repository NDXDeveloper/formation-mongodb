üîù Retour au [Sommaire](/SOMMAIRE.md)

# 11.3.2 R√¥les Personnalis√©s

## Introduction

Les r√¥les personnalis√©s (custom roles) permettent de d√©finir des permissions pr√©cis√©ment adapt√©es aux besoins m√©tier de votre organisation. Lorsque les r√¥les int√©gr√©s ne correspondent pas exactement aux exigences, les r√¥les personnalis√©s offrent la granularit√© n√©cessaire pour impl√©menter le principe du moindre privil√®ge tout en respectant la logique applicative.

### Quand Cr√©er des R√¥les Personnalis√©s

**Utiliser les r√¥les int√©gr√©s quand** :
- Les permissions correspondent exactement aux besoins
- L'application a des besoins standards (CRUD simple)
- La simplicit√© de maintenance est prioritaire

**Cr√©er des r√¥les personnalis√©s quand** :
- Besoin de permissions sur des collections sp√©cifiques uniquement
- Logique m√©tier complexe n√©cessitant des permissions granulaires
- S√©paration des responsabilit√©s au niveau collection
- Acc√®s √† des actions syst√®me sp√©cifiques
- Conformit√© r√©glementaire avec restrictions pr√©cises

### Avantages des R√¥les Personnalis√©s

| Avantage | Description |
|----------|-------------|
| **Granularit√©** | Permissions au niveau collection et action |
| **Logique m√©tier** | Refl√®te l'organisation et les processus |
| **Moindre privil√®ge** | Permissions exactes n√©cessaires |
| **R√©utilisabilit√©** | M√™me r√¥le pour plusieurs utilisateurs |
| **√âvolutivit√©** | Modification centralis√©e des permissions |
| **Audit** | Tra√ßabilit√© des permissions m√©tier |
| **Conformit√©** | Respect des politiques de s√©curit√© |

## Anatomie d'un R√¥le Personnalis√©

### Structure Compl√®te

```javascript
{
  role: "nomDuRole",                    // Nom unique dans la base
  db: "nomDatabase",                     // Base o√π le r√¥le est d√©fini

  // Privil√®ges directs
  privileges: [
    {
      resource: {                        // Cible des permissions
        db: "database",
        collection: "collection"
      },
      actions: [                         // Actions autoris√©es
        "find",
        "insert",
        "update"
      ]
    }
  ],

  // R√¥les h√©rit√©s
  roles: [
    {
      role: "autreRole",
      db: "autreDatabase"
    }
  ],

  // Restrictions d'authentification (optionnel)
  authenticationRestrictions: [
    {
      clientSource: ["10.0.0.0/8"],     // IPs sources autoris√©es
      serverAddress: ["192.168.1.100"]   // Serveurs cibles autoris√©s
    }
  ]
}
```

### Composants Essentiels

#### 1. Nom du R√¥le (role)

```javascript
role: "customerServiceAgent"
```

**Conventions de nommage** :
- CamelCase ou snake_case coh√©rent
- Descriptif de la fonction m√©tier
- √âviter les noms g√©n√©riques (`user1`, `role2`)
- Inclure le contexte si n√©cessaire (`production_readonly`)

#### 2. Base de D√©finition (db)

```javascript
db: "production"
```

**R√®gles** :
- R√¥le existe dans le contexte de cette base
- Utiliser `admin` pour r√¥les cross-database
- Coh√©rent avec l'organisation des bases

#### 3. Privil√®ges (privileges)

D√©finition pr√©cise des permissions :

```javascript
privileges: [
  {
    resource: { db: "production", collection: "orders" },
    actions: ["find", "insert", "update"]
  },
  {
    resource: { db: "production", collection: "customers" },
    actions: ["find"]
  }
]
```

#### 4. H√©ritage de R√¥les (roles)

```javascript
roles: [
  { role: "read", db: "analytics" },
  { role: "customRole", db: "production" }
]
```

## Cr√©ation de R√¥les Personnalis√©s

### Syntaxe de Base

```javascript
use production
db.createRole({
  role: "orderManager",
  privileges: [
    {
      resource: { db: "production", collection: "orders" },
      actions: ["find", "insert", "update", "remove"]
    }
  ],
  roles: []
})
```

### R√¥le avec Collections Multiples

```javascript
use production
db.createRole({
  role: "salesAgent",
  privileges: [
    // Acc√®s complet aux commandes
    {
      resource: { db: "production", collection: "orders" },
      actions: ["find", "insert", "update", "remove"]
    },
    // Lecture seule des clients
    {
      resource: { db: "production", collection: "customers" },
      actions: ["find", "listIndexes"]
    },
    // Lecture seule des produits
    {
      resource: { db: "production", collection: "products" },
      actions: ["find"]
    },
    // √âcriture dans les logs d'activit√©
    {
      resource: { db: "production", collection: "activity_logs" },
      actions: ["insert"]
    }
  ],
  roles: []
})
```

### R√¥le avec H√©ritage

```javascript
use production
db.createRole({
  role: "seniorSalesAgent",
  privileges: [
    // Privil√®ges additionnels
    {
      resource: { db: "production", collection: "customers" },
      actions: ["update"]  // Peut maintenant modifier les clients
    },
    {
      resource: { db: "production", collection: "discounts" },
      actions: ["find", "insert"]  // Acc√®s aux remises
    }
  ],
  // H√©rite de salesAgent
  roles: [
    { role: "salesAgent", db: "production" }
  ]
})

// R√©sultat : seniorSalesAgent a tous les privil√®ges de salesAgent
// plus les privil√®ges additionnels d√©finis
```

### R√¥le Cross-Database

```javascript
use admin
db.createRole({
  role: "dataAnalyst",
  privileges: [
    // Lecture production
    {
      resource: { db: "production", collection: "" },
      actions: ["find", "listCollections", "listIndexes"]
    },
    // Lecture analytics
    {
      resource: { db: "analytics", collection: "" },
      actions: ["find", "listCollections"]
    },
    // √âcriture dans analytics seulement
    {
      resource: { db: "analytics", collection: "reports" },
      actions: ["insert", "update", "remove"]
    }
  ],
  roles: []
})
```

## Privil√®ges Granulaires

### Actions par Cat√©gorie

#### Actions de Lecture

```javascript
privileges: [
  {
    resource: { db: "production", collection: "orders" },
    actions: [
      "find",              // Requ√™tes de lecture
      "listIndexes",       // Lister les index
      "collStats"          // Statistiques collection
    ]
  }
]
```

#### Actions d'√âcriture

```javascript
privileges: [
  {
    resource: { db: "production", collection: "orders" },
    actions: [
      "insert",            // Insertion documents
      "update",            // Modification documents
      "remove",            // Suppression documents
      "bypassDocumentValidation"  // Contourner validation (attention!)
    ]
  }
]
```

#### Actions d'Administration Collection

```javascript
privileges: [
  {
    resource: { db: "production", collection: "orders" },
    actions: [
      "createIndex",       // Cr√©er des index
      "dropIndex",         // Supprimer des index
      "collMod",           // Modifier collection
      "validate",          // Valider la collection
      "compact"            // Compacter la collection
    ]
  }
]
```

#### Actions au Niveau Database

```javascript
privileges: [
  {
    resource: { db: "production", collection: "" },
    actions: [
      "listCollections",   // Lister les collections
      "dbStats",           // Statistiques database
      "createCollection",  // Cr√©er des collections
      "dropCollection"     // Supprimer des collections
    ]
  }
]
```

#### Actions Syst√®me

```javascript
privileges: [
  {
    resource: { cluster: true },
    actions: [
      "serverStatus",      // Statut du serveur
      "top",               // Top des op√©rations
      "inprog",            // Op√©rations en cours
      "killop"             // Tuer des op√©rations
    ]
  }
]
```

### Resources Sp√©cifiques

#### Collection Sp√©cifique

```javascript
resource: { db: "production", collection: "orders" }
```

#### Toutes Collections d'une Base

```javascript
resource: { db: "production", collection: "" }
```

#### Collection Sp√©cifique dans Toutes Bases

```javascript
resource: { db: "", collection: "logs" }
```

#### Collections Syst√®me

```javascript
// system.users
resource: { db: "admin", collection: "system.users" }

// system.roles
resource: { db: "admin", collection: "system.roles" }

// system.js (fonctions stock√©es)
resource: { db: "production", collection: "system.js" }
```

#### Niveau Cluster

```javascript
resource: { cluster: true }
```

## Patterns M√©tier Courants

### Pattern 1 : Service Customer Support

```javascript
use production
db.createRole({
  role: "customerSupportAgent",
  privileges: [
    // Lecture compl√®te des clients
    {
      resource: { db: "production", collection: "customers" },
      actions: ["find", "listIndexes"]
    },
    // Modification limit√©e des clients (pas de suppression)
    {
      resource: { db: "production", collection: "customers" },
      actions: ["update"]
    },
    // Lecture des commandes
    {
      resource: { db: "production", collection: "orders" },
      actions: ["find"]
    },
    // Modification statut commande
    {
      resource: { db: "production", collection: "orders" },
      actions: ["update"]
    },
    // Insertion tickets support
    {
      resource: { db: "production", collection: "support_tickets" },
      actions: ["find", "insert", "update"]
    },
    // Lecture produits (catalogue)
    {
      resource: { db: "production", collection: "products" },
      actions: ["find"]
    }
  ],
  roles: []
})
```

**Usage** :

```javascript
db.createUser({
  user: "support_marie",
  pwd: passwordPrompt(),
  roles: [
    { role: "customerSupportAgent", db: "production" }
  ]
})
```

### Pattern 2 : Analyste de Donn√©es

```javascript
use admin
db.createRole({
  role: "dataScientist",
  privileges: [
    // Lecture compl√®te production (toutes collections)
    {
      resource: { db: "production", collection: "" },
      actions: ["find", "listCollections", "listIndexes", "collStats", "dbStats"]
    },
    // Lecture/√©criture dans analytics
    {
      resource: { db: "analytics", collection: "" },
      actions: ["find", "insert", "update", "remove", "createCollection", "dropCollection"]
    },
    // Gestion index dans analytics
    {
      resource: { db: "analytics", collection: "" },
      actions: ["createIndex", "dropIndex"]
    },
    // Lecture donn√©es de r√©f√©rence
    {
      resource: { db: "reference_data", collection: "" },
      actions: ["find"]
    }
  ],
  roles: []
})
```

### Pattern 3 : Microservice Sp√©cifique

```javascript
use production
db.createRole({
  role: "paymentServiceRole",
  privileges: [
    // Acc√®s complet √† sa collection
    {
      resource: { db: "production", collection: "payments" },
      actions: ["find", "insert", "update", "remove", "createIndex", "dropIndex"]
    },
    // Lecture seule commandes (pour validation)
    {
      resource: { db: "production", collection: "orders" },
      actions: ["find"]
    },
    // Mise √† jour statut commande apr√®s paiement
    {
      resource: { db: "production", collection: "orders" },
      actions: ["update"]
    },
    // Lecture seule clients (pour facturation)
    {
      resource: { db: "production", collection: "customers" },
      actions: ["find"]
    },
    // Logs d'audit
    {
      resource: { db: "audit", collection: "payment_logs" },
      actions: ["insert"]
    }
  ],
  roles: []
})
```

### Pattern 4 : Administrateur Application

```javascript
use production
db.createRole({
  role: "applicationAdmin",
  privileges: [
    // Lecture/√©criture toutes collections m√©tier
    {
      resource: { db: "production", collection: "" },
      actions: ["find", "insert", "update", "remove"]
    },
    // Gestion des collections
    {
      resource: { db: "production", collection: "" },
      actions: ["createCollection", "dropCollection", "listCollections"]
    },
    // Gestion des index
    {
      resource: { db: "production", collection: "" },
      actions: ["createIndex", "dropIndex", "listIndexes"]
    },
    // Statistiques pour monitoring
    {
      resource: { db: "production", collection: "" },
      actions: ["collStats", "dbStats"]
    }
  ],
  roles: [
    // H√©rite de capacit√©s de lecture analytics
    { role: "read", db: "analytics" }
  ]
})
```

### Pattern 5 : Service de Reporting

```javascript
use admin
db.createRole({
  role: "reportingService",
  privileges: [
    // Lecture optimis√©e (avec index)
    {
      resource: { db: "production", collection: "" },
      actions: ["find", "listIndexes", "collStats"]
    },
    {
      resource: { db: "analytics", collection: "" },
      actions: ["find", "listIndexes"]
    },
    // √âcriture rapports g√©n√©r√©s
    {
      resource: { db: "reports", collection: "generated_reports" },
      actions: ["insert", "update", "remove"]
    },
    {
      resource: { db: "reports", collection: "report_cache" },
      actions: ["insert", "update", "remove"]
    },
    // Monitoring l√©ger
    {
      resource: { cluster: true },
      actions: ["serverStatus"]
    }
  ],
  roles: []
})
```

### Pattern 6 : Acc√®s PII Restreint

```javascript
use production
db.createRole({
  role: "piiAccessRole",
  privileges: [
    // Acc√®s donn√©es personnelles sensibles
    {
      resource: { db: "production", collection: "customer_pii" },
      actions: ["find", "update"]  // Pas de insert/remove
    },
    // Logs d'acc√®s obligatoires
    {
      resource: { db: "audit", collection: "pii_access_logs" },
      actions: ["insert"]
    }
  ],
  roles: [],

  // Restrictions r√©seau strictes
  authenticationRestrictions: [
    {
      // Uniquement depuis VPN corporate
      clientSource: ["10.0.0.0/8", "172.16.0.0/12"],
      // Uniquement vers serveurs production
      serverAddress: ["192.168.1.100", "192.168.1.101", "192.168.1.102"]
    }
  ]
})
```

## Gestion Avanc√©e des R√¥les

### Modification de R√¥les

#### Ajouter des Privil√®ges

```javascript
use production
db.grantPrivilegesToRole("salesAgent", [
  {
    resource: { db: "production", collection: "inventory" },
    actions: ["find"]
  }
])
```

#### Retirer des Privil√®ges

```javascript
db.revokePrivilegesFromRole("salesAgent", [
  {
    resource: { db: "production", collection: "orders" },
    actions: ["remove"]  // Ne peut plus supprimer de commandes
  }
])
```

#### Ajouter des R√¥les H√©rit√©s

```javascript
db.grantRolesToRole("seniorSalesAgent", [
  { role: "read", db: "analytics" }
])
```

#### Retirer des R√¥les H√©rit√©s

```javascript
db.revokeRolesFromRole("seniorSalesAgent", [
  { role: "read", db: "analytics" }
])
```

### Inspection des R√¥les

#### Voir un R√¥le Complet

```javascript
use production
db.getRole("salesAgent", {
  showPrivileges: true,
  showBuiltinRoles: true
})

// R√©sultat :
{
  "_id" : "production.salesAgent",
  "role" : "salesAgent",
  "db" : "production",
  "privileges" : [
    {
      "resource" : { "db" : "production", "collection" : "orders" },
      "actions" : [ "find", "insert", "update", "remove" ]
    },
    // ... autres privil√®ges
  ],
  "roles" : [],
  "inheritedRoles" : [],
  "inheritedPrivileges" : []
}
```

#### Voir les Privil√®ges Effectifs

```javascript
// Inclut privil√®ges h√©rit√©s
db.getRole("seniorSalesAgent", {
  showPrivileges: true,
  showAuthenticationRestrictions: true
})
```

#### Lister Tous les R√¥les

```javascript
use production
db.getRoles({
  rolesInfo: 1,
  showPrivileges: true,
  showBuiltinRoles: false  // Exclure les r√¥les int√©gr√©s
})
```

### Clonage de R√¥les

```javascript
// Fonction utilitaire de clonage
function cloneRole(sourceRole, sourceDb, targetRole, targetDb) {
  const role = db.getSiblingDB(sourceDb).getRole(sourceRole, {
    showPrivileges: true
  });

  if (!role) {
    print(`Source role not found: ${sourceRole}@${sourceDb}`);
    return;
  }

  db.getSiblingDB(targetDb).createRole({
    role: targetRole,
    privileges: role.privileges,
    roles: role.roles
  });

  print(`‚úÖ Cloned ${sourceRole}@${sourceDb} ‚Üí ${targetRole}@${targetDb}`);
}

// Usage
cloneRole("salesAgent", "production", "salesAgent", "staging");
```

## R√¥les Hi√©rarchiques Complexes

### Hi√©rarchie √† 3 Niveaux

```javascript
use production

// Niveau 1 : Base
db.createRole({
  role: "employee_base",
  privileges: [
    {
      resource: { db: "production", collection: "company_info" },
      actions: ["find"]
    },
    {
      resource: { db: "production", collection: "public_documents" },
      actions: ["find"]
    }
  ],
  roles: []
})

// Niveau 2 : D√©partement
db.createRole({
  role: "sales_department",
  privileges: [
    {
      resource: { db: "production", collection: "customers" },
      actions: ["find", "insert", "update"]
    },
    {
      resource: { db: "production", collection: "sales_leads" },
      actions: ["find", "insert", "update", "remove"]
    }
  ],
  roles: [
    { role: "employee_base", db: "production" }
  ]
})

// Niveau 3 : Manager
db.createRole({
  role: "sales_manager",
  privileges: [
    {
      resource: { db: "production", collection: "sales_reports" },
      actions: ["find", "insert", "update"]
    },
    {
      resource: { db: "production", collection: "team_performance" },
      actions: ["find", "insert", "update"]
    },
    {
      resource: { db: "production", collection: "sales_leads" },
      actions: ["remove"]  // Peut supprimer (pas les sales_department)
    }
  ],
  roles: [
    { role: "sales_department", db: "production" }
  ]
})

// R√©sultat : sales_manager h√©rite de sales_department qui h√©rite de employee_base
```

### Matrice de Permissions

```javascript
use production

// R√¥le pour chaque combinaison d√©partement/niveau

// Junior Sales
db.createRole({
  role: "sales_junior",
  privileges: [
    {
      resource: { db: "production", collection: "orders" },
      actions: ["find", "insert"]  // Uniquement cr√©ation
    }
  ],
  roles: [{ role: "employee_base", db: "production" }]
})

// Senior Sales
db.createRole({
  role: "sales_senior",
  privileges: [
    {
      resource: { db: "production", collection: "orders" },
      actions: ["update"]  // Privil√®ge additionnel
    }
  ],
  roles: [{ role: "sales_junior", db: "production" }]
})

// Sales Manager
db.createRole({
  role: "sales_manager",
  privileges: [
    {
      resource: { db: "production", collection: "orders" },
      actions: ["remove"]  // Privil√®ge additionnel
    }
  ],
  roles: [{ role: "sales_senior", db: "production" }]
})
```

## Cas d'Usage Avanc√©s

### S√©paration Lecture/√âcriture par Collection

```javascript
use production
db.createRole({
  role: "auditCompliantApp",
  privileges: [
    // Lecture seule donn√©es de r√©f√©rence
    {
      resource: { db: "production", collection: "products" },
      actions: ["find"]
    },
    {
      resource: { db: "production", collection: "categories" },
      actions: ["find"]
    },
    // Lecture/√©criture donn√©es applicatives
    {
      resource: { db: "production", collection: "orders" },
      actions: ["find", "insert", "update"]
    },
    // Insertion uniquement dans les logs (append-only)
    {
      resource: { db: "audit", collection: "application_logs" },
      actions: ["insert"]  // Pas de update ou remove
    }
  ],
  roles: []
})
```

### Acc√®s Temporel (Time-Based)

```javascript
// Note : MongoDB ne supporte pas nativement les permissions temporelles
// Mais on peut simuler avec des r√¥les distincts et rotation manuelle

use production
db.createRole({
  role: "contractor_temporary",
  privileges: [
    {
      resource: { db: "production", collection: "projects" },
      actions: ["find", "update"]
    }
  ],
  roles: []
})

// Script de r√©vocation automatique (externe)
// √Ä ex√©cuter via cron ou scheduler
function revokeExpiredContractorAccess(username, expirationDate) {
  if (new Date() > expirationDate) {
    db.getSiblingDB("admin").grantRolesToUser(username, [
      { role: "contractor_temporary", db: "production" }
    ]);
    print(`‚úÖ Revoked access for ${username}`);
  }
}
```

### Multi-Tenant avec Isolation

```javascript
use admin

// R√¥le g√©n√©rique pour tenant
function createTenantRole(tenantId) {
  db.getSiblingDB("admin").createRole({
    role: `tenant_${tenantId}_access`,
    privileges: [
      {
        resource: { db: `tenant_${tenantId}`, collection: "" },
        actions: ["find", "insert", "update", "remove"]
      }
    ],
    roles: []
  });
}

// Cr√©er r√¥les pour plusieurs tenants
["acme", "globex", "initech"].forEach(tenant => {
  createTenantRole(tenant);
});

// Utilisateur avec acc√®s multi-tenant
db.createUser({
  user: "cross_tenant_admin",
  pwd: passwordPrompt(),
  roles: [
    { role: "tenant_acme_access", db: "admin" },
    { role: "tenant_globex_access", db: "admin" }
  ]
})
```

### R√¥le avec Restrictions R√©seau

```javascript
use production
db.createRole({
  role: "remoteAccessRole",
  privileges: [
    {
      resource: { db: "production", collection: "" },
      actions: ["find"]  // Lecture seule
    }
  ],
  roles: [],

  authenticationRestrictions: [
    {
      // Uniquement depuis certaines IP
      clientSource: [
        "203.0.113.0/24",    // Bureau principal
        "198.51.100.0/24"    // Bureau secondaire
      ],
      // Uniquement vers replicas en lecture
      serverAddress: [
        "10.0.1.101",        // Secondary 1
        "10.0.1.102"         // Secondary 2
      ]
    }
  ]
})
```

### R√¥le pour Service Externe (API Key)

```javascript
use production
db.createRole({
  role: "externalApiService",
  privileges: [
    // Acc√®s limit√© aux endpoints publics
    {
      resource: { db: "production", collection: "public_api_data" },
      actions: ["find"]
    },
    // Rate limiting via collection d√©di√©e
    {
      resource: { db: "production", collection: "api_usage" },
      actions: ["insert", "update"]
    }
  ],
  roles: [],

  authenticationRestrictions: [
    {
      clientSource: ["0.0.0.0/0"],  // Internet public
      serverAddress: ["10.0.1.200"]  // Serveur API Gateway uniquement
    }
  ]
})
```

## Migration et √âvolution des R√¥les

### Versioning des R√¥les

```javascript
use production

// Version 1
db.createRole({
  role: "apiUser_v1",
  privileges: [
    {
      resource: { db: "production", collection: "data" },
      actions: ["find", "insert"]
    }
  ],
  roles: []
})

// Version 2 : Ajout de privil√®ges
db.createRole({
  role: "apiUser_v2",
  privileges: [
    {
      resource: { db: "production", collection: "data" },
      actions: ["find", "insert", "update"]  // update ajout√©
    },
    {
      resource: { db: "production", collection: "metadata" },
      actions: ["find"]  // Nouvelle collection
    }
  ],
  roles: []
})

// Migration progressive des utilisateurs
function migrateUserToV2(username) {
  db.revokeRolesFromUser(username, [
    { role: "apiUser_v1", db: "production" }
  ]);
  db.grantRolesToUser(username, [
    { role: "apiUser_v2", db: "production" }
  ]);
  print(`‚úÖ Migrated ${username} to apiUser_v2`);
}
```

### D√©pr√©ciation de R√¥les

```javascript
use production

// Marquer comme d√©pr√©ci√© (via convention de nommage)
db.createRole({
  role: "DEPRECATED_oldRole",
  privileges: [],
  roles: [
    { role: "newRole", db: "production" }
  ]
})

// Audit des r√¥les d√©pr√©ci√©s
function findDeprecatedRoleUsage() {
  db.getSiblingDB("admin").system.users.find().forEach(user => {
    const deprecated = user.roles.filter(r => r.role.startsWith("DEPRECATED_"));
    if (deprecated.length > 0) {
      print(`‚ö†Ô∏è  User ${user.user} uses deprecated roles:`);
      printjson(deprecated);
    }
  });
}

findDeprecatedRoleUsage();
```

### Refactoring de R√¥les

```javascript
// Avant : R√¥le monolithique
db.createRole({
  role: "applicationUser_old",
  privileges: [
    // Beaucoup de privil√®ges m√©lang√©s...
  ],
  roles: []
})

// Apr√®s : R√¥les modulaires
db.createRole({
  role: "dataReader",
  privileges: [
    {
      resource: { db: "production", collection: "" },
      actions: ["find"]
    }
  ],
  roles: []
})

db.createRole({
  role: "dataWriter",
  privileges: [
    {
      resource: { db: "production", collection: "orders" },
      actions: ["insert", "update"]
    }
  ],
  roles: []
})

db.createRole({
  role: "applicationUser_new",
  privileges: [],
  roles: [
    { role: "dataReader", db: "production" },
    { role: "dataWriter", db: "production" }
  ]
})
```

## Testing et Validation

### Validation des Permissions

```javascript
// Fonction de test des permissions
function testRolePermissions(roleName, database) {
  print(`\n=== Testing role: ${roleName}@${database} ===`);

  const role = db.getSiblingDB(database).getRole(roleName, {
    showPrivileges: true
  });

  if (!role) {
    print(`‚ùå Role not found`);
    return;
  }

  print(`‚úÖ Role exists`);
  print(`Privileges: ${role.privileges.length}`);
  print(`Inherited roles: ${role.roles.length}`);

  // V√©rifier la coh√©rence
  const collections = new Set();
  role.privileges.forEach(priv => {
    if (priv.resource.collection) {
      collections.add(priv.resource.collection);
    }
  });

  print(`Collections targeted: ${collections.size}`);
  print(`Collections: ${Array.from(collections).join(", ")}`);
}

// Usage
testRolePermissions("salesAgent", "production");
```

### Simulation d'Utilisateur

```javascript
// Cr√©er un utilisateur de test
use production
db.createUser({
  user: "test_salesagent",
  pwd: "testpassword",
  roles: [{ role: "salesAgent", db: "production" }]
})

// Tester les op√©rations (dans une session s√©par√©e)
// mongosh -u test_salesagent -p testpassword --authenticationDatabase production

// Script de nettoyage
function cleanupTestUsers() {
  db.getSiblingDB("production").system.users.find({
    user: /^test_/
  }).forEach(user => {
    db.getSiblingDB(user.db).dropUser(user.user);
    print(`Deleted test user: ${user.user}`);
  });
}
```

### Comparaison de R√¥les

```javascript
function compareRoles(role1, db1, role2, db2) {
  const r1 = db.getSiblingDB(db1).getRole(role1, { showPrivileges: true });
  const r2 = db.getSiblingDB(db2).getRole(role2, { showPrivileges: true });

  print(`\n=== Comparing ${role1}@${db1} vs ${role2}@${db2} ===`);

  print(`${role1}: ${r1.privileges.length} privileges, ${r1.roles.length} inherited roles`);
  print(`${role2}: ${r2.privileges.length} privileges, ${r2.roles.length} inherited roles`);

  // Comparer les actions
  const actions1 = new Set();
  const actions2 = new Set();

  r1.privileges.forEach(p => p.actions.forEach(a => actions1.add(a)));
  r2.privileges.forEach(p => p.actions.forEach(a => actions2.add(a)));

  const onlyIn1 = [...actions1].filter(a => !actions2.has(a));
  const onlyIn2 = [...actions2].filter(a => !actions1.has(a));

  if (onlyIn1.length > 0) {
    print(`Actions only in ${role1}: ${onlyIn1.join(", ")}`);
  }
  if (onlyIn2.length > 0) {
    print(`Actions only in ${role2}: ${onlyIn2.join(", ")}`);
  }
}
```

## Audit et Documentation

### Export des R√¥les

```javascript
// Fonction d'export vers JSON
function exportRole(roleName, database) {
  const role = db.getSiblingDB(database).getRole(roleName, {
    showPrivileges: true,
    showAuthenticationRestrictions: true
  });

  if (!role) {
    print(`Role not found: ${roleName}@${database}`);
    return null;
  }

  const exportData = {
    role: role.role,
    db: role.db,
    privileges: role.privileges,
    roles: role.roles,
    authenticationRestrictions: role.authenticationRestrictions || []
  };

  return JSON.stringify(exportData, null, 2);
}

// Usage
const roleJson = exportRole("salesAgent", "production");
print(roleJson);

// Sauvegarder dans un fichier (via shell)
// mongosh --eval "print(exportRole('salesAgent', 'production'))" > salesAgent.json
```

### Import de R√¥les

```javascript
// Fonction d'import depuis JSON
function importRole(jsonString, targetDatabase) {
  const roleData = JSON.parse(jsonString);

  try {
    db.getSiblingDB(targetDatabase).createRole({
      role: roleData.role,
      privileges: roleData.privileges,
      roles: roleData.roles,
      authenticationRestrictions: roleData.authenticationRestrictions
    });

    print(`‚úÖ Imported role: ${roleData.role}@${targetDatabase}`);
  } catch (e) {
    print(`‚ùå Error importing role: ${e}`);
  }
}
```

### Documentation Automatique

```javascript
function documentRole(roleName, database) {
  const role = db.getSiblingDB(database).getRole(roleName, {
    showPrivileges: true
  });

  if (!role) {
    return `Role not found: ${roleName}@${database}`;
  }

  let doc = `# Role: ${roleName}@${database}\n\n`;
  doc += `## Overview\n`;
  doc += `- Database: ${database}\n`;
  doc += `- Privileges: ${role.privileges.length}\n`;
  doc += `- Inherited Roles: ${role.roles.length}\n\n`;

  doc += `## Direct Privileges\n\n`;
  role.privileges.forEach(priv => {
    const resource = priv.resource.collection
      ? `${priv.resource.db}.${priv.resource.collection}`
      : priv.resource.db
      ? `${priv.resource.db}.*`
      : "cluster";

    doc += `### ${resource}\n`;
    doc += `Actions: ${priv.actions.join(", ")}\n\n`;
  });

  if (role.roles.length > 0) {
    doc += `## Inherited Roles\n\n`;
    role.roles.forEach(r => {
      doc += `- ${r.role}@${r.db}\n`;
    });
  }

  return doc;
}

// Usage
print(documentRole("salesAgent", "production"));
```

### Audit Trail

```javascript
// Enregistrer les changements de r√¥les
function auditRoleChange(action, roleName, database, details) {
  db.getSiblingDB("audit").role_changes.insertOne({
    timestamp: new Date(),
    action: action,  // "create", "modify", "delete"
    role: roleName,
    database: database,
    details: details,
    user: db.runCommand({ connectionStatus: 1 }).authInfo.authenticatedUsers[0]
  });
}

// Wrapper pour createRole avec audit
function createRoleWithAudit(database, roleDefinition) {
  db.getSiblingDB(database).createRole(roleDefinition);

  auditRoleChange(
    "create",
    roleDefinition.role,
    database,
    { privileges: roleDefinition.privileges.length }
  );
}
```

## Bonnes Pratiques de Production

### 1. Convention de Nommage

```javascript
// ‚úÖ BON : Noms descriptifs et coh√©rents
"customerServiceAgent"
"sales_regional_manager"
"apiReadOnly"
"payment_service_role"

// ‚ùå MAUVAIS : Noms vagues
"role1"
"temp"
"user"
"newrole"
```

**Recommandations** :
- Pr√©fixe par fonction m√©tier : `sales_`, `support_`, `api_`
- Suffixe par niveau : `_junior`, `_senior`, `_manager`
- Suffixe par type : `_readonly`, `_service`, `_admin`

### 2. Granularit√© Appropri√©e

```javascript
// ‚ùå TROP GRANULAIRE : Maintenance difficile
db.createRole({ role: "orderReader", ... })
db.createRole({ role: "orderWriter", ... })
db.createRole({ role: "orderUpdater", ... })
db.createRole({ role: "orderDeleter", ... })

// ‚úÖ BON : √âquilibre entre granularit√© et maintenabilit√©
db.createRole({
  role: "orderManager",
  privileges: [
    {
      resource: { db: "production", collection: "orders" },
      actions: ["find", "insert", "update", "remove"]
    }
  ],
  roles: []
})
```

### 3. Documentation dans M√©tadonn√©es

```javascript
use production
db.createRole({
  role: "salesAgent",
  privileges: [...],
  roles: []
})

// Ajouter m√©tadonn√©es
db.system.roles.updateOne(
  { _id: "production.salesAgent" },
  {
    $set: {
      _metadata: {
        description: "R√¥le pour agents commerciaux : gestion commandes, consultation clients",
        owner: "Sales Department",
        created: new Date(),
        lastModified: new Date(),
        approvedBy: "Security Team",
        reviewDate: new Date("2025-06-01")
      }
    }
  }
)
```

### 4. Principe de S√©paration des Responsabilit√©s

```javascript
// ‚ùå MAUVAIS : Un seul r√¥le pour tout
db.createRole({
  role: "appRole",
  privileges: [
    { resource: { db: "production", collection: "" }, actions: ["find", "insert", "update", "remove"] },
    { resource: { cluster: true }, actions: ["serverStatus"] }
  ],
  roles: [{ role: "dbAdmin", db: "production" }]
})

// ‚úÖ BON : R√¥les s√©par√©s par responsabilit√©
db.createRole({ role: "appDataAccess", ... })      // Acc√®s donn√©es
db.createRole({ role: "appMonitoring", ... })      // Monitoring
db.createRole({ role: "appMaintenance", ... })     // Maintenance
```

### 5. R√©vision P√©riodique

```javascript
// Script de r√©vision trimestrielle
function quarterlyRoleReview() {
  const report = {
    date: new Date(),
    roles: [],
    warnings: []
  };

  db.getRoles({ showPrivileges: true, showBuiltinRoles: false })
    .forEach(role => {
      const roleInfo = {
        name: role.role,
        privilegeCount: role.privileges.length,
        users: []
      };

      // Compter utilisateurs avec ce r√¥le
      db.getSiblingDB("admin").system.users.find().forEach(user => {
        if (user.roles.some(r => r.role === role.role)) {
          roleInfo.users.push(user.user);
        }
      });

      roleInfo.userCount = roleInfo.users.length;

      // Warning si r√¥le non utilis√©
      if (roleInfo.userCount === 0) {
        report.warnings.push(`‚ö†Ô∏è  Role ${role.role} has no users`);
      }

      report.roles.push(roleInfo);
    });

  return report;
}

// Ex√©cuter et analyser
const review = quarterlyRoleReview();
printjson(review);
```

### 6. Testing Avant D√©ploiement

```javascript
// Environnement de test
use staging

// Cr√©er le r√¥le en staging d'abord
db.createRole({
  role: "newFeatureRole",
  privileges: [...],
  roles: []
})

// Tester avec utilisateur temporaire
db.createUser({
  user: "test_newfeature",
  pwd: "testpass",
  roles: [{ role: "newFeatureRole", db: "staging" }]
})

// Valider les op√©rations
// ... tests ...

// Si OK, d√©ployer en production
use production
db.createRole({
  role: "newFeatureRole",
  privileges: [...],
  roles: []
})

// Nettoyer staging
use staging
db.dropUser("test_newfeature")
```

### 7. Versioning et Rollback

```javascript
// Sauvegarder avant modification
function backupRole(roleName, database) {
  const role = db.getSiblingDB(database).getRole(roleName, {
    showPrivileges: true
  });

  db.getSiblingDB("backups").role_backups.insertOne({
    timestamp: new Date(),
    role: roleName,
    database: database,
    definition: role
  });

  print(`‚úÖ Backed up ${roleName}@${database}`);
}

// Restaurer si probl√®me
function rollbackRole(roleName, database, timestamp) {
  const backup = db.getSiblingDB("backups").role_backups.findOne({
    role: roleName,
    database: database,
    timestamp: timestamp
  });

  if (!backup) {
    print(`‚ùå Backup not found`);
    return;
  }

  // Supprimer r√¥le actuel
  db.getSiblingDB(database).dropRole(roleName);

  // Recr√©er depuis backup
  db.getSiblingDB(database).createRole({
    role: backup.definition.role,
    privileges: backup.definition.privileges,
    roles: backup.definition.roles
  });

  print(`‚úÖ Rolled back ${roleName}@${database} to ${timestamp}`);
}
```

## Outils et Scripts Utilitaires

### G√©n√©rateur de R√¥les

```javascript
class RoleGenerator {
  constructor(database) {
    this.database = database;
    this.db = db.getSiblingDB(database);
  }

  // R√¥le CRUD standard
  createCrudRole(roleName, collections) {
    const privileges = collections.map(coll => ({
      resource: { db: this.database, collection: coll },
      actions: ["find", "insert", "update", "remove"]
    }));

    this.db.createRole({
      role: roleName,
      privileges: privileges,
      roles: []
    });

    print(`‚úÖ Created CRUD role: ${roleName}`);
  }

  // R√¥le lecture seule
  createReadOnlyRole(roleName, collections) {
    const privileges = collections.map(coll => ({
      resource: { db: this.database, collection: coll },
      actions: ["find", "listIndexes"]
    }));

    this.db.createRole({
      role: roleName,
      privileges: privileges,
      roles: []
    });

    print(`‚úÖ Created read-only role: ${roleName}`);
  }

  // R√¥le microservice
  createMicroserviceRole(serviceName, ownedCollections, readCollections) {
    const privileges = [];

    // Collections poss√©d√©es : acc√®s complet
    ownedCollections.forEach(coll => {
      privileges.push({
        resource: { db: this.database, collection: coll },
        actions: ["find", "insert", "update", "remove", "createIndex", "dropIndex"]
      });
    });

    // Collections partag√©es : lecture seule
    readCollections.forEach(coll => {
      privileges.push({
        resource: { db: this.database, collection: coll },
        actions: ["find"]
      });
    });

    this.db.createRole({
      role: `${serviceName}_service_role`,
      privileges: privileges,
      roles: []
    });

    print(`‚úÖ Created microservice role: ${serviceName}_service_role`);
  }
}

// Usage
const generator = new RoleGenerator("production");
generator.createCrudRole("orderManager", ["orders", "order_items"]);
generator.createReadOnlyRole("reportingService", ["orders", "customers", "products"]);
generator.createMicroserviceRole(
  "payment",
  ["payments", "transactions"],
  ["orders", "customers"]
);
```

### Analyseur de R√¥les

```javascript
class RoleAnalyzer {
  constructor() {
    this.adminDb = db.getSiblingDB("admin");
  }

  // Analyser l'utilisation des r√¥les
  analyzeRoleUsage() {
    const roleUsage = {};

    // Parcourir tous les utilisateurs
    this.adminDb.system.users.find().forEach(user => {
      user.roles.forEach(role => {
        const key = `${role.role}@${role.db}`;
        if (!roleUsage[key]) {
          roleUsage[key] = {
            role: role.role,
            db: role.db,
            users: []
          };
        }
        roleUsage[key].users.push(user.user);
      });
    });

    // Afficher rapport
    print("\n=== Role Usage Report ===");
    Object.values(roleUsage).forEach(info => {
      print(`\n${info.role}@${info.db}`);
      print(`  Users (${info.users.length}): ${info.users.join(", ")}`);
    });

    return roleUsage;
  }

  // Trouver les r√¥les orphelins
  findOrphanRoles() {
    const usedRoles = new Set();

    this.adminDb.system.users.find().forEach(user => {
      user.roles.forEach(role => {
        usedRoles.add(`${role.role}@${role.db}`);
      });
    });

    const orphans = [];

    // V√©rifier chaque base
    this.adminDb.runCommand({ listDatabases: 1 }).databases.forEach(dbInfo => {
      const database = db.getSiblingDB(dbInfo.name);

      try {
        database.getRoles({ showBuiltinRoles: false }).forEach(role => {
          const key = `${role.role}@${role.db}`;
          if (!usedRoles.has(key)) {
            orphans.push({
              role: role.role,
              db: role.db
            });
          }
        });
      } catch (e) {
        // Ignorer les erreurs d'acc√®s
      }
    });

    print("\n=== Orphan Roles (not assigned to any user) ===");
    orphans.forEach(role => {
      print(`‚ö†Ô∏è  ${role.role}@${role.db}`);
    });

    return orphans;
  }

  // Analyser la complexit√© des r√¥les
  analyzeRoleComplexity() {
    const analysis = [];

    db.getRoles({ showPrivileges: true, showBuiltinRoles: false })
      .forEach(role => {
        const complexity = {
          role: role.role,
          privilegeCount: role.privileges.length,
          inheritedRoleCount: role.roles.length,
          actionCount: 0,
          collectionCount: new Set()
        };

        role.privileges.forEach(priv => {
          complexity.actionCount += priv.actions.length;
          if (priv.resource.collection) {
            complexity.collectionCount.add(priv.resource.collection);
          }
        });

        complexity.collectionCount = complexity.collectionCount.size;
        complexity.complexityScore =
          complexity.privilegeCount * 2 +
          complexity.actionCount +
          complexity.collectionCount;

        analysis.push(complexity);
      });

    // Trier par complexit√©
    analysis.sort((a, b) => b.complexityScore - a.complexityScore);

    print("\n=== Role Complexity Analysis ===");
    analysis.forEach(a => {
      print(`\n${a.role} (Score: ${a.complexityScore})`);
      print(`  Privileges: ${a.privilegeCount}`);
      print(`  Actions: ${a.actionCount}`);
      print(`  Collections: ${a.collectionCount}`);
      print(`  Inherited: ${a.inheritedRoleCount}`);
    });

    return analysis;
  }
}

// Usage
const analyzer = new RoleAnalyzer();
analyzer.analyzeRoleUsage();
analyzer.findOrphanRoles();
analyzer.analyzeRoleComplexity();
```

## Conclusion

Les r√¥les personnalis√©s offrent une flexibilit√© essentielle pour impl√©menter des politiques de s√©curit√© pr√©cises et adapt√©es aux besoins m√©tier.

**Principes cl√©s** :
- ‚úÖ Cr√©er des r√¥les personnalis√©s pour logique m√©tier sp√©cifique
- ‚úÖ Utiliser l'h√©ritage pour √©viter la duplication
- ‚úÖ Maintenir une granularit√© √©quilibr√©e
- ‚úÖ Documenter tous les r√¥les personnalis√©s
- ‚úÖ Tester avant d√©ploiement en production
- ‚úÖ R√©viser et auditer r√©guli√®rement
- ‚úÖ Versionner et sauvegarder les d√©finitions
- ‚úÖ Utiliser des conventions de nommage coh√©rentes

**Quand utiliser r√¥les personnalis√©s vs int√©gr√©s** :
- **R√¥les int√©gr√©s** : Besoins standards, maintenance simple
- **R√¥les personnalis√©s** : Logique m√©tier complexe, conformit√© stricte

**Workflow recommand√©** :
1. Analyser les besoins m√©tier
2. V√©rifier si r√¥les int√©gr√©s suffisent
3. Concevoir r√¥les personnalis√©s si n√©cessaire
4. Tester en staging
5. Documenter
6. D√©ployer en production
7. Auditer r√©guli√®rement
8. Refactorer si besoin

Les r√¥les personnalis√©s sont un outil puissant qui, combin√© aux r√¥les int√©gr√©s et aux principes RBAC, permet de construire une architecture de s√©curit√© robuste et maintenable.

---

**Prochaine Section** :
- **11.3.3** : Privil√®ges et actions - Catalogue complet des actions disponibles et cas d'usage

‚è≠Ô∏è [Privil√®ges et actions](/11-securite/03.3-privileges-actions.md)
