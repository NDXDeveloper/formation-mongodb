üîù Retour au [Sommaire](/SOMMAIRE.md)

# 11.3.3 Privil√®ges et Actions

## Introduction

Les actions MongoDB d√©finissent les op√©rations sp√©cifiques qu'un utilisateur peut effectuer sur une resource. Comprendre les actions disponibles et leurs implications est essentiel pour cr√©er des r√¥les personnalis√©s efficaces et s√©curis√©s. Ce catalogue exhaustif d√©taille toutes les actions MongoDB, leurs cas d'usage, et les bonnes pratiques d'utilisation.

### Anatomie d'un Privil√®ge

```javascript
{
  resource: {
    db: "production",           // Base de donn√©es cible
    collection: "orders"        // Collection cible (ou "" pour toutes)
  },
  actions: [
    "find",                     // Action 1
    "insert",                   // Action 2
    "update"                    // Action 3
  ]
}
```

**Composants** :
- **Resource** : D√©finit la port√©e (database, collection, cluster)
- **Actions** : Liste des op√©rations autoris√©es sur cette resource

### Classification des Actions

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      ACTIONS MONGODB                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ                   ‚îÇ                   ‚îÇ
        ‚ñº                   ‚ñº                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    DATA     ‚îÇ    ‚îÇ   DATABASE  ‚îÇ    ‚îÇ   CLUSTER   ‚îÇ
‚îÇ   ACTIONS   ‚îÇ    ‚îÇ    ADMIN    ‚îÇ    ‚îÇ   ACTIONS   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ                   ‚îÇ                   ‚îÇ
        ‚îú‚îÄ find             ‚îú‚îÄ createIndex      ‚îú‚îÄ serverStatus
        ‚îú‚îÄ insert           ‚îú‚îÄ dropIndex        ‚îú‚îÄ replSetReconfig
        ‚îú‚îÄ update           ‚îú‚îÄ createCollection ‚îú‚îÄ shardCollection
        ‚îú‚îÄ remove           ‚îú‚îÄ dbStats          ‚îú‚îÄ shutdown
        ‚îî‚îÄ ...              ‚îî‚îÄ ...              ‚îî‚îÄ ...
```

## Actions de Donn√©es (Data Actions)

### Actions de Lecture

#### find

**Description** : Ex√©cuter des requ√™tes de lecture sur une collection.

**Op√©rations autoris√©es** :
- `db.collection.find()`
- `db.collection.findOne()`
- `db.collection.aggregate()` (lecture seule)
- `db.collection.count()`
- `db.collection.distinct()`

**Niveau** : Collection

**Exemple** :

```javascript
{
  resource: { db: "production", collection: "orders" },
  actions: ["find"]
}
```

**Cas d'usage** :
- Applications analytics en lecture seule
- Services de reporting
- Dashboards de visualisation
- Exports de donn√©es

**‚ö†Ô∏è Note** : Ne permet pas les modifications, m√™me temporaires (pas de `$out` dans aggregate).

#### listCollections

**Description** : Lister les collections d'une base de donn√©es.

**Op√©rations autoris√©es** :
- `db.getCollectionNames()`
- `db.getCollectionInfos()`
- `show collections`

**Niveau** : Database

**Exemple** :

```javascript
{
  resource: { db: "production", collection: "" },
  actions: ["listCollections"]
}
```

**Cas d'usage** :
- Outils de d√©couverte de sch√©ma
- Applications de migration
- Scripts d'administration

#### listIndexes

**Description** : Lister les index d'une collection.

**Op√©rations autoris√©es** :
- `db.collection.getIndexes()`
- `db.collection.getIndexSpecs()`

**Niveau** : Collection

**Exemple** :

```javascript
{
  resource: { db: "production", collection: "orders" },
  actions: ["listIndexes"]
}
```

**Cas d'usage** :
- Analyse de performances
- Optimisation de requ√™tes
- Documentation du sch√©ma

#### listDatabases

**Description** : Lister toutes les bases de donn√©es.

**Op√©rations autoris√©es** :
- `db.adminCommand({ listDatabases: 1 })`
- `show dbs`

**Niveau** : Cluster

**Exemple** :

```javascript
{
  resource: { cluster: true },
  actions: ["listDatabases"]
}
```

**Cas d'usage** :
- Outils de monitoring globaux
- Backups automatis√©s
- Inventaire des ressources

### Actions d'√âcriture

#### insert

**Description** : Ins√©rer de nouveaux documents dans une collection.

**Op√©rations autoris√©es** :
- `db.collection.insertOne()`
- `db.collection.insertMany()`
- `db.collection.bulkWrite()` (insert operations)

**Niveau** : Collection

**Exemple** :

```javascript
{
  resource: { db: "production", collection: "orders" },
  actions: ["insert"]
}
```

**Cas d'usage** :
- Applications cr√©ant de nouvelles donn√©es
- Services d'ingestion
- APIs REST (POST)

**‚ö†Ô∏è S√©curit√©** : Permet la cr√©ation de documents mais pas leur modification ou suppression.

#### update

**Description** : Modifier des documents existants dans une collection.

**Op√©rations autoris√©es** :
- `db.collection.updateOne()`
- `db.collection.updateMany()`
- `db.collection.replaceOne()`
- `db.collection.findAndModify()` (update)
- `db.collection.bulkWrite()` (update operations)

**Niveau** : Collection

**Exemple** :

```javascript
{
  resource: { db: "production", collection: "orders" },
  actions: ["update"]
}
```

**Cas d'usage** :
- Applications modifiant les donn√©es
- Mise √† jour de statuts
- APIs REST (PUT/PATCH)

**‚ö†Ô∏è Important** : Ne permet pas l'insertion de nouveaux documents (upsert n√©cessite `insert` aussi).

#### remove

**Description** : Supprimer des documents d'une collection.

**Op√©rations autoris√©es** :
- `db.collection.deleteOne()`
- `db.collection.deleteMany()`
- `db.collection.remove()`
- `db.collection.findAndModify()` (remove)
- `db.collection.bulkWrite()` (delete operations)

**Niveau** : Collection

**Exemple** :

```javascript
{
  resource: { db: "production", collection: "orders" },
  actions: ["remove"]
}
```

**Cas d'usage** :
- Nettoyage de donn√©es
- Suppression d'enregistrements obsol√®tes
- APIs REST (DELETE)

**‚ö†Ô∏è Danger** : Action destructive, auditer les acc√®s.

#### bypassDocumentValidation

**Description** : Contourner les r√®gles de validation de documents.

**Op√©rations autoris√©es** :
- Insertion/mise √† jour ignorant les validateurs
- Op√©rations avec `{ bypassDocumentValidation: true }`

**Niveau** : Collection

**Exemple** :

```javascript
{
  resource: { db: "production", collection: "orders" },
  actions: ["bypassDocumentValidation"]
}
```

**Cas d'usage** :
- Scripts de migration de donn√©es
- Imports de donn√©es legacy
- Corrections exceptionnelles

**‚ö†Ô∏è DANGER** : Permet d'ins√©rer des donn√©es non conformes au sch√©ma. √Ä utiliser avec extr√™me pr√©caution.

**Recommandation** : Ne pas inclure dans les r√¥les standard.

## Actions d'Administration de Collection

#### createIndex

**Description** : Cr√©er des index sur une collection.

**Op√©rations autoris√©es** :
- `db.collection.createIndex()`
- `db.collection.createIndexes()`
- `db.collection.ensureIndex()` (d√©pr√©ci√©)

**Niveau** : Collection

**Exemple** :

```javascript
{
  resource: { db: "production", collection: "orders" },
  actions: ["createIndex"]
}
```

**Cas d'usage** :
- Optimisation de performances
- DBAs et d√©veloppeurs
- Scripts de d√©ploiement

**Impact** :
- Peut bloquer les op√©rations (index build)
- Consomme de l'espace disque
- Am√©liore les performances de lecture

#### dropIndex

**Description** : Supprimer des index d'une collection.

**Op√©rations autoris√©es** :
- `db.collection.dropIndex()`
- `db.collection.dropIndexes()`

**Niveau** : Collection

**Exemple** :

```javascript
{
  resource: { db: "production", collection: "orders" },
  actions: ["dropIndex"]
}
```

**Cas d'usage** :
- Nettoyage d'index inutilis√©s
- R√©organisation d'index
- Maintenance de performances

**‚ö†Ô∏è Impact** : Suppression d'index peut d√©grader significativement les performances.

#### reIndex

**Description** : Reconstruire tous les index d'une collection.

**Op√©rations autoris√©es** :
- `db.collection.reIndex()`

**Niveau** : Collection

**Exemple** :

```javascript
{
  resource: { db: "production", collection: "orders" },
  actions: ["reIndex"]
}
```

**Cas d'usage** :
- Correction d'index corrompus
- Optimisation apr√®s modifications massives
- Maintenance planifi√©e

**‚ö†Ô∏è ATTENTION** : Op√©ration bloquante, √† effectuer en maintenance.

#### collMod

**Description** : Modifier les options d'une collection.

**Op√©rations autoris√©es** :
- `db.runCommand({ collMod: "collection", ... })`
- Modification de validateurs
- Modification d'options de collection

**Niveau** : Collection

**Exemple** :

```javascript
{
  resource: { db: "production", collection: "orders" },
  actions: ["collMod"]
}
```

**Cas d'usage** :
- Modification de sch√©mas de validation
- Ajustement de TTL indexes
- Configuration de capped collections

#### compact

**Description** : Compacter une collection (d√©fragmentation).

**Op√©rations autoris√©es** :
- `db.runCommand({ compact: "collection" })`

**Niveau** : Collection

**Exemple** :

```javascript
{
  resource: { db: "production", collection: "orders" },
  actions: ["compact"]
}
```

**Cas d'usage** :
- R√©cup√©ration d'espace disque
- Optimisation de performances
- Maintenance planifi√©e

**‚ö†Ô∏è ATTENTION** : Op√©ration lourde, bloque la collection.

#### validate

**Description** : Valider la structure et l'int√©grit√© d'une collection.

**Op√©rations autoris√©es** :
- `db.collection.validate()`

**Niveau** : Collection

**Exemple** :

```javascript
{
  resource: { db: "production", collection: "orders" },
  actions: ["validate"]
}
```

**Cas d'usage** :
- Diagnostic de corruption
- V√©rification d'int√©grit√©
- Audits de sant√©

#### convertToCapped

**Description** : Convertir une collection normale en capped collection.

**Op√©rations autoris√©es** :
- `db.runCommand({ convertToCapped: "collection", size: ... })`

**Niveau** : Collection

**Exemple** :

```javascript
{
  resource: { db: "production", collection: "logs" },
  actions: ["convertToCapped"]
}
```

**Cas d'usage** :
- Conversion de collections de logs
- Limitation de taille automatique

**‚ö†Ô∏è ATTENTION** : Op√©ration irr√©versible et bloquante.

## Actions d'Administration de Base de Donn√©es

#### createCollection

**Description** : Cr√©er de nouvelles collections.

**Op√©rations autoris√©es** :
- `db.createCollection()`
- Cr√©ation implicite via insertion

**Niveau** : Database

**Exemple** :

```javascript
{
  resource: { db: "production", collection: "" },
  actions: ["createCollection"]
}
```

**Cas d'usage** :
- D√©ploiement de nouvelles fonctionnalit√©s
- Migrations de sch√©ma
- Initialisation d'applications

#### dropCollection

**Description** : Supprimer des collections.

**Op√©rations autoris√©es** :
- `db.collection.drop()`

**Niveau** : Database

**Exemple** :

```javascript
{
  resource: { db: "production", collection: "" },
  actions: ["dropCollection"]
}
```

**Cas d'usage** :
- Nettoyage de collections obsol√®tes
- Migrations de donn√©es
- Tests et d√©veloppement

**‚ö†Ô∏è DANGER** : Suppression d√©finitive de donn√©es. Auditer strictement.

#### dbStats

**Description** : Obtenir les statistiques d'une base de donn√©es.

**Op√©rations autoris√©es** :
- `db.stats()`
- `db.runCommand({ dbStats: 1 })`

**Niveau** : Database

**Exemple** :

```javascript
{
  resource: { db: "production", collection: "" },
  actions: ["dbStats"]
}
```

**Cas d'usage** :
- Monitoring de l'utilisation
- Capacity planning
- Rapports d'audit

#### collStats

**Description** : Obtenir les statistiques d'une collection.

**Op√©rations autoris√©es** :
- `db.collection.stats()`
- `db.runCommand({ collStats: "collection" })`

**Niveau** : Collection

**Exemple** :

```javascript
{
  resource: { db: "production", collection: "orders" },
  actions: ["collStats"]
}
```

**Cas d'usage** :
- Analyse de performances
- Optimisation de sch√©ma
- Monitoring

#### enableProfiler

**Description** : Activer/d√©sactiver le profiler de base de donn√©es.

**Op√©rations autoris√©es** :
- `db.setProfilingLevel()`
- `db.runCommand({ profile: 1, slowms: 100 })`

**Niveau** : Database

**Exemple** :

```javascript
{
  resource: { db: "production", collection: "" },
  actions: ["enableProfiler"]
}
```

**Cas d'usage** :
- Diagnostic de performances
- Identification de requ√™tes lentes
- Optimisation

**‚ö†Ô∏è Impact** : Le profiling a un co√ªt performance.

#### dropDatabase

**Description** : Supprimer une base de donn√©es enti√®re.

**Op√©rations autoris√©es** :
- `db.dropDatabase()`

**Niveau** : Database

**Exemple** :

```javascript
{
  resource: { db: "production", collection: "" },
  actions: ["dropDatabase"]
}
```

**Cas d'usage** :
- Nettoyage d'environnements de test
- D√©commissioning de projets

**‚ö†Ô∏è DANGER EXTR√äME** : Suppression totale et irr√©versible. Ne jamais accorder en production sauf cas tr√®s sp√©cifiques.

## Actions de Gestion des Utilisateurs

#### createUser

**Description** : Cr√©er de nouveaux utilisateurs.

**Op√©rations autoris√©es** :
- `db.createUser()`

**Niveau** : Database

**Exemple** :

```javascript
{
  resource: { db: "production", collection: "" },
  actions: ["createUser"]
}
```

**Cas d'usage** :
- Administrateurs de s√©curit√©
- Provisioning automatique
- Self-service portals

#### dropUser

**Description** : Supprimer des utilisateurs.

**Op√©rations autoris√©es** :
- `db.dropUser()`

**Niveau** : Database

**Exemple** :

```javascript
{
  resource: { db: "production", collection: "" },
  actions: ["dropUser"]
}
```

**Cas d'usage** :
- R√©vocation d'acc√®s
- D√©provisioning
- Gestion du cycle de vie

#### changeCustomData

**Description** : Modifier les donn√©es personnalis√©es d'un utilisateur.

**Op√©rations autoris√©es** :
- `db.updateUser()` (customData field)

**Niveau** : Database

**Exemple** :

```javascript
{
  resource: { db: "admin", collection: "" },
  actions: ["changeCustomData"]
}
```

**Cas d'usage** :
- M√©tadonn√©es utilisateur
- Informations de contact
- Attributs personnalis√©s

#### changePassword

**Description** : Modifier le mot de passe d'un utilisateur.

**Op√©rations autoris√©es** :
- `db.changeUserPassword()`
- `db.updateUser()` (pwd field)

**Niveau** : Database

**Exemple** :

```javascript
{
  resource: { db: "admin", collection: "" },
  actions: ["changePassword"]
}
```

**Cas d'usage** :
- R√©initialisation de mots de passe
- Politiques de rotation
- Self-service

**‚ö†Ô∏è Note** : Un utilisateur avec cette permission peut changer n'importe quel mot de passe dans la base, y compris celui des admins.

#### viewUser

**Description** : Voir les informations des utilisateurs.

**Op√©rations autoris√©es** :
- `db.getUser()`
- `db.getUsers()`

**Niveau** : Database

**Exemple** :

```javascript
{
  resource: { db: "admin", collection: "" },
  actions: ["viewUser"]
}
```

**Cas d'usage** :
- Audit des acc√®s
- Reporting de s√©curit√©
- Documentation

## Actions de Gestion des R√¥les

#### createRole

**Description** : Cr√©er de nouveaux r√¥les personnalis√©s.

**Op√©rations autoris√©es** :
- `db.createRole()`

**Niveau** : Database

**Exemple** :

```javascript
{
  resource: { db: "production", collection: "" },
  actions: ["createRole"]
}
```

**Cas d'usage** :
- Administrateurs de s√©curit√©
- D√©finition de r√¥les m√©tier
- Gestion d'acc√®s

#### dropRole

**Description** : Supprimer des r√¥les personnalis√©s.

**Op√©rations autoris√©es** :
- `db.dropRole()`

**Niveau** : Database

**Exemple** :

```javascript
{
  resource: { db: "production", collection: "" },
  actions: ["dropRole"]
}
```

**Cas d'usage** :
- Nettoyage de r√¥les obsol√®tes
- Refactoring de permissions

#### grantRole

**Description** : Accorder des r√¥les √† des utilisateurs.

**Op√©rations autoris√©es** :
- `db.grantRolesToUser()`

**Niveau** : Database

**Exemple** :

```javascript
{
  resource: { db: "admin", collection: "" },
  actions: ["grantRole"]
}
```

**Cas d'usage** :
- Provisioning d'utilisateurs
- √âl√©vation de privil√®ges
- Gestion d'acc√®s

**‚ö†Ô∏è Pouvoir** : Peut accorder n'importe quel r√¥le, y compris des r√¥les √† hauts privil√®ges.

#### revokeRole

**Description** : R√©voquer des r√¥les d'utilisateurs.

**Op√©rations autoris√©es** :
- `db.revokeRolesFromUser()`

**Niveau** : Database

**Exemple** :

```javascript
{
  resource: { db: "admin", collection: "" },
  actions: ["revokeRole"]
}
```

**Cas d'usage** :
- R√©vocation d'acc√®s
- D√©provisioning
- R√©duction de privil√®ges

#### viewRole

**Description** : Voir les informations des r√¥les.

**Op√©rations autoris√©es** :
- `db.getRole()`
- `db.getRoles()`

**Niveau** : Database

**Exemple** :

```javascript
{
  resource: { db: "production", collection: "" },
  actions: ["viewRole"]
}
```

**Cas d'usage** :
- Audit des permissions
- Documentation
- Analyse de s√©curit√©

#### grantPrivilegesToRole

**Description** : Ajouter des privil√®ges √† un r√¥le.

**Op√©rations autoris√©es** :
- `db.grantPrivilegesToRole()`

**Niveau** : Database

**Exemple** :

```javascript
{
  resource: { db: "production", collection: "" },
  actions: ["grantPrivilegesToRole"]
}
```

**Cas d'usage** :
- √âvolution de r√¥les
- Ajustement de permissions
- Maintenance

#### revokePrivilegesFromRole

**Description** : Retirer des privil√®ges d'un r√¥le.

**Op√©rations autoris√©es** :
- `db.revokePrivilegesFromRole()`

**Niveau** : Database

**Exemple** :

```javascript
{
  resource: { db: "production", collection: "" },
  actions: ["revokePrivilegesFromRole"]
}
```

**Cas d'usage** :
- R√©duction de privil√®ges
- Correction de sur-privil√®ges
- Conformit√©

## Actions de Cluster

#### serverStatus

**Description** : Obtenir le statut du serveur MongoDB.

**Op√©rations autoris√©es** :
- `db.serverStatus()`
- `db.adminCommand({ serverStatus: 1 })`

**Niveau** : Cluster

**Exemple** :

```javascript
{
  resource: { cluster: true },
  actions: ["serverStatus"]
}
```

**Cas d'usage** :
- Monitoring de sant√©
- M√©triques de performance
- Alerting

**Informations retourn√©es** :
- Connexions actives
- Op√©rations en cours
- M√©moire utilis√©e
- Statistiques r√©seau

#### replSetGetStatus

**Description** : Obtenir le statut du replica set.

**Op√©rations autoris√©es** :
- `rs.status()`
- `db.adminCommand({ replSetGetStatus: 1 })`

**Niveau** : Cluster

**Exemple** :

```javascript
{
  resource: { cluster: true },
  actions: ["replSetGetStatus"]
}
```

**Cas d'usage** :
- Monitoring de r√©plication
- D√©tection de lag
- Sant√© du cluster

#### replSetConfigure

**Description** : Configurer un replica set.

**Op√©rations autoris√©es** :
- `rs.initiate()`
- `rs.reconfig()`
- `db.adminCommand({ replSetReconfig: ... })`

**Niveau** : Cluster

**Exemple** :

```javascript
{
  resource: { cluster: true },
  actions: ["replSetConfigure"]
}
```

**Cas d'usage** :
- Initialisation de replica set
- Ajout/retrait de membres
- Changements de configuration

**‚ö†Ô∏è DANGER** : Mauvaise configuration peut rendre le cluster inaccessible.

#### replSetReconfig

**Description** : Reconfigurer un replica set existant.

**Op√©rations autoris√©es** :
- `rs.reconfig()`

**Niveau** : Cluster

**Exemple** :

```javascript
{
  resource: { cluster: true },
  actions: ["replSetReconfig"]
}
```

**Cas d'usage** :
- Modifications de topologie
- Ajustements de priorit√©s
- Changements de configuration

#### replSetStateChange

**Description** : Changer l'√©tat d'un membre du replica set.

**Op√©rations autoris√©es** :
- `rs.stepDown()`
- `rs.freeze()`
- `db.adminCommand({ replSetStepDown: ... })`

**Niveau** : Cluster

**Exemple** :

```javascript
{
  resource: { cluster: true },
  actions: ["replSetStateChange"]
}
```

**Cas d'usage** :
- Maintenance planifi√©e
- Failover contr√¥l√©
- Tests de r√©silience

#### shardingState

**Description** : Obtenir l'√©tat du sharding.

**Op√©rations autoris√©es** :
- `db.adminCommand({ shardingState: 1 })`

**Niveau** : Cluster

**Exemple** :

```javascript
{
  resource: { cluster: true },
  actions: ["shardingState"]
}
```

**Cas d'usage** :
- V√©rification de configuration
- Monitoring de sharding
- Diagnostic

#### addShard

**Description** : Ajouter un shard au cluster.

**Op√©rations autoris√©es** :
- `sh.addShard()`
- `db.adminCommand({ addShard: ... })`

**Niveau** : Cluster

**Exemple** :

```javascript
{
  resource: { cluster: true },
  actions: ["addShard"]
}
```

**Cas d'usage** :
- Expansion du cluster
- Scale horizontal
- Ajout de capacit√©

#### removeShard

**Description** : Retirer un shard du cluster.

**Op√©rations autoris√©es** :
- `db.adminCommand({ removeShard: ... })`

**Niveau** : Cluster

**Exemple** :

```javascript
{
  resource: { cluster: true },
  actions: ["removeShard"]
}
```

**Cas d'usage** :
- R√©duction de cluster
- D√©commissioning
- Rebalancing

**‚ö†Ô∏è ATTENTION** : Processus long, n√©cessite migration de donn√©es.

#### enableSharding

**Description** : Activer le sharding sur une base de donn√©es.

**Op√©rations autoris√©es** :
- `sh.enableSharding()`
- `db.adminCommand({ enableSharding: "database" })`

**Niveau** : Database

**Exemple** :

```javascript
{
  resource: { db: "production", collection: "" },
  actions: ["enableSharding"]
}
```

**Cas d'usage** :
- Pr√©paration pour scale horizontal
- Migration vers sharded cluster

#### shardCollection

**Description** : Sharder une collection.

**Op√©rations autoris√©es** :
- `sh.shardCollection()`
- `db.adminCommand({ shardCollection: "db.collection", key: ... })`

**Niveau** : Database

**Exemple** :

```javascript
{
  resource: { db: "production", collection: "" },
  actions: ["shardCollection"]
}
```

**Cas d'usage** :
- Distribution de donn√©es
- Am√©lioration de performances
- Scale horizontal

**‚ö†Ô∏è CRITIQUE** : Choix de shard key irr√©versible.

#### flushRouterConfig

**Description** : Forcer le rafra√Æchissement de la configuration sur les mongos.

**Op√©rations autoris√©es** :
- `db.adminCommand({ flushRouterConfig: 1 })`

**Niveau** : Cluster

**Exemple** :

```javascript
{
  resource: { cluster: true },
  actions: ["flushRouterConfig"]
}
```

**Cas d'usage** :
- Propagation de changements de config
- R√©solution de probl√®mes de routing

#### shutdown

**Description** : Arr√™ter le serveur MongoDB.

**Op√©rations autoris√©es** :
- `db.shutdownServer()`
- `db.adminCommand({ shutdown: 1 })`

**Niveau** : Cluster

**Exemple** :

```javascript
{
  resource: { cluster: true },
  actions: ["shutdown"]
}
```

**Cas d'usage** :
- Maintenance planifi√©e
- Red√©marrages

**‚ö†Ô∏è DANGER EXTR√äME** : Arr√™t complet du serveur. Ne jamais accorder sauf pour super-admins.

## Actions de Diagnostic et Monitoring

#### top

**Description** : Voir les statistiques d'utilisation par collection.

**Op√©rations autoris√©es** :
- `db.adminCommand({ top: 1 })`

**Niveau** : Cluster

**Exemple** :

```javascript
{
  resource: { cluster: true },
  actions: ["top"]
}
```

**Cas d'usage** :
- Identification de collections les plus utilis√©es
- Analyse de workload
- Optimisation

#### inprog

**Description** : Voir les op√©rations en cours.

**Op√©rations autoris√©es** :
- `db.currentOp()`
- `db.adminCommand({ currentOp: 1 })`

**Niveau** : Cluster

**Exemple** :

```javascript
{
  resource: { cluster: true },
  actions: ["inprog"]
}
```

**Cas d'usage** :
- Diagnostic de performances
- Identification de requ√™tes lentes
- Monitoring temps r√©el

#### killop

**Description** : Tuer des op√©rations en cours.

**Op√©rations autoris√©es** :
- `db.killOp()`

**Niveau** : Cluster

**Exemple** :

```javascript
{
  resource: { cluster: true },
  actions: ["killop"]
}
```

**Cas d'usage** :
- Arr√™t de requ√™tes probl√©matiques
- R√©solution de blocages
- Gestion d'urgence

**‚ö†Ô∏è Impact** : Peut affecter les applications en cours.

#### getLog

**Description** : Acc√©der aux logs du serveur.

**Op√©rations autoris√©es** :
- `db.adminCommand({ getLog: "global" })`
- `db.adminCommand({ getLog: "startupWarnings" })`

**Niveau** : Cluster

**Exemple** :

```javascript
{
  resource: { cluster: true },
  actions: ["getLog"]
}
```

**Cas d'usage** :
- Diagnostic de probl√®mes
- Analyse de logs
- Troubleshooting

#### getCmdLineOpts

**Description** : Voir les options de ligne de commande du serveur.

**Op√©rations autoris√©es** :
- `db.adminCommand({ getCmdLineOpts: 1 })`

**Niveau** : Cluster

**Exemple** :

```javascript
{
  resource: { cluster: true },
  actions: ["getCmdLineOpts"]
}
```

**Cas d'usage** :
- V√©rification de configuration
- Audit de d√©ploiement
- Documentation

#### hostInfo

**Description** : Obtenir des informations sur le syst√®me h√¥te.

**Op√©rations autoris√©es** :
- `db.hostInfo()`

**Niveau** : Cluster

**Exemple** :

```javascript
{
  resource: { cluster: true },
  actions: ["hostInfo"]
}
```

**Cas d'usage** :
- Inventaire du mat√©riel
- Capacity planning
- Documentation infrastructure

## Actions de Maintenance Syst√®me

#### setParameter

**Description** : Modifier des param√®tres runtime du serveur.

**Op√©rations autoris√©es** :
- `db.adminCommand({ setParameter: 1, ... })`

**Niveau** : Cluster

**Exemple** :

```javascript
{
  resource: { cluster: true },
  actions: ["setParameter"]
}
```

**Cas d'usage** :
- Tuning de performances
- Ajustements de configuration
- Tests

**‚ö†Ô∏è ATTENTION** : Modifications peuvent affecter stabilit√© et performances.

#### logRotate

**Description** : Rotation des fichiers de logs.

**Op√©rations autoris√©es** :
- `db.adminCommand({ logRotate: 1 })`

**Niveau** : Cluster

**Exemple** :

```javascript
{
  resource: { cluster: true },
  actions: ["logRotate"]
}
```

**Cas d'usage** :
- Gestion automatique de logs
- Scripts de maintenance
- Pr√©vention de saturation disque

#### connPoolSync

**Description** : Synchroniser les connection pools.

**Op√©rations autoris√©es** :
- `db.adminCommand({ connPoolSync: 1 })`

**Niveau** : Cluster

**Exemple** :

```javascript
{
  resource: { cluster: true },
  actions: ["connPoolSync"]
}
```

**Cas d'usage** :
- Maintenance de connexions
- R√©solution de probl√®mes r√©seau

#### invalidateUserCache

**Description** : Invalider le cache des utilisateurs.

**Op√©rations autoris√©es** :
- `db.adminCommand({ invalidateUserCache: 1 })`

**Niveau** : Cluster

**Exemple** :

```javascript
{
  resource: { cluster: true },
  actions: ["invalidateUserCache"]
}
```

**Cas d'usage** :
- Forcer rafra√Æchissement des permissions
- Apr√®s modification de r√¥les
- Debugging

#### cpuProfiler

**Description** : Contr√¥ler le CPU profiler.

**Op√©rations autoris√©es** :
- `db.adminCommand({ profile: ... })`

**Niveau** : Cluster

**Exemple** :

```javascript
{
  resource: { cluster: true },
  actions: ["cpuProfiler"]
}
```

**Cas d'usage** :
- Diagnostic de performances CPU
- Profiling avanc√©

## Combinaisons d'Actions Courantes

### Lecture Seule Compl√®te

```javascript
{
  resource: { db: "production", collection: "" },
  actions: [
    "find",
    "listCollections",
    "listIndexes",
    "collStats",
    "dbStats"
  ]
}
```

**Usage** : Analytics, reporting, monitoring en lecture seule.

### CRUD Complet

```javascript
{
  resource: { db: "production", collection: "orders" },
  actions: [
    "find",
    "insert",
    "update",
    "remove"
  ]
}
```

**Usage** : Application standard avec op√©rations CRUD.

### Administration Collection

```javascript
{
  resource: { db: "production", collection: "orders" },
  actions: [
    "createIndex",
    "dropIndex",
    "collMod",
    "collStats",
    "validate"
  ]
}
```

**Usage** : DBA g√©rant les index et la structure.

### Monitoring Complet

```javascript
{
  resource: { cluster: true },
  actions: [
    "serverStatus",
    "replSetGetStatus",
    "shardingState",
    "top",
    "inprog",
    "getLog",
    "hostInfo"
  ]
}
```

**Usage** : Outils de monitoring (Prometheus, Datadog).

### Gestion Utilisateurs

```javascript
{
  resource: { db: "admin", collection: "" },
  actions: [
    "createUser",
    "dropUser",
    "viewUser",
    "changePassword",
    "grantRole",
    "revokeRole"
  ]
}
```

**Usage** : Administrateur de s√©curit√©.

### Backup Complet

```javascript
{
  resource: { cluster: true },
  actions: [
    "find",              // Lecture de toutes les donn√©es
    "listDatabases",
    "listCollections",
    "listIndexes"
  ]
}
```

**Usage** : Service de backup (mongodump).

### Op√©rations DBA

```javascript
{
  resource: { db: "production", collection: "" },
  actions: [
    "find",
    "createIndex",
    "dropIndex",
    "createCollection",
    "dropCollection",
    "collStats",
    "dbStats",
    "enableProfiler"
  ]
}
```

**Usage** : DBA pour maintenance et optimisation.

## Actions Dangereuses et Pr√©cautions

### Actions √† Haut Risque

| Action | Risque | Pr√©cautions |
|--------|--------|-------------|
| `shutdown` | Arr√™t total du serveur | Uniquement super-admins, audit strict |
| `dropDatabase` | Suppression totale de donn√©es | Jamais en production, sauf cas exceptionnels |
| `dropCollection` | Perte de donn√©es | Audit obligatoire, backups r√©cents |
| `remove` | Suppression de documents | Audit des suppressions, soft deletes pr√©f√©r√©s |
| `bypassDocumentValidation` | Donn√©es non conformes | Ne jamais accorder sauf migrations |
| `replSetReconfig` | Cluster inaccessible | Tests en staging, backups de config |
| `setParameter` | Instabilit√© du serveur | Documentation des changements |
| `killop` | Interruption d'op√©rations | V√©rifier impact avant kill |

### Recommandations de S√©curit√©

#### 1. Ne Jamais Accorder

```javascript
// ‚ùå INTERDIT en production
actions: [
  "shutdown",                      // Arr√™t serveur
  "bypassDocumentValidation",      // Contournement validation
  "dropDatabase"                   // Suppression base
]
```

#### 2. Restreindre Strictement

```javascript
// ‚ö†Ô∏è  Uniquement pour super-admins
actions: [
  "dropCollection",
  "replSetReconfig",
  "setParameter",
  "removeShard"
]
```

#### 3. Auditer Syst√©matiquement

```javascript
// üìù Avec audit logging (Enterprise)
actions: [
  "remove",
  "dropIndex",
  "createUser",
  "grantRole",
  "killop"
]
```

## Mapping Actions ‚Üí Cas d'Usage M√©tier

### Application Web Standard

```javascript
{
  role: "webApplicationRole",
  privileges: [
    {
      resource: { db: "production", collection: "users" },
      actions: ["find", "insert", "update"]  // Pas de remove
    },
    {
      resource: { db: "production", collection: "sessions" },
      actions: ["find", "insert", "update", "remove"]  // TTL naturel
    },
    {
      resource: { db: "production", collection: "products" },
      actions: ["find"]  // Lecture seule
    }
  ],
  roles: []
}
```

### Service de Cache

```javascript
{
  role: "cacheServiceRole",
  privileges: [
    {
      resource: { db: "cache", collection: "entries" },
      actions: [
        "find",
        "insert",
        "update",
        "remove",        // Expiration de cache
        "createIndex"    // TTL index
      ]
    }
  ],
  roles: []
}
```

### Service de Logs

```javascript
{
  role: "loggingServiceRole",
  privileges: [
    {
      resource: { db: "logs", collection: "" },
      actions: [
        "insert",        // Append-only
        "find"           // Lecture pour recherche
        // Pas de update ou remove
      ]
    },
    {
      resource: { db: "logs", collection: "" },
      actions: [
        "convertToCapped"  // Pour rotation automatique
      ]
    }
  ],
  roles: []
}
```

### Analyste Business Intelligence

```javascript
{
  role: "biAnalystRole",
  privileges: [
    {
      resource: { db: "production", collection: "" },
      actions: [
        "find",
        "listCollections",
        "listIndexes",
        "collStats"
      ]
    },
    {
      resource: { db: "analytics", collection: "" },
      actions: [
        "find",
        "insert",
        "update",
        "remove",
        "createCollection",
        "createIndex"
      ]
    }
  ],
  roles: []
}
```

### Administrateur de Donn√©es

```javascript
{
  role: "dataAdministratorRole",
  privileges: [
    {
      resource: { db: "production", collection: "" },
      actions: [
        "find",
        "insert",
        "update",
        "remove",
        "createIndex",
        "dropIndex",
        "collStats",
        "validate"
      ]
    },
    {
      resource: { cluster: true },
      actions: [
        "serverStatus",
        "top",
        "inprog"
      ]
    }
  ],
  roles: []
}
```

## Actions Sp√©ciales et Internes

### Actions Internes (Ne pas utiliser)

Ces actions sont r√©serv√©es au syst√®me MongoDB :

- `internal` : Actions syst√®me internes
- `anyAction` : Toutes les actions (tr√®s dangereux)
- `useUUID` : Utilisation d'UUID pour collections
- `forceUUID` : Forcer UUID

**‚ö†Ô∏è INTERDICTION** : Ne jamais cr√©er de r√¥les avec ces actions.

### Actions de Changement de Streams

```javascript
{
  resource: { db: "production", collection: "orders" },
  actions: [
    "changeStream"  // Acc√®s aux change streams
  ]
}
```

**Usage** : Applications utilisant change streams pour r√©activit√©.

### Actions de Transactions

Les transactions multi-documents utilisent les actions standards (`find`, `insert`, `update`, `remove`). Aucune action sp√©ciale requise.

## Outils de Validation

### Script de V√©rification des Actions

```javascript
function validateRoleActions(roleName, database) {
  const role = db.getSiblingDB(database).getRole(roleName, {
    showPrivileges: true
  });

  if (!role) {
    print(`Role not found: ${roleName}@${database}`);
    return;
  }

  const dangerousActions = [
    "shutdown",
    "dropDatabase",
    "bypassDocumentValidation",
    "replSetReconfig",
    "removeShard"
  ];

  const warnings = [];

  role.privileges.forEach(priv => {
    priv.actions.forEach(action => {
      if (dangerousActions.includes(action)) {
        warnings.push({
          action: action,
          resource: priv.resource,
          severity: "HIGH"
        });
      }
    });
  });

  if (warnings.length > 0) {
    print(`‚ö†Ô∏è  Role ${roleName} has dangerous actions:`);
    warnings.forEach(w => {
      print(`   ${w.action} on ${JSON.stringify(w.resource)}`);
    });
  } else {
    print(`‚úÖ Role ${roleName} looks safe`);
  }

  return warnings;
}

// Usage
validateRoleActions("myRole", "production");
```

### Analyse de Permissions Effectives

```javascript
function analyzeEffectivePermissions(username, authDb) {
  const user = db.getSiblingDB(authDb).getUser(username, {
    showPrivileges: true
  });

  if (!user) {
    print(`User not found: ${username}@${authDb}`);
    return;
  }

  const actionSummary = {};

  // Compter les actions par type
  user.inheritedPrivileges.forEach(priv => {
    priv.actions.forEach(action => {
      if (!actionSummary[action]) {
        actionSummary[action] = {
          count: 0,
          resources: []
        };
      }
      actionSummary[action].count++;
      actionSummary[action].resources.push(priv.resource);
    });
  });

  print(`\n=== Permissions for ${username} ===`);
  print(`Total unique actions: ${Object.keys(actionSummary).length}`);

  // Trier par fr√©quence
  const sorted = Object.entries(actionSummary)
    .sort((a, b) => b[1].count - a[1].count);

  sorted.forEach(([action, info]) => {
    print(`\n${action} (${info.count} resources)`);
    info.resources.slice(0, 3).forEach(r => {
      print(`  - ${JSON.stringify(r)}`);
    });
    if (info.resources.length > 3) {
      print(`  ... and ${info.resources.length - 3} more`);
    }
  });

  return actionSummary;
}

// Usage
analyzeEffectivePermissions("myUser", "admin");
```

## Conclusion

La compr√©hension d√©taill√©e des actions MongoDB est essentielle pour cr√©er des r√¥les efficaces et s√©curis√©s.

**Principes cl√©s** :
- ‚úÖ Conna√Ætre toutes les actions disponibles et leurs implications
- ‚úÖ Utiliser les combinaisons d'actions appropri√©es pour chaque cas d'usage
- ‚úÖ √âviter les actions dangereuses (`shutdown`, `dropDatabase`, `bypassDocumentValidation`)
- ‚úÖ Auditer syst√©matiquement les actions √† haut risque
- ‚úÖ Tester les permissions avant d√©ploiement
- ‚úÖ Valider r√©guli√®rement les r√¥les en production

**Hi√©rarchie de risque** :
1. **Bas** : `find`, `listIndexes`, `collStats`, `dbStats`
2. **Moyen** : `insert`, `update`, `createIndex`
3. **√âlev√©** : `remove`, `dropIndex`, `dropCollection`
4. **Critique** : `dropDatabase`, `shutdown`, `replSetReconfig`
5. **Interdit** : `bypassDocumentValidation`, `anyAction`

**Recommandations finales** :
1. Commencer avec le minimum d'actions n√©cessaires
2. Ajouter progressivement selon les besoins r√©els
3. Documenter chaque action accord√©e et sa justification
4. R√©viser et auditer r√©guli√®rement
5. Utiliser des r√¥les s√©par√©s pour diff√©rentes responsabilit√©s
6. Ne jamais accorder d'actions dangereuses sauf absolue n√©cessit√©
7. Tester toutes les combinaisons d'actions avant production

Les actions MongoDB, combin√©es correctement dans des r√¥les personnalis√©s, permettent d'impl√©menter une s√©curit√© granulaire parfaitement adapt√©e √† votre architecture et vos besoins m√©tier.

---

**Fin du Chapitre 11.3 - Autorisation et R√¥les**

**Prochaines Sections du Chapitre 11 - S√©curit√©** :
- **11.4** : Chiffrement - TLS/SSL, chiffrement au repos, CSFLE
- **11.5** : Audit et conformit√© - Logs d'audit, tra√ßabilit√©
- **11.6** : S√©curit√© r√©seau - Firewalls, VPNs, IP whitelisting

‚è≠Ô∏è [Gestion des utilisateurs](/11-securite/04-gestion-utilisateurs.md)
