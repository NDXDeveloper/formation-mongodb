ğŸ” Retour au [Sommaire](/SOMMAIRE.md)

# 11.2.4 Kerberos

## Introduction

Kerberos est un protocole d'authentification rÃ©seau dÃ©veloppÃ© au MIT qui utilise la cryptographie Ã  clÃ© secrÃ¨te pour fournir une authentification forte sur des rÃ©seaux non sÃ©curisÃ©s. MongoDB Enterprise supporte l'authentification Kerberos (GSSAPI) pour une intÃ©gration transparente avec les environnements d'entreprise oÃ¹ Kerberos est dÃ©jÃ  dÃ©ployÃ©, particuliÃ¨rement dans les infrastructures Windows avec Active Directory ou les environnements Unix/Linux utilisant MIT Kerberos.

### PrÃ©requis

**âš ï¸ Important** : L'authentification Kerberos nÃ©cessite **MongoDB Enterprise Edition**. Cette fonctionnalitÃ© n'est pas disponible dans la version Community.

### Cas d'Usage

- **Environnements hautement sÃ©curisÃ©s** : Secteurs rÃ©glementÃ©s (finance, santÃ©, dÃ©fense)
- **Infrastructure Kerberos existante** : AD ou MIT Kerberos dÃ©jÃ  dÃ©ployÃ©
- **Single Sign-On (SSO) enterprise** : Authentification unique pour toutes les applications
- **Zero-trust networking** : Authentification mutuelle systÃ©matique
- **ConformitÃ©** : Standards de sÃ©curitÃ© stricts (NIST, FedRAMP)
- **Unix/Linux enterprise** : IntÃ©gration avec infrastructure Linux/Unix legacy

### Avantages de Kerberos

| Avantage | Description |
|----------|-------------|
| **Authentification mutuelle** | Client et serveur se prouvent mutuellement leur identitÃ© |
| **SSO enterprise** | Une seule authentification pour tous les services |
| **Tickets temporaires** | Credentials avec expiration automatique |
| **Pas de transmission de password** | Jamais de mot de passe sur le rÃ©seau |
| **RÃ©sistance replay attacks** | Protection contre les attaques par rejeu |
| **Chiffrement fort** | AES-256 par dÃ©faut (configurable) |
| **IntÃ©gration AD** | Utilise Active Directory comme KDC |
| **Audit centralisÃ©** | TraÃ§abilitÃ© via le KDC |

## Fondamentaux de Kerberos

### Architecture Kerberos

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    KEY DISTRIBUTION CENTER (KDC)                   â”‚
â”‚                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Authentication Server  â”‚    â”‚  Ticket Granting Server      â”‚   â”‚
â”‚  â”‚  (AS)                   â”‚    â”‚  (TGS)                       â”‚   â”‚
â”‚  â”‚                         â”‚    â”‚                              â”‚   â”‚
â”‚  â”‚  â€¢ Database principals  â”‚    â”‚  â€¢ DÃ©livre service tickets   â”‚   â”‚
â”‚  â”‚  â€¢ DÃ©livre TGT          â”‚    â”‚  â€¢ Valide TGT                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–²                    â”‚                    â–²            â”‚
         â”‚ 1. Auth Request    â”‚ 2. TGT             â”‚ 3. Service â”‚ 4. Service
         â”‚    (password)      â”‚    (encrypted)     â”‚    Ticket  â”‚    Ticket
         â”‚                    â–¼                    â”‚    Request â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   â”‚                    â”‚                              â”‚
â”‚      CLIENT       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚         MONGODB SERVER       â”‚
â”‚   (User/App)      â”‚  5. Service Ticket â”‚      (Service Principal)     â”‚
â”‚                   â”‚     + Authenticatorâ”‚                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                    â”‚
                                                    â”‚ 6. Access Granted
                                                    â–¼
                                           [Authenticated Session]
```

### Flux d'Authentification Kerberos DÃ©taillÃ©

#### Ã‰tape 1 : AS Request (Authentication Service Request)

```
CLIENT â†’ KDC (AS)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Request:
  - Principal: user@REALM.COM
  - Service: krbtgt/REALM.COM@REALM.COM
  - Timestamp encrypted with user's key
```

**Client** : Envoie son principal name et demande un TGT
**KDC (AS)** : VÃ©rifie l'identitÃ© (mot de passe ou keytab)

#### Ã‰tape 2 : AS Reply (TGT Delivery)

```
KDC (AS) â†’ CLIENT
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Response:
  - TGT (Ticket Granting Ticket) encrypted with TGS key
  - Session Key encrypted with user's key
  - TGT validity: 10 hours (configurable)
```

**TGT contient** :
- Principal du client
- Session key
- Timestamp d'Ã©mission
- DurÃ©e de validitÃ©
- ChiffrÃ© avec la clÃ© secrÃ¨te du TGS

#### Ã‰tape 3 : TGS Request (Service Ticket Request)

```
CLIENT â†’ KDC (TGS)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Request:
  - TGT (from step 2)
  - Service Principal: mongodb/mongodb01.company.com@REALM.COM
  - Authenticator (timestamp + client principal) encrypted with session key
```

**Client** : Demande un ticket pour accÃ©der au service MongoDB
**KDC (TGS)** : Valide le TGT et dÃ©livre un service ticket

#### Ã‰tape 4 : TGS Reply (Service Ticket Delivery)

```
KDC (TGS) â†’ CLIENT
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Response:
  - Service Ticket encrypted with service's key (MongoDB keytab)
  - New Session Key encrypted with TGT session key
  - Service Ticket validity: 5 minutes (renewable)
```

#### Ã‰tape 5 : AP Request (Application Request)

```
CLIENT â†’ MONGODB SERVER
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Request:
  - Service Ticket (from step 4)
  - Authenticator encrypted with service session key
```

**MongoDB Server** : DÃ©chiffre le service ticket avec son keytab, valide l'authenticator

#### Ã‰tape 6 : AP Reply (Application Reply - Optional)

```
MONGODB SERVER â†’ CLIENT
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Response:
  - Authenticator response (proves server identity)
```

**Authentification mutuelle** : Le serveur prouve Ã©galement son identitÃ© au client.

### Concepts ClÃ©s Kerberos

#### Realm

Le royaume Kerberos, Ã©quivalent Ã  un domaine AD.

```
Format: REALM.COM (TOUJOURS EN MAJUSCULES)
Exemple: COMPANY.COM
```

**Convention** : Le realm est gÃ©nÃ©ralement le nom de domaine DNS en majuscules.

#### Principal

IdentitÃ© unique dans le realm Kerberos.

**Format** : `primary/instance@REALM`

**Types de principals** :

```
# User Principal
john.doe@COMPANY.COM

# Service Principal (SPN)
mongodb/mongodb01.company.com@COMPANY.COM
mongodb/mongodb02.company.com@COMPANY.COM

# Host Principal
host/server01.company.com@COMPANY.COM
```

**Composants** :
- **Primary** : Nom du service ou utilisateur
- **Instance** : Hostname ou identifiant spÃ©cifique (optionnel)
- **Realm** : Royaume Kerberos

#### Keytab

Fichier contenant les clÃ©s cryptographiques pour un ou plusieurs principals.

**Usage** :
- Permet l'authentification sans interaction (pas de mot de passe)
- UtilisÃ© par les services (daemons)
- Ã‰quivalent d'un fichier de mot de passe chiffrÃ©

**SÃ©curitÃ©** :
- Permissions 400 (lecture seule par le owner)
- Contient des secrets cryptographiques
- Doit Ãªtre protÃ©gÃ© comme un mot de passe

#### Ticket

Credential temporaire dÃ©livrÃ© par le KDC.

**Types** :
- **TGT** (Ticket Granting Ticket) : Permet de demander des service tickets
- **Service Ticket** : Permet d'accÃ©der Ã  un service spÃ©cifique

**PropriÃ©tÃ©s** :
- DurÃ©e de vie limitÃ©e (configurable)
- Renouvelable (configurable)
- ChiffrÃ© (seul le destinataire peut le dÃ©chiffrer)

## Configuration MIT Kerberos

### Installation du KDC

#### Sur Red Hat/CentOS

```bash
# Installer les packages KDC
yum install -y krb5-server krb5-libs krb5-workstation

# Fichiers de configuration
# /etc/krb5.conf - Configuration client
# /var/kerberos/krb5kdc/kdc.conf - Configuration serveur KDC
# /var/kerberos/krb5kdc/kadm5.acl - ACL admin
```

#### Sur Ubuntu/Debian

```bash
# Installer les packages KDC
apt-get install -y krb5-kdc krb5-admin-server krb5-config

# Fichiers de configuration
# /etc/krb5.conf
# /etc/krb5kdc/kdc.conf
# /etc/krb5kdc/kadm5.acl
```

### Configuration du KDC

#### /etc/krb5.conf (Configuration Client)

```ini
# /etc/krb5.conf

[libdefaults]
    # Realm par dÃ©faut
    default_realm = COMPANY.COM

    # DNS pour dÃ©couverte des KDC
    dns_lookup_realm = false
    dns_lookup_kdc = false

    # DurÃ©e de vie des tickets
    ticket_lifetime = 24h
    renew_lifetime = 7d

    # Forward des tickets
    forwardable = true

    # Algorithmes de chiffrement (du plus fort au plus faible)
    default_tgs_enctypes = aes256-cts-hmac-sha1-96 aes128-cts-hmac-sha1-96
    default_tkt_enctypes = aes256-cts-hmac-sha1-96 aes128-cts-hmac-sha1-96
    permitted_enctypes = aes256-cts-hmac-sha1-96 aes128-cts-hmac-sha1-96

[realms]
    COMPANY.COM = {
        # KDC primaire
        kdc = kerberos01.company.com

        # KDC secondaire (failover)
        kdc = kerberos02.company.com

        # Serveur d'administration
        admin_server = kerberos01.company.com

        # Realm par dÃ©faut pour ce domaine
        default_domain = company.com
    }

[domain_realm]
    # Mapping domaine DNS â†’ Realm Kerberos
    .company.com = COMPANY.COM
    company.com = COMPANY.COM

    # Mapping pour sous-domaines
    .prod.company.com = COMPANY.COM
    .dev.company.com = COMPANY.COM

[logging]
    kdc = FILE:/var/log/krb5kdc.log
    admin_server = FILE:/var/log/kadmin.log
    default = FILE:/var/log/krb5lib.log
```

#### /var/kerberos/krb5kdc/kdc.conf (Configuration Serveur)

```ini
# /var/kerberos/krb5kdc/kdc.conf

[kdcdefaults]
    kdc_ports = 88
    kdc_tcp_ports = 88

[realms]
    COMPANY.COM = {
        # Database KDC
        database_name = /var/kerberos/krb5kdc/principal

        # ACL file
        acl_file = /var/kerberos/krb5kdc/kadm5.acl

        # Dictionnaire pour vÃ©rification des mots de passe
        dict_file = /usr/share/dict/words

        # ClÃ©s maÃ®tres
        key_stash_file = /var/kerberos/krb5kdc/.k5.COMPANY.COM

        # Algorithmes supportÃ©s
        supported_enctypes = aes256-cts-hmac-sha1-96:normal aes128-cts-hmac-sha1-96:normal

        # DurÃ©e de vie max des tickets
        max_life = 24h 0m 0s
        max_renewable_life = 7d 0h 0m 0s

        # Master key type
        master_key_type = aes256-cts-hmac-sha1-96
    }
```

#### /var/kerberos/krb5kdc/kadm5.acl (ACL Administrateur)

```
# Format: principal  permissions  [target_principal]
# Permissions: a (add), d (delete), m (modify), c (change password), i (inquire), l (list)

# Super admin (tous les droits)
admin/admin@COMPANY.COM    *

# DBA peut gÃ©rer les principals MongoDB
dba/admin@COMPANY.COM      * mongodb/*@COMPANY.COM

# User admin peut gÃ©rer les users
useradmin/admin@COMPANY.COM  acm *@COMPANY.COM
```

### Initialisation du Realm

```bash
# CrÃ©er la base de donnÃ©es KDC
kdb5_util create -s -r COMPANY.COM

# Prompt: Enter KDC database master key:
# Entrer un mot de passe trÃ¨s fort (stockÃ© dans .k5.COMPANY.COM)

# DÃ©marrer les services
systemctl start krb5kdc
systemctl start kadmin
systemctl enable krb5kdc
systemctl enable kadmin

# VÃ©rifier les services
systemctl status krb5kdc
systemctl status kadmin

# VÃ©rifier les ports
netstat -tlnp | grep :88   # KDC
netstat -tlnp | grep :749  # kadmin
```

### CrÃ©ation des Principals

#### Principal Administrateur

```bash
# Se connecter Ã  kadmin.local (accÃ¨s local au KDC)
kadmin.local

# CrÃ©er le principal admin
addprinc admin/admin@COMPANY.COM
# Enter password: [mot de passe fort]

# CrÃ©er un principal utilisateur standard
addprinc john.doe@COMPANY.COM

# Lister les principals
listprincs

# Quitter
quit
```

#### Principals MongoDB

```bash
kadmin.local

# CrÃ©er les service principals pour chaque instance MongoDB
# Format: mongodb/FQDN@REALM

# Pour un replica set de 3 membres
addprinc -randkey mongodb/mongodb01.company.com@COMPANY.COM
addprinc -randkey mongodb/mongodb02.company.com@COMPANY.COM
addprinc -randkey mongodb/mongodb03.company.com@COMPANY.COM

# Pour mongos (si cluster shardÃ©)
addprinc -randkey mongodb/mongos01.company.com@COMPANY.COM

# VÃ©rifier
listprincs mongodb/*
```

**Option `-randkey`** : GÃ©nÃ¨re une clÃ© alÃ©atoire (pas de mot de passe interactif).

#### GÃ©nÃ©ration des Keytabs

```bash
kadmin.local

# CrÃ©er un keytab pour mongodb01
ktadd -k /var/kerberos/krb5kdc/mongodb01.keytab mongodb/mongodb01.company.com@COMPANY.COM

# CrÃ©er un keytab pour mongodb02
ktadd -k /var/kerberos/krb5kdc/mongodb02.keytab mongodb/mongodb02.company.com@COMPANY.COM

# CrÃ©er un keytab pour mongodb03
ktadd -k /var/kerberos/krb5kdc/mongodb03.keytab mongodb/mongodb03.company.com@COMPANY.COM

quit

# VÃ©rifier le contenu d'un keytab
klist -ket /var/kerberos/krb5kdc/mongodb01.keytab

# RÃ©sultat attendu:
# Keytab name: FILE:/var/kerberos/krb5kdc/mongodb01.keytab
# KVNO Timestamp           Principal
# ---- ------------------- ------------------------------------------------------
#    2 12/08/2024 10:00:00 mongodb/mongodb01.company.com@COMPANY.COM (aes256-cts-hmac-sha1-96)
#    2 12/08/2024 10:00:00 mongodb/mongodb01.company.com@COMPANY.COM (aes128-cts-hmac-sha1-96)

# Copier les keytabs sur les serveurs MongoDB respectifs
scp /var/kerberos/krb5kdc/mongodb01.keytab mongodb01:/etc/mongodb/mongodb.keytab
scp /var/kerberos/krb5kdc/mongodb02.keytab mongodb02:/etc/mongodb/mongodb.keytab
scp /var/kerberos/krb5kdc/mongodb03.keytab mongodb03:/etc/mongodb/mongodb.keytab

# Sur chaque serveur MongoDB, sÃ©curiser le keytab
ssh mongodb01 "chmod 400 /etc/mongodb/mongodb.keytab && chown mongodb:mongodb /etc/mongodb/mongodb.keytab"
```

## Configuration Active Directory comme KDC

Active Directory peut servir de KDC Kerberos, simplifiant l'infrastructure.

### PrÃ©requis Active Directory

- Domaine AD configurÃ© (ex: COMPANY.COM)
- Serveur DNS configurÃ©
- Reverse DNS fonctionnel (important pour Kerberos)

### VÃ©rification DNS

```bash
# Sur le serveur MongoDB, vÃ©rifier la rÃ©solution DNS
nslookup mongodb01.company.com

# VÃ©rifier le reverse DNS (critique pour Kerberos)
nslookup <IP_ADDRESS>

# Doit retourner mongodb01.company.com

# VÃ©rifier les SRV records Kerberos
nslookup -type=SRV _kerberos._tcp.company.com
nslookup -type=SRV _kerberos._udp.company.com
nslookup -type=SRV _kerberos-master._tcp.company.com
```

### CrÃ©ation du Service Account dans AD

```powershell
# PowerShell sur le contrÃ´leur de domaine

# CrÃ©er un compte de service pour chaque instance MongoDB
New-ADUser -Name "mongodb01" `
  -UserPrincipalName "mongodb01@COMPANY.COM" `
  -SamAccountName "mongodb01" `
  -Path "OU=Service Accounts,DC=company,DC=com" `
  -AccountPassword (ConvertTo-SecureString "TempP@ssw0rd123!" -AsPlainText -Force) `
  -Enabled $true `
  -PasswordNeverExpires $true `
  -CannotChangePassword $true `
  -Description "MongoDB Kerberos Service Account - mongodb01"

# RÃ©pÃ©ter pour chaque instance
New-ADUser -Name "mongodb02" -UserPrincipalName "mongodb02@COMPANY.COM" ...
New-ADUser -Name "mongodb03" -UserPrincipalName "mongodb03@COMPANY.COM" ...
```

### Mapping Service Principal Names (SPN)

```powershell
# Associer le SPN au compte de service
# Format: servicename/hostname@REALM

# Pour mongodb01
setspn -A mongodb/mongodb01.company.com mongodb01
setspn -A mongodb/mongodb01.company.com@COMPANY.COM mongodb01
setspn -A mongodb/mongodb01 mongodb01

# VÃ©rifier
setspn -L mongodb01

# RÃ©sultat attendu:
# Registered ServicePrincipalNames for CN=mongodb01,OU=Service Accounts,DC=company,DC=com:
#   mongodb/mongodb01.company.com@COMPANY.COM
#   mongodb/mongodb01.company.com
#   mongodb/mongodb01

# RÃ©pÃ©ter pour mongodb02, mongodb03, etc.
```

### GÃ©nÃ©ration des Keytabs depuis AD

#### MÃ©thode 1 : ktpass (Windows)

```powershell
# Sur le contrÃ´leur de domaine Windows

# GÃ©nÃ©rer le keytab pour mongodb01
ktpass -princ mongodb/mongodb01.company.com@COMPANY.COM `
  -mapuser mongodb01@COMPANY.COM `
  -crypto AES256-SHA1 `
  -ptype KRB5_NT_PRINCIPAL `
  -pass "TempP@ssw0rd123!" `
  -out C:\temp\mongodb01.keytab

# Options:
#   -princ: Service Principal Name
#   -mapuser: Compte AD Ã  mapper
#   -crypto: Type de chiffrement
#   -ptype: Type de principal
#   -pass: Mot de passe du compte (sera changÃ©!)
#   -out: Fichier keytab de sortie

# âš ï¸ Important: ktpass change le mot de passe du compte AD!
```

#### MÃ©thode 2 : Samba (Linux)

```bash
# Sur un serveur Linux joint au domaine AD

# Avec Samba tools
net ads keytab create -U administrator
net ads keytab add mongodb/mongodb01.company.com -U administrator

# Exporter vers un fichier keytab
ktutil
ktutil: read_kt /etc/krb5.keytab
ktutil: list
ktutil: write_kt /tmp/mongodb01.keytab
ktutil: quit

# Copier sur le serveur MongoDB
scp /tmp/mongodb01.keytab mongodb01:/etc/mongodb/mongodb.keytab
```

### Configuration /etc/krb5.conf pour AD

```ini
# /etc/krb5.conf - Configuration pour Active Directory

[libdefaults]
    default_realm = COMPANY.COM
    dns_lookup_realm = true
    dns_lookup_kdc = true

    # Important pour AD
    default_tgs_enctypes = aes256-cts-hmac-sha1-96 aes128-cts-hmac-sha1-96 rc4-hmac
    default_tkt_enctypes = aes256-cts-hmac-sha1-96 aes128-cts-hmac-sha1-96 rc4-hmac
    permitted_enctypes = aes256-cts-hmac-sha1-96 aes128-cts-hmac-sha1-96 rc4-hmac

    forwardable = true
    ticket_lifetime = 24h
    renew_lifetime = 7d

    # DÃ©sactiver la vÃ©rification DNS inverse si problÃ©matique
    # rdns = false

[realms]
    COMPANY.COM = {
        kdc = dc01.company.com
        kdc = dc02.company.com
        admin_server = dc01.company.com
        default_domain = company.com
    }

[domain_realm]
    .company.com = COMPANY.COM
    company.com = COMPANY.COM

[logging]
    default = FILE:/var/log/krb5libs.log
    kdc = FILE:/var/log/krb5kdc.log
    admin_server = FILE:/var/log/kadmind.log
```

## Configuration MongoDB Enterprise avec Kerberos

### Configuration Standalone

```yaml
# /etc/mongod.conf

# Network
net:
  bindIp: 0.0.0.0
  port: 27017

# Security
security:
  authorization: enabled

# Kerberos configuration
setParameter:
  # Activer Kerberos
  authenticationMechanisms: GSSAPI

# Service principal name
# Doit correspondre exactement au principal dans le keytab
# Format: mongodb/FQDN@REALM
KERBEROS_SERVICE_NAME: mongodb/mongodb01.company.com@COMPANY.COM

# Keytab path
KRB5_KTNAME: /etc/mongodb/mongodb.keytab

# Krb5 config file (optionnel, /etc/krb5.conf par dÃ©faut)
# KRB5_CONFIG: /etc/krb5.conf

systemLog:
  destination: file
  path: /var/log/mongodb/mongod.log
  logAppend: true
  component:
    accessControl:
      verbosity: 2
```

**âš ï¸ Important** : Les variables d'environnement Kerberos doivent Ãªtre dÃ©finies avant le dÃ©marrage de mongod.

### Configuration Systemd

```ini
# /etc/systemd/system/mongod.service.d/kerberos.conf

[Service]
# Variables d'environnement Kerberos
Environment="KRB5_KTNAME=/etc/mongodb/mongodb.keytab"
Environment="KERBEROS_SERVICE_NAME=mongodb/mongodb01.company.com@COMPANY.COM"
Environment="KRB5_CONFIG=/etc/krb5.conf"

# S'assurer que le keytab est lisible
ExecStartPre=/bin/sh -c 'test -r /etc/mongodb/mongodb.keytab'
```

```bash
# Recharger systemd et redÃ©marrer
systemctl daemon-reload
systemctl restart mongod

# VÃ©rifier
systemctl status mongod
```

### Configuration Replica Set

```yaml
# /etc/mongod.conf

net:
  bindIp: 0.0.0.0
  port: 27017

security:
  authorization: enabled

  # Authentification interne du replica set
  # Kerberos ne peut pas Ãªtre utilisÃ© pour l'auth interne
  # Utiliser keyFile ou x.509
  keyFile: /etc/mongodb/keyfile

replication:
  replSetName: rs0

setParameter:
  authenticationMechanisms: GSSAPI,SCRAM-SHA-256

# Variables Kerberos (via systemd ou export)
# KRB5_KTNAME=/etc/mongodb/mongodb.keytab
# KERBEROS_SERVICE_NAME=mongodb/mongodb01.company.com@COMPANY.COM

systemLog:
  destination: file
  path: /var/log/mongodb/mongod.log
  logAppend: true
```

**Note** : Chaque membre du replica set doit avoir :
- Son propre keytab avec son FQDN
- Son propre service principal
- Le mÃªme keyfile pour l'authentification interne

### Script de DÃ©marrage avec Variables

```bash
#!/bin/bash
# /usr/local/bin/start-mongod-kerberos.sh

# Variables Kerberos
export KRB5_KTNAME=/etc/mongodb/mongodb.keytab
export KERBEROS_SERVICE_NAME="mongodb/$(hostname -f)@COMPANY.COM"
export KRB5_CONFIG=/etc/krb5.conf

# VÃ©rifier que le keytab existe et est lisible
if [ ! -r "$KRB5_KTNAME" ]; then
  echo "ERROR: Keytab not found or not readable: $KRB5_KTNAME"
  exit 1
fi

# VÃ©rifier le keytab
klist -ket "$KRB5_KTNAME" > /dev/null 2>&1
if [ $? -ne 0 ]; then
  echo "ERROR: Invalid keytab: $KRB5_KTNAME"
  exit 1
fi

# DÃ©marrer MongoDB
exec /usr/bin/mongod --config /etc/mongod.conf
```

## CrÃ©ation des Utilisateurs Kerberos

### Dans MongoDB

Les utilisateurs Kerberos sont crÃ©Ã©s dans la base `$external` avec leur principal Kerberos complet.

```javascript
// Se connecter en tant qu'admin local
mongosh --port 27017 -u admin -p --authenticationDatabase admin

// CrÃ©er un utilisateur Kerberos
db.getSiblingDB("$external").createUser({
  user: "john.doe@COMPANY.COM",
  roles: [
    { role: "readWrite", db: "production" },
    { role: "read", db: "analytics" }
  ]
})

// CrÃ©er un admin Kerberos
db.getSiblingDB("$external").createUser({
  user: "dba@COMPANY.COM",
  roles: [
    { role: "root", db: "admin" }
  ]
})

// VÃ©rifier
db.getSiblingDB("$external").getUsers()
```

**âš ï¸ Format** : Le username doit Ãªtre exactement le principal Kerberos (avec le realm).

### Mapping de Groupes (via LDAP Authorization)

Kerberos peut Ãªtre combinÃ© avec LDAP pour l'authorization :

```yaml
# /etc/mongod.conf

security:
  authorization: enabled

  # LDAP pour l'authorization
  ldap:
    servers: "ldap.company.com"
    bind:
      method: "simple"
      queryUser: "CN=mongodb-ldap,OU=Service Accounts,DC=company,DC=com"
      queryPassword: "<password>"
    userToDNMapping:
      '[
        {
          match: "(.+)@COMPANY\\.COM",
          ldapQuery: "DC=company,DC=com??sub?(userPrincipalName={0})"
        }
      ]'
    authz:
      queryTemplate: "{USER}?memberOf?base"

setParameter:
  # Kerberos pour authentication, LDAP pour authorization
  authenticationMechanisms: GSSAPI
```

Ceci permet :
- **Authentication** : Kerberos (forte, SSO)
- **Authorization** : LDAP (groupes AD)

## Connexion Client avec Kerberos

### Obtenir un TGT

Avant de se connecter Ã  MongoDB, l'utilisateur doit avoir un TGT valide.

```bash
# Se connecter avec un principal Kerberos
kinit john.doe@COMPANY.COM
# Password: [entrer le mot de passe]

# VÃ©rifier le TGT
klist

# RÃ©sultat:
# Ticket cache: FILE:/tmp/krb5cc_1000
# Default principal: john.doe@COMPANY.COM
#
# Valid starting       Expires              Service principal
# 12/08/24 10:00:00  12/08/24 20:00:00  krbtgt/COMPANY.COM@COMPANY.COM
#         renew until 12/15/24 10:00:00
```

### Connection String

```bash
# Format de base
mongodb://john.doe%40COMPANY.COM@mongodb01.company.com:27017/database?authMechanism=GSSAPI&authSource=$external

# Avec replica set
mongodb://john.doe%40COMPANY.COM@mongodb01.company.com:27017,mongodb02.company.com:27017,mongodb03.company.com:27017/database?replicaSet=rs0&authMechanism=GSSAPI&authSource=$external

# Note: @ doit Ãªtre encodÃ© en %40 dans l'URL
```

### mongosh avec Kerberos

```bash
# MÃ©thode 1: URI complÃ¨te
mongosh "mongodb://john.doe%40COMPANY.COM@mongodb01.company.com:27017/admin?authMechanism=GSSAPI&authSource=\$external"

# MÃ©thode 2: ParamÃ¨tres sÃ©parÃ©s
mongosh --host mongodb01.company.com \
  --authenticationDatabase '$external' \
  --authenticationMechanism GSSAPI \
  --username john.doe@COMPANY.COM

# Sans username (utilise le principal du TGT)
mongosh --host mongodb01.company.com \
  --authenticationDatabase '$external' \
  --authenticationMechanism GSSAPI
```

### Node.js

```javascript
const { MongoClient } = require('mongodb');
const { execSync } = require('child_process');

// S'assurer d'avoir un TGT valide
try {
  execSync('klist -s');
} catch (err) {
  console.error('No valid Kerberos ticket. Run: kinit user@REALM.COM');
  process.exit(1);
}

// Connection URI
const principal = 'john.doe@COMPANY.COM';
const uri = `mongodb://${encodeURIComponent(principal)}@mongodb01.company.com:27017,mongodb02.company.com:27017,mongodb03.company.com:27017/production?replicaSet=rs0`;

// Options
const options = {
  authMechanism: 'GSSAPI',
  authSource: '$external',

  // Options Kerberos supplÃ©mentaires
  authMechanismProperties: {
    SERVICE_NAME: 'mongodb',  // Nom du service (dÃ©faut: mongodb)
    SERVICE_REALM: 'COMPANY.COM'  // Realm du service (optionnel)
  }
};

// Connexion
const client = new MongoClient(uri, options);

async function connect() {
  try {
    await client.connect();
    console.log('âœ… Connected with Kerberos authentication');

    const db = client.db('production');
    // OpÃ©rations...

  } catch (err) {
    console.error('âŒ Kerberos authentication failed:', err);
  } finally {
    await client.close();
  }
}

connect();
```

### Python (PyMongo)

```python
from pymongo import MongoClient
from pymongo.auth_mechanism_properties import SERVICE_NAME, SERVICE_REALM
import subprocess

# VÃ©rifier TGT valide
try:
    subprocess.run(['klist', '-s'], check=True)
except subprocess.CalledProcessError:
    print('No valid Kerberos ticket. Run: kinit user@REALM.COM')
    exit(1)

# Connection
principal = 'john.doe@COMPANY.COM'

client = MongoClient(
    ['mongodb01.company.com:27017',
     'mongodb02.company.com:27017',
     'mongodb03.company.com:27017'],
    replicaSet='rs0',
    authSource='$external',
    authMechanism='GSSAPI',
    username=principal,

    # Options Kerberos
    authMechanismProperties={
        SERVICE_NAME: 'mongodb',
        SERVICE_REALM: 'COMPANY.COM'
    }
)

# Test
try:
    client.admin.command('ping')
    print('âœ… Connected with Kerberos authentication')
except Exception as e:
    print(f'âŒ Kerberos authentication failed: {e}')
```

### Java

```java
import com.mongodb.MongoClientSettings;
import com.mongodb.MongoCredential;
import com.mongodb.ServerAddress;
import com.mongodb.client.MongoClient;
import com.mongodb.client.MongoClients;

import javax.security.auth.login.LoginContext;
import java.util.Arrays;
import java.util.HashMap;
import java.util.Map;

// Configuration JAAS (Java Authentication and Authorization Service)
// Fichier jaas.conf:
/*
MongoDBClient {
  com.sun.security.auth.module.Krb5LoginModule required
  useTicketCache=true
  renewTGT=true
  doNotPrompt=true;
};
*/

// Dans le code Java
System.setProperty("java.security.auth.login.config", "/path/to/jaas.conf");
System.setProperty("javax.security.auth.useSubjectCredsOnly", "false");

// Kerberos credential
Map<String, Object> mechanismProperties = new HashMap<>();
mechanismProperties.put("SERVICE_NAME", "mongodb");
mechanismProperties.put("SERVICE_REALM", "COMPANY.COM");

MongoCredential credential = MongoCredential.createGSSAPICredential("john.doe@COMPANY.COM")
    .withMechanismProperty("SERVICE_NAME", "mongodb")
    .withMechanismProperty("SERVICE_REALM", "COMPANY.COM");

// Configuration
MongoClientSettings settings = MongoClientSettings.builder()
    .credential(credential)
    .applyToClusterSettings(builder ->
        builder.hosts(Arrays.asList(
            new ServerAddress("mongodb01.company.com", 27017),
            new ServerAddress("mongodb02.company.com", 27017),
            new ServerAddress("mongodb03.company.com", 27017)
        ))
        .requiredReplicaSetName("rs0"))
    .build();

// Connexion
MongoClient mongoClient = MongoClients.create(settings);

// Test
try {
    mongoClient.getDatabase("admin").runCommand(new Document("ping", 1));
    System.out.println("âœ… Connected with Kerberos authentication");
} catch (Exception e) {
    System.err.println("âŒ Kerberos authentication failed: " + e.getMessage());
}
```

### Go

```go
package main

import (
    "context"
    "fmt"
    "log"
    "time"

    "go.mongodb.org/mongo-driver/mongo"
    "go.mongodb.org/mongo-driver/mongo/options"
)

func main() {
    // VÃ©rifier TGT (optionnel)
    // exec.Command("klist", "-s").Run()

    // Credential Kerberos
    credential := options.Credential{
        AuthMechanism: "GSSAPI",
        AuthSource:    "$external",
        Username:      "john.doe@COMPANY.COM",

        // PropriÃ©tÃ©s mÃ©canisme
        AuthMechanismProperties: map[string]string{
            "SERVICE_NAME":  "mongodb",
            "SERVICE_REALM": "COMPANY.COM",
        },
    }

    // Options client
    clientOpts := options.Client().
        ApplyURI("mongodb://mongodb01.company.com:27017,mongodb02.company.com:27017,mongodb03.company.com:27017/?replicaSet=rs0").
        SetAuth(credential)

    // Connexion
    ctx, cancel := context.WithTimeout(context.Background(), 10*time.Second)
    defer cancel()

    client, err := mongo.Connect(ctx, clientOpts)
    if err != nil {
        log.Fatal("Connection error:", err)
    }
    defer client.Disconnect(ctx)

    // Test
    err = client.Ping(ctx, nil)
    if err != nil {
        log.Fatal("âŒ Kerberos authentication failed:", err)
    }

    fmt.Println("âœ… Connected with Kerberos authentication")
}
```

## Haute DisponibilitÃ© et Failover

### Multiple KDC Servers

```ini
# /etc/krb5.conf

[realms]
    COMPANY.COM = {
        # KDC primaire
        kdc = kerberos01.company.com

        # KDC secondaires (failover automatique)
        kdc = kerberos02.company.com
        kdc = kerberos03.company.com

        # Admin server avec failover
        admin_server = kerberos01.company.com
        admin_server = kerberos02.company.com
    }
```

**Comportement** :
1. Client essaie kerberos01
2. Si timeout/erreur â†’ essaie kerberos02
3. Si timeout/erreur â†’ essaie kerberos03

### RÃ©plication MIT Kerberos

#### Configuration Master KDC

```ini
# /var/kerberos/krb5kdc/kdc.conf - Master

[realms]
    COMPANY.COM = {
        database_name = /var/kerberos/krb5kdc/principal
        key_stash_file = /var/kerberos/krb5kdc/.k5.COMPANY.COM
        acl_file = /var/kerberos/krb5kdc/kadm5.acl

        # Activer propagation
        iprop_enable = true
        iprop_master_ulogsize = 1000
        iprop_port = 2121

        supported_enctypes = aes256-cts-hmac-sha1-96:normal
    }
```

```bash
# DÃ©marrer le service de propagation
systemctl start kpropd
systemctl enable kpropd
```

#### Configuration Slave KDC

```ini
# /var/kerberos/krb5kdc/kdc.conf - Slave

[realms]
    COMPANY.COM = {
        database_name = /var/kerberos/krb5kdc/principal
        key_stash_file = /var/kerberos/krb5kdc/.k5.COMPANY.COM

        # Configuration slave
        iprop_enable = true
        iprop_slave_poll = 2m
        iprop_master = kerberos01.company.com:2121

        supported_enctypes = aes256-cts-hmac-sha1-96:normal
    }
```

```bash
# Synchronisation initiale depuis le master
kdb5_util dump /var/kerberos/krb5kdc/slave_datatrans

# Copier depuis master vers slave
scp kerberos01:/var/kerberos/krb5kdc/slave_datatrans /var/kerberos/krb5kdc/

# Charger la base
kdb5_util load /var/kerberos/krb5kdc/slave_datatrans

# DÃ©marrer les services
systemctl start krb5kdc
systemctl start kpropd
systemctl enable krb5kdc
systemctl enable kpropd
```

### Renouvellement Automatique des Tickets

```bash
#!/bin/bash
# /usr/local/bin/renew-kerberos-ticket.sh

# Pour les services qui tournent longtemps
# Renouveler le TGT avant expiration

# VÃ©rifier le ticket actuel
klist -s

if [ $? -ne 0 ]; then
  # Pas de ticket, obtenir un nouveau TGT depuis keytab
  kinit -kt /etc/mongodb/service.keytab mongodb-service@COMPANY.COM
else
  # Renouveler le ticket existant
  kinit -R
fi

# Ajouter Ã  cron (toutes les 4 heures)
# 0 */4 * * * /usr/local/bin/renew-kerberos-ticket.sh
```

## Troubleshooting Kerberos

### ProblÃ¨mes Courants

#### 1. "GSSAPI authentication failed"

**Diagnostic** :

```bash
# VÃ©rifier le TGT
klist

# Si pas de TGT:
kinit john.doe@COMPANY.COM

# VÃ©rifier le service principal
klist -ket /etc/mongodb/mongodb.keytab

# Tester l'obtention d'un service ticket
kvno mongodb/mongodb01.company.com@COMPANY.COM

# Ceci devrait crÃ©er un service ticket visible avec klist
klist | grep mongodb
```

**Causes courantes** :
- Pas de TGT valide
- Service principal incorrect dans le keytab
- Keytab non lisible par mongod
- Horloge dÃ©synchronisÃ©e (clock skew)

#### 2. "Clock skew too great"

Kerberos est trÃ¨s sensible Ã  la synchronisation horaire (tolÃ©rance: 5 minutes par dÃ©faut).

```bash
# VÃ©rifier l'horloge
date

# VÃ©rifier NTP
systemctl status chronyd  # ou ntpd

# Synchroniser immÃ©diatement
chronyc makestep

# Configuration NTP
cat /etc/chrony.conf

# Ajouter les serveurs NTP
server ntp1.company.com iburst
server ntp2.company.com iburst
```

**Solution** : Synchroniser tous les serveurs (KDC, MongoDB, clients) avec NTP.

#### 3. "Server not found in Kerberos database"

```bash
# Le service principal n'existe pas dans le KDC

# VÃ©rifier sur le KDC
kadmin.local
listprincs mongodb/*

# Si manquant, crÃ©er:
addprinc -randkey mongodb/mongodb01.company.com@COMPANY.COM

# RÃ©gÃ©nÃ©rer le keytab
ktadd -k /tmp/mongodb01.keytab mongodb/mongodb01.company.com@COMPANY.COM
```

#### 4. "Hostname mismatch"

```bash
# Le hostname dans la connexion ne correspond pas au principal

# MongoDB est accessible via mongodb01.company.com
# Mais le principal est mongodb/server01.company.com

# VÃ©rifier le FQDN
hostname -f

# VÃ©rifier les principals dans le keytab
klist -ket /etc/mongodb/mongodb.keytab

# Le hostname utilisÃ© pour la connexion doit correspondre
# au hostname dans le service principal
```

**Solution** : Utiliser le FQDN exact du service principal.

#### 5. "Permission denied" sur le keytab

```bash
# VÃ©rifier les permissions
ls -l /etc/mongodb/mongodb.keytab
# Doit Ãªtre 400 et owned by mongodb

# Corriger
chmod 400 /etc/mongodb/mongodb.keytab
chown mongodb:mongodb /etc/mongodb/mongodb.keytab
```

### Debugging avec Variables d'Environnement

```bash
# Activer le debug Kerberos
export KRB5_TRACE=/dev/stdout

# Tester kinit avec trace
kinit john.doe@COMPANY.COM

# Affichera tous les dÃ©tails du processus d'authentification

# Pour mongod
export KRB5_TRACE=/var/log/mongodb/krb5-trace.log
systemctl restart mongod
```

### VÃ©rification de la Configuration

```bash
#!/bin/bash
# check-kerberos.sh

echo "=== Kerberos Configuration Check ==="

# 1. VÃ©rifier krb5.conf
echo -e "\n1. krb5.conf Configuration:"
grep -A 10 "COMPANY.COM" /etc/krb5.conf

# 2. VÃ©rifier le keytab
echo -e "\n2. Keytab Check:"
klist -ket /etc/mongodb/mongodb.keytab

# 3. VÃ©rifier les permissions
echo -e "\n3. Keytab Permissions:"
ls -l /etc/mongodb/mongodb.keytab

# 4. VÃ©rifier la rÃ©solution DNS
echo -e "\n4. DNS Resolution:"
HOSTNAME=$(hostname -f)
echo "  Hostname: $HOSTNAME"
nslookup "$HOSTNAME"
nslookup $(hostname -i) | grep "name ="

# 5. VÃ©rifier la synchronisation horaire
echo -e "\n5. Time Synchronization:"
echo "  Local time: $(date)"
echo "  NTP status:"
chronyc tracking | grep "System time"

# 6. Tester la connectivitÃ© KDC
echo -e "\n6. KDC Connectivity:"
nc -zv kerberos01.company.com 88

# 7. Obtenir un TGT de test (avec keytab)
echo -e "\n7. Test TGT Acquisition:"
kinit -kt /etc/mongodb/mongodb.keytab mongodb/$(hostname -f)@COMPANY.COM
klist

echo -e "\n=== Check Complete ==="
```

### Logs MongoDB

```javascript
// Activer le logging dÃ©taillÃ© pour Kerberos
db.setLogLevel(2, "accessControl")

// Via mongod.conf
systemLog:
  component:
    accessControl:
      verbosity: 2
    network:
      verbosity: 2

// Logs apparaÃ®tront dans mongod.log avec dÃ©tails GSSAPI
```

## Automatisation

### Ansible Playbook

```yaml
# playbooks/configure-mongodb-kerberos.yml
---
- name: Configure MongoDB with Kerberos authentication
  hosts: mongodb_servers
  become: yes

  vars:
    kerberos_realm: COMPANY.COM
    kdc_server: kerberos01.company.com
    mongodb_keytab_path: /etc/mongodb/mongodb.keytab

  tasks:
    - name: Install Kerberos client packages
      yum:
        name:
          - krb5-workstation
          - krb5-libs
        state: present
      when: ansible_os_family == "RedHat"

    - name: Configure krb5.conf
      template:
        src: templates/krb5.conf.j2
        dest: /etc/krb5.conf
        owner: root
        group: root
        mode: '0644'

    - name: Copy MongoDB keytab
      copy:
        src: "files/keytabs/{{ inventory_hostname }}.keytab"
        dest: "{{ mongodb_keytab_path }}"
        owner: mongodb
        group: mongodb
        mode: '0400'

    - name: Configure mongod systemd override
      template:
        src: templates/mongod-kerberos.conf.j2
        dest: /etc/systemd/system/mongod.service.d/kerberos.conf
        owner: root
        group: root
        mode: '0644'
      notify: restart mongod

    - name: Reload systemd
      systemd:
        daemon_reload: yes

    - name: Ensure MongoDB is started
      systemd:
        name: mongod
        state: started
        enabled: yes

  handlers:
    - name: restart mongod
      systemd:
        name: mongod
        state: restarted
```

**Templates** :

```jinja2
{# templates/mongod-kerberos.conf.j2 #}
[Service]
Environment="KRB5_KTNAME={{ mongodb_keytab_path }}"
Environment="KERBEROS_SERVICE_NAME=mongodb/{{ ansible_fqdn }}@{{ kerberos_realm }}"
Environment="KRB5_CONFIG=/etc/krb5.conf"
```

## Bonnes Pratiques de Production

### Checklist Kerberos

- [ ] **Infrastructure Kerberos**
  - [ ] KDC primaire et secondaire configurÃ©s
  - [ ] RÃ©plication KDC fonctionnelle
  - [ ] NTP synchronisÃ© partout (tolÃ©rance 5min)
  - [ ] DNS et reverse DNS configurÃ©s

- [ ] **Principals et Keytabs**
  - [ ] Un principal par instance MongoDB
  - [ ] Keytabs gÃ©nÃ©rÃ©s avec AES-256
  - [ ] Keytabs sÃ©curisÃ©s (400 permissions)
  - [ ] Keytabs sauvegardÃ©s de maniÃ¨re sÃ©curisÃ©e

- [ ] **Configuration MongoDB**
  - [ ] Variables d'environnement correctes
  - [ ] Service name correspond au principal
  - [ ] Logging activÃ© pour debug
  - [ ] Authentification interne (keyFile/x.509) pour replica sets

- [ ] **SÃ©curitÃ©**
  - [ ] Pas de keytabs dans Git/repos
  - [ ] Rotation des keytabs planifiÃ©e
  - [ ] Monitoring des expirations
  - [ ] Audit activÃ© (Enterprise)

- [ ] **Haute DisponibilitÃ©**
  - [ ] Multiples KDC configurÃ©s
  - [ ] Renouvellement automatique des tickets
  - [ ] Monitoring santÃ© KDC
  - [ ] ProcÃ©dure de failover testÃ©e

- [ ] **Documentation**
  - [ ] Mapping principals â†’ serveurs
  - [ ] ProcÃ©dures troubleshooting
  - [ ] Contacts Kerberos admin
  - [ ] Diagrammes d'architecture

### Configuration RecommandÃ©e (Production)

```yaml
# /etc/mongod.conf - Production Kerberos

net:
  bindIp: 0.0.0.0
  port: 27017

security:
  authorization: enabled
  keyFile: /etc/mongodb/keyfile  # Pour auth interne

replication:
  replSetName: rs0

setParameter:
  # Kerberos + fallback SCRAM pour admin local
  authenticationMechanisms: GSSAPI,SCRAM-SHA-256

systemLog:
  destination: file
  path: /var/log/mongodb/mongod.log
  logAppend: true
  logRotate: reopen
  component:
    accessControl:
      verbosity: 1

storage:
  dbPath: /var/lib/mongodb
  journal:
    enabled: true
```

```ini
# /etc/systemd/system/mongod.service.d/kerberos.conf

[Service]
Environment="KRB5_KTNAME=/etc/mongodb/mongodb.keytab"
Environment="KERBEROS_SERVICE_NAME=mongodb/mongodb01.company.com@COMPANY.COM"
Environment="KRB5_CONFIG=/etc/krb5.conf"

# Debug (dÃ©sactiver en production normale)
# Environment="KRB5_TRACE=/var/log/mongodb/krb5-trace.log"

ExecStartPre=/bin/sh -c 'test -r /etc/mongodb/mongodb.keytab'
ExecStartPre=/bin/sh -c 'klist -ket /etc/mongodb/mongodb.keytab > /dev/null'
```

### Monitoring

```python
#!/usr/bin/env python3
# monitor-kerberos-auth.py

from pymongo import MongoClient
import subprocess
import time
import json

def check_kerberos_ticket():
    """VÃ©rifier la validitÃ© du TGT"""
    try:
        result = subprocess.run(
            ['klist', '-s'],
            capture_output=True,
            text=True
        )
        return result.returncode == 0
    except Exception as e:
        return False

def check_mongodb_kerberos(uri):
    """Tester l'authentification Kerberos vers MongoDB"""
    try:
        client = MongoClient(
            uri,
            authMechanism='GSSAPI',
            authSource='$external',
            serverSelectionTimeoutMS=5000
        )
        client.admin.command('ping')
        return {'status': 'ok', 'message': 'Authentication successful'}
    except Exception as e:
        return {'status': 'error', 'message': str(e)}

def main():
    mongodb_hosts = [
        'mongodb01.company.com',
        'mongodb02.company.com',
        'mongodb03.company.com'
    ]

    while True:
        print(f"\n=== Kerberos Health Check - {time.ctime()} ===")

        # VÃ©rifier TGT
        has_ticket = check_kerberos_ticket()
        print(f"TGT Status: {'âœ… Valid' if has_ticket else 'âŒ Invalid/Expired'}")

        if not has_ticket:
            print("âš ï¸ No valid TGT - run 'kinit' to obtain ticket")

        # Tester chaque instance MongoDB
        for host in mongodb_hosts:
            uri = f"mongodb://{host}:27017"
            result = check_mongodb_kerberos(uri)

            status_icon = 'âœ…' if result['status'] == 'ok' else 'âŒ'
            print(f"{status_icon} {host}: {result['message']}")

        time.sleep(300)  # VÃ©rifier toutes les 5 minutes

if __name__ == '__main__':
    main()
```

## Conclusion

Kerberos offre le plus haut niveau de sÃ©curitÃ© pour l'authentification MongoDB dans les environnements enterprise.

**Avantages** :
- âœ… Authentification mutuelle forte
- âœ… Single Sign-On (SSO) enterprise
- âœ… Pas de transmission de mots de passe
- âœ… Tickets avec expiration automatique
- âœ… RÃ©sistance aux attaques replay
- âœ… IntÃ©gration Active Directory native
- âœ… Audit centralisÃ© via KDC
- âœ… Standards de sÃ©curitÃ© stricts

**DÃ©fis** :
- âŒ NÃ©cessite MongoDB Enterprise
- âŒ ComplexitÃ© opÃ©rationnelle trÃ¨s Ã©levÃ©e
- âŒ Infrastructure Kerberos requise
- âŒ SensibilitÃ© Ã  la synchronisation horaire
- âŒ DNS et reverse DNS critiques
- âŒ Debugging complexe
- âŒ Courbe d'apprentissage importante

**Recommandations finales** :
1. Utiliser Kerberos pour **environnements hautement sÃ©curisÃ©s**
2. Infrastructure Kerberos/AD **dÃ©jÃ  en place** et mature
3. Configurer **haute disponibilitÃ©** (multiples KDC)
4. Synchroniser **NTP** rigoureusement
5. Tester **failover** KDC rÃ©guliÃ¨rement
6. Monitorer **expiration** tickets et keytabs
7. Former les **Ã©quipes** sur Kerberos
8. Documenter **tous** les principals
9. Automatiser le **renouvellement** des tickets
10. Maintenir un **admin local** SCRAM en fallback

Kerberos est idÃ©al pour les grandes organisations avec des exigences de sÃ©curitÃ© strictes, une infrastructure Kerberos mature, et les ressources pour gÃ©rer la complexitÃ© opÃ©rationnelle.

---

**Section Suivante** :
- **11.3** : Autorisation et RBAC - Gestion des rÃ´les et permissions

â­ï¸ [Autorisation et rÃ´les](/11-securite/03-autorisation-roles.md)
