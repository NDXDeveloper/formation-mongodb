üîù Retour au [Sommaire](/SOMMAIRE.md)

# 9.3.4 Hidden

## Introduction

Les **Hidden members** (membres cach√©s) sont des Secondaries sp√©cialis√©s d'un Replica Set MongoDB qui r√©pliquent les donn√©es du Primary tout en restant invisibles aux applications clientes. Cette invisibilit√© permet d'isoler certaines charges de travail intensives (reporting, analytics, backups) sans impacter les performances des membres servant les requ√™tes de production.

Les Hidden members repr√©sentent une solution architecturale √©l√©gante pour s√©parer les pr√©occupations op√©rationnelles : les op√©rations transactionnelles (OLTP) restent sur les membres visibles, tandis que les op√©rations analytiques (OLAP), les backups et autres t√¢ches de maintenance sont d√©l√©gu√©es √† des membres d√©di√©s et isol√©s.

Cette section explore en profondeur le fonctionnement des Hidden members, leurs cas d'usage, leurs configurations optimales, et les strat√©gies pour les exploiter efficacement en production.

## D√©finition et Caract√©ristiques

### Propri√©t√©s Fondamentales

Un Hidden member poss√®de les caract√©ristiques suivantes :

**Ce qu'un Hidden Member FAIT** :
- R√©plique toutes les donn√©es depuis le Primary (ou une autre source via chaining)
- Maintient une copie compl√®te du dataset
- Peut voter dans les √©lections (si `votes: 1`)
- Participe au calcul du commit point pour `readConcern: "majority"`
- Peut √™tre acc√©d√© directement par connexion explicite √† son hostname/IP

**Ce qu'un Hidden Member NE FAIT PAS** :
- N'appara√Æt pas dans les r√©sultats de `isMaster` ou `hello`
- Ne re√ßoit jamais de requ√™tes via Read Preference (m√™me `secondary`)
- Ne peut jamais devenir Primary (`priority: 0` obligatoire)
- N'est pas d√©couvert automatiquement par les drivers clients

### Configuration Requise

Pour qu'un membre soit Hidden, il doit respecter les contraintes suivantes :

**Propri√©t√©s obligatoires** :
```javascript
{
  priority: 0,    // OBLIGATOIRE : Ne peut pas devenir Primary
  hidden: true    // Marqueur d'invisibilit√©
}
```

**Propri√©t√©s optionnelles** :
```javascript
{
  votes: 1,       // Peut voter (par d√©faut) ou votes: 0
  tags: { ... },  // Tags pour identification logique
  slaveDelay: 0   // Par d√©faut, mais peut √™tre combin√© avec hidden
}
```

**Contrainte stricte** : `hidden: true` ‚áí `priority: 0`

Si vous tentez de configurer `hidden: true` avec `priority > 0`, MongoDB rejette la configuration :
```javascript
Error: BadValue: priority must be 0 when hidden=true
```

### Invisibilit√© Technique

L'invisibilit√© d'un Hidden member est impl√©ment√©e au niveau du protocole de d√©couverte de MongoDB :

#### Commande isMaster / hello

Les drivers MongoDB utilisent `isMaster` (deprecated) ou `hello` pour d√©couvrir la topologie du Replica Set :

**Sans Hidden member** :
```javascript
db.runCommand({ isMaster: 1 })

{
  "hosts": [
    "mongo1.example.com:27017",  // Primary
    "mongo2.example.com:27017",  // Secondary
    "mongo3.example.com:27017"   // Secondary
  ],
  "primary": "mongo1.example.com:27017",
  "me": "mongo1.example.com:27017",
  "setName": "myReplicaSet"
}
```

**Avec Hidden member** :
```javascript
// mongo4 est configur√© comme Hidden
db.runCommand({ isMaster: 1 })

{
  "hosts": [
    "mongo1.example.com:27017",  // Primary
    "mongo2.example.com:27017",  // Secondary
    "mongo3.example.com:27017"   // Secondary
    // mongo4 n'appara√Æt PAS
  ],
  "primary": "mongo1.example.com:27017",
  "me": "mongo1.example.com:27017",
  "setName": "myReplicaSet"
}
```

**Implication** : Les drivers ne savent pas que mongo4 existe et ne lui enverront jamais de requ√™tes.

#### Connexion Directe

Malgr√© l'invisibilit√©, on peut se connecter directement :

**Connexion via Replica Set (invisible)** :
```javascript
// mongo4 est ignor√© par le driver
const client = new MongoClient(
  "mongodb://mongo1,mongo2,mongo3,mongo4/?replicaSet=myReplicaSet"
)
// Le driver ne d√©couvre et n'utilise que mongo1, mongo2, mongo3
```

**Connexion directe (visible)** :
```javascript
// Connexion explicite au Hidden member
const client = new MongoClient(
  "mongodb://mongo4.example.com:27017/?directConnection=true"
)
// Acc√®s direct, pas de d√©couverte de topologie
```

Cette capacit√© de connexion directe est essentielle pour les cas d'usage (reporting, backup).

## Cas d'Usage D√©taill√©s

### 1. Reporting et Analytics (OLAP)

**Probl√©matique** :

Les requ√™tes analytiques sont souvent tr√®s co√ªteuses :
- Scans de collections enti√®res
- Aggregations complexes sur de gros volumes
- Calculs intensifs (groupBy, sort sur millions de documents)
- Dur√©e d'ex√©cution : secondes √† minutes

Si ex√©cut√©es sur les membres de production :
- Saturation CPU ‚Üí latence accrue pour les op√©rations OLTP
- Saturation RAM ‚Üí √©viction du cache ‚Üí d√©gradation globale
- Saturation disque (IOPS) ‚Üí ralentissement des √©critures

**Solution avec Hidden Member** :

```javascript
// Configuration
{
  _id: 3,
  host: "analytics.example.com:27017",
  priority: 0,
  hidden: true,
  votes: 0,  // Optionnel : ne pas participer aux √©lections
  tags: { workload: "analytics", purpose: "reporting" }
}
```

**Architecture** :

```
Production :
  [Primary] ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ> [Secondary 1] ‚îÄ‚îê
      ‚Üì                      ‚Üì          ‚îÇ Read Preference: primaryPreferred
  OLTP writes          OLTP reads      ‚îÇ (Applications web, mobile)
                                        ‚Üì
                                   [Load Balancer]

Analytics (Isol√©) :
  [Hidden Member] <‚îÄ‚îÄ Connexion directe ‚Üê [BI Tools, Tableau, Power BI]
      ‚Üì
  Requ√™tes OLAP lourdes
  (aucun impact sur OLTP)
```

**Exemple de requ√™te analytics** :

```javascript
// Connexion directe au Hidden member
const analyticsClient = new MongoClient(
  "mongodb://analytics.example.com:27017/?directConnection=true"
)

// Agr√©gation co√ªteuse
const results = await db.collection('orders').aggregate([
  {
    $match: {
      orderDate: { $gte: new Date('2024-01-01'), $lt: new Date('2025-01-01') }
    }
  },
  {
    $group: {
      _id: { month: { $month: "$orderDate" }, product: "$productId" },
      totalRevenue: { $sum: "$amount" },
      orderCount: { $sum: 1 }
    }
  },
  {
    $sort: { "_id.month": 1, totalRevenue: -1 }
  },
  {
    $facet: {
      topProducts: [{ $limit: 100 }],
      statistics: [
        { $group: { _id: null, avgRevenue: { $avg: "$totalRevenue" } } }
      ]
    }
  }
])
```

Cette requ√™te peut prendre 30-60 secondes sur des millions de documents, mais n'affecte pas les performances OLTP.

### 2. Backups Op√©rationnels

**Probl√©matique** :

Les backups (mongodump, snapshots filesystem) sont co√ªteux :
- Lecture compl√®te du dataset ‚Üí saturation disque
- Verrouillage de lectures ‚Üí impact sur les performances
- Transfert r√©seau ‚Üí bande passante consomm√©e

**Solution avec Hidden Member** :

```javascript
{
  _id: 4,
  host: "backup.example.com:27017",
  priority: 0,
  hidden: true,
  votes: 0,
  tags: { purpose: "backup", location: "offsite" }
}
```

**Script de backup** :

```bash
#!/bin/bash
# backup_hidden_member.sh

BACKUP_HOST="backup.example.com"
BACKUP_PORT="27017"
BACKUP_DIR="/backups/mongodb/$(date +%Y-%m-%d)"
RETENTION_DAYS=30

# Backup via mongodump sur le Hidden member
mongodump \
  --host "$BACKUP_HOST" \
  --port "$BACKUP_PORT" \
  --out "$BACKUP_DIR" \
  --gzip \
  --oplog  # Capture du point-in-time

# V√©rification
if [ $? -eq 0 ]; then
  echo "Backup successful: $BACKUP_DIR"

  # Nettoyage des anciens backups
  find /backups/mongodb -type d -mtime +$RETENTION_DAYS -exec rm -rf {} \;
else
  echo "Backup failed!"
  exit 1
fi
```

**Avantages** :
- Backup sans impact sur les op√©rations de production
- Snapshot coh√©rent avec --oplog
- Peut √™tre planifi√© en heures de pointe sans risque

**Automatisation avec cron** :

```cron
# /etc/cron.d/mongodb-backup
# Backup quotidien √† 2h du matin
0 2 * * * mongodb /opt/scripts/backup_hidden_member.sh >> /var/log/mongodb-backup.log 2>&1
```

### 3. Extract-Transform-Load (ETL)

**Probl√©matique** :

Les pipelines ETL extraient des donn√©es de MongoDB vers des data warehouses (Snowflake, BigQuery, Redshift) :
- Requ√™tes volumineuses (exports massifs)
- Transformations co√ªteuses (aggregations pr√©liminaires)
- Fr√©quence √©lev√©e (syncs horaires ou continues)

**Solution avec Hidden Member** :

```javascript
{
  _id: 5,
  host: "etl.example.com:27017",
  priority: 0,
  hidden: true,
  votes: 0,
  tags: { purpose: "etl", pipeline: "datawarehouse" }
}
```

**Pipeline ETL (exemple avec Python)** :

```python
# etl_pipeline.py
from pymongo import MongoClient
from google.cloud import bigquery
import pandas as pd

# Connexion au Hidden member
mongo_client = MongoClient(
    "mongodb://etl.example.com:27017/?directConnection=true"
)
db = mongo_client['production']

# Extraction depuis MongoDB
cursor = db.orders.find(
    { "processed_at": { "$gte": last_sync_timestamp } },
    projection={ "_id": 0, "orderId": 1, "amount": 1, "customerId": 1 }
)

# Transformation
df = pd.DataFrame(list(cursor))
df['amount_usd'] = df['amount'] / 100  # Conversion centimes ‚Üí dollars
df['sync_timestamp'] = pd.Timestamp.now()

# Load vers BigQuery
bq_client = bigquery.Client()
job = bq_client.load_table_from_dataframe(
    df,
    'project.dataset.orders',
    job_config=bigquery.LoadJobConfig(write_disposition="WRITE_APPEND")
)
job.result()  # Attend la fin du job

print(f"Loaded {len(df)} rows to BigQuery")
```

**Avantages** :
- Extraction continue sans perturber la production
- Possibilit√© de parall√©liser (plusieurs pipelines ETL)
- Coh√©rence des donn√©es (r√©plication synchrone depuis Primary)

### 4. Environnements de Test et D√©veloppement

**Probl√©matique** :

Les d√©veloppeurs ont besoin d'acc√®s √† des donn√©es de production pour :
- Tests d'int√©gration
- Debugging de probl√®mes de production
- D√©veloppement de nouvelles features

Mais acc√©der directement √† la production est risqu√© :
- Requ√™tes exp√©rimentales mal optimis√©es ‚Üí impact performance
- Risque de modification accidentelle de donn√©es
- Probl√®mes de s√©curit√© (acc√®s d√©veloppeurs √† donn√©es sensibles)

**Solution avec Hidden Member** :

```javascript
{
  _id: 6,
  host: "devdata.internal.example.com:27017",
  priority: 0,
  hidden: true,
  votes: 0,
  tags: { purpose: "development", environment: "staging" }
}
```

**Configuration d√©veloppeur** :

```javascript
// config/database.js (environnement staging)
module.exports = {
  development: {
    url: "mongodb://devdata.internal.example.com:27017/myapp?directConnection=true",
    options: {
      readPreference: "secondary",  // M√™me si directConnection, bonne pratique
      maxPoolSize: 10
    }
  },
  production: {
    url: "mongodb://mongo1,mongo2,mongo3/myapp?replicaSet=prod",
    options: {
      readPreference: "primaryPreferred",
      maxPoolSize: 100,
      w: "majority"
    }
  }
}
```

**Bonnes pratiques** :

1. **Read-only access** : Limiter les d√©veloppeurs √† des comptes en lecture seule
```javascript
db.createUser({
  user: "dev_readonly",
  pwd: "secure_password",
  roles: [{ role: "read", db: "myapp" }]
})
```

2. **Anonymisation des donn√©es sensibles** : Script p√©riodique pour anonymiser PII
```javascript
// anonymize_dev_data.js (ex√©cut√© sur Hidden member)
db.users.updateMany(
  {},
  {
    $set: {
      email: { $concat: ["user_", "$_id", "@example.com"] },
      phone: "555-0000",
      ssn: "XXX-XX-XXXX"
    }
  }
)
```

### 5. Validation de Nouvelles Versions MongoDB

**Probl√©matique** :

Avant d'upgrader le cluster de production, il faut valider :
- Compatibilit√© des requ√™tes avec la nouvelle version
- Performance compar√©e
- Comportement des nouvelles features

**Solution avec Hidden Member** :

```javascript
// Hidden member sur MongoDB 7.0 (cluster principal sur 6.0)
{
  _id: 7,
  host: "test-upgrade.example.com:27017",
  priority: 0,
  hidden: true,
  votes: 0,
  tags: { purpose: "upgrade_test", version: "7.0" }
}
```

**Processus de validation** :

1. **R√©plication continue depuis la production (6.0)** :
   - Le Hidden member 7.0 r√©plique depuis le Primary 6.0
   - Compatibilit√© backward garantie

2. **Tests de charge** :
   ```bash
   # Replay du trafic de production sur le Hidden member
   mongo-replay \
     --source production-logs.json \
     --target mongodb://test-upgrade.example.com:27017
   ```

3. **Comparaison de performance** :
   - Mesurer les latences sur la version 7.0
   - Identifier les r√©gressions potentielles

4. **Validation fonctionnelle** :
   - Tester les nouvelles features (ex: Queryable Encryption)
   - V√©rifier les changements de comportement

**Rollback facile** : Si probl√®mes d√©tect√©s, simplement supprimer le Hidden member sans impact.

### 6. Change Data Capture (CDC)

**Probl√©matique** :

Surveiller les modifications de donn√©es en temps r√©el pour :
- Synchronisation avec d'autres syst√®mes
- Audit trail
- Event-driven architectures

**Solution avec Hidden Member et Change Streams** :

```javascript
{
  _id: 8,
  host: "cdc.example.com:27017",
  priority: 0,
  hidden: true,
  votes: 0,
  tags: { purpose: "change_streams", integration: "kafka" }
}
```

**Pipeline CDC** :

```javascript
// cdc_to_kafka.js
const { MongoClient } = require('mongodb')
const { Kafka } = require('kafkajs')

const mongoClient = new MongoClient(
  "mongodb://cdc.example.com:27017/?directConnection=true"
)
const kafka = new Kafka({ brokers: ['kafka1:9092', 'kafka2:9092'] })
const producer = kafka.producer()

async function streamChanges() {
  await mongoClient.connect()
  await producer.connect()

  const db = mongoClient.db('production')
  const changeStream = db.collection('orders').watch([
    { $match: { operationType: { $in: ['insert', 'update', 'delete'] } } }
  ])

  changeStream.on('change', async (change) => {
    console.log('Change detected:', change.operationType)

    // Publier vers Kafka
    await producer.send({
      topic: 'mongodb.orders.changes',
      messages: [{
        key: change.documentKey._id.toString(),
        value: JSON.stringify(change)
      }]
    })
  })
}

streamChanges().catch(console.error)
```

**Avantages** :
- Change Stream sur Hidden member ‚Üí aucun impact sur production
- R√©silience : si le CDC crash, pas d'impact sur les op√©rations
- Scalabilit√© : plusieurs consumers CDC sur le m√™me Hidden member

## Configuration et D√©ploiement

### Configuration Basique

**Ajout lors de l'initialisation** :

```javascript
rs.initiate({
  _id: "myReplicaSet",
  members: [
    { _id: 0, host: "mongo1.example.com:27017", priority: 2 },
    { _id: 1, host: "mongo2.example.com:27017", priority: 1 },
    { _id: 2, host: "mongo3.example.com:27017", priority: 1 },
    {
      _id: 3,
      host: "hidden.example.com:27017",
      priority: 0,
      hidden: true,
      votes: 0,
      tags: { usage: "analytics" }
    }
  ]
})
```

**Ajout √† un Replica Set existant** :

```javascript
// √âtape 1 : D√©marrer le nouveau membre
// mongod --replSet myReplicaSet --dbpath /data/hidden --port 27017

// √âtape 2 : Ajouter √† la configuration
cfg = rs.conf()
cfg.members.push({
  _id: 4,
  host: "hidden2.example.com:27017",
  priority: 0,
  hidden: true,
  votes: 1,  // Peut voter
  tags: { usage: "backup", dc: "offsite" }
})
rs.reconfig(cfg)

// √âtape 3 : Attendre l'initial sync
rs.status().members.find(m => m._id === 4)
// Surveiller stateStr: STARTUP2 ‚Üí RECOVERING ‚Üí SECONDARY
```

**Transformation d'un Secondary existant** :

```javascript
cfg = rs.conf()

// Trouver le membre √† rendre Hidden
const memberIndex = cfg.members.findIndex(m => m.host === "mongo4.example.com:27017")

// Modifier ses propri√©t√©s
cfg.members[memberIndex].priority = 0
cfg.members[memberIndex].hidden = true
cfg.members[memberIndex].tags = { usage: "reporting" }

rs.reconfig(cfg)
```

### Configuration Avanc√©e avec Multiple Hidden Members

**Topologie complexe** :

```javascript
rs.initiate({
  _id: "production",
  members: [
    // Production OLTP
    { _id: 0, host: "prod-primary:27017", priority: 2, tags: { dc: "us-east", role: "oltp" } },
    { _id: 1, host: "prod-sec1:27017", priority: 1, tags: { dc: "us-east", role: "oltp" } },
    { _id: 2, host: "prod-sec2:27017", priority: 1, tags: { dc: "us-west", role: "oltp" } },

    // Hidden members sp√©cialis√©s
    {
      _id: 3,
      host: "analytics:27017",
      priority: 0,
      hidden: true,
      votes: 0,
      tags: { dc: "us-east", role: "analytics", purpose: "bi" }
    },
    {
      _id: 4,
      host: "backup:27017",
      priority: 0,
      hidden: true,
      votes: 0,
      tags: { dc: "us-central", role: "backup", purpose: "disaster_recovery" }
    },
    {
      _id: 5,
      host: "etl:27017",
      priority: 0,
      hidden: true,
      votes: 0,
      tags: { dc: "us-east", role: "etl", purpose: "datawarehouse" }
    },
    {
      _id: 6,
      host: "delayed:27017",
      priority: 0,
      hidden: true,
      slaveDelay: 14400,  // 4 heures
      votes: 0,
      tags: { dc: "us-west", role: "delayed", purpose: "point_in_time_recovery" }
    }
  ]
})
```

**Avantages de cette topologie** :
- **Isolation compl√®te** : Chaque charge de travail sur un membre d√©di√©
- **Pas d'interf√©rence** : Analytics, backup, ETL ne se g√™nent pas mutuellement
- **Flexibilit√©** : Ajout/suppression de membres Hidden sans impact
- **Scalabilit√©** : Horizontal scaling des charges non-OLTP

### Fichier de Configuration mongod.conf

```yaml
# /etc/mongod-hidden.conf

# Stockage
storage:
  dbPath: /var/lib/mongodb-hidden
  engine: wiredTiger
  wiredTiger:
    engineConfig:
      cacheSizeGB: 32  # Adapter selon RAM disponible
      journalCompressor: snappy
    collectionConfig:
      blockCompressor: snappy

# R√©seau
net:
  port: 27017
  bindIp: 0.0.0.0  # Ou IP sp√©cifique pour s√©curit√©
  maxIncomingConnections: 500  # Peut √™tre plus √©lev√© que production

# R√©plication
replication:
  replSetName: myReplicaSet
  enableMajorityReadConcern: true

# S√©curit√©
security:
  authorization: enabled
  keyFile: /etc/mongodb-keyfile
  # Ou x.509
  # clusterAuthMode: x509

# TLS
net:
  tls:
    mode: requireTLS
    certificateKeyFile: /etc/ssl/hidden-member.pem
    CAFile: /etc/ssl/ca.pem

# Logging
systemLog:
  destination: file
  path: /var/log/mongodb/hidden.log
  logAppend: true
  logRotate: reopen

# Profiling (utile pour analyser les requ√™tes analytics)
operationProfiling:
  mode: slowOp
  slowOpThresholdMs: 1000  # Logger les ops > 1s

# Process Management
processManagement:
  fork: true
  pidFilePath: /var/run/mongodb/hidden.pid
```

### Hardware Sizing

Le dimensionnement d'un Hidden member d√©pend de son usage :

#### Hidden Member pour Analytics

**Caract√©ristiques** :
- CPU : √âlev√© (calculs aggregations complexes)
- RAM : Tr√®s √©lev√© (working set + cache pour scans)
- Disque : IOPS mod√©r√©s (lectures principalement)
- R√©seau : Mod√©r√©

**Recommandation** :
```
CPU : 16-32 cores (plus que production si queries tr√®s parall√®les)
RAM : 128-256 GB (id√©alement working set complet en RAM)
Disque : SSD 1-2 TB (moins critique que production)
R√©seau : 1-10 Gbps
```

#### Hidden Member pour Backup

**Caract√©ristiques** :
- CPU : Faible (compression uniquement)
- RAM : Mod√©r√© (cache WiredTiger standard)
- Disque : IOPS faibles (lectures s√©quentielles)
- R√©seau : √âlev√© (transfert des backups)

**Recommandation** :
```
CPU : 8 cores (suffisant)
RAM : 64 GB (peut √™tre moins que production)
Disque : HDD 2-4 TB (stockage temporaire, co√ªt optimis√©)
R√©seau : 10 Gbps (pour transferts rapides)
```

#### Hidden Member pour ETL

**Caract√©ristiques** :
- CPU : Mod√©r√© (transformations l√©g√®res)
- RAM : Mod√©r√© (queries cibl√©es)
- Disque : IOPS mod√©r√©s
- R√©seau : √âlev√© (export continu)

**Recommandation** :
```
CPU : 8-16 cores
RAM : 64-128 GB
Disque : SSD 500 GB - 1 TB
R√©seau : 10 Gbps
```

## Architecture et Fonctionnement

### Flux de R√©plication

Un Hidden member r√©plique exactement comme un Secondary standard :

```
Primary ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ> Hidden Member
  |
  | 1. Op√©rations √©crites dans Oplog
  |
  ‚Üì
  Hidden Member ouvre tailable cursor sur Oplog
  |
  ‚Üì
  2. R√©cup√®re batches d'op√©rations
  |
  ‚Üì
  3. Applique localement (m√™me ordre)
  |
  ‚Üì
  4. Met √† jour lastAppliedOpTime
  |
  ‚Üì
  5. Envoie heartbeat avec position
```

**Particularit√©s** :
- M√™me replication lag que les Secondaries normaux
- Peut r√©pliquer via chaining (depuis un autre Secondary)
- Participe au commit point si `votes: 1`

### Participation au Commit Point

Si le Hidden member a `votes: 1`, il participe au calcul du commit point :

**Sc√©nario** :
```
Configuration : P + S1 + S2 + H (Hidden, votes: 1)

Quorum = 3/4

√âcriture avec w: "majority":
  1. Primary √©crit (OpTime: 100)
  2. Attend r√©plication sur 3/4 membres
  3. S1 r√©plique (OpTime: 100)
  4. S2 r√©plique (OpTime: 100)
  5. H (Hidden) r√©plique (OpTime: 100)

  Commit point = 100 (r√©pliqu√© sur P, S1, S2, H)
```

**Avec `votes: 0`** :
```
Configuration : P + S1 + S2 + H (Hidden, votes: 0)

Quorum = 2/3 (H ne compte pas)

√âcriture avec w: "majority":
  1. Primary √©crit (OpTime: 100)
  2. Attend r√©plication sur 2/3 membres votants
  3. S1 r√©plique (OpTime: 100)

  Commit point = 100 (P + S1 suffisent)
  H r√©plique √©ventuellement, mais ne bloque pas le commit
```

**Recommandation** : Utiliser `votes: 0` pour les Hidden members d√©di√©s aux charges lourdes (√©vite qu'ils ralentissent le commit point).

### Replication Chaining

Les Hidden members peuvent servir de source de r√©plication pour d'autres Secondaries :

**Topologie en cha√Æne** :
```
Primary ‚îÄ‚îÄ> Secondary 1 ‚îÄ‚îÄ> Hidden (Analytics)
                ‚Üì
            Secondary 2
```

**Avantages** :
- R√©duit la charge r√©seau sur le Primary
- Le Hidden member r√©plique depuis le Secondary g√©ographiquement proche

**Configuration** :
```javascript
// Activ√© par d√©faut
rs.conf().settings.chainingAllowed  // true
```

**Monitoring de la source** :
```javascript
rs.status().members.find(m => m.hidden === true).syncSourceHost
// Affiche depuis quel membre le Hidden r√©plique
```

### Gestion des Index

Les Hidden members maintiennent les m√™mes index que le Primary (par d√©faut) :

**Sc√©nario 1 : Index identiques (d√©faut)** :
```javascript
// Sur le Primary
db.orders.createIndex({ customerId: 1, orderDate: -1 })

// R√©pliqu√© automatiquement sur tous les membres (y compris Hidden)
```

**Sc√©nario 2 : Index sp√©cifiques pour Analytics** :

Les Hidden members peuvent avoir des index suppl√©mentaires pour optimiser les requ√™tes analytics :

```javascript
// Connexion directe au Hidden member
const hiddenClient = new MongoClient(
  "mongodb://analytics.example.com:27017/?directConnection=true"
)

// Cr√©er un index sp√©cifique pour analytics (non pr√©sent sur Primary)
await hiddenClient.db('production').collection('orders').createIndex(
  { productCategory: 1, orderDate: 1 },
  { name: "analytics_category_date" }
)
```

**Important** : Ces index ne sont PAS r√©pliqu√©s vers le Primary ou les autres membres.

**Cas d'usage** :
- Index pour aggregations sp√©cifiques
- Index texte pour recherche full-text (co√ªteux √† maintenir)
- Index g√©ospatiaux pour analytics de localisation

**Attention** : Cr√©er des index uniquement sur le Hidden member augmente :
- L'espace disque utilis√©
- Le temps d'application de l'Oplog (updates d'index suppl√©mentaires)

## Isolation des Charges de Travail

### Strat√©gie de Routage avec Tags

Les tags permettent un routage intelligent vers les Hidden members :

**Configuration** :
```javascript
cfg = rs.conf()

// Production
cfg.members[0].tags = { environment: "production", workload: "oltp" }
cfg.members[1].tags = { environment: "production", workload: "oltp" }

// Analytics
cfg.members[3].tags = { environment: "analytics", workload: "olap" }

rs.reconfig(cfg)
```

**Connexion applicative** :

```javascript
// Application OLTP (web/mobile)
const oltp = new MongoClient(
  "mongodb://mongo1,mongo2,mongo3/?replicaSet=myRS",
  {
    readPreference: "primaryPreferred",
    readPreferenceTags: [{ workload: "oltp" }]
  }
)

// Application Analytics (BI, dashboards) - Connexion directe
const analytics = new MongoClient(
  "mongodb://analytics.example.com:27017/?directConnection=true",
  {
    readPreference: "secondary",  // Bonne pratique m√™me en direct
    maxPoolSize: 50
  }
)
```

### Isolation R√©seau

**VLANs s√©par√©s** :
```
Production VLAN (10.0.1.0/24) :
  - Primary : 10.0.1.10
  - Secondary 1 : 10.0.1.11
  - Secondary 2 : 10.0.1.12

Analytics VLAN (10.0.2.0/24) :
  - Hidden Analytics : 10.0.2.10
  - BI Servers : 10.0.2.20-30

Backup VLAN (10.0.3.0/24) :
  - Hidden Backup : 10.0.3.10
  - Backup Storage : 10.0.3.20
```

**Firewall Rules** :
```bash
# Hidden member peut communiquer avec Replica Set (heartbeats, r√©plication)
iptables -A INPUT -p tcp --dport 27017 -s 10.0.1.0/24 -j ACCEPT

# Autoriser connexions depuis Analytics VLAN uniquement
iptables -A INPUT -p tcp --dport 27017 -s 10.0.2.0/24 -j ACCEPT

# Bloquer tout le reste
iptables -A INPUT -p tcp --dport 27017 -j DROP
```

### Resource Limits (cgroups)

Limiter les ressources utilisables par le Hidden member :

```bash
# /etc/systemd/system/mongod-hidden.service
[Service]
ExecStart=/usr/bin/mongod --config /etc/mongod-hidden.conf
User=mongodb
Group=mongodb

# CPU limits (70% d'un serveur 16 cores = ~11 cores)
CPUQuota=1100%

# Memory limits (100 GB sur serveur 128 GB)
MemoryLimit=100G
MemoryAccounting=true

# IO limits (throttle reads/writes)
IOReadBandwidthMax=/dev/sda 500M
IOWriteBandwidthMax=/dev/sda 200M

[Install]
WantedBy=multi-user.target
```

**Avantages** :
- Garantit que le Hidden member ne monopolise pas toutes les ressources
- Protection contre les requ√™tes analytics runaway
- Pr√©visibilit√© des performances

## Performance et Optimisations

### Optimisation pour Requ√™tes Analytics

#### Working Set en RAM

Les requ√™tes analytics b√©n√©ficient √©norm√©ment de donn√©es en RAM :

**Strat√©gie** :
1. **Identifier le working set analytics** :
```javascript
// Sur le Hidden member, analyser les collections fr√©quemment acc√©d√©es
db.adminCommand({ serverStatus: 1 }).wiredTiger.cache

// Mesurer la taille des collections principales
db.orders.stats().size  // Taille en octets
db.customers.stats().size
```

2. **Dimensionner la RAM** :
```
RAM_required = Working_Set_Analytics + WiredTiger_Cache + OS_overhead

Exemple :
  Working Set : 80 GB (collections orders, customers, products)
  WiredTiger Cache : 64 GB (configur√©)
  OS overhead : 8 GB
  ‚Üí RAM recommand√©e : 152 GB (arrondi √† 160 GB)
```

3. **Pr√©-chargement** (warmup cache) :
```javascript
// Script de warmup au d√©marrage
db.orders.find().hint({ $natural: 1 }).forEach(() => {})  // Scan complet
db.customers.find().hint({ $natural: 1 }).forEach(() => {})
```

#### Index Couvrants pour Analytics

Cr√©er des index couvrants pour les requ√™tes analytics fr√©quentes :

```javascript
// Requ√™te analytics typique
db.orders.aggregate([
  { $match: { orderDate: { $gte: ISODate('2024-01-01') } } },
  { $group: { _id: "$customerId", totalSpent: { $sum: "$amount" } } },
  { $sort: { totalSpent: -1 } },
  { $limit: 100 }
])

// Index couvrant optimal
db.orders.createIndex(
  { orderDate: 1, customerId: 1, amount: 1 },
  { name: "analytics_top_customers" }
)
```

**V√©rification** :
```javascript
db.orders.explain("executionStats").aggregate([...])

// Chercher :
// - totalKeysExamined ‚âà totalDocsExamined (index utilis√©)
// - IXSCAN dans executionStages
```

#### Compression des Donn√©es

Optimiser la compression pour √©conomiser RAM et disque :

```yaml
# mongod-hidden.conf
storage:
  wiredTiger:
    collectionConfig:
      blockCompressor: zstd  # Meilleur ratio que snappy (d√©faut)
    indexConfig:
      prefixCompression: true  # Compression des pr√©fixes d'index
```

**Trade-off** :
- `zstd` : Meilleur ratio (~60-70%) mais CPU l√©g√®rement plus √©lev√©
- `snappy` : Ratio mod√©r√© (~50-60%) mais tr√®s rapide
- `zlib` : Excellent ratio (~70-80%) mais co√ªteux CPU

Pour analytics (lectures >> √©critures), `zstd` est souvent optimal.

### Gestion du Replication Lag

Le replication lag sur un Hidden member est acceptable (donn√©es l√©g√®rement obsol√®tes pour analytics), mais ne doit pas √™tre excessif :

#### Monitoring du Lag

```javascript
// Script de monitoring
function checkHiddenMemberLag() {
  const status = rs.status()
  const primary = status.members.find(m => m.state === 1)
  const hiddenMembers = status.members.filter(m => m.hidden === true)

  hiddenMembers.forEach(h => {
    const lagSeconds = (primary.optimeDate - h.optimeDate) / 1000
    console.log(`${h.name}: ${lagSeconds.toFixed(2)}s lag`)

    if (lagSeconds > 300) {  // 5 minutes
      console.warn(`WARNING: High lag on ${h.name}`)
    }
  })
}

checkHiddenMemberLag()
```

#### R√©duction du Lag

**1. Augmenter les ressources** :
```yaml
# Upgrade du disque HDD ‚Üí SSD
# Augmentation RAM pour cache WiredTiger
storage:
  wiredTiger:
    engineConfig:
      cacheSizeGB: 96  # Avant : 64 GB
```

**2. Optimiser les requ√™tes analytics** :
```javascript
// Avant : Scan complet
db.orders.aggregate([
  { $match: {} },  // Pas de filtre !
  { $group: { _id: "$customerId", count: { $sum: 1 } } }
])

// Apr√®s : Filtre temporel
db.orders.aggregate([
  { $match: { orderDate: { $gte: ISODate('2024-01-01') } } },  // R√©duit 90% des docs
  { $group: { _id: "$customerId", count: { $sum: 1 } } }
])
```

**3. Planifier les requ√™tes lourdes** :
```javascript
// Ex√©cuter les aggregations massives en heures creuses
const schedule = require('node-schedule')

// Tous les jours √† 3h du matin
schedule.scheduleJob('0 3 * * *', async () => {
  await runHeavyAnalytics()
})
```

## Monitoring et Maintenance

### M√©triques Sp√©cifiques

**Surveillance du Hidden Member** :

```javascript
// √âtat g√©n√©ral
rs.status().members.filter(m => m.hidden === true)

{
  "_id": 3,
  "name": "analytics.example.com:27017",
  "health": 1,
  "state": 2,
  "stateStr": "SECONDARY",
  "uptime": 345600,
  "optime": { "ts": Timestamp(...), "t": NumberLong(5) },
  "optimeDate": ISODate("2024-12-08T12:00:00Z"),
  "syncSourceHost": "mongo1.example.com:27017",
  "syncSourceId": 0,
  "configVersion": 5,
  "hidden": true  // Confirmation
}
```

**M√©triques de performance** :

```javascript
// Connexion directe au Hidden member
db.serverStatus()

{
  // Connexions actives
  "connections": {
    "current": 42,       // Connexions analytics, ETL, etc.
    "available": 458,
    "totalCreated": 1234
  },

  // Op√©rations
  "opcounters": {
    "query": 123456,
    "getmore": 78901,  // Cursors analytics
    "insert": 0,        // 0 (Hidden ne re√ßoit pas d'√©critures directes)
    "update": 0,
    "delete": 0
  },

  // Replication lag
  "metrics": {
    "repl": {
      "apply": {
        "batches": { "num": 12345, "totalMillis": 67890 },
        "ops": NumberLong(1234567)
      }
    }
  },

  // WiredTiger cache
  "wiredTiger": {
    "cache": {
      "bytes currently in the cache": 68719476736,  // ~64 GB
      "pages read into cache": 234567,
      "pages evicted by application threads": 12345
    }
  }
}
```

### Alerting

**Conditions d'alerte pour Hidden members** :

```yaml
# alerts.yml (Prometheus/Grafana)

groups:
  - name: mongodb_hidden_members
    rules:
      # Hidden member DOWN
      - alert: HiddenMemberDown
        expr: mongodb_mongod_replset_member_health{state="HIDDEN"} == 0
        for: 5m
        severity: warning
        annotations:
          summary: "Hidden member {{ $labels.member }} is DOWN"

      # Replication lag √©lev√©
      - alert: HiddenMemberHighLag
        expr: |
          (mongodb_mongod_replset_optime_date{state="PRIMARY"}
          - mongodb_mongod_replset_optime_date{hidden="true"}) > 600
        for: 10m
        severity: warning
        annotations:
          summary: "Hidden member lag > 10 minutes"

      # CPU satur√©
      - alert: HiddenMemberCPUSaturation
        expr: |
          rate(process_cpu_seconds_total{job="mongodb-hidden"}[5m]) > 0.9
        for: 15m
        severity: warning
        annotations:
          summary: "Hidden member CPU > 90% for 15 minutes"

      # Cache evictions √©lev√©es
      - alert: HiddenMemberCacheEvictions
        expr: |
          rate(mongodb_wiredtiger_cache_evicted_total{job="mongodb-hidden"}[5m]) > 1000
        for: 10m
        severity: info
        annotations:
          summary: "High cache eviction rate on hidden member"
```

### Maintenance et Op√©rations

#### Rolling Restart pour Mise √† Jour

Les Hidden members peuvent √™tre red√©marr√©s sans impact sur les applications :

```bash
#!/bin/bash
# restart_hidden_members.sh

HIDDEN_HOSTS=("analytics.example.com" "backup.example.com" "etl.example.com")

for host in "${HIDDEN_HOSTS[@]}"; do
  echo "Restarting $host..."

  # Arr√™t graceful
  ssh "$host" "sudo systemctl stop mongod"

  # Mise √† jour si n√©cessaire
  ssh "$host" "sudo apt-get update && sudo apt-get install -y mongodb-org"

  # Red√©marrage
  ssh "$host" "sudo systemctl start mongod"

  # V√©rification
  sleep 30
  mongo --host "$host" --eval "db.adminCommand('ping')" && echo "‚úì $host is UP"

  echo "Waiting 2 minutes before next member..."
  sleep 120
done

echo "All hidden members restarted successfully"
```

**Avantage** : Pas de downtime pour les utilisateurs de production.

#### Suppression d'un Hidden Member

```javascript
// √âtape 1 : Identifier le membre
rs.conf().members.filter(m => m.hidden === true)

// √âtape 2 : Retirer de la configuration
cfg = rs.conf()
cfg.members = cfg.members.filter(m => m.host !== "old-analytics.example.com:27017")
rs.reconfig(cfg)

// √âtape 3 : V√©rifier
rs.status()  // Le membre ne devrait plus appara√Ætre

// √âtape 4 : Arr√™ter le processus mongod sur le serveur
// ssh old-analytics.example.com
// sudo systemctl stop mongod
// sudo systemctl disable mongod
```

## Bonnes Pratiques

### 1. Utiliser votes: 0 pour Charges Lourdes

**Principe** : Les Hidden members d√©di√©s aux charges analytics ne devraient pas influencer le quorum.

```javascript
// BON : votes: 0
{
  _id: 3,
  host: "analytics.example.com:27017",
  priority: 0,
  hidden: true,
  votes: 0  // Ne participe pas au commit point
}

// √âVITER : votes: 1 (peut ralentir w: "majority")
{
  _id: 3,
  host: "analytics.example.com:27017",
  priority: 0,
  hidden: true,
  votes: 1  // Si lag important, ralentit les √©critures
}
```

### 2. Documenter le R√¥le de Chaque Hidden Member

**Template de documentation** :

```markdown
## Hidden Member: analytics.example.com

**Purpose**: Business Intelligence and Analytics
**Configuration**:
- Priority: 0
- Hidden: true
- Votes: 0
- Tags: { purpose: "analytics", team: "data" }

**Resources**:
- CPU: 32 cores
- RAM: 256 GB
- Disk: 2 TB NVMe SSD
- Network: 10 Gbps

**Clients**:
- Tableau Server (10.0.2.20)
- Power BI Gateway (10.0.2.21)
- Data Science Jupyter (10.0.2.30-35)

**Maintenance Window**: Sundays 2-4 AM UTC
**On-call**: data-engineering@example.com
```

### 3. Monitoring D√©di√©

Cr√©er des dashboards sp√©cifiques pour les Hidden members :

```javascript
// Dashboard Grafana - Hidden Members Panel
{
  "title": "Hidden Members Health",
  "panels": [
    {
      "title": "Replication Lag",
      "targets": [{
        "expr": "mongodb_replset_optime_lag{hidden='true'}"
      }]
    },
    {
      "title": "Query Throughput",
      "targets": [{
        "expr": "rate(mongodb_opcounters_query{job='mongodb-hidden'}[5m])"
      }]
    },
    {
      "title": "Active Connections",
      "targets": [{
        "expr": "mongodb_connections_current{job='mongodb-hidden'}"
      }]
    }
  ]
}
```

### 4. Rate Limiting pour Protection

Limiter le d√©bit de requ√™tes pour √©viter la saturation :

```javascript
// Application analytics avec rate limiting
const RateLimiter = require('limiter').RateLimiter
const limiter = new RateLimiter({ tokensPerInterval: 100, interval: "second" })

async function runAnalyticsQuery(query) {
  await limiter.removeTokens(1)  // Attend si limite atteinte
  return await hiddenDB.collection('orders').aggregate(query).toArray()
}
```

### 5. S√©parer par Fonction

**Ne pas m√©langer les usages** :

```javascript
// MAUVAIS : Un seul Hidden member pour tout
{
  _id: 3,
  host: "swiss-army-knife.example.com:27017",
  priority: 0,
  hidden: true,
  tags: { purpose: "analytics,backup,etl,testing" }  // Trop de r√¥les
}

// BON : Membres d√©di√©s
{
  _id: 3,
  host: "analytics.example.com:27017",
  priority: 0,
  hidden: true,
  tags: { purpose: "analytics" }
}
{
  _id: 4,
  host: "backup.example.com:27017",
  priority: 0,
  hidden: true,
  tags: { purpose: "backup" }
}
```

## Limitations et Consid√©rations

### 1. Co√ªt d'Infrastructure

Chaque Hidden member n√©cessite un serveur complet :

**Calcul de co√ªt** :
```
Production : 3 membres √ó $500/mois = $1,500/mois
Hidden analytics : 1 membre √ó $600/mois = $600/mois (specs plus √©lev√©es)
Hidden backup : 1 membre √ó $300/mois = $300/mois (specs r√©duites)

Total : $2,400/mois (vs $1,500 sans Hidden members)
Surco√ªt : +60%
```

**Justification** : L'isolation vaut g√©n√©ralement le co√ªt (√©vite les incidents en production).

### 2. Complexit√© de Gestion

Plus de membres = plus de complexit√© :

- **Monitoring** : M√©triques multipli√©es
- **Maintenance** : Rolling upgrades sur plus de serveurs
- **S√©curit√©** : Plus de surface d'attaque
- **Documentation** : N√©cessit√© de documenter les r√¥les

**Mitigation** : Automatisation (Ansible, Terraform, Kubernetes Operators).

### 3. Replication Lag Acceptable

Les Hidden members peuvent avoir un lag plus √©lev√© que les Secondaries de production :

**Seuils recommand√©s** :
- Production : Lag < 10 secondes
- Hidden analytics : Lag < 5 minutes (donn√©es l√©g√®rement obsol√®tes OK)
- Hidden backup : Lag < 1 minute (important pour Point-in-Time Recovery)
- Hidden ETL : Lag < 30 secondes (synchronisation fr√©quente)

### 4. Pas de Failover Automatique

Les Hidden members ne peuvent jamais devenir Primary (`priority: 0`) :

**Implication** : Ne comptent pas dans la tol√©rance aux pannes de production.

```
Configuration : P + S1 + S2 + H (Hidden)

Tol√©rance aux pannes : 1 membre (parmi P, S1, S2)
Le Hidden member n'am√©liore pas la HA
```

## Conclusion

Les **Hidden members** sont un outil puissant pour l'architecture des Replica Sets MongoDB, permettant une **isolation propre des charges de travail** sans compromettre les performances de production.

**Cas d'usage principaux** :
1. **Analytics et BI** : Requ√™tes OLAP lourdes isol√©es
2. **Backups** : Dumps sans impact sur les op√©rations
3. **ETL** : Pipelines de donn√©es vers data warehouses
4. **Testing** : Environnements de dev avec donn√©es r√©elles
5. **CDC** : Change Streams pour event-driven architectures

**Avantages cl√©s** :
- **Isolation compl√®te** : Aucun impact sur les performances OLTP
- **Flexibilit√©** : Ajout/suppression sans disruption
- **Sp√©cialisation** : Hardware et index optimis√©s par usage
- **S√©curit√©** : Contr√¥le d'acc√®s granulaire par membre

**Points d'attention** :
- Co√ªt d'infrastructure (+60% typique)
- `votes: 0` recommand√© pour charges lourdes
- Documentation rigoureuse des r√¥les requise
- Monitoring d√©di√© essentiel

**Bonnes pratiques** :
- Un Hidden member par fonction (ne pas m√©langer analytics + backup)
- Dimensionnement appropri√© selon l'usage
- Automatisation de la maintenance
- Rate limiting pour protection

Les Hidden members sont particuli√®rement recommand√©s pour les syst√®mes de production matures o√π l'isolation des charges justifie le surco√ªt d'infrastructure. Ils permettent d'offrir des services analytics, de backup et d'int√©gration de donn√©es sans compromettre la stabilit√© et les performances des op√©rations critiques.

‚è≠Ô∏è [Delayed](/09-replication/03.5-delayed.md)
