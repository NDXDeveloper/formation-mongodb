ğŸ” Retour au [Sommaire](/SOMMAIRE.md)

# 18.4.2 MongoDB Enterprise Kubernetes Operator

## Introduction

Le MongoDB Enterprise Kubernetes Operator Ã©tend les capacitÃ©s du Community Operator en ajoutant des fonctionnalitÃ©s enterprise critiques pour les dÃ©ploiements Ã  grande Ã©chelle : intÃ©gration avec Ops Manager, backup automatisÃ© avancÃ©, monitoring centralisÃ©, support des clusters shardÃ©s, et authentification enterprise (LDAP, Kerberos).

Cet opÃ©rateur est conÃ§u pour les organisations nÃ©cessitant des SLAs stricts, une gestion centralisÃ©e multi-cluster, et des fonctionnalitÃ©s de compliance avancÃ©es.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         MongoDB Enterprise Operator Architecture                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    Ops Manager / Cloud Manager              â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚  â€¢ Centralized Management                                   â”‚ â”‚
â”‚  â”‚  â€¢ Automated Backups                                        â”‚ â”‚
â”‚  â”‚  â€¢ Performance Monitoring                                   â”‚ â”‚
â”‚  â”‚  â€¢ Alerting & Automation                                    â”‚ â”‚
â”‚  â”‚  â€¢ Query Optimization                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â”‚                                      â”‚
â”‚                           â”‚ API Communication                    â”‚
â”‚                           â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              Enterprise Operator Pod                        â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚         Operator Controller                            â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Watches Enterprise CRs                              â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Manages Ops Manager Integration                     â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Coordinates Automation Agents                       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Handles Backup Configuration                        â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â”‚                                      â”‚
â”‚                           â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚            MongoDB Enterprise Resources                     â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  Replica Set   â”‚  â”‚ Sharded Clusterâ”‚  â”‚  Ops Manager   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                â”‚  â”‚                â”‚  â”‚   Integration  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ 3+ Members  â”‚  â”‚  â€¢ Config Srvs â”‚  â”‚                â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Automation  â”‚  â”‚  â€¢ Shards      â”‚  â”‚  â€¢ API Keys    â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Monitoring  â”‚  â”‚  â€¢ Mongos      â”‚  â”‚  â€¢ Projects    â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Backup      â”‚  â”‚  â€¢ Backup      â”‚  â”‚  â€¢ Agents      â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### DiffÃ©rences Enterprise vs Community

```yaml
# comparison-matrix.yaml
---
feature:
  replica_sets:
    community: âœ… Full support
    enterprise: âœ… Full support + Ops Manager integration

  sharded_clusters:
    community: âŒ Not supported
    enterprise: âœ… Full support with automation

  ops_manager_integration:
    community: âŒ Not available
    enterprise: âœ… Full integration

  automated_backups:
    community: âš ï¸  Manual via CronJobs
    enterprise: âœ… Ops Manager continuous backup

  point_in_time_recovery:
    community: âŒ Not available
    enterprise: âœ… Full PITR support

  monitoring:
    community: âš ï¸  Prometheus/Grafana
    enterprise: âœ… Ops Manager + Prometheus

  authentication:
    community: âœ… SCRAM, x.509
    enterprise: âœ… SCRAM, x.509, LDAP, Kerberos

  encryption_at_rest:
    community: âš ï¸  Storage-level only
    enterprise: âœ… Native MongoDB encryption

  auditing:
    community: âŒ Not available
    enterprise: âœ… Full audit logging

  multi_cluster_management:
    community: âŒ Not available
    enterprise: âœ… Via Ops Manager

  support:
    community: Community forums
    enterprise: 24/7 Enterprise support

  licensing:
    community: Open source (Apache 2.0)
    enterprise: Commercial license required
```

---

## PrÃ©requis et Licence

### Obtention de la Licence Enterprise

```bash
# Contact MongoDB pour obtenir:
# 1. Enterprise subscription
# 2. Ops Manager license
# 3. Organization ID and API keys

# Variables de licence nÃ©cessaires
MONGODB_ENTERPRISE_LICENSE="<license-key>"
OPS_MANAGER_URL="https://ops-manager.company.com:8443"
OPS_MANAGER_ORG_ID="<org-id>"
OPS_MANAGER_API_KEY="<public-api-key>"
OPS_MANAGER_API_SECRET="<private-api-key>"
```

### Installation de Ops Manager

```yaml
# ops-manager-deployment.yaml
# DÃ©ploiement de Ops Manager dans Kubernetes (optionnel)
apiVersion: v1
kind: Namespace
metadata:
  name: ops-manager
---
# PersistentVolumeClaim pour Ops Manager
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: ops-manager-data
  namespace: ops-manager
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: fast-ssd
  resources:
    requests:
      storage: 500Gi
---
# ConfigMap pour Ops Manager
apiVersion: v1
kind: ConfigMap
metadata:
  name: ops-manager-config
  namespace: ops-manager
data:
  mms.conf: |
    mms.centralUrl=https://ops-manager.company.com:8443
    mms.fromEmailAddr=ops-manager@company.com
    mms.replyToEmailAddr=ops-manager@company.com
    mms.adminEmailAddr=admin@company.com
    mms.mail.transport=smtp
    mms.mail.hostname=smtp.company.com
    mms.mail.port=587

    # MongoDB backing database
    mongo.mongoUri=mongodb://ops-manager-db-0,ops-manager-db-1,ops-manager-db-2:27017
    mongo.ssl=true

    # Security
    mms.https.PEMKeyFile=/etc/ops-manager/tls/mongodb.pem
    mms.https.PEMKeyFilePassword=<password>
---
# Deployment Ops Manager
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ops-manager
  namespace: ops-manager
spec:
  replicas: 2
  selector:
    matchLabels:
      app: ops-manager
  template:
    metadata:
      labels:
        app: ops-manager
    spec:
      containers:
        - name: ops-manager
          image: quay.io/mongodb/mongodb-enterprise-ops-manager:7.0.5

          ports:
            - name: http
              containerPort: 8080
            - name: https
              containerPort: 8443

          env:
            - name: OM_LICENSE_KEY
              valueFrom:
                secretKeyRef:
                  name: ops-manager-license
                  key: license

          volumeMounts:
            - name: config
              mountPath: /etc/mongodb-mms
              readOnly: true
            - name: data
              mountPath: /data
            - name: tls
              mountPath: /etc/ops-manager/tls
              readOnly: true

          resources:
            requests:
              memory: "4Gi"
              cpu: "2"
            limits:
              memory: "8Gi"
              cpu: "4"

          livenessProbe:
            httpGet:
              path: /api/public/v1.0/admin/healthCheck
              port: 8443
              scheme: HTTPS
            initialDelaySeconds: 60
            periodSeconds: 30

          readinessProbe:
            httpGet:
              path: /api/public/v1.0/admin/healthCheck
              port: 8443
              scheme: HTTPS
            initialDelaySeconds: 30
            periodSeconds: 10

      volumes:
        - name: config
          configMap:
            name: ops-manager-config
        - name: data
          persistentVolumeClaim:
            claimName: ops-manager-data
        - name: tls
          secret:
            secretName: ops-manager-tls
---
# Service pour Ops Manager
apiVersion: v1
kind: Service
metadata:
  name: ops-manager
  namespace: ops-manager
spec:
  type: LoadBalancer
  selector:
    app: ops-manager
  ports:
    - name: http
      port: 8080
      targetPort: 8080
    - name: https
      port: 8443
      targetPort: 8443
```

---

## Installation de l'Enterprise Operator

### Via Helm

```bash
# Ajouter le repository Helm MongoDB Enterprise
helm repo add mongodb-enterprise https://mongodb.github.io/helm-charts
helm repo update

# CrÃ©er le namespace
kubectl create namespace mongodb-enterprise-operator

# CrÃ©er le secret pour les credentials Ops Manager
kubectl create secret generic ops-manager-credentials \
  --from-literal="publicKey=${OPS_MANAGER_API_KEY}" \
  --from-literal="privateKey=${OPS_MANAGER_API_SECRET}" \
  --namespace=mongodb-enterprise-operator

# Installer l'opÃ©rateur
helm install enterprise-operator mongodb-enterprise/mongodb-enterprise-operator \
  --namespace mongodb-enterprise-operator \
  --set operator.watchNamespace="*" \
  --set operator.createOperatorServiceAccount=true \
  --set registry.imagePullSecrets=mongodb-enterprise-registry \
  --set registry.operator="quay.io/mongodb/mongodb-enterprise-operator:1.23.0" \
  --set registry.database="quay.io/mongodb/mongodb-enterprise-database:7.0.5-ent" \
  --set registry.initDatabase="quay.io/mongodb/mongodb-enterprise-init-database:7.0.5-ent" \
  --set registry.opsManager="quay.io/mongodb/mongodb-enterprise-ops-manager:7.0.5" \
  --set registry.appDb="quay.io/mongodb/mongodb-enterprise-appdb:7.0.5"

# VÃ©rifier l'installation
kubectl get pods -n mongodb-enterprise-operator
kubectl get crd | grep mongodb.com
```

### Configuration Manuelle

```yaml
# enterprise-operator-config.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: mongodb-enterprise-operator
---
# ServiceAccount
apiVersion: v1
kind: ServiceAccount
metadata:
  name: mongodb-enterprise-operator
  namespace: mongodb-enterprise-operator
---
# ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: mongodb-enterprise-operator
rules:
  # CRDs
  - apiGroups: ["mongodb.com"]
    resources: ["*"]
    verbs: ["*"]

  # Standard resources
  - apiGroups: [""]
    resources: ["pods", "services", "configmaps", "secrets"]
    verbs: ["get", "list", "watch", "create", "update", "delete"]

  - apiGroups: ["apps"]
    resources: ["statefulsets", "deployments"]
    verbs: ["get", "list", "watch", "create", "update", "delete"]

  - apiGroups: [""]
    resources: ["events"]
    verbs: ["create", "patch"]
---
# ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: mongodb-enterprise-operator
subjects:
  - kind: ServiceAccount
    name: mongodb-enterprise-operator
    namespace: mongodb-enterprise-operator
roleRef:
  kind: ClusterRole
  name: mongodb-enterprise-operator
  apiGroup: rbac.authorization.k8s.io
---
# Deployment de l'opÃ©rateur
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mongodb-enterprise-operator
  namespace: mongodb-enterprise-operator
spec:
  replicas: 2
  selector:
    matchLabels:
      app: mongodb-enterprise-operator
  template:
    metadata:
      labels:
        app: mongodb-enterprise-operator
    spec:
      serviceAccountName: mongodb-enterprise-operator

      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchLabels:
                  app: mongodb-enterprise-operator
              topologyKey: kubernetes.io/hostname

      containers:
        - name: operator
          image: quay.io/mongodb/mongodb-enterprise-operator:1.23.0

          command:
            - /usr/local/bin/mongodb-enterprise-operator

          imagePullPolicy: Always

          env:
            - name: OPERATOR_ENV
              value: prod

            - name: WATCH_NAMESPACE
              value: "*"

            - name: OPERATOR_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace

            - name: MONGODB_ENTERPRISE_DATABASE_IMAGE
              value: quay.io/mongodb/mongodb-enterprise-database:7.0.5-ent

            - name: IMAGE_PULL_POLICY
              value: Always

          resources:
            limits:
              cpu: "1"
              memory: "1Gi"
            requests:
              cpu: "500m"
              memory: "512Mi"
```

---

## IntÃ©gration avec Ops Manager

### ConfigMap de Configuration Ops Manager

```yaml
# ops-manager-connection.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: ops-manager-connection
  namespace: mongodb
data:
  # URL de Ops Manager
  baseUrl: "https://ops-manager.company.com:8443"

  # Project ID dans Ops Manager
  projectName: "Production MongoDB"

  # Organisation ID
  orgId: "5f9a8b7c6d5e4f3a2b1c0d9e"
---
# Secret pour les credentials Ops Manager
apiVersion: v1
kind: Secret
metadata:
  name: ops-manager-credentials
  namespace: mongodb
type: Opaque
stringData:
  # API Keys (Public et Private)
  user: "ABCDEFGH"  # Public API Key
  publicApiKey: "ABCDEFGH"  # Public API Key (alias)
  privateApiKey: "1234567890abcdef1234567890abcdef1234567890abcdef"  # Private API Key
```

### MongoDB Enterprise Custom Resources

```yaml
# mongodb-enterprise-replica-set.yaml
apiVersion: mongodb.com/v1
kind: MongoDB
metadata:
  name: enterprise-replica-set
  namespace: mongodb
spec:
  # Nombre de membres
  members: 3

  # Version de MongoDB Enterprise
  version: "7.0.5-ent"

  # Type de dÃ©ploiement
  type: ReplicaSet

  # IntÃ©gration Ops Manager
  opsManager:
    configMapRef:
      name: ops-manager-connection

  # Credentials Ops Manager
  credentials: ops-manager-credentials

  # Configuration de sÃ©curitÃ©
  security:
    authentication:
      enabled: true
      modes: ["SCRAM"]
      internalCluster: "SCRAM"

    tls:
      enabled: true
      ca: mongodb-ca

      # Certificats additionnels
      additionalCertificateDomains:
        - "*.mongodb.svc.cluster.local"
        - "*.mongodb"

  # Utilisateurs (gÃ©rÃ©s via Ops Manager)
  users:
    - name: admin
      db: admin
      passwordSecretKeyRef:
        name: mongodb-admin-password
        key: password
      roles:
        - db: admin
          name: clusterAdmin
        - db: admin
          name: userAdminAnyDatabase
      scramCredentialsSecretName: mongodb-admin-scram

  # Configuration additionnelle MongoDB
  additionalMongodConfig:
    # Storage
    storage:
      engine: wiredTiger
      wiredTiger:
        engineConfig:
          cacheSizeGB: 6
          journalCompressor: snappy
        collectionConfig:
          blockCompressor: snappy
        indexConfig:
          prefixCompression: true

    # Networking
    net:
      maxIncomingConnections: 65536
      compression:
        compressors: "snappy,zstd,zlib"

    # Replication
    replication:
      oplogSizeMB: 10240

    # Security
    security:
      # Enterprise-only: Native encryption at rest
      enableEncryption: true
      encryptionKeyFile: /data/keys/mongodb-keyfile

      # Auditing (Enterprise feature)
      auditLog:
        destination: file
        format: JSON
        path: /data/db/audit.log
        filter: |
          {
            atype: {
              $in: [
                "authenticate",
                "createUser",
                "dropUser",
                "dropDatabase",
                "dropCollection",
                "createCollection",
                "dropIndex",
                "createIndex"
              ]
            }
          }

    # Operation Profiling
    operationProfiling:
      mode: slowOp
      slowOpThresholdMs: 100

    # System Log
    systemLog:
      verbosity: 0
      component:
        replication:
          verbosity: 1
        command:
          verbosity: 0

  # Configuration du StatefulSet
  statefulSet:
    spec:
      # Service Account
      serviceAccountName: mongodb-enterprise-database

      # Template des pods
      template:
        metadata:
          labels:
            app: enterprise-replica-set
          annotations:
            prometheus.io/scrape: "true"
            prometheus.io/port: "9216"

        spec:
          # Anti-affinity
          affinity:
            podAntiAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                - labelSelector:
                    matchLabels:
                      app: enterprise-replica-set-svc
                  topologyKey: kubernetes.io/hostname

            nodeAffinity:
              preferredDuringSchedulingIgnoredDuringExecution:
                - weight: 100
                  preference:
                    matchExpressions:
                      - key: mongodb-enterprise
                        operator: In
                        values:
                          - "true"

          # Topology Spread
          topologySpreadConstraints:
            - maxSkew: 1
              topologyKey: topology.kubernetes.io/zone
              whenUnsatisfiable: DoNotSchedule
              labelSelector:
                matchLabels:
                  app: enterprise-replica-set-svc

          # Init Containers
          initContainers:
            - name: install-automation-agent
              image: quay.io/mongodb/mongodb-enterprise-init-database:7.0.5-ent
              command:
                - /bin/bash
                - -c
                - |
                  # Installation de l'automation agent Ops Manager
                  cp -r /agent/* /mongodb-automation/

          # Conteneurs principaux
          containers:
            # MongoDB avec Automation Agent
            - name: mongod
              image: quay.io/mongodb/mongodb-enterprise-database:7.0.5-ent

              env:
                - name: AGENT_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: ops-manager-credentials
                      key: privateApiKey

              resources:
                limits:
                  cpu: "8"
                  memory: "32Gi"
                requests:
                  cpu: "4"
                  memory: "16Gi"

              volumeMounts:
                - name: data-volume
                  mountPath: /data/db
                - name: logs-volume
                  mountPath: /data/logs
                - name: mongodb-keyfile
                  mountPath: /data/keys
                  readOnly: true

            # Monitoring Agent
            - name: mongodb-agent-monitoring
              image: quay.io/mongodb/mongodb-agent:12.0.25

              env:
                - name: AGENT_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: ops-manager-credentials
                      key: privateApiKey

                - name: MMS_BASE_URL
                  valueFrom:
                    configMapKeyRef:
                      name: ops-manager-connection
                      key: baseUrl

              resources:
                limits:
                  cpu: "500m"
                  memory: "512Mi"
                requests:
                  cpu: "200m"
                  memory: "256Mi"

            # Backup Agent
            - name: mongodb-agent-backup
              image: quay.io/mongodb/mongodb-agent:12.0.25

              env:
                - name: AGENT_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: ops-manager-credentials
                      key: privateApiKey

                - name: MMS_BASE_URL
                  valueFrom:
                    configMapKeyRef:
                      name: ops-manager-connection
                      key: baseUrl

              resources:
                limits:
                  cpu: "1"
                  memory: "2Gi"
                requests:
                  cpu: "500m"
                  memory: "1Gi"

      # VolumeClaimTemplates
      volumeClaimTemplates:
        - metadata:
            name: data-volume
          spec:
            accessModes: ["ReadWriteOnce"]
            storageClassName: fast-ssd
            resources:
              requests:
                storage: 1Ti

        - metadata:
            name: logs-volume
          spec:
            accessModes: ["ReadWriteOnce"]
            storageClassName: standard
            resources:
              requests:
                storage: 100Gi

  # Configuration du backup (via Ops Manager)
  backup:
    enabled: true

    # Configuration de la stratÃ©gie de backup
    mode: "automated"  # Ops Manager gÃ¨re les backups

    # Politiques de rÃ©tention
    snapshotRetention:
      - count: 7
        unit: days
      - count: 4
        unit: weeks
      - count: 12
        unit: months

    # Scheduled snapshots
    snapshotSchedule:
      - frequencyType: "daily"
        frequencyInterval: 1
        retentionUnit: "days"
        retentionValue: 7

      - frequencyType: "weekly"
        frequencyInterval: 1
        retentionUnit: "weeks"
        retentionValue: 4

      - frequencyType: "monthly"
        frequencyInterval: 1
        retentionUnit: "months"
        retentionValue: 12
```

---

## Cluster ShardÃ© Enterprise

### Configuration ComplÃ¨te d'un Sharded Cluster

```yaml
# mongodb-enterprise-sharded-cluster.yaml
apiVersion: mongodb.com/v1
kind: MongoDB
metadata:
  name: enterprise-sharded-cluster
  namespace: mongodb
spec:
  # Type: Sharded Cluster
  type: ShardedCluster

  # Version Enterprise
  version: "7.0.5-ent"

  # IntÃ©gration Ops Manager
  opsManager:
    configMapRef:
      name: ops-manager-connection

  credentials: ops-manager-credentials

  # Configuration des Config Servers
  configServerCount: 3

  configSrv:
    members: 3

    statefulSet:
      spec:
        template:
          spec:
            affinity:
              podAntiAffinity:
                requiredDuringSchedulingIgnoredDuringExecution:
                  - labelSelector:
                      matchLabels:
                        app: enterprise-sharded-cluster-configsvr
                    topologyKey: kubernetes.io/hostname

            containers:
              - name: mongod
                resources:
                  limits:
                    cpu: "2"
                    memory: "8Gi"
                  requests:
                    cpu: "1"
                    memory: "4Gi"

        volumeClaimTemplates:
          - metadata:
              name: data-volume
            spec:
              accessModes: ["ReadWriteOnce"]
              storageClassName: fast-ssd
              resources:
                requests:
                  storage: 100Gi

  # Configuration des Mongos
  mongosCount: 3

  mongos:
    count: 3

    # Configuration des mongos
    additionalMongodConfig:
      net:
        maxIncomingConnections: 100000

    deployment:
      spec:
        template:
          spec:
            affinity:
              podAntiAffinity:
                preferredDuringSchedulingIgnoredDuringExecution:
                  - weight: 100
                    podAffinityTerm:
                      labelSelector:
                        matchLabels:
                          app: enterprise-sharded-cluster-mongos
                      topologyKey: kubernetes.io/hostname

            containers:
              - name: mongos
                resources:
                  limits:
                    cpu: "4"
                    memory: "8Gi"
                  requests:
                    cpu: "2"
                    memory: "4Gi"

  # Configuration des Shards
  shardCount: 3

  shardPodSpec:
    # Anti-affinity pour les shards
    podAntiAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        - labelSelector:
            matchLabels:
              app: enterprise-sharded-cluster-shard
          topologyKey: kubernetes.io/hostname

    # Topology spread
    podTopologySpreadConstraints:
      - maxSkew: 1
        topologyKey: topology.kubernetes.io/zone
        whenUnsatisfiable: DoNotSchedule
        labelSelector:
          matchLabels:
            app: enterprise-sharded-cluster-shard

    # Ressources par shard
    containers:
      - name: mongod
        resources:
          limits:
            cpu: "16"
            memory: "64Gi"
          requests:
            cpu: "8"
            memory: "32Gi"

    # Volumes par shard
    volumeClaimTemplates:
      - metadata:
          name: data-volume
        spec:
          accessModes: ["ReadWriteOnce"]
          storageClassName: premium-ssd
          resources:
            requests:
              storage: 2Ti

  # DÃ©finition de chaque shard
  shardSpec:
    shards:
      # Shard 0
      - name: shard-0
        members: 3
        shardPodSpec:
          podTemplate:
            metadata:
              labels:
                shard: "0"

        # Config spÃ©cifique au shard 0
        additionalMongodConfig:
          storage:
            wiredTiger:
              engineConfig:
                cacheSizeGB: 48

      # Shard 1
      - name: shard-1
        members: 3
        shardPodSpec:
          podTemplate:
            metadata:
              labels:
                shard: "1"

        additionalMongodConfig:
          storage:
            wiredTiger:
              engineConfig:
                cacheSizeGB: 48

      # Shard 2
      - name: shard-2
        members: 3
        shardPodSpec:
          podTemplate:
            metadata:
              labels:
                shard: "2"

        additionalMongodConfig:
          storage:
            wiredTiger:
              engineConfig:
                cacheSizeGB: 48

  # Configuration de sÃ©curitÃ©
  security:
    authentication:
      enabled: true
      modes: ["SCRAM"]
      internalCluster: "SCRAM"

    tls:
      enabled: true
      ca: mongodb-ca

  # Configuration additionnelle globale
  additionalMongodConfig:
    # Audit logging (Enterprise feature)
    auditLog:
      destination: file
      format: JSON
      path: /data/db/audit.log
      filter: |
        {
          atype: {
            $in: [
              "authenticate",
              "authCheck",
              "createUser",
              "dropUser",
              "dropDatabase",
              "dropCollection",
              "createCollection",
              "dropIndex",
              "createIndex",
              "insert",
              "update",
              "delete"
            ]
          }
        }

    # Operation Profiling
    operationProfiling:
      mode: slowOp
      slowOpThresholdMs: 50

  # Backup configuration (via Ops Manager)
  backup:
    enabled: true
    mode: "automated"

    # Point-in-time recovery
    pointInTimeWindowHours: 24

    # Snapshot retention
    snapshotRetention:
      - count: 3
        unit: days
      - count: 2
        unit: weeks
      - count: 6
        unit: months
```

---

## Authentification Enterprise

### Configuration LDAP

```yaml
# mongodb-ldap-auth.yaml
apiVersion: mongodb.com/v1
kind: MongoDB
metadata:
  name: mongodb-ldap
  namespace: mongodb
spec:
  members: 3
  type: ReplicaSet
  version: "7.0.5-ent"

  # Ops Manager integration
  opsManager:
    configMapRef:
      name: ops-manager-connection
  credentials: ops-manager-credentials

  # Security configuration
  security:
    authentication:
      enabled: true
      modes: ["LDAP"]  # LDAP authentication
      internalCluster: "SCRAM"

    # LDAP Configuration
    ldap:
      servers: "ldap.company.com"
      port: 636
      transportSecurity: "tls"

      # LDAP binding
      bind:
        method: "simple"
        saslMechanisms: "PLAIN"
        queryUser: "cn=mongodb,ou=services,dc=company,dc=com"
        queryPassword:
          secretRef:
            name: ldap-query-password
            key: password

      # User to DN mapping
      userToDNMapping: |
        [
          {
            match: "(.+)",
            substitution: "uid={0},ou=users,dc=company,dc=com"
          }
        ]

      # Authorization
      authz:
        queryTemplate: |
          {
            USER: "uid={USER},ou=users,dc=company,dc=com"
          }

  # Configuration MongoDB
  additionalMongodConfig:
    security:
      ldap:
        servers: "ldap.company.com"
        bind:
          method: "simple"
          queryUser: "cn=mongodb,ou=services,dc=company,dc=com"
          queryPassword: "${LDAP_QUERY_PASSWORD}"

        userToDNMapping: |
          [
            {
              match: "(.+)",
              ldapQuery: "ou=users,dc=company,dc=com??sub?(uid={0})"
            }
          ]

        authz:
          queryTemplate: |
            {
              USER: "uid={USER},ou=users,dc=company,dc=com",
              ROLES: [
                {
                  role: "read",
                  db: "test"
                }
              ]
            }
---
# ConfigMap pour les rÃ´les LDAP
apiVersion: v1
kind: ConfigMap
metadata:
  name: ldap-roles-mapping
  namespace: mongodb
data:
  roles.json: |
    {
      "ldapGroups": [
        {
          "dn": "cn=mongodb-admins,ou=groups,dc=company,dc=com",
          "roles": [
            {"role": "root", "db": "admin"}
          ]
        },
        {
          "dn": "cn=mongodb-developers,ou=groups,dc=company,dc=com",
          "roles": [
            {"role": "readWrite", "db": "app_db"},
            {"role": "read", "db": "config"}
          ]
        },
        {
          "dn": "cn=mongodb-readonly,ou=groups,dc=company,dc=com",
          "roles": [
            {"role": "read", "db": "app_db"}
          ]
        }
      ]
    }
```

### Configuration Kerberos

```yaml
# mongodb-kerberos-auth.yaml
apiVersion: mongodb.com/v1
kind: MongoDB
metadata:
  name: mongodb-kerberos
  namespace: mongodb
spec:
  members: 3
  type: ReplicaSet
  version: "7.0.5-ent"

  opsManager:
    configMapRef:
      name: ops-manager-connection
  credentials: ops-manager-credentials

  # Kerberos authentication
  security:
    authentication:
      enabled: true
      modes: ["GSSAPI"]  # Kerberos
      internalCluster: "SCRAM"

    # Kerberos configuration
    kerberos:
      enabled: true

      # Service principal
      principal: "mongodb/mongodb.company.com@COMPANY.COM"

      # Keytab secret
      keytabSecretRef:
        name: mongodb-kerberos-keytab
        key: keytab

      # KDC configuration
      krb5ConfigMap:
        name: krb5-config

  additionalMongodConfig:
    security:
      # Kerberos service name
      sasl:
        hostName: "mongodb.company.com"
        serviceName: "mongodb"

      # Authorization
      authorization: "enabled"
---
# ConfigMap pour krb5.conf
apiVersion: v1
kind: ConfigMap
metadata:
  name: krb5-config
  namespace: mongodb
data:
  krb5.conf: |
    [libdefaults]
      default_realm = COMPANY.COM
      dns_lookup_realm = false
      dns_lookup_kdc = true
      ticket_lifetime = 24h
      renew_lifetime = 7d
      forwardable = true

    [realms]
      COMPANY.COM = {
        kdc = kdc.company.com
        admin_server = kdc.company.com
      }

    [domain_realm]
      .company.com = COMPANY.COM
      company.com = COMPANY.COM
---
# Secret pour le keytab
apiVersion: v1
kind: Secret
metadata:
  name: mongodb-kerberos-keytab
  namespace: mongodb
type: Opaque
data:
  # Keytab gÃ©nÃ©rÃ© avec: ktutil
  keytab: <base64-encoded-keytab>
```

---

## Encryption at Rest Native

### Configuration du Chiffrement

```yaml
# mongodb-encryption-at-rest.yaml
apiVersion: mongodb.com/v1
kind: MongoDB
metadata:
  name: mongodb-encrypted
  namespace: mongodb
spec:
  members: 3
  type: ReplicaSet
  version: "7.0.5-ent"

  opsManager:
    configMapRef:
      name: ops-manager-connection
  credentials: ops-manager-credentials

  # Encryption at rest (Enterprise feature)
  security:
    encryption:
      enabled: true

      # Key management
      kmip:
        enabled: true
        serverName: "kmip.company.com"
        port: 5696

        # Client certificate for KMIP
        clientCertificateSecretRef:
          name: kmip-client-cert

        # CA certificate
        serverCASecretRef:
          name: kmip-ca-cert

      # Alternative: Local key management (moins sÃ©curisÃ©)
      # localKey:
      #   secretRef:
      #     name: mongodb-encryption-key

  additionalMongodConfig:
    security:
      # Enable encryption
      enableEncryption: true

      # KMIP configuration
      kmip:
        serverName: "kmip.company.com"
        port: 5696
        clientCertificateFile: "/etc/mongodb-kmip/client.pem"
        serverCAFile: "/etc/mongodb-kmip/ca.pem"

        # Key identifier
        keyIdentifier: "mongodb-master-key"

      # Encryption cipher mode
      encryptionCipherMode: "AES256-CBC"
---
# Secret pour les certificats KMIP
apiVersion: v1
kind: Secret
metadata:
  name: kmip-client-cert
  namespace: mongodb
type: kubernetes.io/tls
data:
  tls.crt: <base64-encoded-cert>
  tls.key: <base64-encoded-key>
---
apiVersion: v1
kind: Secret
metadata:
  name: kmip-ca-cert
  namespace: mongodb
type: Opaque
data:
  ca.crt: <base64-encoded-ca>
```

---

## Backup et Point-in-Time Recovery

### Configuration du Backup Ops Manager

```yaml
# mongodb-backup-config.yaml
apiVersion: mongodb.com/v1
kind: MongoDB
metadata:
  name: mongodb-with-backup
  namespace: mongodb
spec:
  members: 3
  type: ReplicaSet
  version: "7.0.5-ent"

  opsManager:
    configMapRef:
      name: ops-manager-connection
  credentials: ops-manager-credentials

  # Configuration complÃ¨te du backup
  backup:
    enabled: true

    # Mode de backup
    mode: "automated"  # GÃ©rÃ© par Ops Manager

    # Point-in-time recovery
    pointInTimeWindowHours: 72  # 3 jours de PITR

    # Scheduled snapshots
    snapshotSchedule:
      # Quotidien
      - frequencyType: "daily"
        frequencyInterval: 1
        retentionUnit: "days"
        retentionValue: 7
        startTime: "02:00"  # 2h du matin

      # Hebdomadaire (dimanche)
      - frequencyType: "weekly"
        frequencyInterval: 1
        retentionUnit: "weeks"
        retentionValue: 4
        startTime: "03:00"
        dayOfWeek: "sunday"

      # Mensuel (1er du mois)
      - frequencyType: "monthly"
        frequencyInterval: 1
        retentionUnit: "months"
        retentionValue: 12
        startTime: "04:00"
        dayOfMonth: 1

      # Annuel (1er janvier)
      - frequencyType: "yearly"
        frequencyInterval: 1
        retentionUnit: "years"
        retentionValue: 7
        startTime: "05:00"
        dayOfMonth: 1
        monthOfYear: "january"

    # Configuration de la rÃ©fÃ©rence de snapshot
    snapshotRetention:
      - count: 7
        unit: days
      - count: 4
        unit: weeks
      - count: 12
        unit: months
      - count: 7
        unit: years

    # Storage configuration
    storage:
      # S3 storage
      s3:
        bucket: "mongodb-backups-prod"
        pathStyleAccessEnabled: false

        # Credentials
        credentialsSecretRef:
          name: backup-s3-credentials

      # Encryption des backups
      encryptionEnabled: true
      encryptionKeySecretRef:
        name: backup-encryption-key
---
# Secret pour S3
apiVersion: v1
kind: Secret
metadata:
  name: backup-s3-credentials
  namespace: mongodb
type: Opaque
stringData:
  accessKeyId: "<aws-access-key>"
  secretAccessKey: "<aws-secret-key>"
  region: "eu-west-3"
```

### Restore depuis Backup avec Point-in-Time

```bash
#!/bin/bash
# scripts/restore-pitr.sh

set -euo pipefail

NAMESPACE="mongodb"
MONGODB_NAME="mongodb-with-backup"
OPS_MANAGER_URL="https://ops-manager.company.com:8443"
OPS_MANAGER_API_KEY="<public-key>"
OPS_MANAGER_API_SECRET="<private-key>"

# Timestamp pour le point-in-time restore
# Format: 2024-01-15T10:30:00Z
RESTORE_TIMESTAMP="${1:-}"

if [ -z "$RESTORE_TIMESTAMP" ]; then
  echo "Usage: $0 <restore-timestamp>"
  echo "Example: $0 2024-01-15T10:30:00Z"
  exit 1
fi

echo "ğŸ”„ Point-in-Time Restore to: $RESTORE_TIMESTAMP"

# 1. Obtenir le Project ID depuis Ops Manager
PROJECT_ID=$(curl -s -u "${OPS_MANAGER_API_KEY}:${OPS_MANAGER_API_SECRET}" \
  "${OPS_MANAGER_URL}/api/public/v1.0/groups/byName/${MONGODB_NAME}" | \
  jq -r '.id')

echo "ğŸ“‹ Project ID: $PROJECT_ID"

# 2. Obtenir le Cluster ID
CLUSTER_ID=$(curl -s -u "${OPS_MANAGER_API_KEY}:${OPS_MANAGER_API_SECRET}" \
  "${OPS_MANAGER_URL}/api/public/v1.0/groups/${PROJECT_ID}/clusters" | \
  jq -r ".results[] | select(.clusterName==\"${MONGODB_NAME}\") | .id")

echo "ğŸ“‹ Cluster ID: $CLUSTER_ID"

# 3. CrÃ©er un restore job
RESTORE_JOB=$(cat <<EOF
{
  "delivery": {
    "methodName": "AUTOMATED_RESTORE",
    "targetClusterId": "${CLUSTER_ID}",
    "targetGroupId": "${PROJECT_ID}"
  },
  "snapshotId": "pointInTime",
  "pointInTimeUTCMillis": $(date -d "$RESTORE_TIMESTAMP" +%s)000
}
EOF
)

echo "ğŸ”„ Creating restore job..."

RESTORE_JOB_ID=$(curl -s -X POST \
  -u "${OPS_MANAGER_API_KEY}:${OPS_MANAGER_API_SECRET}" \
  -H "Content-Type: application/json" \
  "${OPS_MANAGER_URL}/api/public/v1.0/groups/${PROJECT_ID}/clusters/${CLUSTER_ID}/backup/restoreJobs" \
  -d "$RESTORE_JOB" | jq -r '.id')

echo "ğŸ“‹ Restore Job ID: $RESTORE_JOB_ID"

# 4. Surveiller le restore job
echo "â³ Monitoring restore progress..."

while true; do
  STATUS=$(curl -s -u "${OPS_MANAGER_API_KEY}:${OPS_MANAGER_API_SECRET}" \
    "${OPS_MANAGER_URL}/api/public/v1.0/groups/${PROJECT_ID}/clusters/${CLUSTER_ID}/backup/restoreJobs/${RESTORE_JOB_ID}" | \
    jq -r '.statusName')

  echo "Status: $STATUS"

  if [ "$STATUS" = "FINISHED" ]; then
    echo "âœ… Restore completed successfully!"
    break
  elif [ "$STATUS" = "FAILED" ]; then
    echo "âŒ Restore failed!"
    exit 1
  fi

  sleep 30
done

# 5. VÃ©rifier l'Ã©tat du cluster
echo "ğŸ“Š Verifying cluster status..."

kubectl exec "${MONGODB_NAME}-0" -n "$NAMESPACE" -- \
  mongosh --eval "
    rs.status();
    db.serverStatus().version;
  "

echo "âœ… Point-in-Time Restore completed!"
```

---

## Monitoring AvancÃ©

### Integration Prometheus avec Ops Manager

```yaml
# mongodb-monitoring-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-mongodb-config
  namespace: monitoring
data:
  mongodb-ops-manager.yml: |
    # Scrape configuration pour Ops Manager
    - job_name: 'ops-manager'
      static_configs:
        - targets: ['ops-manager.ops-manager.svc.cluster.local:8443']

      scheme: https
      tls_config:
        insecure_skip_verify: true

      basic_auth:
        username: 'prometheus'
        password: '<prometheus-password>'

      metrics_path: '/api/public/v1.0/prometheus'

      relabel_configs:
        - source_labels: [__address__]
          target_label: instance
          replacement: 'ops-manager'

    # Scrape des mÃ©triques des clusters MongoDB
    - job_name: 'mongodb-enterprise'
      kubernetes_sd_configs:
        - role: pod
          namespaces:
            names:
              - mongodb

      relabel_configs:
        - source_labels: [__meta_kubernetes_pod_label_app]
          regex: '.*-svc'
          action: keep

        - source_labels: [__meta_kubernetes_pod_name]
          target_label: mongodb_pod

        - source_labels: [__meta_kubernetes_pod_label_statefulset_kubernetes_io_pod_name]
          target_label: replica_member
---
# ServiceMonitor pour MongoDB Enterprise
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: mongodb-enterprise
  namespace: mongodb
spec:
  selector:
    matchLabels:
      app.kubernetes.io/component: mongodb

  endpoints:
    - port: metrics
      path: /metrics
      interval: 30s

      relabelings:
        - sourceLabels: [__meta_kubernetes_pod_name]
          targetLabel: pod

        - sourceLabels: [__meta_kubernetes_namespace]
          targetLabel: namespace
---
# PrometheusRule pour alertes Enterprise
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: mongodb-enterprise-alerts
  namespace: mongodb
spec:
  groups:
    - name: mongodb-enterprise
      interval: 30s
      rules:
        # Ops Manager connectivity
        - alert: OpsManagerDown
          expr: up{job="ops-manager"} == 0
          for: 2m
          labels:
            severity: critical
          annotations:
            summary: "Ops Manager is down"
            description: "Ops Manager has been down for more than 2 minutes"

        # Backup alerts
        - alert: BackupJobFailed
          expr: mongodb_backup_last_successful_timestamp < (time() - 86400)
          for: 1h
          labels:
            severity: warning
          annotations:
            summary: "Backup job failed"
            description: "No successful backup in the last 24 hours for {{ $labels.cluster }}"

        # Encryption at rest
        - alert: EncryptionDisabled
          expr: mongodb_security_encryption_enabled == 0
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Encryption at rest is disabled"
            description: "Encryption at rest is disabled on {{ $labels.pod }}"

        # LDAP authentication
        - alert: LDAPAuthenticationFailure
          expr: rate(mongodb_ldap_auth_failures_total[5m]) > 10
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High LDAP authentication failure rate"
            description: "{{ $value }} LDAP auth failures per second on {{ $labels.pod }}"
```

---

## Multi-Cluster et Disaster Recovery

### Configuration Multi-Cluster

```yaml
# mongodb-multi-cluster.yaml
# Cluster Primary (eu-west-3)
apiVersion: mongodb.com/v1
kind: MongoDB
metadata:
  name: mongodb-primary
  namespace: mongodb
  labels:
    cluster-role: primary
    region: eu-west-3
spec:
  members: 5
  type: ReplicaSet
  version: "7.0.5-ent"

  opsManager:
    configMapRef:
      name: ops-manager-connection
  credentials: ops-manager-credentials

  # Configuration des membres avec prioritÃ©s
  memberConfig:
    # 3 membres dans la rÃ©gion primaire
    - priority: 7
      votes: 1
      tags:
        region: "eu-west-3"
        datacenter: "primary"
    - priority: 6
      votes: 1
      tags:
        region: "eu-west-3"
        datacenter: "primary"
    - priority: 5
      votes: 1
      tags:
        region: "eu-west-3"
        datacenter: "primary"

    # 2 membres dans la rÃ©gion secondaire (pour DR)
    - priority: 1
      votes: 1
      tags:
        region: "us-east-1"
        datacenter: "dr"
    - priority: 0
      votes: 1
      tags:
        region: "us-east-1"
        datacenter: "dr"

  # PrÃ©fÃ©rences de lecture
  additionalMongodConfig:
    # Write Concern adaptÃ© au multi-rÃ©gion
    setParameter:
      # Attendre la majoritÃ©
      defaultWriteConcern:
        w: "majority"
        wtimeout: 5000

  statefulSet:
    spec:
      template:
        spec:
          # Distribuer selon les rÃ©gions
          affinity:
            nodeAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                nodeSelectorTerms:
                  - matchExpressions:
                      - key: topology.kubernetes.io/region
                        operator: In
                        values:
                          - eu-west-3
                          - us-east-1
---
# ReadPreference pour les applications
apiVersion: v1
kind: ConfigMap
metadata:
  name: mongodb-connection-config
  namespace: applications
data:
  connection-string: |
    mongodb://mongodb-primary-0.mongodb-primary-svc.mongodb.svc.cluster.local:27017,\
    mongodb-primary-1.mongodb-primary-svc.mongodb.svc.cluster.local:27017,\
    mongodb-primary-2.mongodb-primary-svc.mongodb.svc.cluster.local:27017,\
    mongodb-primary-3.mongodb-primary-svc.mongodb.svc.cluster.local:27017,\
    mongodb-primary-4.mongodb-primary-svc.mongodb.svc.cluster.local:27017/\
    ?replicaSet=mongodb-primary&\
    readPreference=nearest&\
    readPreferenceTags=region:eu-west-3&\
    readPreferenceTags=region:us-east-1&\
    w=majority&\
    wtimeoutMS=5000
```

---

## Best Practices Enterprise

### Checklist Production Enterprise

```yaml
# enterprise-production-checklist.yaml
---
licensing:
  - âœ… Licence Enterprise activÃ©e et valide
  - âœ… Support Enterprise contractÃ©
  - âœ… Ops Manager dÃ©ployÃ© et configurÃ©
  - âœ… Organisation et projets crÃ©Ã©s dans Ops Manager

infrastructure:
  - âœ… Kubernetes cluster production-ready
  - âœ… Multiple availability zones
  - âœ… StorageClass performant (SSD, IOPS Ã©levÃ©s)
  - âœ… Network policies configurÃ©es
  - âœ… LoadBalancers ou Ingress configurÃ©s

security:
  - âœ… TLS/SSL activÃ© et forcÃ©
  - âœ… Authentication enterprise (LDAP ou Kerberos)
  - âœ… Encryption at rest avec KMIP
  - âœ… Audit logging activÃ©
  - âœ… RBAC Kubernetes configurÃ©
  - âœ… Secrets management (Vault recommandÃ©)
  - âœ… Network segmentation

monitoring:
  - âœ… Ops Manager monitoring actif
  - âœ… Prometheus/Grafana intÃ©grÃ©
  - âœ… Alertes configurÃ©es
  - âœ… Logs centralisÃ©s
  - âœ… Performance Advisor activÃ© dans Ops Manager
  - âœ… Real-time monitoring dashboards

backup:
  - âœ… Backup automatisÃ© via Ops Manager
  - âœ… Point-in-time recovery configurÃ© (72h minimum)
  - âœ… Snapshots multiples (daily, weekly, monthly, yearly)
  - âœ… Backup storage off-site (S3, GCS)
  - âœ… Backup encryption activÃ©
  - âœ… Restore testÃ© rÃ©guliÃ¨rement (quarterly)
  - âœ… RTO/RPO dÃ©finis et testÃ©s

high_availability:
  - âœ… Minimum 5 membres pour multi-rÃ©gion
  - âœ… PrioritÃ©s configurÃ©es selon les rÃ©gions
  - âœ… Write Concern: majority
  - âœ… Read Preference: nearest avec tags
  - âœ… PodDisruptionBudget configurÃ©
  - âœ… Anti-affinity rules strictes

disaster_recovery:
  - âœ… Plan de DR documentÃ©
  - âœ… ProcÃ©dures de failover testÃ©es
  - âœ… Restore procedures validÃ©es
  - âœ… Runbooks Ã  jour
  - âœ… Contact d'escalation dÃ©fini
  - âœ… DR drills rÃ©guliers (quarterly)

compliance:
  - âœ… Audit logs activÃ©s et archivÃ©s
  - âœ… Encryption at rest et in transit
  - âœ… Access controls documentÃ©s
  - âœ… Compliance reports gÃ©nÃ©rÃ©s
  - âœ… Data retention policies appliquÃ©es
  - âœ… GDPR/HIPAA requirements satisfied

operations:
  - âœ… Documentation complÃ¨te
  - âœ… Runbooks pour incidents courants
  - âœ… ProcÃ©dures de scaling
  - âœ… Change management process
  - âœ… Incident response plan
  - âœ… On-call rotation dÃ©finie
  - âœ… SLAs dÃ©finis et mesurÃ©s
```

---

## Conclusion

Le MongoDB Enterprise Kubernetes Operator offre des fonctionnalitÃ©s avancÃ©es essentielles pour les dÃ©ploiements critiques :

**FonctionnalitÃ©s ClÃ©s :**
- **Ops Manager Integration** : Gestion centralisÃ©e multi-cluster
- **Automated Backups** : Backups continus avec point-in-time recovery
- **Advanced Authentication** : LDAP, Kerberos, x.509
- **Encryption at Rest** : Chiffrement natif avec KMIP
- **Audit Logging** : Compliance et traÃ§abilitÃ© complÃ¨te
- **Sharded Clusters** : Support complet avec automation
- **Enterprise Support** : 24/7 avec SLAs

**Avantages :**
- RÃ©duction de la complexitÃ© opÃ©rationnelle
- ConformitÃ© aux standards enterprise
- Haute disponibilitÃ© garantie
- Disaster recovery automatisÃ©
- ObservabilitÃ© complÃ¨te

Pour les organisations nÃ©cessitant ces fonctionnalitÃ©s enterprise, l'investissement dans la licence Enterprise et Ops Manager est rapidement rentabilisÃ© par la rÃ©duction des coÃ»ts opÃ©rationnels et l'amÃ©lioration de la fiabilitÃ©.

---


â­ï¸ [Helm Charts](/18-devops-deploiement/05-helm-charts.md)
