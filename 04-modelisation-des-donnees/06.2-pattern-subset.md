ğŸ” Retour au [Sommaire](/SOMMAIRE.md)

# 4.6.2 Pattern Subset (Sous-ensemble de DonnÃ©es)

## Introduction

Le **Pattern Subset** est une technique de modÃ©lisation qui consiste Ã  **stocker seulement une partie (un sous-ensemble) des donnÃ©es liÃ©es** directement dans le document principal, tout en conservant **l'ensemble complet des donnÃ©es dans une collection sÃ©parÃ©e**.

Ce pattern est particuliÃ¨rement utile lorsque vous avez beaucoup de donnÃ©es liÃ©es, mais que vous n'avez besoin que d'une petite partie de ces donnÃ©es dans la plupart de vos requÃªtes.

> **Analogie simple :** Imaginez un livre avec des centaines de pages. Sur la couverture (votre document principal), vous mettez seulement un rÃ©sumÃ© et les premiÃ¨res pages. Si quelqu'un veut lire tout le livre, il peut l'ouvrir (faire une requÃªte Ã  une autre collection), mais la plupart du temps, le rÃ©sumÃ© suffit.

---

## Le ProblÃ¨me que le Pattern Subset RÃ©sout

### ScÃ©nario ProblÃ©matique

Imaginez un site e-commerce oÃ¹ chaque produit peut avoir des **centaines de commentaires** :

```javascript
// âŒ PROBLÃˆME : Document trop volumineux avec tous les commentaires
{
  _id: ObjectId("507f1f77bcf86cd799439011"),
  nom: "Smartphone XYZ",
  prix: 599.99,
  description: "Un smartphone performant...",
  commentaires: [
    {
      auteur: "Jean",
      note: 5,
      texte: "Excellent produit ! La qualitÃ© est au rendez-vous...",
      date: ISODate("2024-01-15"),
      images: ["url1.jpg", "url2.jpg"],
      votes: { utile: 45, nonUtile: 2 }
    },
    // ... 500 autres commentaires dÃ©taillÃ©s
  ]
}
```

**ProblÃ¨mes :**
1. âš ï¸ Le document devient **Ã©norme** (peut atteindre 16 Mo)
2. âš ï¸ Vous chargez **tous les commentaires** mÃªme si vous ne voulez afficher que le produit
3. âš ï¸ Les performances se **dÃ©gradent** avec le temps

### Solution avec le Pattern Subset

Le Pattern Subset propose de ne garder qu'un **sous-ensemble** des commentaires dans le document produit :

```javascript
// âœ… SOLUTION : Ne garder que les commentaires les plus rÃ©cents/utiles
{
  _id: ObjectId("507f1f77bcf86cd799439011"),
  nom: "Smartphone XYZ",
  prix: 599.99,
  description: "Un smartphone performant...",

  // Sous-ensemble : Seulement les 5 commentaires les plus rÃ©cents
  derniersCommentaires: [
    {
      auteur: "Marie",
      note: 5,
      texte: "Parfait !",
      date: ISODate("2024-11-20")
    },
    {
      auteur: "Pierre",
      note: 4,
      texte: "TrÃ¨s bon rapport qualitÃ©-prix",
      date: ISODate("2024-11-18")
    },
    // ... 3 autres commentaires rÃ©cents
  ],

  // Statistiques globales
  statistiquesCommentaires: {
    total: 523,
    moyenneNote: 4.3,
    distribution: { 5: 320, 4: 150, 3: 40, 2: 10, 1: 3 }
  }
}

// Collection sÃ©parÃ©e pour TOUS les commentaires
// Collection: commentaires
{
  _id: ObjectId("607f1f77bcf86cd799439012"),
  produitId: ObjectId("507f1f77bcf86cd799439011"),
  auteur: "Jean",
  note: 5,
  texte: "Excellent produit ! La qualitÃ© est au rendez-vous...",
  date: ISODate("2024-01-15"),
  images: ["url1.jpg", "url2.jpg"],
  votes: { utile: 45, nonUtile: 2 }
}
// ... 522 autres documents de commentaires
```

---

## Concept ClÃ© : Duplication StratÃ©gique

Le Pattern Subset repose sur une **duplication intentionnelle** des donnÃ©es :

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Document Principal (Produit)    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Subset : 5 derniers avis      â”‚ â”‚ â† Duplication partielle
â”‚  â”‚  + Statistiques agrÃ©gÃ©es       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

            â†“ RÃ©fÃ©rence

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Collection ComplÃ¨te (Commentaires) â”‚
â”‚  â€¢ Tous les 523 commentaires        â”‚ â† DonnÃ©es complÃ¨tes
â”‚  â€¢ Avec tous les dÃ©tails            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

Cette duplication est **acceptable** car :
- âœ… Elle amÃ©liore drastiquement les performances (90% des requÃªtes)
- âœ… Le sous-ensemble reste petit et gÃ©rable
- âœ… Les donnÃ©es complÃ¨tes restent accessibles quand nÃ©cessaire

---

## Quand Utiliser le Pattern Subset ?

### 1. **Relation "One-to-Many" avec Beaucoup d'Ã‰lÃ©ments**

Quand vous avez une relation oÃ¹ le "Many" reprÃ©sente des centaines ou milliers d'Ã©lÃ©ments.

**Exemple : Blog avec Beaucoup de Commentaires**

```javascript
// Document article
{
  _id: ObjectId("507f1f77bcf86cd799439020"),
  titre: "Les 10 meilleures pratiques MongoDB",
  contenu: "Dans cet article, nous allons explorer...",
  auteur: "Sophie Martin",
  datePublication: ISODate("2024-01-15"),

  // Subset : Top 3 commentaires les plus utiles
  topCommentaires: [
    {
      auteur: "DevExpert",
      texte: "Excellent article, trÃ¨s instructif !",
      votes: 156,
      date: ISODate("2024-01-16")
    },
    {
      auteur: "CodeMaster",
      texte: "Merci pour ces conseils pratiques",
      votes: 89,
      date: ISODate("2024-01-17")
    },
    {
      auteur: "MongoFan",
      texte: "TrÃ¨s utile pour mon projet",
      votes: 67,
      date: ISODate("2024-01-20")
    }
  ],

  statsCommentaires: {
    total: 342,
    nombreVotes: 1523
  }
}

// Collection commentaires (tous les commentaires)
{
  _id: ObjectId("607f1f77bcf86cd799439021"),
  articleId: ObjectId("507f1f77bcf86cd799439020"),
  auteur: "JeanDupont",
  texte: "IntÃ©ressant...",
  votes: 12,
  date: ISODate("2024-01-18")
}
```

### 2. **Affichage de Listes NÃ©cessitant des DÃ©tails Partiels**

Quand vous listez des Ã©lÃ©ments qui ont beaucoup de dÃ©tails, mais vous n'avez besoin que d'un aperÃ§u.

**Exemple : Liste de Commandes avec Quelques Articles**

```javascript
// Document commande
{
  _id: ObjectId("507f1f77bcf86cd799439030"),
  numeroCommande: "CMD-2024-001",
  client: {
    id: ObjectId("507f1f77bcf86cd799439031"),
    nom: "Claire Dubois",
    email: "claire@example.com"
  },
  dateCommande: ISODate("2024-11-15"),
  statut: "expediee",

  // Subset : AperÃ§u des 3 premiers articles
  apercuArticles: [
    {
      nom: "Smartphone XYZ",
      sku: "PHONE-001",
      quantite: 1,
      prix: 599.99,
      image: "phone.jpg"
    },
    {
      nom: "Coque de protection",
      sku: "CASE-045",
      quantite: 2,
      prix: 19.99,
      image: "case.jpg"
    },
    {
      nom: "CÃ¢ble USB-C",
      sku: "CABLE-010",
      quantite: 1,
      prix: 12.99,
      image: "cable.jpg"
    }
  ],

  // Statistiques
  resume: {
    totalArticles: 15,  // Il y a en fait 15 articles
    montantTotal: 1247.85,
    poidsTotal: 3.5
  }
}

// Collection lignesCommande (tous les articles de toutes les commandes)
{
  _id: ObjectId("607f1f77bcf86cd799439032"),
  commandeId: ObjectId("507f1f77bcf86cd799439030"),
  nom: "Ã‰couteurs Bluetooth",
  sku: "HEAD-023",
  quantite: 1,
  prix: 79.99,
  poids: 0.2,
  image: "headphones.jpg",
  garantie: "2 ans",
  descriptifComplet: "Ã‰couteurs sans fil avec rÃ©duction de bruit active..."
}
```

### 3. **DonnÃ©es Historiques avec Besoin d'AccÃ¨s RÃ©cent**

Quand vous stockez un historique, mais que vous consultez principalement les donnÃ©es rÃ©centes.

**Exemple : Historique des Transactions Bancaires**

```javascript
// Document compte bancaire
{
  _id: ObjectId("507f1f77bcf86cd799439040"),
  numeroCompte: "FR7630001007941234567890185",
  titulaire: {
    nom: "Martin Leroux",
    email: "martin@example.com"
  },
  solde: 5234.56,
  devise: "EUR",

  // Subset : 10 derniÃ¨res transactions
  dernieresTransactions: [
    {
      date: ISODate("2024-11-28"),
      type: "debit",
      montant: -45.00,
      libelle: "Restaurant Le Gourmet",
      categorie: "Alimentation"
    },
    {
      date: ISODate("2024-11-27"),
      type: "credit",
      montant: 2500.00,
      libelle: "Virement salaire",
      categorie: "Revenu"
    },
    // ... 8 autres transactions rÃ©centes
  ],

  // Statistiques
  statsTransactions: {
    totalTransactions: 1247,
    moyenneMensuelle: -1834.50,
    derniereTransaction: ISODate("2024-11-28")
  }
}

// Collection transactions (historique complet)
{
  _id: ObjectId("607f1f77bcf86cd799439041"),
  compteId: ObjectId("507f1f77bcf86cd799439040"),
  date: ISODate("2023-05-15"),
  type: "debit",
  montant: -89.50,
  libelle: "Achat supermarchÃ©",
  categorie: "Alimentation",
  geolocalisation: { lat: 48.8566, lon: 2.3522 },
  methode: "carte_bancaire",
  commercant: {
    nom: "Super U",
    siret: "12345678901234"
  }
}
```

---

## Avantages du Pattern Subset

### âœ… 1. **Performance Optimale pour les RequÃªtes Courantes**

La plupart du temps, vous n'avez besoin que du sous-ensemble :

```javascript
// âš¡ TrÃ¨s rapide : Une seule requÃªte, document lÃ©ger
const produit = await db.produits.findOne({ _id: produitId });
// Vous avez le produit + les 5 derniers commentaires + les stats
```

### âœ… 2. **Ã‰vite la Limite de 16 Mo**

MÃªme avec des milliers d'Ã©lÃ©ments liÃ©s, le document principal reste petit :

```javascript
// Document principal : ~5 Ko
// Collection complÃ¨te : IllimitÃ©e (millions de documents possibles)
```

### âœ… 3. **FlexibilitÃ© : Le Meilleur des Deux Mondes**

Vous bÃ©nÃ©ficiez de :
- âœ… La rapiditÃ© du pattern Embedded (pour le subset)
- âœ… La scalabilitÃ© du pattern RÃ©fÃ©rence (pour les donnÃ©es complÃ¨tes)

### âœ… 4. **AmÃ©lioration de l'ExpÃ©rience Utilisateur**

Les pages se chargent plus rapidement avec les informations essentielles :

```javascript
// Affichage initial : Rapide (subset)
// Page de dÃ©tails : Chargement Ã  la demande (collection complÃ¨te)
```

---

## ImplÃ©mentation du Pattern Subset

### Ã‰tape 1 : DÃ©finir le Sous-ensemble

Identifiez quelles donnÃ©es sont le plus souvent consultÃ©es :

```javascript
/**
 * Questions Ã  se poser :
 * - Quelles donnÃ©es sont affichÃ©es 90% du temps ?
 * - Quelle est la taille raisonnable du subset ? (< 100 Ã©lÃ©ments recommandÃ©)
 * - Les donnÃ©es du subset changent-elles souvent ?
 */

// Exemple : Pour des commentaires
const subset = {
  critere: "5 commentaires les plus rÃ©cents",
  tailleMax: 5,
  champs: ["auteur", "note", "texte", "date"], // Pas tous les champs
  renouvellement: "Ã€ chaque nouveau commentaire"
};
```

### Ã‰tape 2 : CrÃ©er la Structure de DonnÃ©es

```javascript
// Collection produits (avec subset)
{
  _id: ObjectId("..."),
  // DonnÃ©es produit
  nom: "...",
  prix: 599.99,

  // Subset des commentaires
  derniersCommentaires: [
    // 5 commentaires max
  ],

  // Statistiques agrÃ©gÃ©es
  stats: {
    totalCommentaires: 523,
    moyenneNote: 4.3
  }
}

// Collection commentaires (donnÃ©es complÃ¨tes)
{
  _id: ObjectId("..."),
  produitId: ObjectId("..."),
  // Toutes les donnÃ©es du commentaire
}
```

### Ã‰tape 3 : GÃ©rer les Insertions

Quand un nouveau commentaire arrive, mettez Ã  jour le subset :

```javascript
// Fonction pour ajouter un commentaire
async function ajouterCommentaire(produitId, nouveauCommentaire) {
  // 1. InsÃ©rer dans la collection complÃ¨te
  const commentaireId = await db.commentaires.insertOne({
    produitId: produitId,
    auteur: nouveauCommentaire.auteur,
    texte: nouveauCommentaire.texte,
    note: nouveauCommentaire.note,
    date: new Date(),
    votes: { utile: 0, nonUtile: 0 },
    images: nouveauCommentaire.images || []
  });

  // 2. Mettre Ã  jour le subset dans le produit
  await db.produits.updateOne(
    { _id: produitId },
    {
      // Ajouter le nouveau commentaire au dÃ©but
      $push: {
        derniersCommentaires: {
          $each: [{
            auteur: nouveauCommentaire.auteur,
            texte: nouveauCommentaire.texte,
            note: nouveauCommentaire.note,
            date: new Date()
          }],
          $position: 0,    // Au dÃ©but du tableau
          $slice: 5        // Garder seulement les 5 premiers
        }
      },
      // Mettre Ã  jour les statistiques
      $inc: {
        "stats.totalCommentaires": 1
      }
    }
  );

  // 3. Recalculer la moyenne (si nÃ©cessaire)
  // Peut Ãªtre fait de maniÃ¨re asynchrone
}
```

### Ã‰tape 4 : RequÃªter les DonnÃ©es

```javascript
// RequÃªte simple : Seulement le subset
const produit = await db.produits.findOne({ _id: produitId });
// produit.derniersCommentaires contient les 5 derniers

// RequÃªte complÃ¨te : Si l'utilisateur veut tous les commentaires
const tousLesCommentaires = await db.commentaires
  .find({ produitId: produitId })
  .sort({ date: -1 })
  .toArray();
```

---

## StratÃ©gies de SÃ©lection du Subset

### StratÃ©gie 1 : Les Plus RÃ©cents

Les N Ã©lÃ©ments les plus rÃ©cents :

```javascript
{
  // Exemple : 10 derniÃ¨res connexions
  dernieresConnexions: [
    { date: ISODate("2024-11-28"), ip: "192.168.1.1" },
    { date: ISODate("2024-11-27"), ip: "192.168.1.2" },
    // ... 8 autres
  ]
}
```

### StratÃ©gie 2 : Les Plus Populaires/Utiles

Les N Ã©lÃ©ments avec le meilleur score :

```javascript
{
  // Exemple : 3 commentaires les plus utiles
  topCommentaires: [
    { texte: "...", votes: 234 },
    { texte: "...", votes: 189 },
    { texte: "...", votes: 145 }
  ]
}
```

### StratÃ©gie 3 : Ã‰chantillon ReprÃ©sentatif

Un Ã©chantillon stratÃ©gique :

```javascript
{
  // Exemple : 1 commentaire de chaque note (5 Ã  1 Ã©toile)
  echantillonCommentaires: [
    { note: 5, texte: "Excellent !" },
    { note: 4, texte: "TrÃ¨s bien" },
    { note: 3, texte: "Correct" },
    { note: 2, texte: "DÃ©cevant" },
    { note: 1, texte: "Mauvais" }
  ]
}
```

### StratÃ©gie 4 : Statistiques AgrÃ©gÃ©es

Remplacer les dÃ©tails par des statistiques :

```javascript
{
  // Au lieu de tous les commentaires, des statistiques
  statistiques: {
    totalCommentaires: 523,
    moyenneNote: 4.3,
    distribution: {
      5: 320, // 320 commentaires 5 Ã©toiles
      4: 150,
      3: 40,
      2: 10,
      1: 3
    },
    derniereDate: ISODate("2024-11-28")
  }
}
```

---

## Exemples Pratiques DÃ©taillÃ©s

### Exemple 1 : RÃ©seau Social - Publications avec Likes

```javascript
// Collection publications
{
  _id: ObjectId("507f1f77bcf86cd799439050"),
  auteur: {
    id: ObjectId("507f1f77bcf86cd799439051"),
    nom: "Sophie Martin",
    avatar: "sophie.jpg"
  },
  contenu: "Magnifique coucher de soleil ! ğŸŒ…",
  image: "sunset.jpg",
  datePublication: ISODate("2024-11-20T18:30:00Z"),

  // Subset : 10 premiers utilisateurs qui ont likÃ©
  premiersLikes: [
    { userId: ObjectId("..."), nom: "Jean" },
    { userId: ObjectId("..."), nom: "Marie" },
    { userId: ObjectId("..."), nom: "Pierre" },
    // ... 7 autres
  ],

  // Statistiques
  statsLikes: {
    total: 1247,  // Au total 1247 likes
    montrerPlus: true  // Indique qu'il y en a plus
  }
}

// Collection likes (tous les likes)
{
  _id: ObjectId("607f1f77bcf86cd799439052"),
  publicationId: ObjectId("507f1f77bcf86cd799439050"),
  userId: ObjectId("707f1f77bcf86cd799439053"),
  userName: "Alexandre",
  date: ISODate("2024-11-20T19:15:00Z")
}
```

**Affichage :**
```
Sophie Martin â€¢ Il y a 8 jours
Magnifique coucher de soleil ! ğŸŒ…
[Photo]

â¤ï¸ 1,247 J'aime
Jean, Marie, Pierre et 1244 autres personnes aiment Ã§a
[Voir tous les likes] â† Click pour charger les 1247 likes complets
```

### Exemple 2 : Application de SantÃ© - Mesures Corporelles

```javascript
// Collection utilisateurs
{
  _id: ObjectId("507f1f77bcf86cd799439060"),
  nom: "Claire Dubois",
  email: "claire@example.com",
  dateNaissance: ISODate("1990-05-15"),

  // Subset : 30 derniers jours de mesures
  dernieresMesures: [
    { date: ISODate("2024-11-28"), poids: 65.2, tension: "120/80" },
    { date: ISODate("2024-11-27"), poids: 65.4, tension: "118/78" },
    // ... 28 autres jours
  ],

  // Statistiques et tendances
  tendances: {
    totalMesures: 547,  // 1.5 an de donnÃ©es
    poidsActuel: 65.2,
    poidsInitial: 72.0,
    evolution: -6.8,
    derniereMesure: ISODate("2024-11-28")
  }
}

// Collection mesures (historique complet)
{
  _id: ObjectId("607f1f77bcf86cd799439061"),
  userId: ObjectId("507f1f77bcf86cd799439060"),
  date: ISODate("2023-06-10"),
  poids: 71.5,
  tension: "125/82",
  frequenceCardiaque: 72,
  glycemie: 95,
  notes: "AprÃ¨s exercice intense"
}
```

### Exemple 3 : Site de Recettes - Avis Culinaires

```javascript
// Collection recettes
{
  _id: ObjectId("507f1f77bcf86cd799439070"),
  titre: "Tarte aux pommes traditionnelle",
  auteur: "Chef Martin",
  ingredients: [
    { nom: "Pommes", quantite: "6", unite: "unitÃ©s" },
    { nom: "PÃ¢te brisÃ©e", quantite: "300", unite: "g" },
    // ...
  ],
  etapes: [
    "PrÃ©chauffer le four Ã  180Â°C",
    "Ã‰plucher et couper les pommes",
    // ...
  ],
  tempsPreparation: 30,
  tempsCuisson: 45,

  // Subset : Mix stratÃ©gique d'avis
  avisRepresentatifs: [
    // 1 avis 5 Ã©toiles le plus rÃ©cent
    {
      note: 5,
      auteur: "GourmetPro",
      commentaire: "Recette parfaite ! Exactement comme ma grand-mÃ¨re la faisait.",
      date: ISODate("2024-11-25"),
      votes: 45
    },
    // 1 avis 4 Ã©toiles le plus utile
    {
      note: 4,
      auteur: "HomeCook",
      commentaire: "TrÃ¨s bonne recette, j'ai ajoutÃ© un peu de cannelle.",
      date: ISODate("2024-11-15"),
      votes: 32
    },
    // 1 avis 3 Ã©toiles pour Ã©quilibre
    {
      note: 3,
      auteur: "NoviceCook",
      commentaire: "Bien mais un peu long pour un dÃ©butant.",
      date: ISODate("2024-11-10"),
      votes: 12
    }
  ],

  // Statistiques complÃ¨tes
  statistiquesAvis: {
    total: 234,
    moyenneNote: 4.6,
    distribution: { 5: 180, 4: 40, 3: 10, 2: 3, 1: 1 },
    tauxReussite: 92  // % qui referaient la recette
  }
}

// Collection avis (tous les avis)
{
  _id: ObjectId("607f1f77bcf86cd799439071"),
  recetteId: ObjectId("507f1f77bcf86cd799439070"),
  note: 5,
  auteur: "BakingLover",
  commentaire: "DÃ©licieuse ! Toute la famille a adorÃ©.",
  date: ISODate("2024-11-01"),
  votes: { utile: 8, nonUtile: 0 },
  photos: ["tarte1.jpg", "tarte2.jpg"],
  aRefait: true
}
```

---

## Maintenance du Subset

### Mise Ã  Jour Automatique

Utilisez des **hooks** ou **triggers** pour maintenir le subset Ã  jour :

```javascript
// Exemple avec MongoDB Change Streams
const changeStream = db.commentaires.watch();

changeStream.on('change', async (change) => {
  if (change.operationType === 'insert') {
    const commentaire = change.fullDocument;

    // Mettre Ã  jour le subset
    await mettreAJourSubset(commentaire.produitId, commentaire);
  }
});

async function mettreAJourSubset(produitId, nouveauCommentaire) {
  await db.produits.updateOne(
    { _id: produitId },
    {
      $push: {
        derniersCommentaires: {
          $each: [nouveauCommentaire],
          $position: 0,
          $slice: 5
        }
      },
      $inc: { "stats.totalCommentaires": 1 }
    }
  );
}
```

### Reconstruction PÃ©riodique

Pour certains subsets (comme "les plus populaires"), une reconstruction pÃ©riodique est nÃ©cessaire :

```javascript
// Script de maintenance Ã  exÃ©cuter pÃ©riodiquement (ex: chaque nuit)
async function reconstruireSubsetsPopulaires() {
  const produits = await db.produits.find({}).toArray();

  for (const produit of produits) {
    // RÃ©cupÃ©rer les 3 commentaires les plus utiles
    const topCommentaires = await db.commentaires
      .find({ produitId: produit._id })
      .sort({ "votes.utile": -1 })
      .limit(3)
      .toArray();

    // Mettre Ã  jour le subset
    await db.produits.updateOne(
      { _id: produit._id },
      { $set: { topCommentaires: topCommentaires } }
    );
  }
}
```

---

## Quand NE PAS Utiliser le Pattern Subset ?

### âŒ 1. Le Subset Change TrÃ¨s FrÃ©quemment

Si votre subset doit Ãªtre mis Ã  jour plusieurs fois par seconde :

```javascript
// âŒ MAUVAIS : Compteur temps rÃ©el mis Ã  jour 100x/seconde
{
  streamerId: "user123",
  derniersViewers: [/* change constamment */]
}

// âœ… MEILLEUR : Collection sÃ©parÃ©e uniquement
```

### âŒ 2. Toutes les DonnÃ©es Sont Toujours NÃ©cessaires

Si vous avez toujours besoin de toutes les donnÃ©es :

```javascript
// âŒ MAUVAIS : Vous consultez toujours tous les Ã©lÃ©ments
{
  ordreId: 123,
  articles: [/* subset de 5 */]  // Mais vous affichez toujours les 50
}

// âœ… MEILLEUR : Pattern Embedded ou RÃ©fÃ©rence pure
```

### âŒ 3. Le Subset Est Presque Aussi Grand Que les DonnÃ©es ComplÃ¨tes

Si votre subset reprÃ©sente 80-90% des donnÃ©es :

```javascript
// âŒ MAUVAIS : Subset de 90 Ã©lÃ©ments sur 100 totaux
// â†’ Pas de gain, seulement de la complexitÃ©

// âœ… MEILLEUR : Embedded ou RÃ©fÃ©rence selon le cas
```

---

## Comparaison des Patterns

| Aspect | Embedded | Subset | RÃ©fÃ©rence |
|--------|----------|--------|-----------|
| **Performance lecture** | âš¡âš¡âš¡ Excellent | âš¡âš¡ TrÃ¨s bon | âš¡ Bon |
| **Nombre d'Ã©lÃ©ments** | < 100 | < 1000 dans subset | IllimitÃ© |
| **ComplexitÃ©** | âœ… Simple | âš ï¸ Moyenne | âš ï¸ Complexe |
| **Duplication** | âš ï¸ Possible | âš ï¸ ContrÃ´lÃ©e | âœ… Aucune |
| **Maintenance** | âœ… Facile | âš ï¸ Moyenne | âœ… Facile |
| **RequÃªtes** | 1 requÃªte | 1-2 requÃªtes | 2+ requÃªtes |
| **Taille document** | âš ï¸ LimitÃ©e | âœ… ContrÃ´lÃ©e | âœ… Petite |

---

## Bonnes Pratiques

### âœ… 1. Limiter la Taille du Subset

Le subset doit rester **petit et gÃ©rable** :

```javascript
// âœ… BON : Subset de 5-20 Ã©lÃ©ments
derniersCommentaires: [/* 5 Ã©lÃ©ments */]

// âš ï¸ Ã€ Ã‰VITER : Subset trop grand
derniersCommentaires: [/* 500 Ã©lÃ©ments */]
```

### âœ… 2. Inclure des Indicateurs

Indiquez clairement qu'il y a plus de donnÃ©es :

```javascript
{
  derniersCommentaires: [/* subset */],
  stats: {
    totalCommentaires: 523,
    montrerPlus: true,  // â† Indicateur
    derniereMiseAJour: ISODate("2024-11-28")
  }
}
```

### âœ… 3. DÃ©finir une StratÃ©gie de Mise Ã  Jour Claire

Documentez comment et quand le subset est mis Ã  jour :

```javascript
/**
 * StratÃ©gie de mise Ã  jour du subset "derniersCommentaires":
 * - Mise Ã  jour : Ã€ chaque nouveau commentaire
 * - MÃ©thode : $push avec $slice
 * - CritÃ¨re : 5 commentaires les plus rÃ©cents
 * - Champs : auteur, note, texte, date (pas d'images)
 */
```

### âœ… 4. Utiliser des Index AppropriÃ©s

Indexez les champs utilisÃ©s pour reconstruire le subset :

```javascript
// Index pour rÃ©cupÃ©rer rapidement les Ã©lÃ©ments du subset
db.commentaires.createIndex({ produitId: 1, date: -1 });
db.commentaires.createIndex({ produitId: 1, "votes.utile": -1 });
```

### âœ… 5. Monitorer la CohÃ©rence

VÃ©rifiez pÃ©riodiquement que les subsets sont cohÃ©rents :

```javascript
// Script de vÃ©rification
async function verifierCoherence() {
  const produits = await db.produits.find({}).toArray();

  for (const produit of produits) {
    const comptageReel = await db.commentaires.countDocuments({
      produitId: produit._id
    });

    if (comptageReel !== produit.stats.totalCommentaires) {
      console.log(`IncohÃ©rence dÃ©tectÃ©e pour produit ${produit._id}`);
      // Reconstruire le subset
    }
  }
}
```

---

## Conclusion

Le **Pattern Subset** est une solution Ã©lÃ©gante pour gÃ©rer des relations "One-to-Many" avec beaucoup d'Ã©lÃ©ments :

**Avantages :**
- âœ… Excellentes performances pour les requÃªtes courantes
- âœ… Ã‰vite la limite de 16 Mo
- âœ… Combine les avantages d'Embedded et RÃ©fÃ©rence
- âœ… AmÃ©liore l'expÃ©rience utilisateur

**ConsidÃ©rations :**
- âš ï¸ ComplexitÃ© accrue (deux emplacements pour les donnÃ©es)
- âš ï¸ NÃ©cessite une maintenance du subset
- âš ï¸ Duplication contrÃ´lÃ©e des donnÃ©es

**RÃ¨gle d'or :** Utilisez le Pattern Subset quand vous avez beaucoup de donnÃ©es liÃ©es (>100 Ã©lÃ©ments), mais que vous n'avez besoin que d'un petit aperÃ§u (5-20 Ã©lÃ©ments) dans la majoritÃ© de vos requÃªtes.

---

## Ressources ComplÃ©mentaires

- [Documentation MongoDB - Pattern Subset](https://www.mongodb.com/blog/post/building-with-patterns-the-subset-pattern)

---


â­ï¸ [Pattern Extended Reference](/04-modelisation-des-donnees/06.3-pattern-extended-reference.md)
