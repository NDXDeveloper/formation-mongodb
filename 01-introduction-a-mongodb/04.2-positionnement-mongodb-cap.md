ğŸ” Retour au [Sommaire](/SOMMAIRE.md)

# 1.4.2 Positionnement de MongoDB dans le thÃ©orÃ¨me CAP

## Introduction

Maintenant que vous comprenez le thÃ©orÃ¨me CAP, voyons comment MongoDB se positionne par rapport Ã  ces trois propriÃ©tÃ©s. MongoDB est gÃ©nÃ©ralement classÃ© comme un systÃ¨me **CP** (Consistency + Partition Tolerance), mais la rÃ©alitÃ© est plus nuancÃ©e.

MongoDB offre des mÃ©canismes configurables qui permettent d'ajuster le compromis entre cohÃ©rence et disponibilitÃ© selon vos besoins. Cette flexibilitÃ© est l'une des forces de MongoDB.

---

## MongoDB : un systÃ¨me CP par dÃ©faut

### Pourquoi MongoDB est-il classÃ© CP ?

Par dÃ©faut, MongoDB privilÃ©gie la **cohÃ©rence** des donnÃ©es sur la **disponibilitÃ©** en cas de partition rÃ©seau.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                MongoDB dans le triangle CAP                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚                           Consistency                               â”‚
â”‚                               /\                                    â”‚
â”‚                              /  \                                   â”‚
â”‚                             / â—  \    â† MongoDB est ici             â”‚
â”‚                            / CP   \                                 â”‚
â”‚                           /________\                                â”‚
â”‚                          /\        /\                               â”‚
â”‚                         /  \      /  \                              â”‚
â”‚                        /    \    /    \                             â”‚
â”‚                       /______\  /______\                            â”‚
â”‚                                                                     â”‚
â”‚               Partition              Availability                   â”‚
â”‚               tolerance                                             â”‚
â”‚                                                                     â”‚
â”‚   MongoDB par dÃ©faut :                                              â”‚
â”‚   âœ… Consistency (CohÃ©rence)                                        â”‚
â”‚   âœ… Partition Tolerance                                            â”‚
â”‚   âš ï¸ Availability (peut Ãªtre rÃ©duite en cas de partition)           â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Le comportement par dÃ©faut

Dans une configuration standard (Replica Set), MongoDB garantit que :

1. **Toutes les Ã©critures passent par le Primary** (nÅ“ud principal)
2. **Les lectures par dÃ©faut vont au Primary** Ã©galement
3. **En cas de panne du Primary**, le systÃ¨me **Ã©lit un nouveau Primary** avant d'accepter de nouvelles Ã©critures

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Comportement par dÃ©faut de MongoDB                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   Fonctionnement normal :                                           â”‚
â”‚                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚   â”‚  PRIMARY  â”‚â—„â”€â”€â”€â”€â–ºâ”‚ SECONDARY â”‚â—„â”€â”€â”€â”€â–ºâ”‚ SECONDARY â”‚               â”‚
â”‚   â”‚  (Ã©critureâ”‚ sync â”‚  (copie)  â”‚ sync â”‚  (copie)  â”‚               â”‚
â”‚   â”‚  + lecture)      â”‚           â”‚      â”‚           â”‚               â”‚
â”‚   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚         â”‚                                                           â”‚
â”‚         â–¼                                                           â”‚
â”‚      Clients                                                        â”‚
â”‚                                                                     â”‚
â”‚   â€¢ Ã‰critures : uniquement sur le Primary                           â”‚
â”‚   â€¢ Lectures : par dÃ©faut sur le Primary                            â”‚
â”‚   â€¢ RÃ©plication : automatique vers les Secondaries                  â”‚
â”‚                                                                     â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚                                                                     â”‚
â”‚   En cas de panne du Primary :                                      â”‚
â”‚                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚   â”‚  PRIMARY  â”‚  âœ‚ï¸  â”‚ SECONDARY â”‚â—„â”€â”€â”€â”€â–ºâ”‚ SECONDARY â”‚               â”‚
â”‚   â”‚    âŒ     â”‚      â”‚           â”‚      â”‚           â”‚               â”‚
â”‚   â”‚  (panne)  â”‚      â”‚           â”‚      â”‚           â”‚               â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                            â”‚                                        â”‚
â”‚                      Ã‰lection                                       â”‚
â”‚                            â–¼                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚   â”‚ (ancien)  â”‚      â”‚  PRIMARY  â”‚â—„â”€â”€â”€â”€â–ºâ”‚ SECONDARY â”‚               â”‚
â”‚   â”‚  PRIMARY  â”‚      â”‚  (nouveau)â”‚      â”‚           â”‚               â”‚
â”‚   â”‚    âŒ     â”‚      â”‚     âœ…    â”‚      â”‚     âœ…    â”‚               â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                            â”‚                                        â”‚
â”‚                            â–¼                                        â”‚
â”‚                         Clients                                     â”‚
â”‚                                                                     â”‚
â”‚   Pendant l'Ã©lection (~10-30 secondes) :                            â”‚
â”‚   â€¢ Ã‰critures REFUSÃ‰ES (indisponibilitÃ© temporaire)                 â”‚
â”‚   â€¢ Lectures possibles sur Secondaries (si configurÃ©)               â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ce que cela signifie concrÃ¨tement

| Situation | Comportement MongoDB | PropriÃ©tÃ© CAP |
|-----------|---------------------|---------------|
| Fonctionnement normal | Lectures et Ã©critures cohÃ©rentes | C + A |
| Panne d'un Secondary | Aucun impact, le Primary continue | C + A |
| Panne du Primary | Ã‰lection en cours, Ã©critures refusÃ©es | C (pas A) |
| Partition rÃ©seau | Le groupe majoritaire Ã©lit un Primary | C + P |

---

## L'architecture Replica Set et le CAP

### Le concept de majoritÃ©

MongoDB utilise le concept de **majoritÃ©** pour garantir la cohÃ©rence et gÃ©rer les partitions :

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Le concept de majoritÃ©                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   Replica Set de 3 membres :                                        â”‚
â”‚                                                                     â”‚
â”‚   MajoritÃ© = (3 Ã· 2) + 1 = 2 membres                                â”‚
â”‚                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚   â”‚ Membre 1â”‚    â”‚ Membre 2â”‚    â”‚ Membre 3â”‚                         â”‚
â”‚   â”‚  (vote) â”‚    â”‚  (vote) â”‚    â”‚  (vote) â”‚                         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                                                                     â”‚
â”‚   Pour Ã©lire un Primary : besoin de 2 votes minimum                 â”‚
â”‚                                                                     â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚                                                                     â”‚
â”‚   Replica Set de 5 membres :                                        â”‚
â”‚                                                                     â”‚
â”‚   MajoritÃ© = (5 Ã· 2) + 1 = 3 membres                                â”‚
â”‚                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”                            â”‚
â”‚   â”‚ M1 â”‚  â”‚ M2 â”‚  â”‚ M3 â”‚  â”‚ M4 â”‚  â”‚ M5 â”‚                            â”‚
â”‚   â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜                            â”‚
â”‚                                                                     â”‚
â”‚   Pour Ã©lire un Primary : besoin de 3 votes minimum                 â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Gestion des partitions rÃ©seau

Voyons comment MongoDB rÃ©agit en cas de partition rÃ©seau :

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Partition rÃ©seau dans un Replica Set                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   Situation initiale : Replica Set de 3 membres                     â”‚
â”‚                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚   â”‚ PRIMARY â”‚â—„â”€â”€â–ºâ”‚SECONDARYâ”‚â—„â”€â”€â–ºâ”‚SECONDARYâ”‚                         â”‚
â”‚   â”‚  Paris  â”‚    â”‚  Lyon   â”‚    â”‚Marseilleâ”‚                         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                                                                     â”‚
â”‚   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                     â”‚
â”‚   Partition : Paris isolÃ© de Lyon et Marseille                      â”‚
â”‚                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â•‘    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â—„â”€â”€â–ºâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚   â”‚ PRIMARY â”‚    â•‘    â”‚SECONDARYâ”‚    â”‚SECONDARYâ”‚                    â”‚
â”‚   â”‚  Paris  â”‚    â•‘    â”‚  Lyon   â”‚    â”‚Marseilleâ”‚                    â”‚
â”‚   â”‚ (isolÃ©) â”‚    â•‘    â”‚         â”‚    â”‚         â”‚                    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â•‘    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                  â•‘                                                  â”‚
â”‚    MinoritÃ©      â•‘         MajoritÃ© (2 sur 3)                       â”‚
â”‚    (1 sur 3)     â•‘                                                  â”‚
â”‚                                                                     â”‚
â”‚   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                     â”‚
â”‚   RÃ©sultat :                                                        â”‚
â”‚                                                                     â”‚
â”‚   CÃ´tÃ© Paris (minoritÃ©) :                                           â”‚
â”‚   â€¢ L'ancien Primary dÃ©tecte qu'il est seul                         â”‚
â”‚   â€¢ Il se RÃ‰TROGRADE en Secondary                                   â”‚
â”‚   â€¢ Il REFUSE les Ã©critures                                         â”‚
â”‚   â€¢ Lectures possibles (donnÃ©es potentiellement obsolÃ¨tes)          â”‚
â”‚                                                                     â”‚
â”‚   CÃ´tÃ© Lyon-Marseille (majoritÃ©) :                                  â”‚
â”‚   â€¢ Ã‰lection d'un nouveau Primary                                   â”‚
â”‚   â€¢ Le systÃ¨me continue de fonctionner                              â”‚
â”‚   â€¢ Ã‰critures et lectures acceptÃ©es                                 â”‚
â”‚                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â•‘    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â—„â”€â”€â–ºâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚   â”‚SECONDARYâ”‚    â•‘    â”‚ PRIMARY â”‚    â”‚SECONDARYâ”‚                    â”‚
â”‚   â”‚  Paris  â”‚    â•‘    â”‚  Lyon   â”‚    â”‚Marseilleâ”‚                    â”‚
â”‚   â”‚(read-only)   â•‘    â”‚(nouveau)â”‚    â”‚         â”‚                    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â•‘    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Pourquoi ce comportement garantit la cohÃ©rence

Ce mÃ©canisme de majoritÃ© empÃªche le **split-brain** (cerveau divisÃ©), situation oÃ¹ deux nÅ“uds croiraient Ãªtre Primary simultanÃ©ment :

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PrÃ©vention du split-brain                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   âŒ ScÃ©nario CATASTROPHIQUE (sans rÃ¨gle de majoritÃ©) :             â”‚
â”‚                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â•‘    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚   â”‚ PRIMARY â”‚    â•‘    â”‚ PRIMARY â”‚   â† DEUX Primary !                â”‚
â”‚   â”‚   A     â”‚    â•‘    â”‚   B     â”‚                                   â”‚
â”‚   â”‚ solde:  â”‚    â•‘    â”‚ solde:  â”‚                                   â”‚
â”‚   â”‚  800â‚¬   â”‚    â•‘    â”‚ 1000â‚¬   â”‚   â† DonnÃ©es DIVERGENTES           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â•‘    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚       â–²          â•‘        â–²                                         â”‚
â”‚       â”‚          â•‘        â”‚                                         â”‚
â”‚   Client 1       â•‘    Client 2                                      â”‚
â”‚   "Retrait 200â‚¬" â•‘    "Voir solde"                                  â”‚
â”‚                  â•‘                                                  â”‚
â”‚   â†’ IncohÃ©rence ! Quel est le vrai solde ?                          â”‚
â”‚                                                                     â”‚
â”‚   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                     â”‚
â”‚   âœ… Comportement MongoDB (avec rÃ¨gle de majoritÃ©) :                â”‚
â”‚                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â•‘    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚   â”‚SECONDARYâ”‚    â•‘    â”‚ PRIMARY â”‚   â† UN SEUL Primary               â”‚
â”‚   â”‚   A     â”‚    â•‘    â”‚   B     â”‚                                   â”‚
â”‚   â”‚(read-only)   â•‘    â”‚         â”‚                                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â•‘    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚       â–²          â•‘        â–²                                         â”‚
â”‚       â”‚          â•‘        â”‚                                         â”‚
â”‚   Client 1       â•‘    Client 2                                      â”‚
â”‚   "Ã‰chec Ã©criture"â•‘   "SuccÃ¨s"                                      â”‚
â”‚                  â•‘                                                  â”‚
â”‚   â†’ CohÃ©rence garantie ! Un seul Primary peut accepter              â”‚
â”‚     les Ã©critures.                                                  â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Les mÃ©canismes de configuration du CAP

MongoDB offre trois mÃ©canismes principaux pour ajuster le compromis CAP :

1. **Write Concern** : ContrÃ´le la durabilitÃ© des Ã©critures
2. **Read Concern** : ContrÃ´le la cohÃ©rence des lectures
3. **Read Preference** : ContrÃ´le oÃ¹ les lectures sont effectuÃ©es

### 1. Write Concern (Niveau de confirmation d'Ã©criture)

Le **Write Concern** dÃ©finit le niveau de garantie demandÃ© pour une opÃ©ration d'Ã©criture.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Write Concern                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   w: 1 (par dÃ©faut)                                                 â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                 â”‚
â”‚   Confirmation quand le PRIMARY a Ã©crit                             â”‚
â”‚                                                                     â”‚
â”‚   Client â”€â”€â–º PRIMARY â”€â”€â–º "OK"                                       â”‚
â”‚                â”‚                                                    â”‚
â”‚                â–¼ (rÃ©plication asynchrone)                           â”‚
â”‚            SECONDARY                                                â”‚
â”‚                                                                     â”‚
â”‚   âœ… Rapide                                                         â”‚
â”‚   âš ï¸ Risque : perte si le Primary tombe avant rÃ©plication           â”‚
â”‚                                                                     â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚                                                                     â”‚
â”‚   w: "majority"                                                     â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                     â”‚
â”‚   Confirmation quand la MAJORITÃ‰ a Ã©crit                            â”‚
â”‚                                                                     â”‚
â”‚   Client â”€â”€â–º PRIMARY â”€â”€â”¬â”€â”€â–º SECONDARY â”€â”€â–º "OK"                      â”‚
â”‚                        â”‚                                            â”‚
â”‚                        â””â”€â”€â–º SECONDARY                               â”‚
â”‚                                                                     â”‚
â”‚   âœ… DonnÃ©es durables (survivent Ã  une panne du Primary)            â”‚
â”‚   âš ï¸ Plus lent (attend la rÃ©plication)                              â”‚
â”‚                                                                     â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚                                                                     â”‚
â”‚   w: 0 (fire and forget)                                            â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                             â”‚
â”‚   Aucune confirmation attendue                                      â”‚
â”‚                                                                     â”‚
â”‚   Client â”€â”€â–º PRIMARY                                                â”‚
â”‚          â””â”€â”€â–º "OK" (immÃ©diat, sans attendre)                        â”‚
â”‚                                                                     â”‚
â”‚   âœ… TrÃ¨s rapide                                                    â”‚
â”‚   âŒ Aucune garantie (peut Ãªtre perdu silencieusement)              â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Exemples de Write Concern

```javascript
// Write Concern par dÃ©faut (w: 1)
db.users.insertOne({ name: "Alice" })

// Write Concern "majority" - plus sÃ»r
db.users.insertOne(
  { name: "Bob" },
  { writeConcern: { w: "majority" } }
)

// Write Concern avec timeout
db.users.insertOne(
  { name: "Charlie" },
  { writeConcern: { w: "majority", wtimeout: 5000 } }
)

// Write Concern avec journal
db.users.insertOne(
  { name: "Diana" },
  { writeConcern: { w: 1, j: true } }  // j: true = attendre le journal
)
```

#### Tableau rÃ©capitulatif Write Concern

| Write Concern | Signification | CohÃ©rence | Performance |
|---------------|---------------|-----------|-------------|
| `w: 0` | Aucune confirmation | âŒ Faible | âš¡ TrÃ¨s rapide |
| `w: 1` | Confirmation Primary | âš ï¸ Moyenne | ğŸš€ Rapide |
| `w: "majority"` | Confirmation majoritÃ© | âœ… Forte | ğŸ¢ Plus lent |
| `w: <n>` | Confirmation de n nÅ“uds | âœ… Configurable | Variable |

### 2. Read Concern (Niveau de cohÃ©rence de lecture)

Le **Read Concern** dÃ©finit le niveau de cohÃ©rence des donnÃ©es lues.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Read Concern                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   "local" (par dÃ©faut)                                              â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
â”‚   Lit les donnÃ©es locales du nÅ“ud, sans garantie de durabilitÃ©      â”‚
â”‚                                                                     â”‚
â”‚   â€¢ Peut lire des donnÃ©es pas encore rÃ©pliquÃ©es                     â”‚
â”‚   â€¢ Peut lire des donnÃ©es qui seront annulÃ©es (rollback)            â”‚
â”‚   â€¢ Le plus rapide                                                  â”‚
â”‚                                                                     â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚                                                                     â”‚
â”‚   "majority"                                                        â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                        â”‚
â”‚   Lit uniquement les donnÃ©es confirmÃ©es par la majoritÃ©             â”‚
â”‚                                                                     â”‚
â”‚   â€¢ Garantit que les donnÃ©es ne seront pas annulÃ©es                 â”‚
â”‚   â€¢ Les donnÃ©es ont survÃ©cu Ã  une panne potentielle du Primary      â”‚
â”‚   â€¢ LÃ©gÃ¨rement plus lent                                            â”‚
â”‚                                                                     â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚                                                                     â”‚
â”‚   "linearizable"                                                    â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                   â”‚
â”‚   Garantit la lecture des donnÃ©es les plus rÃ©centes                 â”‚
â”‚                                                                     â”‚
â”‚   â€¢ CohÃ©rence la plus forte                                         â”‚
â”‚   â€¢ Attend que toutes les Ã©critures antÃ©rieures soient visibles     â”‚
â”‚   â€¢ Le plus lent                                                    â”‚
â”‚   â€¢ Uniquement sur le Primary                                       â”‚
â”‚                                                                     â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚                                                                     â”‚
â”‚   "snapshot" (transactions uniquement)                              â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                             â”‚
â”‚   Vue cohÃ©rente Ã  un instant T                                      â”‚
â”‚                                                                     â”‚
â”‚   â€¢ UtilisÃ© dans les transactions multi-documents                   â”‚
â”‚   â€¢ Isolation des lectures pendant la transaction                   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Exemples de Read Concern

```javascript
// Read Concern par dÃ©faut (local)
db.users.find({ city: "Paris" })

// Read Concern "majority" - donnÃ©es durables
db.users.find({ city: "Paris" }).readConcern("majority")

// Read Concern "linearizable" - cohÃ©rence maximale
db.users.find({ city: "Paris" }).readConcern("linearizable")

// Configuration au niveau de la collection
db.users.find({ city: "Paris" }, { readConcern: { level: "majority" } })
```

#### Tableau rÃ©capitulatif Read Concern

| Read Concern | DonnÃ©es lues | CohÃ©rence | Performance |
|--------------|--------------|-----------|-------------|
| `local` | Locales, peut-Ãªtre non rÃ©pliquÃ©es | âš ï¸ Faible | âš¡ Rapide |
| `available` | Locales (sharding) | âš ï¸ Faible | âš¡ Rapide |
| `majority` | ConfirmÃ©es par majoritÃ© | âœ… Forte | ğŸš€ Moyen |
| `linearizable` | Les plus rÃ©centes | âœ…âœ… TrÃ¨s forte | ğŸ¢ Lent |
| `snapshot` | CohÃ©rentes dans transaction | âœ… Forte | Variable |

### 3. Read Preference (PrÃ©fÃ©rence de lecture)

Le **Read Preference** dÃ©finit sur quels nÅ“uds les lectures peuvent Ãªtre effectuÃ©es.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Read Preference                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚   â”‚ PRIMARY â”‚       â”‚SECONDARYâ”‚       â”‚SECONDARYâ”‚                   â”‚
â”‚   â”‚         â”‚       â”‚   #1    â”‚       â”‚   #2    â”‚                   â”‚
â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                   â”‚
â”‚        â”‚                 â”‚                 â”‚                        â”‚
â”‚   â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚        â”‚                 â”‚                 â”‚                        â”‚
â”‚        â–¼                 â–¼                 â–¼                        â”‚
â”‚                                                                     â”‚
â”‚   "primary" (dÃ©faut)                                                â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                â”‚
â”‚   Toutes les lectures vont au Primary                               â”‚
â”‚   âœ… CohÃ©rence maximale                                             â”‚
â”‚   âŒ Charge concentrÃ©e sur le Primary                               â”‚
â”‚                                                                     â”‚
â”‚   "primaryPreferred"                                                â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                â”‚
â”‚   Primary si disponible, sinon Secondary                            â”‚
â”‚   âœ… Haute disponibilitÃ© des lectures                               â”‚
â”‚   âš ï¸ DonnÃ©es potentiellement obsolÃ¨tes si fallback                  â”‚
â”‚                                                                     â”‚
â”‚   "secondary"                                                       â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                       â”‚
â”‚   Uniquement les Secondaries                                        â”‚
â”‚   âœ… DÃ©charge le Primary                                            â”‚
â”‚   âš ï¸ DonnÃ©es potentiellement obsolÃ¨tes (dÃ©lai de rÃ©plication)       â”‚
â”‚                                                                     â”‚
â”‚   "secondaryPreferred"                                              â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
â”‚   Secondary si disponible, sinon Primary                            â”‚
â”‚   âœ… Ã‰quilibre charge et disponibilitÃ©                              â”‚
â”‚   âš ï¸ DonnÃ©es potentiellement obsolÃ¨tes                              â”‚
â”‚                                                                     â”‚
â”‚   "nearest"                                                         â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                         â”‚
â”‚   Le nÅ“ud avec la latence la plus faible                            â”‚
â”‚   âœ… Performance optimale                                           â”‚
â”‚   âš ï¸ CohÃ©rence variable selon le nÅ“ud                               â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Exemples de Read Preference

```javascript
// Read Preference par dÃ©faut (primary)
db.users.find({ city: "Paris" })

// Lire sur un Secondary
db.users.find({ city: "Paris" }).readPref("secondary")

// Lire sur le nÅ“ud le plus proche
db.users.find({ city: "Paris" }).readPref("nearest")

// Read Preference avec tags (pour cibler des nÅ“uds spÃ©cifiques)
db.users.find({ city: "Paris" }).readPref(
  "secondary",
  [{ region: "europe" }]
)

// Configuration dans l'URI de connexion
// mongodb://host1,host2,host3/?readPreference=secondaryPreferred
```

#### Tableau rÃ©capitulatif Read Preference

| Read Preference | NÅ“uds ciblÃ©s | CohÃ©rence | DisponibilitÃ© |
|-----------------|--------------|-----------|---------------|
| `primary` | Primary uniquement | âœ… Forte | âš ï¸ Si Primary OK |
| `primaryPreferred` | Primary, puis Secondary | âœ…/âš ï¸ Variable | âœ… Haute |
| `secondary` | Secondaries uniquement | âš ï¸ Ã‰ventuelle | âš ï¸ Si Secondary OK |
| `secondaryPreferred` | Secondary, puis Primary | âš ï¸ Ã‰ventuelle | âœ… Haute |
| `nearest` | Le plus proche | âš ï¸ Variable | âœ… Haute |

---

## Combinaisons et configurations pratiques

### Configuration CP stricte (cohÃ©rence maximale)

Pour les donnÃ©es critiques nÃ©cessitant une cohÃ©rence absolue :

```javascript
// Ã‰criture avec confirmation majoritÃ© + journal
db.comptes_bancaires.updateOne(
  { _id: "compte123" },
  { $inc: { solde: -100 } },
  { writeConcern: { w: "majority", j: true } }
)

// Lecture des donnÃ©es confirmÃ©es, uniquement sur Primary
db.comptes_bancaires.find(
  { _id: "compte123" }
).readConcern("linearizable").readPref("primary")
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Configuration CP stricte                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   writeConcern: { w: "majority", j: true }                          â”‚
â”‚   readConcern: "linearizable"                                       â”‚
â”‚   readPreference: "primary"                                         â”‚
â”‚                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  Client                                                     â”‚   â”‚
â”‚   â”‚    â”‚                                                        â”‚   â”‚
â”‚   â”‚    â”‚ Ã‰criture                                               â”‚   â”‚
â”‚   â”‚    â–¼                                                        â”‚   â”‚
â”‚   â”‚  PRIMARY â”€â”€â”€â”€â”€â”€â–º SECONDARY â”€â”€â”€â”€â”€â”€â–º SECONDARY                â”‚   â”‚
â”‚   â”‚    â”‚              (sync)            (sync)                  â”‚   â”‚
â”‚   â”‚    â”‚                                                        â”‚   â”‚
â”‚   â”‚    â”‚â—„â”€â”€â”€ "OK" seulement quand majoritÃ© a confirmÃ©           â”‚   â”‚
â”‚   â”‚    â”‚                                                        â”‚   â”‚
â”‚   â”‚    â”‚ Lecture (toujours sur Primary)                         â”‚   â”‚
â”‚   â”‚    â–¼                                                        â”‚   â”‚
â”‚   â”‚  PRIMARY                                                    â”‚   â”‚
â”‚   â”‚    â”‚                                                        â”‚   â”‚
â”‚   â”‚    â”‚â—„â”€â”€â”€ DonnÃ©es les plus rÃ©centes garanties                â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚   Cas d'usage :                                                     â”‚
â”‚   â€¢ Transactions bancaires                                          â”‚
â”‚   â€¢ RÃ©servations (siÃ¨ges, chambres)                                 â”‚
â”‚   â€¢ Inventaire critique                                             â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Configuration AP (disponibilitÃ© maximale)

Pour les applications privilÃ©giant la disponibilitÃ© :

```javascript
// Ã‰criture rapide sans attendre la rÃ©plication
db.logs.insertOne(
  { event: "page_view", timestamp: new Date() },
  { writeConcern: { w: 1 } }
)

// Lecture sur n'importe quel nÅ“ud disponible
db.analytics.find(
  { date: "2024-01-15" }
).readConcern("local").readPref("nearest")
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Configuration AP (haute disponibilitÃ©)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   writeConcern: { w: 1 }                                            â”‚
â”‚   readConcern: "local"                                              â”‚
â”‚   readPreference: "nearest"                                         â”‚
â”‚                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                                                             â”‚   â”‚
â”‚   â”‚  Client â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚   â”‚
â”‚   â”‚                   â”‚          â”‚          â”‚                   â”‚   â”‚
â”‚   â”‚                   â–¼          â–¼          â–¼                   â”‚   â”‚
â”‚   â”‚               PRIMARY    SECONDARY  SECONDARY               â”‚   â”‚
â”‚   â”‚               (Paris)    (Lyon)     (Marseille)             â”‚   â”‚
â”‚   â”‚                                         â–²                   â”‚   â”‚
â”‚   â”‚                                         â”‚                   â”‚   â”‚
â”‚   â”‚         Le client Ã  Marseille lit â”€â”€â”€â”€â”€â”€â”˜                   â”‚   â”‚
â”‚   â”‚         sur le Secondary local (plus proche)                â”‚   â”‚
â”‚   â”‚                                                             â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚   Avantages :                                                       â”‚
â”‚   â€¢ Lecture rapide (nÅ“ud le plus proche)                            â”‚
â”‚   â€¢ Haute disponibilitÃ©                                             â”‚
â”‚   â€¢ RÃ©partition de charge                                           â”‚
â”‚                                                                     â”‚
â”‚   Cas d'usage :                                                     â”‚
â”‚   â€¢ Analytics et mÃ©triques                                          â”‚
â”‚   â€¢ Logs applicatifs                                                â”‚
â”‚   â€¢ Contenu statique/cache                                          â”‚
â”‚   â€¢ RÃ©seaux sociaux (likes, vues)                                   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Configuration mixte (selon les opÃ©rations)

Dans une application rÃ©elle, vous pouvez mixer les configurations :

```javascript
// Pour les opÃ©rations critiques : CP strict
async function transfertBancaire(source, destination, montant) {
  const session = client.startSession();
  try {
    session.startTransaction({
      readConcern: { level: "snapshot" },
      writeConcern: { w: "majority" }
    });

    await comptes.updateOne(
      { _id: source },
      { $inc: { solde: -montant } },
      { session }
    );

    await comptes.updateOne(
      { _id: destination },
      { $inc: { solde: montant } },
      { session }
    );

    await session.commitTransaction();
  } finally {
    session.endSession();
  }
}

// Pour les opÃ©rations non critiques : AP
async function enregistrerVisite(userId, pageId) {
  await analytics.insertOne(
    { userId, pageId, timestamp: new Date() },
    { writeConcern: { w: 1 } }  // Rapide, pas critique
  );
}

// Pour les lectures frÃ©quentes : Secondary
async function getStatistiques(userId) {
  return await analytics.find(
    { userId }
  ).readPref("secondaryPreferred").toArray();
}
```

---

## ScÃ©narios de partition et comportement

### ScÃ©nario 1 : Primary isolÃ© (minoritÃ©)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            ScÃ©nario : Primary dans la minoritÃ©                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   Avant partition :                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚   â”‚ PRIMARY â”‚â—„â”€â”€â–ºâ”‚SECONDARYâ”‚â—„â”€â”€â–ºâ”‚SECONDARYâ”‚                         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                                                                     â”‚
â”‚   AprÃ¨s partition (Primary isolÃ©) :                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â—„â”€â”€â–ºâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚   â”‚ PRIMARY â”‚  â•‘  â”‚SECONDARYâ”‚    â”‚SECONDARYâ”‚                        â”‚
â”‚   â”‚ (seul)  â”‚  â•‘  â”‚         â”‚    â”‚         â”‚                        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚   MinoritÃ©     â•‘       MajoritÃ© (2/3)                               â”‚
â”‚                â•‘                                                    â”‚
â”‚   Comportement :                                                    â”‚
â”‚                                                                     â”‚
â”‚   CÃ´tÃ© Primary isolÃ© :                                              â”‚
â”‚   1. DÃ©tecte qu'il ne peut pas atteindre la majoritÃ©                â”‚
â”‚   2. Se rÃ©trograde en SECONDARY                                     â”‚
â”‚   3. Refuse toutes les Ã©critures                                    â”‚
â”‚   4. Peut accepter lectures (readPreference: secondary)             â”‚
â”‚                                                                     â”‚
â”‚   CÃ´tÃ© majoritÃ© :                                                   â”‚
â”‚   1. DÃ©tecte l'absence du Primary                                   â”‚
â”‚   2. Lance une Ã©lection                                             â”‚
â”‚   3. Ã‰lit un nouveau Primary                                        â”‚
â”‚   4. Continue les opÃ©rations normalement                            â”‚
â”‚                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â—„â”€â”€â–ºâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚   â”‚SECONDARYâ”‚  â•‘  â”‚ PRIMARY â”‚    â”‚SECONDARYâ”‚                        â”‚
â”‚   â”‚(ex-Prim)â”‚  â•‘  â”‚(nouveau)â”‚    â”‚         â”‚                        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ScÃ©nario 2 : Partition Ã©gale (2 + 2 dans un RS de 4)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            ScÃ©nario : Partition 50/50 (4 membres)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   Replica Set de 4 membres (majoritÃ© = 3)                           â”‚
â”‚                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚   â”‚ PRIMARY â”‚â—„â”€â”€â–ºâ”‚SECONDARYâ”‚  â•‘  â”‚SECONDARYâ”‚â—„â”€â”€â–ºâ”‚SECONDARYâ”‚         â”‚
â”‚   â”‚         â”‚    â”‚         â”‚  â•‘  â”‚         â”‚    â”‚         â”‚         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                               â•‘                                     â”‚
â”‚      Groupe A (2)             â•‘      Groupe B (2)                   â”‚
â”‚                               â•‘                                     â”‚
â”‚   Aucun groupe n'a la majoritÃ© (3 requis)                           â”‚
â”‚                                                                     â”‚
â”‚   RÃ©sultat :                                                        â”‚
â”‚   â€¢ Le Primary se rÃ©trograde                                        â”‚
â”‚   â€¢ Aucun nouveau Primary ne peut Ãªtre Ã©lu                          â”‚
â”‚   â€¢ AUCUNE Ã©criture possible dans tout le cluster                   â”‚
â”‚   â€¢ Lectures possibles sur tous les nÅ“uds                           â”‚
â”‚                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚   â”‚SECONDARYâ”‚â—„â”€â”€â–ºâ”‚SECONDARYâ”‚  â•‘  â”‚SECONDARYâ”‚â—„â”€â”€â–ºâ”‚SECONDARYâ”‚         â”‚
â”‚   â”‚(lecture â”‚    â”‚(lecture â”‚  â•‘  â”‚(lecture â”‚    â”‚(lecture â”‚         â”‚
â”‚   â”‚ seule)  â”‚    â”‚ seule)  â”‚  â•‘  â”‚ seule)  â”‚    â”‚ seule)  â”‚         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                     â”‚
â”‚   âš ï¸ C'est pourquoi on recommande un nombre IMPAIR de membres       â”‚
â”‚      (3, 5, 7) pour Ã©viter les Ã©galitÃ©s                             â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ScÃ©nario 3 : Rollback aprÃ¨s partition

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            ScÃ©nario : Rollback aprÃ¨s reconnexion                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   Pendant la partition :                                            â”‚
â”‚                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚   â”‚ Ex-PRIMARY  â”‚  â•‘  â”‚ Nouveau     â”‚                               â”‚
â”‚   â”‚             â”‚  â•‘  â”‚ PRIMARY     â”‚                               â”‚
â”‚   â”‚ Ã‰critures:  â”‚  â•‘  â”‚ Ã‰critures:  â”‚                               â”‚
â”‚   â”‚ Op1, Op2    â”‚  â•‘  â”‚ Op3, Op4    â”‚                               â”‚
â”‚   â”‚ (non        â”‚  â•‘  â”‚ (confirmÃ©es â”‚                               â”‚
â”‚   â”‚ confirmÃ©es) â”‚  â•‘  â”‚ majoritÃ©)   â”‚                               â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                                                                     â”‚
â”‚   AprÃ¨s reconnexion :                                               â”‚
â”‚                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚   â”‚ Ex-PRIMARY  â”‚         â”‚   PRIMARY   â”‚                           â”‚
â”‚   â”‚ (maintenant â”‚ sync    â”‚  (conservÃ©) â”‚                           â”‚
â”‚   â”‚  SECONDARY) â”‚         â”‚             â”‚                           â”‚
â”‚   â”‚             â”‚         â”‚ Op3, Op4    â”‚                           â”‚
â”‚   â”‚ ROLLBACK:   â”‚         â”‚ (officiels) â”‚                           â”‚
â”‚   â”‚ Op1, Op2    â”‚         â”‚             â”‚                           â”‚
â”‚   â”‚ annulÃ©s !   â”‚         â”‚             â”‚                           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                                                                     â”‚
â”‚   Les opÃ©rations non confirmÃ©es par la majoritÃ© sont annulÃ©es       â”‚
â”‚   et sauvegardÃ©es dans un fichier de rollback pour analyse.         â”‚
â”‚                                                                     â”‚
â”‚   PrÃ©vention : utilisez writeConcern: "majority" pour les           â”‚
â”‚   donnÃ©es critiques.                                                â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Bonnes pratiques

### Recommandations par cas d'usage

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Guide de configuration CAP                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   ğŸ¦ DONNÃ‰ES CRITIQUES (finance, inventaire, rÃ©servations)          â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€             â”‚
â”‚   writeConcern: { w: "majority", j: true }                          â”‚
â”‚   readConcern: "majority" ou "linearizable"                         â”‚
â”‚   readPreference: "primary"                                         â”‚
â”‚                                                                     â”‚
â”‚   ğŸ“Š ANALYTICS ET MÃ‰TRIQUES                                         â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                         â”‚
â”‚   writeConcern: { w: 1 }                                            â”‚
â”‚   readConcern: "local"                                              â”‚
â”‚   readPreference: "secondaryPreferred"                              â”‚
â”‚                                                                     â”‚
â”‚   ğŸ“ LOGS ET Ã‰VÃ‰NEMENTS                                             â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                             â”‚
â”‚   writeConcern: { w: 0 } ou { w: 1 }                                â”‚
â”‚   readConcern: "local"                                              â”‚
â”‚   readPreference: "nearest"                                         â”‚
â”‚                                                                     â”‚
â”‚   ğŸ‘¤ PROFILS UTILISATEURS                                           â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                           â”‚
â”‚   writeConcern: { w: "majority" }  (modifications importantes)      â”‚
â”‚   readConcern: "majority"                                           â”‚
â”‚   readPreference: "primaryPreferred"                                â”‚
â”‚                                                                     â”‚
â”‚   ğŸŒ CONTENU (articles, posts)                                      â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                      â”‚
â”‚   writeConcern: { w: 1 }                                            â”‚
â”‚   readConcern: "local"                                              â”‚
â”‚   readPreference: "secondaryPreferred"                              â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Checklist de configuration

| Question | Si OUI | Si NON |
|----------|--------|--------|
| La perte de cette donnÃ©e coÃ»te-t-elle de l'argent ? | `w: "majority"` | `w: 1` |
| Les lectures doivent-elles Ãªtre absolument Ã  jour ? | `readPref: primary` | `readPref: secondary` |
| Les donnÃ©es peuvent-elles Ãªtre annulÃ©es (rollback) ? | `w: 1` suffit | `w: "majority"` |
| Besoin de haute disponibilitÃ© en lecture ? | `readPref: secondaryPreferred` | `readPref: primary` |
| Performance critique ? | `readConcern: local` | `readConcern: majority` |

---

## Conclusion

MongoDB est un systÃ¨me **CP par dÃ©faut**, mais sa vraie force rÃ©side dans sa **configurabilitÃ©**. GrÃ¢ce aux mÃ©canismes de Write Concern, Read Concern et Read Preference, vous pouvez ajuster le compromis CAP selon vos besoins :

- **CohÃ©rence maximale** : `w: "majority"` + `readConcern: "linearizable"` + `readPref: primary`
- **DisponibilitÃ© maximale** : `w: 1` + `readConcern: "local"` + `readPref: nearest`
- **Ã‰quilibre** : `w: "majority"` + `readConcern: "majority"` + `readPref: primaryPreferred`

Le choix dÃ©pend toujours de votre cas d'usage. N'hÃ©sitez pas Ã  mixer les configurations dans une mÃªme application : cohÃ©rence forte pour les transactions financiÃ¨res, disponibilitÃ© pour les analytics.

---

## Points clÃ©s Ã  retenir

- MongoDB est **CP par dÃ©faut** (privilÃ©gie la cohÃ©rence)
- Le concept de **majoritÃ©** Ã©vite le split-brain
- **Write Concern** contrÃ´le la durabilitÃ© des Ã©critures
  - `w: "majority"` pour les donnÃ©es critiques
- **Read Concern** contrÃ´le la cohÃ©rence des lectures
  - `"linearizable"` pour la cohÃ©rence maximale
- **Read Preference** contrÃ´le oÃ¹ les lectures sont effectuÃ©es
  - `primary` pour la cohÃ©rence, `secondary` pour la disponibilitÃ©
- En cas de partition, le groupe **minoritaire** refuse les Ã©critures
- Les configurations peuvent Ãªtre **mixÃ©es** selon les opÃ©rations
- Utilisez un nombre **impair** de membres dans un Replica Set

---


â­ï¸ [Eventual Consistency vs Strong Consistency](/01-introduction-a-mongodb/04.3-eventual-vs-strong-consistency.md)
