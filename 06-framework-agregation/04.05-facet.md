üîù Retour au [Sommaire](/SOMMAIRE.md)

# 6.4.5 $facet

## Introduction

L'√©tape `$facet` est un op√©rateur avanc√© du framework d'agr√©gation MongoDB qui permet d'ex√©cuter **plusieurs pipelines d'agr√©gation en parall√®le** sur le m√™me ensemble de documents d'entr√©e. Chaque pipeline produit son propre r√©sultat, et tous les r√©sultats sont combin√©s dans un seul document de sortie.

### L'Essentiel

- **Ex√©cution parall√®le** : Plusieurs analyses sur les m√™mes donn√©es en une seule requ√™te
- **Un seul scan** : Les documents d'entr√©e ne sont lus qu'une seule fois
- **R√©sultats s√©par√©s** : Chaque facette produit son propre tableau de r√©sultats
- **Performance** : Plus efficace que d'ex√©cuter plusieurs requ√™tes s√©par√©es

### Analogie Simple

Imaginez que vous analysez un **panier de fruits** :
- **Facette 1** : Compter les fruits par couleur (rouge, vert, jaune...)
- **Facette 2** : Calculer le prix moyen par type (pommes, bananes, oranges...)
- **Facette 3** : Trouver les 3 fruits les plus lourds

Au lieu de trier le panier 3 fois, `$facet` vous permet de faire **toutes ces analyses en une seule fois**, en regardant le panier une seule fois.

---

## Pourquoi Utiliser $facet ?

`$facet` est essentiel pour :

1. **√âviter les requ√™tes multiples** : Une seule requ√™te au lieu de plusieurs
2. **Am√©liorer les performances** : Un seul scan des donn√©es
3. **Cr√©er des tableaux de bord** : Plusieurs statistiques simultan√©ment
4. **Pagination avec m√©tadonn√©es** : R√©sultats + nombre total en une requ√™te
5. **Analyses multi-dimensionnelles** : Diff√©rentes perspectives sur les m√™mes donn√©es
6. **Interfaces riches** : Filtres, statistiques et r√©sultats en une fois

---

## Syntaxe

```javascript
{
  $facet: {
    <nom_facette1>: [ <pipeline1> ],
    <nom_facette2>: [ <pipeline2> ],
    <nom_facette3>: [ <pipeline3> ],
    ...
  }
}
```

### Param√®tres

- **Nom de facette** : Nom du champ qui contiendra les r√©sultats de ce pipeline
- **Pipeline** : Tableau d'√©tapes d'agr√©gation (comme un pipeline normal)

### R√®gles Importantes

1. Chaque facette produit un **tableau** de r√©sultats
2. Les facettes s'ex√©cutent de mani√®re **ind√©pendante**
3. Toutes les facettes re√ßoivent les **m√™mes documents d'entr√©e**
4. Le r√©sultat est un **document unique** contenant toutes les facettes

---

## Exemple Simple pour Comprendre

### Pr√©paration des Donn√©es

```javascript
db.produits.insertMany([
  { _id: 1, nom: "Laptop", categorie: "Informatique", prix: 899, stock: 15 },
  { _id: 2, nom: "Souris", categorie: "Informatique", prix: 29, stock: 50 },
  { _id: 3, nom: "Clavier", categorie: "Informatique", prix: 79, stock: 30 },
  { _id: 4, nom: "Bureau", categorie: "Mobilier", prix: 299, stock: 8 },
  { _id: 5, nom: "Chaise", categorie: "Mobilier", prix: 159, stock: 12 },
  { _id: 6, nom: "√âcran", categorie: "Informatique", prix: 349, stock: 20 },
  { _id: 7, nom: "Lampe", categorie: "Mobilier", prix: 45, stock: 25 }
])
```

### Application de $facet

Analysons ces produits selon **trois perspectives diff√©rentes** :

```javascript
db.produits.aggregate([
  {
    $facet: {
      // Facette 1 : Prix moyen par cat√©gorie
      "prix_par_categorie": [
        {
          $group: {
            _id: "$categorie",
            prix_moyen: { $avg: "$prix" },
            nombre_produits: { $sum: 1 }
          }
        },
        { $sort: { prix_moyen: -1 } }
      ],

      // Facette 2 : Les 3 produits les plus chers
      "top_3_chers": [
        { $sort: { prix: -1 } },
        { $limit: 3 },
        {
          $project: {
            nom: 1,
            prix: 1,
            categorie: 1
          }
        }
      ],

      // Facette 3 : Produits avec stock faible
      "stock_faible": [
        { $match: { stock: { $lt: 15 } } },
        { $sort: { stock: 1 } },
        {
          $project: {
            nom: 1,
            stock: 1
          }
        }
      ]
    }
  }
])
```

### R√©sultat

```json
{
  "prix_par_categorie": [
    {
      "_id": "Informatique",
      "prix_moyen": 339,
      "nombre_produits": 4
    },
    {
      "_id": "Mobilier",
      "prix_moyen": 167.67,
      "nombre_produits": 3
    }
  ],
  "top_3_chers": [
    { "_id": 1, "nom": "Laptop", "prix": 899, "categorie": "Informatique" },
    { "_id": 6, "nom": "√âcran", "prix": 349, "categorie": "Informatique" },
    { "_id": 4, "nom": "Bureau", "prix": 299, "categorie": "Mobilier" }
  ],
  "stock_faible": [
    { "_id": 4, "nom": "Bureau", "stock": 8 },
    { "_id": 5, "nom": "Chaise", "stock": 12 }
  ]
}
```

### Observations

1. **Un seul document** contient tous les r√©sultats
2. Chaque facette est un **champ distinct** avec son propre tableau
3. Les **m√™mes 7 produits** ont √©t√© analys√©s trois fois diff√©remment
4. **Un seul scan** des donn√©es pour trois analyses

---

## Cas d'Usage Principal : Pagination avec M√©tadonn√©es

Le cas d'usage le plus courant de `$facet` est la **pagination intelligente** : obtenir √† la fois les r√©sultats pagin√©s ET le nombre total de documents.

### Probl√®me Sans $facet

```javascript
// Requ√™te 1 : Compter le total
const total = db.articles.countDocuments({ statut: "publi√©" })

// Requ√™te 2 : R√©cup√©rer la page
const resultats = db.articles.find({ statut: "publi√©" })
  .skip(20)
  .limit(10)
  .toArray()

// = 2 requ√™tes s√©par√©es !
```

### Solution Avec $facet

```javascript
db.articles.aggregate([
  // Filtrer d'abord
  {
    $match: { statut: "publi√©" }
  },

  // Cr√©er deux facettes
  {
    $facet: {
      // Facette 1 : Les r√©sultats pagin√©s
      "resultats": [
        { $sort: { date: -1 } },
        { $skip: 20 },
        { $limit: 10 },
        {
          $project: {
            titre: 1,
            auteur: 1,
            date: 1,
            resume: 1
          }
        }
      ],

      // Facette 2 : Le nombre total
      "metadata": [
        { $count: "total" }
      ]
    }
  },

  // Reformater le r√©sultat (optionnel)
  {
    $project: {
      resultats: 1,
      total: { $arrayElemAt: ["$metadata.total", 0] },
      page: 3,
      taille_page: 10
    }
  }
])
```

### R√©sultat

```json
{
  "resultats": [
    {
      "_id": 21,
      "titre": "Article 21",
      "auteur": "Alice",
      "date": ISODate("2024-03-15"),
      "resume": "..."
    },
    // ... 9 autres articles
  ],
  "total": 156,
  "page": 3,
  "taille_page": 10
}
```

### Avantages

- ‚úÖ **Une seule requ√™te** au lieu de deux
- ‚úÖ **Performance optimale** : Un seul scan des donn√©es
- ‚úÖ **Coh√©rence** : Le total et les r√©sultats correspondent exactement
- ‚úÖ **Calculs de pagination** faciles : `nombre_pages = Math.ceil(total / taille_page)`

---

## Tableau de Bord Analytique

`$facet` est id√©al pour cr√©er des **tableaux de bord** avec plusieurs statistiques.

### Exemple : Dashboard E-commerce

```javascript
db.commandes.insertMany([
  {
    _id: 1,
    date: ISODate("2024-03-01"),
    client_id: 101,
    montant: 450,
    statut: "livr√©e",
    produits: 3
  },
  {
    _id: 2,
    date: ISODate("2024-03-02"),
    client_id: 102,
    montant: 120,
    statut: "livr√©e",
    produits: 1
  },
  {
    _id: 3,
    date: ISODate("2024-03-05"),
    client_id: 101,
    montant: 890,
    statut: "en_cours",
    produits: 5
  },
  {
    _id: 4,
    date: ISODate("2024-03-10"),
    client_id: 103,
    montant: 220,
    statut: "livr√©e",
    produits: 2
  },
  {
    _id: 5,
    date: ISODate("2024-03-15"),
    client_id: 104,
    montant: 75,
    statut: "annul√©e",
    produits: 1
  }
])

// Dashboard complet
db.commandes.aggregate([
  {
    $facet: {
      // KPI 1 : Statistiques globales
      "statistiques_globales": [
        {
          $group: {
            _id: null,
            nombre_commandes: { $sum: 1 },
            chiffre_affaires_total: { $sum: "$montant" },
            panier_moyen: { $avg: "$montant" },
            produits_vendus: { $sum: "$produits" }
          }
        },
        {
          $project: {
            _id: 0,
            nombre_commandes: 1,
            chiffre_affaires_total: { $round: ["$chiffre_affaires_total", 2] },
            panier_moyen: { $round: ["$panier_moyen", 2] },
            produits_vendus: 1
          }
        }
      ],

      // KPI 2 : R√©partition par statut
      "repartition_statuts": [
        {
          $group: {
            _id: "$statut",
            nombre: { $sum: 1 },
            montant_total: { $sum: "$montant" }
          }
        },
        { $sort: { nombre: -1 } }
      ],

      // KPI 3 : Top 5 clients
      "top_clients": [
        {
          $group: {
            _id: "$client_id",
            nombre_commandes: { $sum: 1 },
            montant_total: { $sum: "$montant" }
          }
        },
        { $sort: { montant_total: -1 } },
        { $limit: 5 }
      ],

      // KPI 4 : √âvolution temporelle (par jour)
      "evolution_journaliere": [
        {
          $group: {
            _id: {
              $dateToString: { format: "%Y-%m-%d", date: "$date" }
            },
            commandes: { $sum: 1 },
            ca: { $sum: "$montant" }
          }
        },
        { $sort: { _id: 1 } }
      ],

      // KPI 5 : Derni√®res commandes
      "dernieres_commandes": [
        { $sort: { date: -1 } },
        { $limit: 5 },
        {
          $project: {
            _id: 1,
            date: 1,
            montant: 1,
            statut: 1
          }
        }
      ]
    }
  }
])
```

### R√©sultat

```json
{
  "statistiques_globales": [
    {
      "nombre_commandes": 5,
      "chiffre_affaires_total": 1755,
      "panier_moyen": 351,
      "produits_vendus": 12
    }
  ],
  "repartition_statuts": [
    { "_id": "livr√©e", "nombre": 3, "montant_total": 790 },
    { "_id": "en_cours", "nombre": 1, "montant_total": 890 },
    { "_id": "annul√©e", "nombre": 1, "montant_total": 75 }
  ],
  "top_clients": [
    { "_id": 101, "nombre_commandes": 2, "montant_total": 1340 },
    { "_id": 102, "nombre_commandes": 1, "montant_total": 120 },
    { "_id": 103, "nombre_commandes": 1, "montant_total": 220 },
    { "_id": 104, "nombre_commandes": 1, "montant_total": 75 }
  ],
  "evolution_journaliere": [
    { "_id": "2024-03-01", "commandes": 1, "ca": 450 },
    { "_id": "2024-03-02", "commandes": 1, "ca": 120 },
    { "_id": "2024-03-05", "commandes": 1, "ca": 890 },
    { "_id": "2024-03-10", "commandes": 1, "ca": 220 },
    { "_id": "2024-03-15", "commandes": 1, "ca": 75 }
  ],
  "dernieres_commandes": [
    { "_id": 5, "date": ISODate("2024-03-15"), "montant": 75, "statut": "annul√©e" },
    { "_id": 4, "date": ISODate("2024-03-10"), "montant": 220, "statut": "livr√©e" },
    { "_id": 3, "date": ISODate("2024-03-05"), "montant": 890, "statut": "en_cours" },
    { "_id": 2, "date": ISODate("2024-03-02"), "montant": 120, "statut": "livr√©e" },
    { "_id": 1, "date": ISODate("2024-03-01"), "montant": 450, "statut": "livr√©e" }
  ]
}
```

---

## Recherche avec Filtres Multiples

`$facet` permet de fournir plusieurs **options de filtrage** en une seule requ√™te.

### Exemple : Recherche de Produits

```javascript
db.produits.aggregate([
  // √âtape 1 : Filtres de base (appliqu√©s √† toutes les facettes)
  {
    $match: {
      categorie: "Informatique",
      prix: { $lte: 1000 }
    }
  },

  // √âtape 2 : Cr√©er des facettes pour diff√©rentes tranches de prix
  {
    $facet: {
      // Tous les r√©sultats
      "tous": [
        { $sort: { prix: 1 } },
        { $project: { nom: 1, prix: 1 } }
      ],

      // Entr√©e de gamme (< 100‚Ç¨)
      "entree_gamme": [
        { $match: { prix: { $lt: 100 } } },
        { $sort: { prix: 1 } },
        { $project: { nom: 1, prix: 1 } }
      ],

      // Milieu de gamme (100-500‚Ç¨)
      "milieu_gamme": [
        {
          $match: {
            prix: { $gte: 100, $lte: 500 }
          }
        },
        { $sort: { prix: 1 } },
        { $project: { nom: 1, prix: 1 } }
      ],

      // Haut de gamme (> 500‚Ç¨)
      "haut_gamme": [
        { $match: { prix: { $gt: 500 } } },
        { $sort: { prix: 1 } },
        { $project: { nom: 1, prix: 1 } }
      ],

      // Statistiques
      "stats": [
        {
          $group: {
            _id: null,
            prix_min: { $min: "$prix" },
            prix_max: { $max: "$prix" },
            prix_moyen: { $avg: "$prix" },
            total_produits: { $sum: 1 }
          }
        }
      ]
    }
  }
])
```

---

## Analyses Comparatives

Comparer diff√©rentes p√©riodes ou segments en une seule requ√™te.

### Exemple : Comparaison Mensuelle

```javascript
db.ventes.aggregate([
  {
    $facet: {
      // Ventes du mois en cours
      "mois_actuel": [
        {
          $match: {
            date: {
              $gte: ISODate("2024-03-01"),
              $lt: ISODate("2024-04-01")
            }
          }
        },
        {
          $group: {
            _id: null,
            total: { $sum: "$montant" },
            nombre: { $sum: 1 }
          }
        }
      ],

      // Ventes du mois pr√©c√©dent
      "mois_precedent": [
        {
          $match: {
            date: {
              $gte: ISODate("2024-02-01"),
              $lt: ISODate("2024-03-01")
            }
          }
        },
        {
          $group: {
            _id: null,
            total: { $sum: "$montant" },
            nombre: { $sum: 1 }
          }
        }
      ],

      // M√™me p√©riode l'ann√©e derni√®re
      "annee_precedente": [
        {
          $match: {
            date: {
              $gte: ISODate("2023-03-01"),
              $lt: ISODate("2023-04-01")
            }
          }
        },
        {
          $group: {
            _id: null,
            total: { $sum: "$montant" },
            nombre: { $sum: 1 }
          }
        }
      ]
    }
  },

  // Calculer les √©volutions
  {
    $project: {
      mois_actuel: { $arrayElemAt: ["$mois_actuel", 0] },
      mois_precedent: { $arrayElemAt: ["$mois_precedent", 0] },
      annee_precedente: { $arrayElemAt: ["$annee_precedente", 0] }
    }
  },
  {
    $project: {
      "Mois actuel": {
        total: "$mois_actuel.total",
        nombre: "$mois_actuel.nombre"
      },
      "Mois pr√©c√©dent": {
        total: "$mois_precedent.total",
        nombre: "$mois_precedent.nombre"
      },
      "Ann√©e pr√©c√©dente": {
        total: "$annee_precedente.total",
        nombre: "$annee_precedente.nombre"
      },
      "Evolution M/M (%)": {
        $multiply: [
          {
            $divide: [
              { $subtract: ["$mois_actuel.total", "$mois_precedent.total"] },
              "$mois_precedent.total"
            ]
          },
          100
        ]
      },
      "Evolution A/A (%)": {
        $multiply: [
          {
            $divide: [
              { $subtract: ["$mois_actuel.total", "$annee_precedente.total"] },
              "$annee_precedente.total"
            ]
          },
          100
        ]
      }
    }
  }
])
```

---

## Combinaison avec d'Autres √âtapes

`$facet` peut √™tre combin√© avec d'autres op√©rateurs dans un pipeline.

### Exemple : Filtrage puis Facettes

```javascript
db.articles.aggregate([
  // √âtape 1 : Filtrer les articles publi√©s
  {
    $match: {
      statut: "publi√©",
      date: { $gte: ISODate("2024-01-01") }
    }
  },

  // √âtape 2 : Enrichir avec les infos auteur
  {
    $lookup: {
      from: "auteurs",
      localField: "auteur_id",
      foreignField: "_id",
      as: "auteur"
    }
  },
  { $unwind: "$auteur" },

  // √âtape 3 : Cr√©er des facettes
  {
    $facet: {
      "par_categorie": [
        {
          $group: {
            _id: "$categorie",
            nombre: { $sum: 1 }
          }
        }
      ],
      "par_auteur": [
        {
          $group: {
            _id: "$auteur.nom",
            nombre: { $sum: 1 },
            vues_totales: { $sum: "$vues" }
          }
        },
        { $sort: { nombre: -1 } },
        { $limit: 10 }
      ],
      "tendances": [
        {
          $group: {
            _id: {
              $dateToString: { format: "%Y-%m", date: "$date" }
            },
            nombre: { $sum: 1 }
          }
        },
        { $sort: { _id: 1 } }
      ]
    }
  }
])
```

---

## Limitations de $facet

### 1. Restrictions sur les √âtapes

Certaines √©tapes **ne peuvent pas √™tre utilis√©es** dans une facette :

‚ùå **Interdites dans $facet** :
- `$collStats`
- `$facet` (pas de facettes imbriqu√©es)
- `$geoNear`
- `$indexStats`
- `$out`
- `$merge`
- `$planCacheStats`

### 2. Limite de M√©moire

Chaque facette est soumise √† la **limite de m√©moire de 100 Mo** par d√©faut pour les pipelines d'agr√©gation.

**Solution** : Utiliser `allowDiskUse: true`

```javascript
db.collection.aggregate(
  [ /* pipeline avec $facet */ ],
  { allowDiskUse: true }
)
```

### 3. Limite de Taille du Document

Le r√©sultat de `$facet` est un **document unique** qui doit respecter la **limite de 16 Mo**.

---

## Bonnes Pratiques

### 1. Filtrer Avant $facet

R√©duisez le volume de donn√©es **avant** d'appliquer `$facet` :

```javascript
// ‚úÖ Bon : Filtrer d'abord
db.commandes.aggregate([
  {
    $match: {
      date: { $gte: ISODate("2024-01-01") },
      statut: { $ne: "annul√©e" }
    }
  },
  {
    $facet: {
      // facettes...
    }
  }
])

// ‚ùå Moins efficace : Filtrer dans chaque facette
db.commandes.aggregate([
  {
    $facet: {
      facette1: [
        { $match: { date: { $gte: ISODate("2024-01-01") } } },
        // ...
      ],
      facette2: [
        { $match: { date: { $gte: ISODate("2024-01-01") } } },
        // ...
      ]
    }
  }
])
```

### 2. Limiter le Nombre de Facettes

- **3-5 facettes** : Id√©al
- **10+ facettes** : Peut impacter les performances

### 3. Projeter Uniquement les Champs N√©cessaires

```javascript
{
  $facet: {
    "resultats": [
      {
        $project: {
          // Seulement les champs n√©cessaires
          nom: 1,
          prix: 1,
          stock: 1
        }
      }
    ]
  }
}
```

### 4. Utiliser des Index

Assurez-vous que les champs utilis√©s dans `$match` (avant et dans les facettes) sont **index√©s**.

```javascript
db.commandes.createIndex({ date: 1, statut: 1 })
```

### 5. Nommer les Facettes Explicitement

```javascript
// ‚úÖ Bon : Noms descriptifs
{
  $facet: {
    "resultats_pagines": [...],
    "nombre_total": [...],
    "statistiques_globales": [...]
  }
}

// ‚ùå Moins clair
{
  $facet: {
    "data": [...],
    "count": [...],
    "stats": [...]
  }
}
```

---

## Patterns Courants

### Pattern 1 : Pagination Compl√®te

```javascript
function paginer(collection, filtres, page, taillePages) {
  const skip = (page - 1) * taillePages;

  return collection.aggregate([
    { $match: filtres },
    {
      $facet: {
        "resultats": [
          { $skip: skip },
          { $limit: taillePages }
        ],
        "metadata": [
          { $count: "total" }
        ]
      }
    },
    {
      $project: {
        resultats: 1,
        total: { $arrayElemAt: ["$metadata.total", 0] },
        page: { $literal: page },
        taille_page: { $literal: taillePages },
        nombre_pages: {
          $ceil: {
            $divide: [
              { $arrayElemAt: ["$metadata.total", 0] },
              taillePages
            ]
          }
        }
      }
    }
  ]);
}

// Utilisation
paginer(db.articles, { statut: "publi√©" }, 2, 10)
```

### Pattern 2 : Dashboard avec Filtres Dynamiques

```javascript
function creerDashboard(filtres) {
  return db.ventes.aggregate([
    { $match: filtres },
    {
      $facet: {
        "kpi": [
          {
            $group: {
              _id: null,
              ca_total: { $sum: "$montant" },
              nombre_ventes: { $sum: 1 },
              panier_moyen: { $avg: "$montant" }
            }
          }
        ],
        "top_produits": [
          { $unwind: "$produits" },
          {
            $group: {
              _id: "$produits.nom",
              quantite: { $sum: "$produits.quantite" },
              ca: { $sum: { $multiply: ["$produits.prix", "$produits.quantite"] } }
            }
          },
          { $sort: { ca: -1 } },
          { $limit: 5 }
        ],
        "evolution": [
          {
            $group: {
              _id: { $dateToString: { format: "%Y-%m-%d", date: "$date" } },
              ca: { $sum: "$montant" }
            }
          },
          { $sort: { _id: 1 } }
        ]
      }
    }
  ]);
}
```

### Pattern 3 : Recherche Multi-crit√®res

```javascript
function rechercherProduits(terme, options = {}) {
  const pipeline = [];

  // Recherche textuelle
  if (terme) {
    pipeline.push({
      $match: { $text: { $search: terme } }
    });
  }

  // Facettes pour diff√©rents tris et filtres
  pipeline.push({
    $facet: {
      "pertinence": [
        { $sort: { score: { $meta: "textScore" } } },
        { $limit: options.limite || 20 }
      ],
      "prix_croissant": [
        { $sort: { prix: 1 } },
        { $limit: options.limite || 20 }
      ],
      "prix_decroissant": [
        { $sort: { prix: -1 } },
        { $limit: options.limite || 20 }
      ],
      "nouveautes": [
        { $sort: { date_ajout: -1 } },
        { $limit: options.limite || 20 }
      ],
      "filtres_disponibles": [
        {
          $group: {
            _id: null,
            categories: { $addToSet: "$categorie" },
            prix_min: { $min: "$prix" },
            prix_max: { $max: "$prix" }
          }
        }
      ]
    }
  });

  return db.produits.aggregate(pipeline);
}
```

---

## Exemple Complet : Application E-commerce

```javascript
// Donn√©es de test
db.commandes.insertMany([
  {
    _id: 1,
    date: ISODate("2024-03-01T10:30:00Z"),
    client_id: 101,
    region: "Europe",
    produits: [
      { nom: "Laptop", categorie: "Informatique", prix: 899, quantite: 1 },
      { nom: "Souris", categorie: "Accessoires", prix: 29, quantite: 2 }
    ],
    montant_total: 957,
    statut: "livr√©e"
  },
  {
    _id: 2,
    date: ISODate("2024-03-05T14:20:00Z"),
    client_id: 102,
    region: "Am√©rique",
    produits: [
      { nom: "√âcran", categorie: "Informatique", prix: 349, quantite: 1 }
    ],
    montant_total: 349,
    statut: "livr√©e"
  },
  {
    _id: 3,
    date: ISODate("2024-03-10T09:15:00Z"),
    client_id: 103,
    region: "Europe",
    produits: [
      { nom: "Clavier", categorie: "Accessoires", prix: 79, quantite: 2 },
      { nom: "Webcam", categorie: "Accessoires", prix: 59, quantite: 1 }
    ],
    montant_total: 217,
    statut: "en_transit"
  }
])

// Dashboard e-commerce complet
db.commandes.aggregate([
  // Filtres globaux
  {
    $match: {
      date: {
        $gte: ISODate("2024-03-01"),
        $lt: ISODate("2024-04-01")
      }
    }
  },

  // Analyses multiples
  {
    $facet: {
      // Vue 1 : KPIs globaux
      "kpis_globaux": [
        {
          $group: {
            _id: null,
            nombre_commandes: { $sum: 1 },
            ca_total: { $sum: "$montant_total" },
            panier_moyen: { $avg: "$montant_total" }
          }
        },
        {
          $project: {
            _id: 0,
            nombre_commandes: 1,
            ca_total: { $round: ["$ca_total", 2] },
            panier_moyen: { $round: ["$panier_moyen", 2] }
          }
        }
      ],

      // Vue 2 : Ventes par r√©gion
      "ventes_par_region": [
        {
          $group: {
            _id: "$region",
            commandes: { $sum: 1 },
            ca: { $sum: "$montant_total" }
          }
        },
        { $sort: { ca: -1 } }
      ],

      // Vue 3 : Produits les plus vendus
      "top_produits": [
        { $unwind: "$produits" },
        {
          $group: {
            _id: "$produits.nom",
            quantite_vendue: { $sum: "$produits.quantite" },
            ca_genere: {
              $sum: { $multiply: ["$produits.prix", "$produits.quantite"] }
            }
          }
        },
        { $sort: { quantite_vendue: -1 } },
        { $limit: 5 }
      ],

      // Vue 4 : Cat√©gories performance
      "performance_categories": [
        { $unwind: "$produits" },
        {
          $group: {
            _id: "$produits.categorie",
            nombre_produits: { $sum: "$produits.quantite" },
            ca: {
              $sum: { $multiply: ["$produits.prix", "$produits.quantite"] }
            }
          }
        },
        { $sort: { ca: -1 } }
      ],

      // Vue 5 : Statuts des commandes
      "statuts": [
        {
          $group: {
            _id: "$statut",
            nombre: { $sum: 1 }
          }
        },
        {
          $project: {
            statut: "$_id",
            nombre: 1,
            _id: 0
          }
        }
      ],

      // Vue 6 : √âvolution journali√®re
      "evolution": [
        {
          $group: {
            _id: {
              $dateToString: { format: "%Y-%m-%d", date: "$date" }
            },
            commandes: { $sum: 1 },
            ca: { $sum: "$montant_total" }
          }
        },
        { $sort: { _id: 1 } }
      ]
    }
  }
])
```

**R√©sultat structur√©** :
```json
{
  "kpis_globaux": [
    {
      "nombre_commandes": 3,
      "ca_total": 1523,
      "panier_moyen": 507.67
    }
  ],
  "ventes_par_region": [
    { "_id": "Europe", "commandes": 2, "ca": 1174 },
    { "_id": "Am√©rique", "commandes": 1, "ca": 349 }
  ],
  "top_produits": [
    { "_id": "Laptop", "quantite_vendue": 1, "ca_genere": 899 },
    { "_id": "√âcran", "quantite_vendue": 1, "ca_genere": 349 },
    { "_id": "Clavier", "quantite_vendue": 2, "ca_genere": 158 },
    { "_id": "Souris", "quantite_vendue": 2, "ca_genere": 58 },
    { "_id": "Webcam", "quantite_vendue": 1, "ca_genere": 59 }
  ],
  "performance_categories": [
    { "_id": "Informatique", "nombre_produits": 2, "ca": 1248 },
    { "_id": "Accessoires", "nombre_produits": 5, "ca": 275 }
  ],
  "statuts": [
    { "statut": "livr√©e", "nombre": 2 },
    { "statut": "en_transit", "nombre": 1 }
  ],
  "evolution": [
    { "_id": "2024-03-01", "commandes": 1, "ca": 957 },
    { "_id": "2024-03-05", "commandes": 1, "ca": 349 },
    { "_id": "2024-03-10", "commandes": 1, "ca": 217 }
  ]
}
```

---

## R√©sum√©

### Points Cl√©s

| Aspect | Description |
|--------|-------------|
| **Fonction** | Ex√©cuter plusieurs pipelines en parall√®le sur les m√™mes donn√©es |
| **Syntaxe** | `{ $facet: { nom1: [pipeline1], nom2: [pipeline2] } }` |
| **R√©sultat** | Document unique avec un champ par facette (tableaux) |
| **Performance** | Un seul scan des donn√©es pour toutes les facettes |
| **Cas d'usage principal** | Pagination + m√©tadonn√©es, dashboards, analyses multi-dimensionnelles |
| **Limitations** | Certaines √©tapes interdites, limite 16 Mo pour le r√©sultat |

### Quand Utiliser $facet

‚úÖ **Utilisez $facet** pour :
- Pagination avec nombre total de r√©sultats
- Tableaux de bord avec plusieurs KPIs
- Analyses comparatives (p√©riodes, segments)
- Recherche avec diff√©rents tris
- √âviter plusieurs requ√™tes sur les m√™mes donn√©es

‚ùå **N'utilisez PAS $facet** si :
- Vous n'avez qu'une seule analyse √† faire
- Les r√©sultats combin√©s d√©passent 16 Mo
- Les facettes sont compl√®tement ind√©pendantes (mieux vaut des requ√™tes s√©par√©es)

### Avantages vs Requ√™tes Multiples

| Crit√®re | $facet | Requ√™tes Multiples |
|---------|--------|-------------------|
| **Nombre de scans** | 1 | N (un par requ√™te) |
| **Performance** | ‚úÖ Meilleure | ‚ùå Plus lente |
| **Coh√©rence** | ‚úÖ Garantie | ‚ö†Ô∏è Risque d'incoh√©rence |
| **Simplicit√© code** | ‚úÖ Une requ√™te | ‚ùå Plusieurs appels |
| **Taille r√©sultat** | ‚ö†Ô∏è Limit√© √† 16 Mo | ‚úÖ Illimit√© |

---

## Conclusion

`$facet` est un outil **puissant** pour cr√©er des analyses multi-dimensionnelles efficaces. En permettant d'ex√©cuter plusieurs pipelines en parall√®le sur le m√™me ensemble de donn√©es, il optimise consid√©rablement les performances et simplifie le code applicatif.

### √Ä Retenir

1. **$facet** ex√©cute plusieurs pipelines en parall√®le
2. **Un seul scan** des donn√©es pour toutes les analyses
3. Id√©al pour la **pagination intelligente** (r√©sultats + total)
4. Parfait pour les **tableaux de bord** multi-KPIs
5. Chaque facette produit un **tableau ind√©pendant**
6. Filtrez **avant** $facet pour de meilleures performances
7. Le r√©sultat ne doit pas d√©passer **16 Mo**

### Prochaines √âtapes

Dans les sections suivantes, nous explorerons :
- **$bucket et $bucketAuto** : Regrouper par intervalles/tranches
- **$graphLookup** : Requ√™tes r√©cursives pour structures hi√©rarchiques
- **Optimisation des pipelines** : Techniques avanc√©es de performance

---

**üìö R√©f√©rences**

- [Documentation officielle $facet](https://www.mongodb.com/docs/manual/reference/operator/aggregation/facet/)
- [Aggregation Pipeline Optimization](https://www.mongodb.com/docs/manual/core/aggregation-pipeline-optimization/)
- [Pagination Patterns](https://www.mongodb.com/docs/manual/reference/method/cursor.skip/)

‚è≠Ô∏è [$bucket et $bucketAuto](/06-framework-agregation/04.06-bucket-bucketauto.md)
