üîù Retour au [Sommaire](/SOMMAIRE.md)

# 6.5.4 Op√©rateurs de Tableaux - Manipulation de Listes

## Introduction

Les op√©rateurs de tableaux permettent de **manipuler et transformer des listes de valeurs** dans vos pipelines d'agr√©gation MongoDB. Ils vous donnent la possibilit√© de filtrer, transformer, combiner et analyser des tableaux directement dans vos requ√™tes.

Pensez aux op√©rateurs de tableaux comme √† une **bo√Æte √† outils pour listes** qui vous permet de r√©pondre √† des questions comme "Combien d'√©l√©ments ?", "Quel est le premier ?", "Contient-il cette valeur ?", "Comment transformer tous les √©l√©ments ?", etc.

## √Ä Quoi Servent les Op√©rateurs de Tableaux ?

### 1. **Analyse de Contenu**
Compter les √©l√©ments, trouver des valeurs, v√©rifier la pr√©sence.

### 2. **Transformation**
Modifier tous les √©l√©ments d'un tableau, filtrer, trier.

### 3. **Extraction**
Obtenir un √©l√©ment sp√©cifique, une portion du tableau.

### 4. **Combinaison**
Fusionner plusieurs tableaux, cr√©er des paires.

### 5. **Calculs**
R√©duire un tableau √† une valeur (somme, moyenne, etc.).

## Liste des Op√©rateurs de Tableaux

### Op√©rateurs d'Information

| Op√©rateur | Description | Exemple |
|-----------|-------------|---------|
| `$size` | Nombre d'√©l√©ments | `{ $size: ["a", "b", "c"] }` ‚Üí 3 |
| `$in` | Valeur dans tableau | `{ $in: ["a", ["a","b"]] }` ‚Üí true |
| `$indexOfArray` | Position d'un √©l√©ment | `{ $indexOfArray: [["a","b","c"], "b"] }` ‚Üí 1 |

### Op√©rateurs d'Acc√®s

| Op√©rateur | Description | Exemple |
|-----------|-------------|---------|
| `$arrayElemAt` | √âl√©ment √† l'index | `{ $arrayElemAt: [["a","b","c"], 0] }` ‚Üí "a" |
| `$first` | Premier √©l√©ment | `{ $first: ["a","b","c"] }` ‚Üí "a" |
| `$last` | Dernier √©l√©ment | `{ $last: ["a","b","c"] }` ‚Üí "c" |
| `$slice` | Sous-tableau | `{ $slice: [["a","b","c"], 2] }` ‚Üí ["a","b"] |

### Op√©rateurs de Transformation

| Op√©rateur | Description | Exemple |
|-----------|-------------|---------|
| `$map` | Transformer chaque √©l√©ment | Appliquer une fonction |
| `$filter` | Filtrer les √©l√©ments | Garder ceux qui matchent |
| `$reduce` | R√©duire √† une valeur | Calculer une somme |
| `$reverseArray` | Inverser l'ordre | `{ $reverseArray: [1,2,3] }` ‚Üí [3,2,1] |
| `$sortArray` | Trier le tableau | Ordre croissant/d√©croissant |

### Op√©rateurs de Combinaison

| Op√©rateur | Description | Exemple |
|-----------|-------------|---------|
| `$concatArrays` | Concat√©ner tableaux | `{ $concatArrays: [[1,2],[3,4]] }` ‚Üí [1,2,3,4] |
| `$setUnion` | Union (valeurs uniques) | Combiner sans doublons |
| `$setIntersection` | Intersection | √âl√©ments communs |
| `$setDifference` | Diff√©rence | √âl√©ments dans A pas dans B |
| `$zip` | Combiner en paires | Cr√©er des tuples |

### Op√©rateurs de Cr√©ation

| Op√©rateur | Description | Exemple |
|-----------|-------------|---------|
| `$range` | Cr√©er une s√©quence | `{ $range: [0, 5] }` ‚Üí [0,1,2,3,4] |
| `$split` | Diviser une cha√Æne | Cr√©er un tableau |

## Op√©rateurs d'Information

### $size : Taille d'un Tableau

Retourne le nombre d'√©l√©ments dans un tableau.

**Syntaxe** :
```javascript
{ $size: <tableau> }
```

**Exemple 1 : Compter les Tags**

```javascript
// Collection: articles
{
  "_id": 1,
  "titre": "Introduction √† MongoDB",
  "tags": ["mongodb", "nosql", "base-de-donnees"]
}
```

```javascript
db.articles.aggregate([
  {
    $project: {
      titre: 1,
      tags: 1,
      nombreTags: { $size: "$tags" }
    }
  }
])
```

**R√©sultat** :
```javascript
{
  "_id": 1,
  "titre": "Introduction √† MongoDB",
  "tags": ["mongodb", "nosql", "base-de-donnees"],
  "nombreTags": 3
}
```

**Exemple 2 : Filtrer par Nombre d'√âl√©ments**

```javascript
// Trouver les articles avec plus de 5 tags
db.articles.aggregate([
  {
    $match: {
      $expr: {
        $gt: [{ $size: "$tags" }, 5]
      }
    }
  }
])
```

**Exemple 3 : Compter les Commandes par Client**

```javascript
// Collection: clients
{
  "_id": 1,
  "nom": "Alice",
  "commandes": [
    { "id": 101, "montant": 50 },
    { "id": 102, "montant": 75 },
    { "id": 103, "montant": 120 }
  ]
}
```

```javascript
db.clients.aggregate([
  {
    $project: {
      nom: 1,
      nombreCommandes: { $size: "$commandes" }
    }
  }
])
```

‚ö†Ô∏è **Important** : `$size` ne fonctionne **que sur des tableaux**. Si le champ n'existe pas ou est `null`, cela g√©n√®re une erreur.

**Solution** : Utiliser `$ifNull` :

```javascript
{
  $project: {
    nombreTags: {
      $size: { $ifNull: ["$tags", []] }
    }
  }
}
```

### $in : V√©rifier la Pr√©sence

V√©rifie si une valeur est pr√©sente dans un tableau.

**Syntaxe** :
```javascript
{ $in: [<valeur>, <tableau>] }
```

**Exemple 1 : V√©rifier un Tag Sp√©cifique**

```javascript
{
  $project: {
    titre: 1,
    estMongoDB: {
      $in: ["mongodb", "$tags"]
    }
  }
}
```

**R√©sultat** :
```javascript
{
  "_id": 1,
  "titre": "Introduction √† MongoDB",
  "estMongoDB": true
}
```

**Exemple 2 : Filtrer par Cat√©gorie**

```javascript
db.produits.aggregate([
  {
    $match: {
      $expr: {
        $in: ["$categorie", ["√âlectronique", "Informatique"]]
      }
    }
  }
])
```

**Exemple 3 : V√©rifier un R√¥le Utilisateur**

```javascript
{
  $project: {
    nom: 1,
    estAdmin: {
      $in: ["admin", "$roles"]
    },
    estModerateur: {
      $in: ["moderateur", "$roles"]
    }
  }
}
```

### $indexOfArray : Trouver la Position

Trouve l'index (position) d'un √©l√©ment dans un tableau.

**Syntaxe** :
```javascript
{ $indexOfArray: [<tableau>, <valeur>, <debut>, <fin>] }
```

Retourne `-1` si l'√©l√©ment n'est pas trouv√©. Les positions commencent √† 0.

**Exemple 1 : Position d'un Tag**

```javascript
{
  $project: {
    tags: 1,
    positionMongoDB: {
      $indexOfArray: ["$tags", "mongodb"]
    }
  }
}
```

**R√©sultat** :
```javascript
{
  "_id": 1,
  "tags": ["mongodb", "nosql", "base-de-donnees"],
  "positionMongoDB": 0
}
```

**Exemple 2 : V√©rifier si Pr√©sent**

```javascript
{
  $project: {
    tags: 1,
    aMongoDBTag: {
      $gte: [{ $indexOfArray: ["$tags", "mongodb"] }, 0]
    }
  }
}
// true si trouv√©, false si -1 (non trouv√©)
```

## Op√©rateurs d'Acc√®s

### $arrayElemAt : Acc√©der √† un √âl√©ment

Retourne l'√©l√©ment √† un index sp√©cifique.

**Syntaxe** :
```javascript
{ $arrayElemAt: [<tableau>, <index>] }
```

- Index positif : 0 = premier, 1 = deuxi√®me, etc.
- Index n√©gatif : -1 = dernier, -2 = avant-dernier, etc.

**Exemple 1 : Premier et Dernier Tag**

```javascript
{
  $project: {
    titre: 1,
    premierTag: { $arrayElemAt: ["$tags", 0] },
    dernierTag: { $arrayElemAt: ["$tags", -1] },
    deuxiemeTag: { $arrayElemAt: ["$tags", 1] }
  }
}
```

**R√©sultat** :
```javascript
{
  "_id": 1,
  "titre": "Introduction √† MongoDB",
  "premierTag": "mongodb",
  "dernierTag": "base-de-donnees",
  "deuxiemeTag": "nosql"
}
```

**Exemple 2 : Premi√®re Commande d'un Client**

```javascript
{
  $project: {
    nom: 1,
    premiereCommande: {
      $arrayElemAt: ["$commandes", 0]
    }
  }
}
```

**Exemple 3 : Extraire avec Index Variable**

```javascript
// Utiliser un champ comme index
{
  $project: {
    element: {
      $arrayElemAt: ["$items", "$indexSelectionne"]
    }
  }
}
```

### $first et $last : Premier et Dernier √âl√©ments

Ces op√©rateurs sont des raccourcis pour acc√©der au premier ou dernier √©l√©ment.

**Syntaxe** :
```javascript
{ $first: <tableau> }
{ $last: <tableau> }
```

**Exemple** :

```javascript
{
  $project: {
    tags: 1,
    premierTag: { $first: "$tags" },
    dernierTag: { $last: "$tags" }
  }
}
```

**√âquivalent avec $arrayElemAt** :
```javascript
{
  premierTag: { $arrayElemAt: ["$tags", 0] },
  dernierTag: { $arrayElemAt: ["$tags", -1] }
}
```

### $slice : Extraire une Portion

Extrait un sous-tableau.

**Syntaxe** :
```javascript
{ $slice: [<tableau>, <nombre>] }                    // Premiers N √©l√©ments
{ $slice: [<tableau>, <position>, <nombre>] }        // N √©l√©ments depuis position
```

**Exemple 1 : Premiers 3 √âl√©ments**

```javascript
{
  $project: {
    titre: 1,
    premiers3Tags: { $slice: ["$tags", 3] }
  }
}
```

**Exemple 2 : Derniers 2 √âl√©ments**

```javascript
{
  $project: {
    derniers2Tags: { $slice: ["$tags", -2] }
  }
}
```

**Exemple 3 : √âl√©ments du Milieu**

```javascript
// 3 √©l√©ments √† partir de la position 2
{
  $project: {
    milieu: { $slice: ["$tags", 2, 3] }
  }
}
```

**Cas d'usage** : Pagination dans un tableau

```javascript
// Collection: posts avec commentaires
{
  $project: {
    titre: 1,
    premiers5Commentaires: { $slice: ["$commentaires", 5] },
    commentairesSuivants: { $slice: ["$commentaires", 5, 5] }
  }
}
```

## Op√©rateurs de Transformation

### $map : Transformer Chaque √âl√©ment

Applique une transformation √† chaque √©l√©ment d'un tableau.

**Syntaxe** :
```javascript
{
  $map: {
    input: <tableau>,
    as: "<nom_variable>",
    in: <expression>
  }
}
```

**Exemple 1 : Doubler tous les Nombres**

```javascript
// Collection: donn√©es
{ "_id": 1, "valeurs": [1, 2, 3, 4, 5] }
```

```javascript
{
  $project: {
    valeurs: 1,
    valeursDoubles: {
      $map: {
        input: "$valeurs",
        as: "valeur",
        in: { $multiply: ["$$valeur", 2] }
      }
    }
  }
}
```

**R√©sultat** :
```javascript
{
  "_id": 1,
  "valeurs": [1, 2, 3, 4, 5],
  "valeursDoubles": [2, 4, 6, 8, 10]
}
```

**Exemple 2 : Ajouter TVA √† tous les Prix**

```javascript
// Collection: produits
{
  "_id": 1,
  "nom": "Pack √âlectronique",
  "prixHT": [100, 200, 50]
}
```

```javascript
{
  $project: {
    nom: 1,
    prixTTC: {
      $map: {
        input: "$prixHT",
        as: "prix",
        in: { $multiply: ["$$prix", 1.20] }
      }
    }
  }
}
```

**R√©sultat** :
```javascript
{
  "_id": 1,
  "nom": "Pack √âlectronique",
  "prixTTC": [120, 240, 60]
}
```

**Exemple 3 : Extraire un Champ d'Objets**

```javascript
// Collection: commandes
{
  "_id": 1,
  "items": [
    { "nom": "Produit A", "quantite": 2, "prix": 10 },
    { "nom": "Produit B", "quantite": 1, "prix": 25 }
  ]
}
```

```javascript
{
  $project: {
    nomsItems: {
      $map: {
        input: "$items",
        as: "item",
        in: "$$item.nom"
      }
    },
    totaux: {
      $map: {
        input: "$items",
        as: "item",
        in: { $multiply: ["$$item.quantite", "$$item.prix"] }
      }
    }
  }
}
```

**R√©sultat** :
```javascript
{
  "_id": 1,
  "nomsItems": ["Produit A", "Produit B"],
  "totaux": [20, 25]
}
```

### $filter : Filtrer les √âl√©ments

Garde uniquement les √©l√©ments qui correspondent √† une condition.

**Syntaxe** :
```javascript
{
  $filter: {
    input: <tableau>,
    as: "<nom_variable>",
    cond: <condition>
  }
}
```

**Exemple 1 : Garder les Nombres > 5**

```javascript
{
  $project: {
    valeurs: 1,
    valeursSupA5: {
      $filter: {
        input: "$valeurs",
        as: "val",
        cond: { $gt: ["$$val", 5] }
      }
    }
  }
}
```

**R√©sultat** (si valeurs = [3, 7, 2, 9, 4, 10]) :
```javascript
{
  "_id": 1,
  "valeurs": [3, 7, 2, 9, 4, 10],
  "valeursSupA5": [7, 9, 10]
}
```

**Exemple 2 : Filtrer les Commandes Valid√©es**

```javascript
{
  $project: {
    commandesValidees: {
      $filter: {
        input: "$commandes",
        as: "cmd",
        cond: { $eq: ["$$cmd.statut", "valid√©e"] }
      }
    }
  }
}
```

**Exemple 3 : Produits en Stock**

```javascript
{
  $project: {
    produitsDisponibles: {
      $filter: {
        input: "$produits",
        as: "prod",
        cond: { $gt: ["$$prod.stock", 0] }
      }
    }
  }
}
```

**Exemple 4 : Prix dans une Fourchette**

```javascript
{
  $project: {
    produitsAbordables: {
      $filter: {
        input: "$produits",
        as: "prod",
        cond: {
          $and: [
            { $gte: ["$$prod.prix", 10] },
            { $lte: ["$$prod.prix", 100] }
          ]
        }
      }
    }
  }
}
```

### $reduce : R√©duire √† une Valeur

R√©duit un tableau √† une seule valeur en appliquant une op√©ration cumulative.

**Syntaxe** :
```javascript
{
  $reduce: {
    input: <tableau>,
    initialValue: <valeur_initiale>,
    in: <expression>
  }
}
```

Dans l'expression `in` :
- `$$value` : Valeur accumul√©e
- `$$this` : √âl√©ment courant

**Exemple 1 : Somme de Tous les √âl√©ments**

```javascript
{
  $project: {
    valeurs: [10, 20, 30, 40],
    somme: {
      $reduce: {
        input: "$valeurs",
        initialValue: 0,
        in: { $add: ["$$value", "$$this"] }
      }
    }
  }
}
// R√©sultat : somme = 100
```

**Exemple 2 : Concat√©ner des Cha√Ænes**

```javascript
{
  $project: {
    mots: ["Bonjour", "le", "monde"],
    phrase: {
      $reduce: {
        input: "$mots",
        initialValue: "",
        in: {
          $concat: [
            "$$value",
            { $cond: [{ $eq: ["$$value", ""] }, "", " "] },
            "$$this"
          ]
        }
      }
    }
  }
}
// R√©sultat : "Bonjour le monde"
```

**Exemple 3 : Total d'une Commande**

```javascript
{
  $project: {
    totalCommande: {
      $reduce: {
        input: "$items",
        initialValue: 0,
        in: {
          $add: [
            "$$value",
            { $multiply: ["$$this.quantite", "$$this.prix"] }
          ]
        }
      }
    }
  }
}
```

**Exemple 4 : Trouver le Maximum**

```javascript
{
  $project: {
    valeurs: [3, 7, 2, 9, 4],
    maximum: {
      $reduce: {
        input: "$valeurs",
        initialValue: { $arrayElemAt: ["$valeurs", 0] },
        in: {
          $cond: [
            { $gt: ["$$this", "$$value"] },
            "$$this",
            "$$value"
          ]
        }
      }
    }
  }
}
// R√©sultat : maximum = 9
```

### $reverseArray : Inverser l'Ordre

Inverse l'ordre des √©l√©ments dans un tableau.

**Syntaxe** :
```javascript
{ $reverseArray: <tableau> }
```

**Exemple** :

```javascript
{
  $project: {
    tags: 1,
    tagsInverses: { $reverseArray: "$tags" }
  }
}
```

**R√©sultat** :
```javascript
{
  "_id": 1,
  "tags": ["mongodb", "nosql", "base-de-donnees"],
  "tagsInverses": ["base-de-donnees", "nosql", "mongodb"]
}
```

**Cas d'usage** : Afficher les commentaires du plus r√©cent au plus ancien

```javascript
{
  $project: {
    commentairesRecents: {
      $reverseArray: "$commentaires"
    }
  }
}
```

### $sortArray : Trier un Tableau

Trie les √©l√©ments d'un tableau.

**Syntaxe** :
```javascript
{
  $sortArray: {
    input: <tableau>,
    sortBy: <ordre>  // 1 croissant, -1 d√©croissant
  }
}
```

Pour trier des objets :
```javascript
{
  $sortArray: {
    input: <tableau>,
    sortBy: { <champ>: <ordre> }
  }
}
```

**Exemple 1 : Trier des Nombres**

```javascript
{
  $project: {
    valeurs: [5, 2, 8, 1, 9],
    valeursCroissantes: {
      $sortArray: {
        input: "$valeurs",
        sortBy: 1
      }
    },
    valeursDecroissantes: {
      $sortArray: {
        input: "$valeurs",
        sortBy: -1
      }
    }
  }
}
```

**R√©sultat** :
```javascript
{
  "valeurs": [5, 2, 8, 1, 9],
  "valeursCroissantes": [1, 2, 5, 8, 9],
  "valeursDecroissantes": [9, 8, 5, 2, 1]
}
```

**Exemple 2 : Trier des Objets par Champ**

```javascript
{
  $project: {
    produitsParPrix: {
      $sortArray: {
        input: "$produits",
        sortBy: { prix: 1 }
      }
    }
  }
}
```

**Exemple 3 : Tri Multiple**

```javascript
{
  $project: {
    itemsTries: {
      $sortArray: {
        input: "$items",
        sortBy: { categorie: 1, prix: -1 }
      }
    }
  }
}
```

## Op√©rateurs de Combinaison

### $concatArrays : Concat√©ner des Tableaux

Combine plusieurs tableaux en un seul.

**Syntaxe** :
```javascript
{ $concatArrays: [<tableau1>, <tableau2>, ...] }
```

**Exemple 1 : Combiner Deux Listes**

```javascript
{
  $project: {
    tousLesTags: {
      $concatArrays: ["$tagsGeneraux", "$tagsSpecifiques"]
    }
  }
}
```

**R√©sultat** :
```javascript
// Si tagsGeneraux = ["mongodb", "nosql"]
// Et tagsSpecifiques = ["tutoriel", "debutant"]
{
  "tousLesTags": ["mongodb", "nosql", "tutoriel", "debutant"]
}
```

**Exemple 2 : Ajouter un √âl√©ment**

```javascript
{
  $project: {
    tagsAvecNouveau: {
      $concatArrays: ["$tags", ["nouveau-tag"]]
    }
  }
}
```

**Exemple 3 : Fusionner Plusieurs Sources**

```javascript
{
  $project: {
    tousLesItems: {
      $concatArrays: [
        "$itemsCommande",
        "$itemsPromo",
        "$itemsGratuits"
      ]
    }
  }
}
```

### $setUnion : Union sans Doublons

Combine des tableaux en ne gardant que les valeurs uniques.

**Syntaxe** :
```javascript
{ $setUnion: [<tableau1>, <tableau2>, ...] }
```

**Exemple** :

```javascript
{
  $project: {
    array1: ["a", "b", "c"],
    array2: ["c", "d", "e"],
    union: {
      $setUnion: [["a", "b", "c"], ["c", "d", "e"]]
    }
  }
}
```

**R√©sultat** :
```javascript
{
  "array1": ["a", "b", "c"],
  "array2": ["c", "d", "e"],
  "union": ["a", "b", "c", "d", "e"]  // Pas de doublon "c"
}
```

**Cas d'usage** : Fusionner les tags de plusieurs sources

```javascript
{
  $project: {
    tousLesTagsUniques: {
      $setUnion: [
        "$tagsAuteur",
        "$tagsEditeur",
        "$tagsCommunaute"
      ]
    }
  }
}
```

### $setIntersection : Intersection

Retourne uniquement les √©l√©ments pr√©sents dans **tous** les tableaux.

**Syntaxe** :
```javascript
{ $setIntersection: [<tableau1>, <tableau2>, ...] }
```

**Exemple** :

```javascript
{
  $project: {
    tagsCommuns: {
      $setIntersection: [
        ["mongodb", "nosql", "javascript"],
        ["mongodb", "python", "javascript"],
        ["mongodb", "java", "javascript"]
      ]
    }
  }
}
```

**R√©sultat** :
```javascript
{
  "tagsCommuns": ["mongodb", "javascript"]
}
```

**Cas d'usage** : Trouver les produits communs √† plusieurs cat√©gories

```javascript
{
  $project: {
    produitsMultiCategories: {
      $setIntersection: [
        "$produitsElectronique",
        "$produitsInformatique"
      ]
    }
  }
}
```

### $setDifference : Diff√©rence

Retourne les √©l√©ments du premier tableau qui ne sont **pas** dans le second.

**Syntaxe** :
```javascript
{ $setDifference: [<tableau1>, <tableau2>] }
```

**Exemple** :

```javascript
{
  $project: {
    tagsUniquesA: {
      $setDifference: [
        ["mongodb", "nosql", "javascript"],
        ["mongodb", "python"]
      ]
    }
  }
}
```

**R√©sultat** :
```javascript
{
  "tagsUniquesA": ["nosql", "javascript"]
}
```

**Cas d'usage** : Trouver les produits en stock mais pas en promotion

```javascript
{
  $project: {
    produitsNormaux: {
      $setDifference: [
        "$produitsEnStock",
        "$produitsEnPromo"
      ]
    }
  }
}
```

### $zip : Combiner en Paires

Combine plusieurs tableaux √©l√©ment par √©l√©ment (comme une fermeture √©clair).

**Syntaxe** :
```javascript
{
  $zip: {
    inputs: [<tableau1>, <tableau2>, ...],
    useLongestLength: <boolean>,     // Optionnel
    defaults: [<valeur1>, ...]       // Optionnel
  }
}
```

**Exemple 1 : Combiner Noms et Scores**

```javascript
{
  $project: {
    noms: ["Alice", "Bob", "Charlie"],
    scores: [95, 87, 92],
    classement: {
      $zip: {
        inputs: ["$noms", "$scores"]
      }
    }
  }
}
```

**R√©sultat** :
```javascript
{
  "classement": [
    ["Alice", 95],
    ["Bob", 87],
    ["Charlie", 92]
  ]
}
```

**Exemple 2 : Tableaux de Longueurs Diff√©rentes**

```javascript
{
  $project: {
    noms: ["Alice", "Bob", "Charlie"],
    ages: [25, 30],
    donnees: {
      $zip: {
        inputs: ["$noms", "$ages"],
        useLongestLength: true,
        defaults: [null, 0]
      }
    }
  }
}
```

**R√©sultat** :
```javascript
{
  "donnees": [
    ["Alice", 25],
    ["Bob", 30],
    ["Charlie", 0]  // Age par d√©faut
  ]
}
```

## Op√©rateurs de Cr√©ation

### $range : Cr√©er une S√©quence

G√©n√®re un tableau de nombres en s√©quence.

**Syntaxe** :
```javascript
{ $range: [<debut>, <fin>, <pas>] }
```

- `debut` : Inclus
- `fin` : Exclus
- `pas` : Optionnel (d√©faut = 1)

**Exemple 1 : S√©quence Simple**

```javascript
{
  $project: {
    nombres: { $range: [0, 5] }
  }
}
```

**R√©sultat** :
```javascript
{
  "nombres": [0, 1, 2, 3, 4]
}
```

**Exemple 2 : Avec Pas Personnalis√©**

```javascript
{
  $project: {
    pairs: { $range: [0, 10, 2] },
    dizaines: { $range: [0, 100, 10] }
  }
}
```

**R√©sultat** :
```javascript
{
  "pairs": [0, 2, 4, 6, 8],
  "dizaines": [0, 10, 20, 30, 40, 50, 60, 70, 80, 90]
}
```

**Cas d'usage** : G√©n√©rer des num√©ros de page

```javascript
{
  $project: {
    nombrePages: 5,
    pages: {
      $range: [1, { $add: ["$nombrePages", 1] }]
    }
  }
}
// R√©sultat : pages = [1, 2, 3, 4, 5]
```

## Cas d'Usage Pratiques

### 1. Statistiques sur des Listes

```javascript
// Analyser les notes d'un √©tudiant
db.etudiants.aggregate([
  {
    $project: {
      nom: 1,
      notes: 1,

      // Nombre de notes
      nombreNotes: { $size: "$notes" },

      // Meilleure note
      meilleureNote: {
        $reduce: {
          input: "$notes",
          initialValue: 0,
          in: {
            $cond: [
              { $gt: ["$$this", "$$value"] },
              "$$this",
              "$$value"
            ]
          }
        }
      },

      // Moyenne
      moyenne: { $avg: "$notes" },

      // Notes tri√©es
      notesCroissantes: {
        $sortArray: {
          input: "$notes",
          sortBy: 1
        }
      },

      // Notes > 10
      notesReussies: {
        $filter: {
          input: "$notes",
          as: "note",
          cond: { $gte: ["$$note", 10] }
        }
      }
    }
  }
])
```

### 2. Gestion de Panier d'Achat

```javascript
// Calculer le total d'un panier
db.paniers.aggregate([
  {
    $project: {
      client: 1,
      items: 1,

      // Total du panier
      totalPanier: {
        $reduce: {
          input: "$items",
          initialValue: 0,
          in: {
            $add: [
              "$$value",
              { $multiply: ["$$this.quantite", "$$this.prix"] }
            ]
          }
        }
      },

      // Nombre d'articles diff√©rents
      nombreArticles: { $size: "$items" },

      // Quantit√© totale
      quantiteTotale: {
        $reduce: {
          input: "$items",
          initialValue: 0,
          in: { $add: ["$$value", "$$this.quantite"] }
        }
      },

      // Articles en promo
      articlesEnPromo: {
        $filter: {
          input: "$items",
          as: "item",
          cond: { $eq: ["$$item.promo", true] }
        }
      },

      // Noms des produits
      nomsProduits: {
        $map: {
          input: "$items",
          as: "item",
          in: "$$item.nom"
        }
      }
    }
  }
])
```

### 3. Analyse de Tags et Cat√©gories

```javascript
// Analyser les articles par tags
db.articles.aggregate([
  {
    $project: {
      titre: 1,
      tags: 1,

      // Nombre de tags
      nombreTags: { $size: "$tags" },

      // Tags en majuscules
      tagsFormats: {
        $map: {
          input: "$tags",
          as: "tag",
          in: { $toUpper: "$$tag" }
        }
      },

      // A des tags sp√©cifiques
      estTutoriel: { $in: ["tutoriel", "$tags"] },
      estMongoDB: { $in: ["mongodb", "$tags"] },

      // Tags tri√©s alphab√©tiquement
      tagsTries: {
        $sortArray: {
          input: "$tags",
          sortBy: 1
        }
      },

      // Premiers 3 tags
      tagsPrincipaux: { $slice: ["$tags", 3] }
    }
  }
])
```

### 4. Fusion de Donn√©es de Plusieurs Sources

```javascript
// Combiner les activit√©s de plusieurs sources
db.utilisateurs.aggregate([
  {
    $project: {
      nom: 1,

      // Toutes les activit√©s (avec doublons potentiels)
      toutesActivites: {
        $concatArrays: [
          "$activitesWeb",
          "$activitesMobile",
          "$activitesAPI"
        ]
      },

      // Activit√©s uniques
      activitesUniques: {
        $setUnion: [
          "$activitesWeb",
          "$activitesMobile",
          "$activitesAPI"
        ]
      },

      // Activit√©s sur toutes les plateformes
      activitesMultiplateforme: {
        $setIntersection: [
          "$activitesWeb",
          "$activitesMobile",
          "$activitesAPI"
        ]
      },

      // Activit√©s uniquement web
      activitesWebSeul: {
        $setDifference: [
          "$activitesWeb",
          { $concatArrays: ["$activitesMobile", "$activitesAPI"] }
        ]
      }
    }
  }
])
```

### 5. Cr√©ation de Rapports Structur√©s

```javascript
// Cr√©er un rapport avec donn√©es structur√©es
db.ventes.aggregate([
  {
    $group: {
      _id: "$vendeur",
      montants: { $push: "$montant" },
      dates: { $push: "$date" }
    }
  },
  {
    $project: {
      vendeur: "$_id",

      // Statistiques
      nombreVentes: { $size: "$montants" },
      totalVentes: { $sum: "$montants" },
      moyenneVente: { $avg: "$montants" },

      // Combiner dates et montants
      ventesDetaillees: {
        $zip: {
          inputs: ["$dates", "$montants"]
        }
      },

      // Top 5 des ventes
      top5Ventes: {
        $slice: [
          {
            $sortArray: {
              input: "$montants",
              sortBy: -1
            }
          },
          5
        ]
      },

      // Distribution par tranches
      ventesInferieures100: {
        $size: {
          $filter: {
            input: "$montants",
            as: "m",
            cond: { $lt: ["$$m", 100] }
          }
        }
      },
      ventesMoyennes: {
        $size: {
          $filter: {
            input: "$montants",
            as: "m",
            cond: {
              $and: [
                { $gte: ["$$m", 100] },
                { $lt: ["$$m", 500] }
              ]
            }
          }
        }
      },
      ventesElevees: {
        $size: {
          $filter: {
            input: "$montants",
            as: "m",
            cond: { $gte: ["$$m", 500] }
          }
        }
      }
    }
  }
])
```

## Gestion des Erreurs et Valeurs Sp√©ciales

### Tableaux null ou Manquants

```javascript
// ‚ùå ERREUR : $size sur null
{ $size: null }  // Erreur !

// ‚úÖ SOLUTION : Utiliser $ifNull
{
  $project: {
    nombreTags: {
      $size: { $ifNull: ["$tags", []] }
    }
  }
}
```

### Tableaux Vides

```javascript
{
  $project: {
    premierTag: {
      $cond: {
        if: { $gt: [{ $size: { $ifNull: ["$tags", []] } }, 0] },
        then: { $first: "$tags" },
        else: "Aucun tag"
      }
    }
  }
}
```

### Index Hors Limites

```javascript
// $arrayElemAt retourne null si index hors limites
{ $arrayElemAt: [[1, 2, 3], 10] }  // ‚Üí null

// V√©rifier avant d'acc√©der
{
  $project: {
    element: {
      $cond: {
        if: { $lt: ["$index", { $size: "$array" }] },
        then: { $arrayElemAt: ["$array", "$index"] },
        else: null
      }
    }
  }
}
```

## Performances et Optimisations

### 1. Filtrer Avant de Transformer

```javascript
// ‚ùå MOINS EFFICACE
db.produits.aggregate([
  {
    $project: {
      tagsFormats: {
        $map: {
          input: "$tags",
          as: "tag",
          in: { $toUpper: "$$tag" }
        }
      }
    }
  },
  {
    $match: { categorie: "√âlectronique" }
  }
])

// ‚úÖ MIEUX
db.produits.aggregate([
  {
    $match: { categorie: "√âlectronique" }
  },
  {
    $project: {
      tagsFormats: {
        $map: {
          input: "$tags",
          as: "tag",
          in: { $toUpper: "$$tag" }
        }
      }
    }
  }
])
```

### 2. Limiter la Taille des Tableaux

Les documents MongoDB sont limit√©s √† 16 Mo. √âvitez les tableaux trop grands :

```javascript
// Limiter aux 100 premiers √©l√©ments si n√©cessaire
{
  $project: {
    items: { $slice: ["$items", 100] }
  }
}
```

### 3. Utiliser des Index pour $in

Si vous utilisez souvent `$in` sur des champs, cr√©ez un index :

```javascript
db.articles.createIndex({ tags: 1 })

// Cette requ√™te utilisera l'index
db.articles.aggregate([
  {
    $match: {
      tags: { $in: ["mongodb", "nosql"] }
    }
  }
])
```

### 4. √âviter les Op√©rations Co√ªteuses en Boucle

```javascript
// ‚ùå CO√õTEUX : $reduce avec op√©ration complexe
{
  $project: {
    resultat: {
      $reduce: {
        input: { $range: [0, 10000] },
        initialValue: [],
        in: {
          $concatArrays: [
            "$$value",
            [{ $multiply: ["$$this", "$$this"] }]
          ]
        }
      }
    }
  }
}

// ‚úÖ MIEUX : Simplifier ou pr√©-calculer
```

## Points Cl√©s √† Retenir

1. ‚úÖ **$size** : Nombre d'√©l√©ments (attention aux null)
2. ‚úÖ **$arrayElemAt** : Acc√©der √† un index (0, 1, -1, -2...)
3. ‚úÖ **$map** : Transformer chaque √©l√©ment
4. ‚úÖ **$filter** : Garder les √©l√©ments qui matchent
5. ‚úÖ **$reduce** : R√©duire √† une valeur unique
6. ‚úÖ **$concatArrays** : Fusionner des tableaux
7. ‚úÖ **$sortArray** : Trier un tableau
8. ‚úÖ **$slice** : Extraire une portion
9. ‚ö†Ô∏è **null** : Toujours utiliser $ifNull
10. ‚ö° **Performance** : Filtrer avant transformer

## Conclusion

Les op√©rateurs de tableaux sont des outils **puissants et flexibles** pour :

- üìä **Analyser** le contenu des listes
- üîÑ **Transformer** chaque √©l√©ment
- üîç **Filtrer** selon des crit√®res
- üßÆ **Calculer** des agr√©gations personnalis√©es
- üîó **Combiner** plusieurs sources de donn√©es
- ‚úÇÔ∏è **Extraire** des portions sp√©cifiques

La ma√Ætrise des op√©rateurs de tableaux est essentielle pour exploiter pleinement les capacit√©s de MongoDB avec des structures de donn√©es complexes. Ils permettent de manipuler des listes directement dans la base de donn√©es, √©vitant ainsi de devoir traiter ces op√©rations dans votre code applicatif.

---


‚è≠Ô∏è [Op√©rateurs conditionnels](/06-framework-agregation/05.5-operateurs-conditionnels.md)
