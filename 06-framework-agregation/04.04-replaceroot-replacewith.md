üîù Retour au [Sommaire](/SOMMAIRE.md)

# 6.4.4 $replaceRoot et $replaceWith

## Introduction

Les √©tapes `$replaceRoot` et `$replaceWith` sont des op√©rateurs du framework d'agr√©gation MongoDB qui permettent de **remplacer compl√®tement le document racine** par un nouveau document ou par un sous-document imbriqu√©.

### L'Essentiel

- **`$replaceRoot`** : Remplace le document racine par un document sp√©cifi√©
- **`$replaceWith`** : Alias de `$replaceRoot` (introduit dans MongoDB 4.2)
- **Fonctionnement identique** : Les deux font exactement la m√™me chose
- **Transformation totale** : Le document d'origine est enti√®rement remplac√©

### Analogie Simple

Imaginez que vous avez une **bo√Æte contenant une autre bo√Æte** √† l'int√©rieur. `$replaceRoot` / `$replaceWith` c'est comme **jeter la bo√Æte ext√©rieure** et ne garder que la bo√Æte int√©rieure. Ou encore, c'est comme **promouvoir un √©l√©ment imbriqu√© au niveau principal**.

---

## Pourquoi Utiliser $replaceRoot / $replaceWith ?

Ces op√©rateurs sont essentiels pour :

1. **Promouvoir un sous-document** au niveau racine
2. **Simplifier la structure** des documents
3. **Extraire des donn√©es imbriqu√©es** apr√®s des op√©rations complexes
4. **Restructurer compl√®tement** les documents
5. **Nettoyer les r√©sultats** d'agr√©gations complexes
6. **Cr√©er de nouveaux documents** √† partir de calculs

---

## Syntaxe

### Syntaxe de $replaceRoot

```javascript
{
  $replaceRoot: {
    newRoot: <expression_ou_chemin_vers_document>
  }
}
```

### Syntaxe de $replaceWith (Simplifi√©e)

```javascript
{
  $replaceWith: <expression_ou_chemin_vers_document>
}
```

### Param√®tres

- **`newRoot`** (pour $replaceRoot) : Le document qui remplacera le document racine
- **Expression directe** (pour $replaceWith) : Document de remplacement sans besoin de `newRoot:`

---

## Diff√©rence entre $replaceRoot et $replaceWith

### Aucune Diff√©rence Fonctionnelle !

Ces deux pipelines sont **identiques** :

```javascript
// Avec $replaceRoot
db.collection.aggregate([
  {
    $replaceRoot: {
      newRoot: "$sous_document"
    }
  }
])

// Avec $replaceWith (plus simple)
db.collection.aggregate([
  {
    $replaceWith: "$sous_document"
  }
])
```

### Quelle Version Utiliser ?

| Op√©rateur | Quand l'utiliser |
|-----------|------------------|
| **$replaceWith** | ‚úÖ **Recommand√©** - Syntaxe plus courte et intuitive |
| **$replaceRoot** | Compatible avec MongoDB < 4.2 (anciennes versions) |

üí° **Conseil** : Privil√©giez `$replaceWith` pour sa syntaxe simplifi√©e, sauf si vous devez supporter d'anciennes versions de MongoDB.

---

## Concept de Base : Promouvoir un Sous-Document

### Exemple Visuel

**Document Original** :
```json
{
  "_id": 1,
  "nom_utilisateur": "alice123",
  "profil": {
    "nom": "Alice",
    "prenom": "Dupont",
    "age": 28,
    "ville": "Paris"
  },
  "date_inscription": "2024-01-15"
}
```

**Apr√®s $replaceWith: "$profil"** :
```json
{
  "nom": "Alice",
  "prenom": "Dupont",
  "age": 28,
  "ville": "Paris"
}
```

### Observation Importante

- Le document **racine** (`_id`, `nom_utilisateur`, `date_inscription`) est **perdu**
- Le sous-document `profil` **devient** le document racine
- **Transformation compl√®te** : rien de l'ancien document n'est conserv√©

---

## Exemple Pratique D√©taill√©

### Pr√©paration des Donn√©es

```javascript
db.commandes.insertMany([
  {
    _id: 1,
    numero_commande: "CMD-001",
    date: ISODate("2024-01-15"),
    client: {
      nom: "Dupont",
      prenom: "Jean",
      email: "jean.dupont@email.com",
      adresse: {
        rue: "123 Rue de la Paix",
        ville: "Paris",
        code_postal: "75001"
      }
    },
    montant_total: 450.00
  },
  {
    _id: 2,
    numero_commande: "CMD-002",
    date: ISODate("2024-01-20"),
    client: {
      nom: "Martin",
      prenom: "Marie",
      email: "marie.martin@email.com",
      adresse: {
        rue: "456 Avenue des Champs",
        ville: "Lyon",
        code_postal: "69001"
      }
    },
    montant_total: 320.00
  }
])
```

### Application de $replaceWith

**Extraire uniquement les informations client** :

```javascript
db.commandes.aggregate([
  {
    $replaceWith: "$client"
  }
])
```

**R√©sultat** :
```json
[
  {
    "nom": "Dupont",
    "prenom": "Jean",
    "email": "jean.dupont@email.com",
    "adresse": {
      "rue": "123 Rue de la Paix",
      "ville": "Paris",
      "code_postal": "75001"
    }
  },
  {
    "nom": "Martin",
    "prenom": "Marie",
    "email": "marie.martin@email.com",
    "adresse": {
      "rue": "456 Avenue des Champs",
      "ville": "Lyon",
      "code_postal": "69001"
    }
  }
]
```

---

## Cr√©er un Nouveau Document avec $replaceWith

Vous pouvez cr√©er un **document enti√®rement nouveau** en combinant des champs existants.

### Exemple : Restructurer les Donn√©es

```javascript
db.commandes.aggregate([
  {
    $replaceWith: {
      client_nom_complet: {
        $concat: ["$client.prenom", " ", "$client.nom"]
      },
      email: "$client.email",
      ville: "$client.adresse.ville",
      montant: "$montant_total",
      date_commande: "$date"
    }
  }
])
```

**R√©sultat** :
```json
[
  {
    "client_nom_complet": "Jean Dupont",
    "email": "jean.dupont@email.com",
    "ville": "Paris",
    "montant": 450.00,
    "date_commande": ISODate("2024-01-15")
  },
  {
    "client_nom_complet": "Marie Martin",
    "email": "marie.martin@email.com",
    "ville": "Lyon",
    "montant": 320.00,
    "date_commande": ISODate("2024-01-20")
  }
]
```

---

## Utilisation avec $mergeObjects

`$mergeObjects` permet de **fusionner plusieurs documents** en un seul, ce qui est tr√®s utile avec `$replaceWith`.

### Exemple : Aplatir une Structure

```javascript
db.produits.insertMany([
  {
    _id: 1,
    reference: "PROD-001",
    details: {
      nom: "Laptop",
      categorie: "Informatique"
    },
    prix: {
      ht: 899,
      tva: 179.8,
      ttc: 1078.8
    }
  },
  {
    _id: 2,
    reference: "PROD-002",
    details: {
      nom: "Souris",
      categorie: "Accessoires"
    },
    prix: {
      ht: 29,
      tva: 5.8,
      ttc: 34.8
    }
  }
])

// Fusionner tous les sous-documents au niveau racine
db.produits.aggregate([
  {
    $replaceWith: {
      $mergeObjects: [
        { reference: "$reference" },  // Conserver la r√©f√©rence
        "$details",                   // Aplatir details
        "$prix"                       // Aplatir prix
      ]
    }
  }
])
```

**R√©sultat** :
```json
[
  {
    "reference": "PROD-001",
    "nom": "Laptop",
    "categorie": "Informatique",
    "ht": 899,
    "tva": 179.8,
    "ttc": 1078.8
  },
  {
    "reference": "PROD-002",
    "nom": "Souris",
    "categorie": "Accessoires",
    "ht": 29,
    "tva": 5.8,
    "ttc": 34.8
  }
]
```

### $mergeObjects : Ordre d'Importance

En cas de **conflit de noms de champs**, le dernier document dans le tableau l'emporte :

```javascript
{
  $mergeObjects: [
    { nom: "Valeur1", prix: 100 },
    { nom: "Valeur2", stock: 50 }
  ]
}
// R√©sultat : { nom: "Valeur2", prix: 100, stock: 50 }
// "nom" de l'objet 2 √©crase celui de l'objet 1
```

---

## Cas d'Usage Courants

### 1. Simplifier les R√©sultats de $lookup

Apr√®s une jointure, le r√©sultat est souvent un tableau. `$replaceWith` permet de nettoyer la structure.

```javascript
db.commandes.aggregate([
  {
    $lookup: {
      from: "clients",
      localField: "client_id",
      foreignField: "_id",
      as: "client_info"
    }
  },
  {
    $unwind: "$client_info"
  },
  // Remplacer par un document restructur√©
  {
    $replaceWith: {
      numero_commande: "$numero_commande",
      date: "$date",
      montant: "$montant_total",
      client: {
        nom: "$client_info.nom",
        email: "$client_info.email",
        ville: "$client_info.ville"
      }
    }
  }
])
```

### 2. Extraire un √âl√©ment de Tableau

Promouvoir le premier √©l√©ment d'un tableau au niveau racine :

```javascript
db.resultats.insertOne({
  _id: 1,
  recherche: "MongoDB",
  resultats: [
    { titre: "Documentation MongoDB", score: 95 },
    { titre: "Tutoriel MongoDB", score: 88 },
    { titre: "MongoDB University", score: 92 }
  ]
})

// Extraire le meilleur r√©sultat
db.resultats.aggregate([
  {
    $replaceWith: {
      $arrayElemAt: ["$resultats", 0]  // Premier √©l√©ment
    }
  }
])
```

**R√©sultat** :
```json
{
  "titre": "Documentation MongoDB",
  "score": 95
}
```

### 3. Promouvoir un Sous-Document Profond

```javascript
db.organisations.insertOne({
  _id: 1,
  nom_organisation: "TechCorp",
  departements: {
    informatique: {
      budget: 500000,
      employes: 25,
      responsable: {
        nom: "Alice",
        email: "alice@techcorp.com"
      }
    }
  }
})

// Promouvoir les infos du responsable
db.organisations.aggregate([
  {
    $replaceWith: "$departements.informatique.responsable"
  }
])
```

**R√©sultat** :
```json
{
  "nom": "Alice",
  "email": "alice@techcorp.com"
}
```

### 4. Transformation Conditionnelle

Remplacer le document par diff√©rentes structures selon une condition :

```javascript
db.utilisateurs.insertMany([
  {
    _id: 1,
    type: "particulier",
    particulier: { nom: "Dupont", prenom: "Jean" }
  },
  {
    _id: 2,
    type: "entreprise",
    entreprise: { raison_sociale: "TechCorp", siret: "12345678901234" }
  }
])

db.utilisateurs.aggregate([
  {
    $replaceWith: {
      $cond: {
        if: { $eq: ["$type", "particulier"] },
        then: "$particulier",
        else: "$entreprise"
      }
    }
  }
])
```

**R√©sultat** :
```json
[
  { "nom": "Dupont", "prenom": "Jean" },
  { "raison_sociale": "TechCorp", "siret": "12345678901234" }
]
```

---

## Combiner avec d'Autres √âtapes

### Pipeline Complet : Analyse et Restructuration

```javascript
db.ventes.insertMany([
  {
    _id: 1,
    date: ISODate("2024-01-15"),
    vendeur: {
      nom: "Alice",
      region: "Nord"
    },
    produits: [
      { nom: "Laptop", prix: 899, quantite: 2 },
      { nom: "Souris", prix: 29, quantite: 5 }
    ]
  },
  {
    _id: 2,
    date: ISODate("2024-01-20"),
    vendeur: {
      nom: "Bob",
      region: "Sud"
    },
    produits: [
      { nom: "Clavier", prix: 79, quantite: 3 }
    ]
  }
])

db.ventes.aggregate([
  // √âtape 1 : D√©plier les produits
  { $unwind: "$produits" },

  // √âtape 2 : Calculer le montant par ligne
  {
    $set: {
      montant_ligne: {
        $multiply: ["$produits.prix", "$produits.quantite"]
      }
    }
  },

  // √âtape 3 : Grouper par vendeur
  {
    $group: {
      _id: "$vendeur.nom",
      region: { $first: "$vendeur.region" },
      total_ventes: { $sum: "$montant_ligne" },
      nombre_lignes: { $sum: 1 }
    }
  },

  // √âtape 4 : Restructurer le document final
  {
    $replaceWith: {
      vendeur: "$_id",
      region: "$region",
      performance: {
        total_ventes: "$total_ventes",
        nombre_lignes: "$nombre_lignes",
        vente_moyenne: {
          $divide: ["$total_ventes", "$nombre_lignes"]
        }
      }
    }
  }
])
```

**R√©sultat** :
```json
[
  {
    "vendeur": "Alice",
    "region": "Nord",
    "performance": {
      "total_ventes": 1943,     // (899√ó2) + (29√ó5)
      "nombre_lignes": 2,
      "vente_moyenne": 971.5
    }
  },
  {
    "vendeur": "Bob",
    "region": "Sud",
    "performance": {
      "total_ventes": 237,      // 79√ó3
      "nombre_lignes": 1,
      "vente_moyenne": 237
    }
  }
]
```

---

## Gestion des Valeurs Nulles et Manquantes

### Probl√®me : Document Null

Si le chemin sp√©cifi√© n'existe pas ou est `null`, l'op√©ration √©chouera :

```javascript
db.users.insertOne({
  _id: 1,
  nom: "Alice"
  // Pas de champ "profil"
})

db.users.aggregate([
  {
    $replaceWith: "$profil"  // ‚ùå Erreur : profil n'existe pas
  }
])
```

### Solution : Utiliser $ifNull

```javascript
db.users.aggregate([
  {
    $replaceWith: {
      $ifNull: [
        "$profil",
        { nom: "$nom", message: "Profil non disponible" }
      ]
    }
  }
])
```

**R√©sultat** :
```json
{
  "nom": "Alice",
  "message": "Profil non disponible"
}
```

---

## Diff√©rence avec $project

### $project vs $replaceWith

| Aspect | $project | $replaceWith |
|--------|----------|--------------|
| **Conservation** | Peut conserver le _id et autres champs | Remplace **tout** le document |
| **Structure** | S√©lection/exclusion de champs | Cr√©ation d'un nouveau document racine |
| **Champs non mentionn√©s** | Peuvent √™tre conserv√©s avec `field: 1` | Toujours perdus |
| **Usage principal** | Filtrer les champs | Restructurer compl√®tement |

### Exemple Comparatif

**Document Original** :
```json
{
  "_id": 1,
  "nom": "Dupont",
  "adresse": {
    "ville": "Paris",
    "code_postal": "75001"
  }
}
```

#### Avec $project

```javascript
db.users.aggregate([
  {
    $project: {
      nom: 1,
      ville: "$adresse.ville"
    }
  }
])
```

**R√©sultat** :
```json
{
  "_id": 1,          // _id conserv√© par d√©faut
  "nom": "Dupont",
  "ville": "Paris"
}
```

#### Avec $replaceWith

```javascript
db.users.aggregate([
  {
    $replaceWith: {
      nom: "$nom",
      ville: "$adresse.ville"
    }
  }
])
```

**R√©sultat** :
```json
{
  "nom": "Dupont",
  "ville": "Paris"
  // _id PERDU !
}
```

---

## Utilisation avec $mergeObjects pour Conserver des Champs

Si vous voulez **conserver certains champs** tout en restructurant :

```javascript
db.produits.aggregate([
  {
    $replaceWith: {
      $mergeObjects: [
        { _id: "$_id" },              // Conserver _id
        { reference: "$reference" },  // Conserver reference
        "$details"                    // Aplatir details
      ]
    }
  }
])
```

---

## Cas d'Usage Avanc√©s

### 1. Cr√©er un Document d'Export

Pr√©parer des donn√©es pour un export avec une structure sp√©cifique :

```javascript
db.clients.aggregate([
  {
    $replaceWith: {
      // Format CSV-friendly
      "Nom": "$nom",
      "Pr√©nom": "$prenom",
      "Email": "$email",
      "Ville": "$adresse.ville",
      "Code Postal": "$adresse.code_postal",
      "Date d'inscription": {
        $dateToString: {
          format: "%d/%m/%Y",
          date: "$date_inscription"
        }
      }
    }
  }
])
```

### 2. Normaliser des Donn√©es H√©t√©rog√®nes

Transformer diff√©rentes structures en un format uniforme :

```javascript
db.evenements.insertMany([
  {
    type: "achat",
    achat: { produit: "Laptop", prix: 899 }
  },
  {
    type: "visite",
    visite: { page: "/produits", duree: 120 }
  },
  {
    type: "inscription",
    inscription: { email: "user@email.com" }
  }
])

db.evenements.aggregate([
  {
    $replaceWith: {
      type: "$type",
      details: {
        $switch: {
          branches: [
            { case: { $eq: ["$type", "achat"] }, then: "$achat" },
            { case: { $eq: ["$type", "visite"] }, then: "$visite" },
            { case: { $eq: ["$type", "inscription"] }, then: "$inscription" }
          ]
        }
      },
      timestamp: "$$NOW"
    }
  }
])
```

### 3. Cr√©er des Vues Simplifi√©es

Cr√©er une vue MongoDB avec une structure simplifi√©e :

```javascript
db.createView(
  "clients_simplifie",
  "clients",
  [
    {
      $replaceWith: {
        nom_complet: { $concat: ["$prenom", " ", "$nom"] },
        contact: "$email",
        ville: "$adresse.ville"
      }
    }
  ]
)

// Utilisation de la vue
db.clients_simplifie.find()
```

---

## Bonnes Pratiques

### 1. Toujours V√©rifier l'Existence des Champs

```javascript
// ‚ùå Risqu√© : peut √©chouer si le champ n'existe pas
{
  $replaceWith: "$sous_document"
}

// ‚úÖ S√ªr : gestion des cas null/manquant
{
  $replaceWith: {
    $ifNull: ["$sous_document", {}]
  }
}
```

### 2. Conserver l'_id si N√©cessaire

```javascript
// Pour maintenir la tra√ßabilit√©
{
  $replaceWith: {
    $mergeObjects: [
      { _id: "$_id" },
      "$nouveau_document"
    ]
  }
}
```

### 3. Documenter les Transformations Complexes

```javascript
db.collection.aggregate([
  {
    $replaceWith: {
      // Nouveau format pour l'API externe
      // Transformation : document interne ‚Üí format API v2
      id: { $toString: "$_id" },
      name: "$nom",
      contact: {
        email: "$email",
        phone: "$telephone"
      }
    }
  }
])
```

### 4. Tester avec des Donn√©es Vari√©es

Testez votre pipeline avec :
- Documents complets
- Documents avec champs manquants
- Documents avec valeurs null
- Documents avec structures imbriqu√©es profondes

---

## Performance

### Impact

`$replaceWith` est g√©n√©ralement **efficace** car :
- Simple transformation en m√©moire
- Pas d'op√©ration d'√©criture en base
- Pas de scan de collection

### Consid√©rations

1. **Positionnement** : Placez apr√®s les filtres (`$match`) pour r√©duire le volume
2. **Complexit√©** : Les expressions complexes avec `$mergeObjects` peuvent ralentir
3. **Volume** : M√™me si efficace, √©vitez sur des millions de documents sans filtrage pr√©alable

---

## Erreurs Courantes et Solutions

### Erreur 1 : Chemin Inexistant

```javascript
// ‚ùå Erreur si "profil" n'existe pas
{ $replaceWith: "$profil" }

// ‚úÖ Solution
{
  $replaceWith: {
    $ifNull: ["$profil", { message: "Profil non disponible" }]
  }
}
```

### Erreur 2 : Valeur Non-Document

```javascript
// ‚ùå Erreur si "age" est un nombre
{ $replaceWith: "$age" }

// ‚úÖ Il faut un document
{
  $replaceWith: {
    age: "$age"
  }
}
```

### Erreur 3 : Perte de l'_id

```javascript
// ‚ùå _id perdu (peut causer des probl√®mes)
{ $replaceWith: "$sous_document" }

// ‚úÖ Conserver _id explicitement
{
  $replaceWith: {
    $mergeObjects: [
      { _id: "$_id" },
      "$sous_document"
    ]
  }
}
```

---

## Exemple Complet : API de Profil Utilisateur

```javascript
// Collection source
db.utilisateurs.insertMany([
  {
    _id: ObjectId("507f1f77bcf86cd799439011"),
    username: "alice123",
    email: "alice@email.com",
    profil: {
      nom: "Dupont",
      prenom: "Alice",
      date_naissance: ISODate("1995-03-15"),
      bio: "D√©veloppeuse passionn√©e",
      avatar_url: "/images/alice.jpg"
    },
    parametres: {
      theme: "dark",
      notifications: true
    },
    date_creation: ISODate("2024-01-10"),
    derniere_connexion: ISODate("2024-03-15T14:30:00Z")
  }
])

// Pipeline pour API publique
db.utilisateurs.aggregate([
  // √âtape 1 : Filtrer par username
  {
    $match: { username: "alice123" }
  },

  // √âtape 2 : Calculer l'√¢ge
  {
    $set: {
      age: {
        $floor: {
          $divide: [
            { $subtract: ["$$NOW", "$profil.date_naissance"] },
            1000 * 60 * 60 * 24 * 365  // Millisecondes ‚Üí ann√©es
          ]
        }
      }
    }
  },

  // √âtape 3 : Restructurer pour l'API
  {
    $replaceWith: {
      user_id: { $toString: "$_id" },
      username: "$username",
      profile: {
        full_name: {
          $concat: ["$profil.prenom", " ", "$profil.nom"]
        },
        age: "$age",
        bio: "$profil.bio",
        avatar: "$profil.avatar_url"
      },
      settings: "$parametres",
      metadata: {
        member_since: {
          $dateToString: {
            format: "%Y-%m-%d",
            date: "$date_creation"
          }
        },
        last_seen: "$derniere_connexion"
      }
    }
  }
])
```

**R√©sultat** (format API) :
```json
{
  "user_id": "507f1f77bcf86cd799439011",
  "username": "alice123",
  "profile": {
    "full_name": "Alice Dupont",
    "age": 29,
    "bio": "D√©veloppeuse passionn√©e",
    "avatar": "/images/alice.jpg"
  },
  "settings": {
    "theme": "dark",
    "notifications": true
  },
  "metadata": {
    "member_since": "2024-01-10",
    "last_seen": ISODate("2024-03-15T14:30:00Z")
  }
}
```

---

## R√©sum√©

### Points Cl√©s

| Aspect | Description |
|--------|-------------|
| **Fonction** | Remplace compl√®tement le document racine |
| **$replaceWith vs $replaceRoot** | Identiques ($replaceWith a une syntaxe plus simple) |
| **Document original** | ‚ö†Ô∏è Enti√®rement remplac√© (rien n'est conserv√©) |
| **_id** | ‚ùå Perdu par d√©faut (utiliser $mergeObjects pour le garder) |
| **Usage principal** | Promouvoir sous-documents, restructurer, nettoyer |
| **Avec $mergeObjects** | Fusionner plusieurs documents en un |

### Quand Utiliser $replaceWith / $replaceRoot

‚úÖ **Utilisez $replaceWith / $replaceRoot** pour :
- Promouvoir un sous-document au niveau racine
- Restructurer compl√®tement les documents
- Cr√©er des documents enti√®rement nouveaux
- Simplifier les r√©sultats apr√®s des op√©rations complexes
- Pr√©parer des donn√©es pour export/API

‚ùå **N'utilisez PAS** (utilisez $project ou $set) si :
- Vous voulez juste ajouter/modifier quelques champs
- Vous devez conserver la structure d'origine
- Vous ne voulez pas perdre le _id

### Sch√©ma de D√©cision

```
Ai-je besoin de restructurer compl√®tement mes documents ?
‚îú‚îÄ Non
‚îÇ  ‚îú‚îÄ Ajouter des champs ‚Üí $set / $addFields
‚îÇ  ‚îî‚îÄ S√©lectionner des champs ‚Üí $project
‚îî‚îÄ Oui
   ‚îú‚îÄ Promouvoir un sous-document ‚Üí $replaceWith: "$sous_doc"
   ‚îú‚îÄ Fusionner plusieurs sous-docs ‚Üí $replaceWith: { $mergeObjects: [...] }
   ‚îú‚îÄ Cr√©er nouveau document ‚Üí $replaceWith: { nouveaux_champs... }
   ‚îî‚îÄ Conserver _id ‚Üí $mergeObjects avec { _id: "$_id" }
```

---

## Conclusion

`$replaceRoot` et `$replaceWith` sont des outils **puissants** pour transformer radicalement la structure de vos documents. Ils sont particuli√®rement utiles pour nettoyer et simplifier les r√©sultats d'agr√©gations complexes, ou pour pr√©parer des donn√©es dans un format sp√©cifique.

### √Ä Retenir

1. **$replaceWith** et **$replaceRoot** sont identiques (pr√©f√©rez `$replaceWith`)
2. **Remplacent compl√®tement** le document racine (tout est perdu)
3. Utilisez **$mergeObjects** pour fusionner plusieurs sources
4. Conservez **explicitement** le `_id` si n√©cessaire
5. G√©rez les **valeurs nulles** avec `$ifNull`
6. Parfait pour **promouvoir des sous-documents** au niveau racine

### Prochaines √âtapes

Dans les sections suivantes, nous explorerons :
- **$facet** : Ex√©cuter plusieurs pipelines en parall√®le
- **$bucket et $bucketAuto** : Regrouper par intervalles
- **$graphLookup** : Requ√™tes r√©cursives hi√©rarchiques

---

**üìö R√©f√©rences**

- [Documentation officielle $replaceRoot](https://www.mongodb.com/docs/manual/reference/operator/aggregation/replaceRoot/)
- [Documentation officielle $replaceWith](https://www.mongodb.com/docs/manual/reference/operator/aggregation/replaceWith/)
- [Documentation $mergeObjects](https://www.mongodb.com/docs/manual/reference/operator/aggregation/mergeObjects/)
- [Aggregation Pipeline Stages](https://www.mongodb.com/docs/manual/reference/operator/aggregation-pipeline/)

‚è≠Ô∏è [$facet](/06-framework-agregation/04.05-facet.md)
