üîù Retour au [Sommaire](/SOMMAIRE.md)

# 6.4.3 $addFields et $set

## Introduction

Les √©tapes `$addFields` et `$set` sont des op√©rateurs du framework d'agr√©gation MongoDB qui permettent d'**ajouter de nouveaux champs** ou de **modifier des champs existants** dans les documents, sans affecter les autres champs.

### L'Essentiel

- **`$addFields`** : Ajoute ou modifie des champs dans les documents
- **`$set`** : Alias de `$addFields` (introduit dans MongoDB 4.2)
- **Fonctionnement identique** : Les deux font exactement la m√™me chose
- **Pr√©servation** : Les champs non mentionn√©s restent intacts

### Analogie Simple

Imaginez un document comme une **fiche de renseignements**. `$addFields` / `$set` vous permet d'**ajouter de nouvelles lignes** ou de **modifier des lignes existantes** sans avoir √† r√©√©crire toute la fiche.

---

## Pourquoi Utiliser $addFields / $set ?

Ces op√©rateurs sont essentiels pour :

1. **Calculer de nouveaux champs** √† partir de champs existants
2. **Enrichir les documents** avec des donn√©es d√©riv√©es
3. **Transformer des valeurs** (conversions, formatage)
4. **Simplifier les pipelines** (alternative plus lisible √† `$project`)
5. **Conserver tous les champs** (contrairement √† `$project`)

---

## Syntaxe

### Syntaxe de Base

```javascript
{
  $addFields: {
    <nouveau_champ1>: <expression>,
    <nouveau_champ2>: <expression>,
    ...
  }
}

// OU (identique)

{
  $set: {
    <nouveau_champ1>: <expression>,
    <nouveau_champ2>: <expression>,
    ...
  }
}
```

### Param√®tres

- **Nom du champ** : Le champ √† ajouter ou modifier
- **Expression** : Valeur statique, calcul, ou expression d'agr√©gation

---

## Diff√©rence entre $addFields et $set

### Aucune Diff√©rence Fonctionnelle !

```javascript
// Ces deux pipelines sont IDENTIQUES
db.collection.aggregate([
  { $addFields: { total: { $add: ["$prix", "$taxe"] } } }
])

db.collection.aggregate([
  { $set: { total: { $add: ["$prix", "$taxe"] } } }
])
```

### Quelle Version Utiliser ?

| Op√©rateur | Quand l'utiliser |
|-----------|------------------|
| **$set** | ‚úÖ **Recommand√©** - Nom plus intuitif et court |
| **$addFields** | Compatible avec MongoDB < 4.2 (anciennes versions) |

üí° **Conseil** : Privil√©giez `$set` pour la clart√©, sauf si vous devez supporter des versions anciennes de MongoDB.

---

## Diff√©rence avec $project

### $project vs $set

| Aspect | $project | $set / $addFields |
|--------|----------|-------------------|
| **Champs non mentionn√©s** | ‚ùå Exclus (sauf _id) | ‚úÖ Conserv√©s |
| **Usage principal** | S√©lection de champs | Ajout/modification de champs |
| **Syntaxe** | Inclusion/exclusion explicite | Uniquement les nouveaux champs |

### Exemple Comparatif

**Document Original** :
```json
{
  "_id": 1,
  "nom": "Laptop",
  "prix": 899,
  "taxe": 90
}
```

#### Avec $project

```javascript
db.produits.aggregate([
  {
    $project: {
      nom: 1,
      total: { $add: ["$prix", "$taxe"] }
    }
  }
])
```

**R√©sultat** :
```json
{
  "_id": 1,
  "nom": "Laptop",
  "total": 989
  // "prix" et "taxe" sont PERDUS !
}
```

#### Avec $set / $addFields

```javascript
db.produits.aggregate([
  {
    $set: {
      total: { $add: ["$prix", "$taxe"] }
    }
  }
])
```

**R√©sultat** :
```json
{
  "_id": 1,
  "nom": "Laptop",
  "prix": 899,
  "taxe": 90,
  "total": 989
  // Tous les champs sont CONSERV√âS !
}
```

---

## Exemples Pratiques D√©taill√©s

### Exemple 1 : Calculs Simples

**Collection `produits`** :
```javascript
db.produits.insertMany([
  {
    _id: 1,
    nom: "Laptop",
    prix_ht: 899,
    taux_tva: 0.20
  },
  {
    _id: 2,
    nom: "Souris",
    prix_ht: 29,
    taux_tva: 0.20
  },
  {
    _id: 3,
    nom: "√âcran",
    prix_ht: 299,
    taux_tva: 0.20
  }
])
```

**Ajouter le prix TTC** :
```javascript
db.produits.aggregate([
  {
    $set: {
      prix_ttc: {
        $multiply: ["$prix_ht", { $add: [1, "$taux_tva"] }]
      }
    }
  }
])
```

**R√©sultat** :
```json
[
  {
    "_id": 1,
    "nom": "Laptop",
    "prix_ht": 899,
    "taux_tva": 0.20,
    "prix_ttc": 1078.8  // 899 √ó 1.20
  },
  {
    "_id": 2,
    "nom": "Souris",
    "prix_ht": 29,
    "taux_tva": 0.20,
    "prix_ttc": 34.8
  },
  {
    "_id": 3,
    "nom": "√âcran",
    "prix_ht": 299,
    "taux_tva": 0.20,
    "prix_ttc": 358.8
  }
]
```

### Exemple 2 : Ajouter Plusieurs Champs

```javascript
db.produits.aggregate([
  {
    $set: {
      // Calcul 1 : Montant de la TVA
      montant_tva: {
        $multiply: ["$prix_ht", "$taux_tva"]
      },
      // Calcul 2 : Prix TTC
      prix_ttc: {
        $multiply: ["$prix_ht", { $add: [1, "$taux_tva"] }]
      },
      // Calcul 3 : Cat√©gorie de prix
      categorie_prix: {
        $cond: {
          if: { $gte: ["$prix_ht", 500] },
          then: "Premium",
          else: "Standard"
        }
      }
    }
  }
])
```

**R√©sultat** :
```json
{
  "_id": 1,
  "nom": "Laptop",
  "prix_ht": 899,
  "taux_tva": 0.20,
  "montant_tva": 179.8,
  "prix_ttc": 1078.8,
  "categorie_prix": "Premium"
}
```

---

## Op√©rations sur les Cha√Ænes

### Exemple : Formatage de Noms

```javascript
db.utilisateurs.insertMany([
  { _id: 1, prenom: "jean", nom: "DUPONT" },
  { _id: 2, prenom: "marie", nom: "MARTIN" },
  { _id: 3, prenom: "pierre", nom: "DURAND" }
])

db.utilisateurs.aggregate([
  {
    $set: {
      // Capitaliser le pr√©nom
      prenom_formate: {
        $concat: [
          { $toUpper: { $substr: ["$prenom", 0, 1] } },
          { $toLower: { $substr: ["$prenom", 1, -1] } }
        ]
      },
      // Capitaliser le nom
      nom_formate: {
        $concat: [
          { $toUpper: { $substr: ["$nom", 0, 1] } },
          { $toLower: { $substr: ["$nom", 1, -1] } }
        ]
      },
      // Nom complet
      nom_complet: {
        $concat: [
          { $toUpper: { $substr: ["$prenom", 0, 1] } },
          { $toLower: { $substr: ["$prenom", 1, -1] } },
          " ",
          { $toUpper: { $substr: ["$nom", 0, 1] } },
          { $toLower: { $substr: ["$nom", 1, -1] } }
        ]
      }
    }
  }
])
```

**R√©sultat** :
```json
{
  "_id": 1,
  "prenom": "jean",
  "nom": "DUPONT",
  "prenom_formate": "Jean",
  "nom_formate": "Dupont",
  "nom_complet": "Jean Dupont"
}
```

---

## Op√©rations sur les Dates

### Exemple : Extraire des Composantes de Date

```javascript
db.commandes.insertMany([
  {
    _id: 1,
    client: "Alice",
    date_commande: ISODate("2024-03-15T14:30:00Z"),
    montant: 250
  },
  {
    _id: 2,
    client: "Bob",
    date_commande: ISODate("2024-06-22T09:15:00Z"),
    montant: 180
  }
])

db.commandes.aggregate([
  {
    $set: {
      annee: { $year: "$date_commande" },
      mois: { $month: "$date_commande" },
      jour: { $dayOfMonth: "$date_commande" },
      jour_semaine: { $dayOfWeek: "$date_commande" },
      nom_mois: {
        $switch: {
          branches: [
            { case: { $eq: [{ $month: "$date_commande" }, 1] }, then: "Janvier" },
            { case: { $eq: [{ $month: "$date_commande" }, 2] }, then: "F√©vrier" },
            { case: { $eq: [{ $month: "$date_commande" }, 3] }, then: "Mars" },
            { case: { $eq: [{ $month: "$date_commande" }, 6] }, then: "Juin" }
          ],
          default: "Autre"
        }
      },
      trimestre: {
        $ceil: { $divide: [{ $month: "$date_commande" }, 3] }
      }
    }
  }
])
```

**R√©sultat** :
```json
{
  "_id": 1,
  "client": "Alice",
  "date_commande": ISODate("2024-03-15T14:30:00Z"),
  "montant": 250,
  "annee": 2024,
  "mois": 3,
  "jour": 15,
  "jour_semaine": 6,  // Vendredi
  "nom_mois": "Mars",
  "trimestre": 1
}
```

---

## Op√©rations Conditionnelles

### Exemple : Cat√©gorisation avec $cond

```javascript
db.etudiants.insertMany([
  { _id: 1, nom: "Alice", note: 18 },
  { _id: 2, nom: "Bob", note: 12 },
  { _id: 3, nom: "Charlie", note: 8 },
  { _id: 4, nom: "Diana", note: 15 }
])

db.etudiants.aggregate([
  {
    $set: {
      mention: {
        $switch: {
          branches: [
            { case: { $gte: ["$note", 16] }, then: "Tr√®s bien" },
            { case: { $gte: ["$note", 14] }, then: "Bien" },
            { case: { $gte: ["$note", 12] }, then: "Assez bien" },
            { case: { $gte: ["$note", 10] }, then: "Passable" }
          ],
          default: "Insuffisant"
        }
      },
      admis: {
        $cond: {
          if: { $gte: ["$note", 10] },
          then: true,
          else: false
        }
      }
    }
  }
])
```

**R√©sultat** :
```json
[
  {
    "_id": 1,
    "nom": "Alice",
    "note": 18,
    "mention": "Tr√®s bien",
    "admis": true
  },
  {
    "_id": 2,
    "nom": "Bob",
    "note": 12,
    "mention": "Assez bien",
    "admis": true
  },
  {
    "_id": 3,
    "nom": "Charlie",
    "note": 8,
    "mention": "Insuffisant",
    "admis": false
  }
]
```

---

## Op√©rations sur les Tableaux

### Exemple : Calculer des Statistiques de Tableau

```javascript
db.commandes.insertMany([
  {
    _id: 1,
    client: "Alice",
    articles: [
      { produit: "Laptop", prix: 899, quantite: 1 },
      { produit: "Souris", prix: 29, quantite: 2 }
    ]
  },
  {
    _id: 2,
    client: "Bob",
    articles: [
      { produit: "Clavier", prix: 79, quantite: 1 },
      { produit: "√âcran", prix: 299, quantite: 1 },
      { produit: "C√¢ble", prix: 15, quantite: 3 }
    ]
  }
])

db.commandes.aggregate([
  {
    $set: {
      // Nombre d'articles diff√©rents
      nombre_articles: { $size: "$articles" },

      // Quantit√© totale d'articles
      quantite_totale: {
        $sum: "$articles.quantite"
      },

      // Prix moyen
      prix_moyen: {
        $avg: "$articles.prix"
      },

      // Total de la commande
      total: {
        $sum: {
          $map: {
            input: "$articles",
            as: "article",
            in: { $multiply: ["$$article.prix", "$$article.quantite"] }
          }
        }
      }
    }
  }
])
```

**R√©sultat** :
```json
{
  "_id": 1,
  "client": "Alice",
  "articles": [...],
  "nombre_articles": 2,
  "quantite_totale": 3,  // 1 + 2
  "prix_moyen": 464,     // (899 + 29) / 2
  "total": 957           // (899√ó1) + (29√ó2)
}
```

---

## Modification de Champs Existants

`$set` / `$addFields` peut √©galement **modifier** des champs existants.

### Exemple : Arrondir des Prix

```javascript
db.produits.insertMany([
  { _id: 1, nom: "Produit A", prix: 12.3456 },
  { _id: 2, nom: "Produit B", prix: 45.6789 },
  { _id: 3, nom: "Produit C", prix: 99.9999 }
])

db.produits.aggregate([
  {
    $set: {
      prix: { $round: ["$prix", 2] }  // Arrondir √† 2 d√©cimales
    }
  }
])
```

**R√©sultat** :
```json
[
  { "_id": 1, "nom": "Produit A", "prix": 12.35 },
  { "_id": 2, "nom": "Produit B", "prix": 45.68 },
  { "_id": 3, "nom": "Produit C", "prix": 100.00 }
]
```

---

## Champs Imbriqu√©s

Vous pouvez ajouter ou modifier des champs √† **n'importe quel niveau** de profondeur.

### Syntaxe avec Notation Point√©e

```javascript
db.utilisateurs.insertOne({
  _id: 1,
  nom: "Dupont",
  adresse: {
    rue: "123 Rue de la Paix",
    ville: "Paris"
  }
})

db.utilisateurs.aggregate([
  {
    $set: {
      "adresse.code_postal": "75001",
      "adresse.pays": "France",
      "contact.email": "dupont@email.com",
      "contact.telephone": "+33123456789"
    }
  }
])
```

**R√©sultat** :
```json
{
  "_id": 1,
  "nom": "Dupont",
  "adresse": {
    "rue": "123 Rue de la Paix",
    "ville": "Paris",
    "code_postal": "75001",
    "pays": "France"
  },
  "contact": {
    "email": "dupont@email.com",
    "telephone": "+33123456789"
  }
}
```

---

## Cas d'Usage Courants

### 1. Enrichissement apr√®s $lookup

Ajouter des champs calcul√©s apr√®s une jointure :

```javascript
db.commandes.aggregate([
  {
    $lookup: {
      from: "clients",
      localField: "client_id",
      foreignField: "_id",
      as: "client"
    }
  },
  { $unwind: "$client" },
  {
    $set: {
      // Ajouter le nom complet du client
      nom_client_complet: {
        $concat: ["$client.prenom", " ", "$client.nom"]
      },
      // Calculer les jours depuis la commande
      jours_depuis_commande: {
        $divide: [
          { $subtract: ["$$NOW", "$date_commande"] },
          1000 * 60 * 60 * 24  // Millisecondes ‚Üí jours
        ]
      }
    }
  }
])
```

### 2. Normalisation de Donn√©es

```javascript
db.produits.aggregate([
  {
    $set: {
      // Normaliser les noms en minuscules
      nom_normalise: { $toLower: "$nom" },

      // Supprimer les espaces superflus
      description_nettoyee: { $trim: { input: "$description" } },

      // Convertir le prix en nombre si c'est une cha√Æne
      prix: { $toDouble: "$prix" }
    }
  }
])
```

### 3. Ajout de M√©tadonn√©es

```javascript
db.documents.aggregate([
  {
    $set: {
      date_traitement: "$$NOW",
      version: 2,
      traite_par: "pipeline_agregation"
    }
  }
])
```

### 4. Calculs de Distance G√©ospatiale

```javascript
db.magasins.aggregate([
  {
    $set: {
      distance_km: {
        $divide: [
          {
            $sqrt: {
              $add: [
                { $pow: [{ $subtract: ["$latitude", 48.8566] }, 2] },
                { $pow: [{ $subtract: ["$longitude", 2.3522] }, 2] }
              ]
            }
          },
          0.009  // Approximation pour convertir en km
        ]
      }
    }
  },
  { $sort: { distance_km: 1 } }
])
```

---

## Op√©rateurs Utiles avec $set / $addFields

### Op√©rateurs Arithm√©tiques

| Op√©rateur | Description | Exemple |
|-----------|-------------|---------|
| `$add` | Addition | `{ $add: ["$prix", "$taxe"] }` |
| `$subtract` | Soustraction | `{ $subtract: ["$stock_initial", "$ventes"] }` |
| `$multiply` | Multiplication | `{ $multiply: ["$prix", "$quantite"] }` |
| `$divide` | Division | `{ $divide: ["$total", "$nombre"] }` |
| `$mod` | Modulo (reste) | `{ $mod: ["$nombre", 2] }` |
| `$pow` | Puissance | `{ $pow: ["$base", 2] }` |
| `$sqrt` | Racine carr√©e | `{ $sqrt: "$nombre" }` |
| `$abs` | Valeur absolue | `{ $abs: "$difference" }` |
| `$ceil` | Arrondi sup√©rieur | `{ $ceil: "$prix" }` |
| `$floor` | Arrondi inf√©rieur | `{ $floor: "$prix" }` |
| `$round` | Arrondi | `{ $round: ["$prix", 2] }` |

### Op√©rateurs de Cha√Ænes

| Op√©rateur | Description | Exemple |
|-----------|-------------|---------|
| `$concat` | Concat√©ner | `{ $concat: ["$prenom", " ", "$nom"] }` |
| `$substr` | Sous-cha√Æne | `{ $substr: ["$texte", 0, 10] }` |
| `$toLower` | Minuscules | `{ $toLower: "$nom" }` |
| `$toUpper` | Majuscules | `{ $toUpper: "$code" }` |
| `$trim` | Supprimer espaces | `{ $trim: { input: "$texte" } }` |
| `$split` | Diviser en tableau | `{ $split: ["$tags", ","] }` |
| `$strLenCP` | Longueur | `{ $strLenCP: "$texte" }` |

### Op√©rateurs de Date

| Op√©rateur | Description | Exemple |
|-----------|-------------|---------|
| `$year` | Ann√©e | `{ $year: "$date" }` |
| `$month` | Mois (1-12) | `{ $month: "$date" }` |
| `$dayOfMonth` | Jour du mois | `{ $dayOfMonth: "$date" }` |
| `$dayOfWeek` | Jour de la semaine | `{ $dayOfWeek: "$date" }` |
| `$hour` | Heure | `{ $hour: "$date" }` |
| `$dateToString` | Formatter | `{ $dateToString: { format: "%Y-%m-%d", date: "$date" } }` |
| `$dateDiff` | Diff√©rence | `{ $dateDiff: { startDate: "$debut", endDate: "$fin", unit: "day" } }` |

### Op√©rateurs Conditionnels

| Op√©rateur | Description | Exemple |
|-----------|-------------|---------|
| `$cond` | If-then-else | `{ $cond: { if: <condition>, then: <valeur>, else: <valeur> } }` |
| `$ifNull` | Valeur par d√©faut | `{ $ifNull: ["$champ", "valeur_defaut"] }` |
| `$switch` | Multi-conditions | `{ $switch: { branches: [...], default: <valeur> } }` |

### Op√©rateurs de Tableau

| Op√©rateur | Description | Exemple |
|-----------|-------------|---------|
| `$size` | Taille du tableau | `{ $size: "$items" }` |
| `$arrayElemAt` | √âl√©ment par index | `{ $arrayElemAt: ["$items", 0] }` |
| `$first` | Premier √©l√©ment | `{ $first: "$items" }` |
| `$last` | Dernier √©l√©ment | `{ $last: "$items" }` |
| `$filter` | Filtrer | `{ $filter: { input: "$items", cond: <condition> } }` |
| `$map` | Transformer | `{ $map: { input: "$items", in: <expression> } }` |
| `$reduce` | R√©duire | `{ $reduce: { input: "$items", initialValue: 0, in: <expression> } }` |

---

## Cha√Ænage de $set

Vous pouvez encha√Æner plusieurs √©tapes `$set` pour plus de lisibilit√© :

```javascript
db.produits.aggregate([
  // √âtape 1 : Calculer le prix TTC
  {
    $set: {
      prix_ttc: { $multiply: ["$prix_ht", 1.20] }
    }
  },
  // √âtape 2 : Calculer la remise
  {
    $set: {
      remise: { $multiply: ["$prix_ttc", 0.10] }
    }
  },
  // √âtape 3 : Calculer le prix final
  {
    $set: {
      prix_final: { $subtract: ["$prix_ttc", "$remise"] }
    }
  }
])
```

**Alternative avec un seul $set** :
```javascript
db.produits.aggregate([
  {
    $set: {
      prix_ttc: { $multiply: ["$prix_ht", 1.20] },
      remise: { $multiply: [{ $multiply: ["$prix_ht", 1.20] }, 0.10] },
      prix_final: {
        $subtract: [
          { $multiply: ["$prix_ht", 1.20] },
          { $multiply: [{ $multiply: ["$prix_ht", 1.20] }, 0.10] }
        ]
      }
    }
  }
])
```

üí° **Conseil** : Le cha√Ænage est plus **lisible** et **r√©utilise** les champs calcul√©s pr√©c√©demment.

---

## Bonnes Pratiques

### 1. Nommer les Champs Clairement

```javascript
// ‚ùå Mauvais
{ $set: { x: { $add: ["$a", "$b"] } } }

// ‚úÖ Bon
{ $set: { prix_total: { $add: ["$prix_ht", "$montant_tva"] } } }
```

### 2. Utiliser $set au Lieu de $project Quand Appropri√©

```javascript
// ‚ùå Moins efficace : $project exclut les autres champs
{
  $project: {
    nom: 1,
    prix: 1,
    prix_ttc: { $multiply: ["$prix", 1.20] }
  }
}

// ‚úÖ Plus simple : $set conserve tout
{
  $set: {
    prix_ttc: { $multiply: ["$prix", 1.20] }
  }
}
```

### 3. G√©rer les Valeurs Nulles

```javascript
{
  $set: {
    prix_final: {
      $ifNull: [
        { $multiply: ["$prix", "$quantite"] },
        0  // Valeur par d√©faut si null
      ]
    }
  }
}
```

### 4. √âviter les Calculs Complexes Redondants

```javascript
// ‚ùå Calcul r√©p√©t√©
{
  $set: {
    champ1: { $multiply: ["$a", "$b", "$c"] },
    champ2: { $divide: [{ $multiply: ["$a", "$b", "$c"] }, 2] }
  }
}

// ‚úÖ Calcul une fois, r√©utilis√© (cha√Æner les $set)
db.collection.aggregate([
  {
    $set: {
      produit_abc: { $multiply: ["$a", "$b", "$c"] }
    }
  },
  {
    $set: {
      moitie_produit: { $divide: ["$produit_abc", 2] }
    }
  }
])
```

### 5. Documenter les Calculs Complexes

```javascript
db.produits.aggregate([
  {
    $set: {
      // Formule : Prix final = (Prix HT √ó 1.20) - Remise
      // Remise = 10% si prix HT > 100, sinon 5%
      prix_final: {
        $subtract: [
          { $multiply: ["$prix_ht", 1.20] },
          {
            $multiply: [
              { $multiply: ["$prix_ht", 1.20] },
              { $cond: { if: { $gt: ["$prix_ht", 100] }, then: 0.10, else: 0.05 } }
            ]
          }
        ]
      }
    }
  }
])
```

---

## Performance

### Impact Minimal

`$set` / `$addFields` a un **impact minimal** sur les performances car :
- Ne modifie pas les donn√©es en base
- Op√®re uniquement sur les documents du pipeline
- Les calculs sont effectu√©s en m√©moire

### Consid√©rations

1. **Calculs Co√ªteux** : √âvitez les expressions tr√®s complexes si possible
2. **Positionnement** : Placez apr√®s les filtres (`$match`) pour r√©duire le volume
3. **Index** : Les nouveaux champs ne sont pas index√©s (cr√©√©s √† la vol√©e)

### Exemple d'Optimisation

```javascript
// ‚ùå Calcul sur tous les documents
db.commandes.aggregate([
  {
    $set: {
      prix_final: { $multiply: ["$prix", "$quantite"] }
    }
  },
  {
    $match: { statut: "livr√©e" }
  }
])

// ‚úÖ Filtrer d'abord, calculer ensuite
db.commandes.aggregate([
  {
    $match: { statut: "livr√©e" }
  },
  {
    $set: {
      prix_final: { $multiply: ["$prix", "$quantite"] }
    }
  }
])
```

---

## Comparaison avec $project

### Quand Utiliser Chacun

| Situation | Op√©rateur Recommand√© |
|-----------|----------------------|
| Ajouter des champs calcul√©s | ‚úÖ `$set` / `$addFields` |
| Conserver tous les champs | ‚úÖ `$set` / `$addFields` |
| S√©lectionner uniquement certains champs | ‚úÖ `$project` |
| Exclure des champs sp√©cifiques | ‚úÖ `$project` |
| Renommer des champs | ‚úÖ `$project` |
| Restructurer compl√®tement le document | ‚úÖ `$project` |

---

## Exemple Complet : Analyse de Ventes

```javascript
// Donn√©es
db.ventes.insertMany([
  {
    _id: 1,
    vendeur: "Alice",
    date: ISODate("2024-01-15T10:30:00Z"),
    produits: [
      { nom: "Laptop", prix_ht: 899, quantite: 1 },
      { nom: "Souris", prix_ht: 29, quantite: 2 }
    ]
  },
  {
    _id: 2,
    vendeur: "Bob",
    date: ISODate("2024-01-20T14:15:00Z"),
    produits: [
      { nom: "Clavier", prix_ht: 79, quantite: 1 },
      { nom: "√âcran", prix_ht: 299, quantite: 1 }
    ]
  }
])

// Pipeline d'analyse
db.ventes.aggregate([
  // √âtape 1 : D√©plier les produits
  { $unwind: "$produits" },

  // √âtape 2 : Calculer le prix TTC par ligne
  {
    $set: {
      prix_ttc_unitaire: { $multiply: ["$produits.prix_ht", 1.20] },
      montant_ligne_ht: {
        $multiply: ["$produits.prix_ht", "$produits.quantite"]
      }
    }
  },

  // √âtape 3 : Calculer le montant TTC par ligne
  {
    $set: {
      montant_ligne_ttc: {
        $multiply: ["$montant_ligne_ht", 1.20]
      }
    }
  },

  // √âtape 4 : Ajouter des m√©tadonn√©es temporelles
  {
    $set: {
      annee: { $year: "$date" },
      mois: { $month: "$date" },
      trimestre: { $ceil: { $divide: [{ $month: "$date" }, 3] } }
    }
  },

  // √âtape 5 : Projection finale
  {
    $project: {
      vendeur: 1,
      "produits.nom": 1,
      "produits.quantite": 1,
      montant_ligne_ht: { $round: ["$montant_ligne_ht", 2] },
      montant_ligne_ttc: { $round: ["$montant_ligne_ttc", 2] },
      trimestre: 1
    }
  }
])
```

**R√©sultat** :
```json
[
  {
    "_id": 1,
    "vendeur": "Alice",
    "produits": { "nom": "Laptop", "quantite": 1 },
    "montant_ligne_ht": 899,
    "montant_ligne_ttc": 1078.8,
    "trimestre": 1
  },
  {
    "_id": 1,
    "vendeur": "Alice",
    "produits": { "nom": "Souris", "quantite": 2 },
    "montant_ligne_ht": 58,
    "montant_ligne_ttc": 69.6,
    "trimestre": 1
  },
  // ...
]
```

---

## Variables Syst√®me

`$set` peut utiliser des **variables syst√®me** :

| Variable | Description |
|----------|-------------|
| `$$NOW` | Date/heure actuelle |
| `$$CLUSTER_TIME` | Timestamp du cluster |
| `$$ROOT` | Document original complet |
| `$$CURRENT` | Document courant dans le pipeline |

### Exemple

```javascript
db.documents.aggregate([
  {
    $set: {
      date_traitement: "$$NOW",
      document_original: "$$ROOT"
    }
  }
])
```

---

## R√©sum√©

### Points Cl√©s

| Aspect | Description |
|--------|-------------|
| **Fonction** | Ajouter ou modifier des champs sans affecter les autres |
| **$set vs $addFields** | Identiques (pr√©f√©rez `$set` pour la clart√©) |
| **Diff√©rence avec $project** | `$set` conserve tous les champs, `$project` s√©lectionne |
| **Champs imbriqu√©s** | Utiliser la notation point√©e : `"adresse.code_postal"` |
| **R√©utilisation** | Cha√Æner plusieurs `$set` pour r√©utiliser les calculs |
| **Performance** | Impact minimal, mais filtrer avant de calculer |

### Quand Utiliser $set / $addFields

‚úÖ **Utilisez $set / $addFields** pour :
- Ajouter des champs calcul√©s
- Enrichir les documents avec des donn√©es d√©riv√©es
- Transformer des valeurs existantes
- Conserver tous les champs d'origine

‚ùå **N'utilisez PAS** (utilisez $project) pour :
- S√©lectionner uniquement certains champs
- Exclure des champs sp√©cifiques
- Restructurer compl√®tement les documents

---

## Conclusion

`$set` et `$addFields` sont des outils **essentiels** du framework d'agr√©gation. Ils permettent d'enrichir facilement les documents avec des calculs, transformations, et m√©tadonn√©es, tout en conservant l'int√©grit√© des donn√©es d'origine.

### √Ä Retenir

1. **$set** et **$addFields** sont identiques (pr√©f√©rez `$set`)
2. Conservent **tous les champs** existants (contrairement √† `$project`)
3. Permettent des **calculs complexes** avec de nombreux op√©rateurs
4. Peuvent √™tre **cha√Æn√©s** pour plus de lisibilit√©
5. Travaillent avec des **champs imbriqu√©s** via la notation point√©e
6. Ont un **impact minimal** sur les performances

### Prochaines √âtapes

Dans les sections suivantes, nous explorerons :
- **$replaceRoot et $replaceWith** : Remplacer compl√®tement le document
- **$facet** : Pipelines multiples en parall√®le
- **Optimisation des pipelines** : Techniques avanc√©es de performance

---

**üìö R√©f√©rences**

- [Documentation officielle $addFields](https://www.mongodb.com/docs/manual/reference/operator/aggregation/addFields/)
- [Documentation officielle $set](https://www.mongodb.com/docs/manual/reference/operator/aggregation/set/)
- [Aggregation Pipeline Operators](https://www.mongodb.com/docs/manual/reference/operator/aggregation/)
- [Expression Operators](https://www.mongodb.com/docs/manual/reference/operator/aggregation/expression/)

‚è≠Ô∏è [$replaceRoot et $replaceWith](/06-framework-agregation/04.04-replaceroot-replacewith.md)
