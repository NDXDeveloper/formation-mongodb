üîù Retour au [Sommaire](/SOMMAIRE.md)

# 6.5.1 Op√©rateurs Arithm√©tiques - Calculs et Transformations Num√©riques

## Introduction

Les op√©rateurs arithm√©tiques permettent d'effectuer des **calculs math√©matiques** dans vos pipelines d'agr√©gation MongoDB. Ils vous donnent la possibilit√© de transformer, calculer et manipuler des valeurs num√©riques directement dans vos requ√™tes.

Pensez aux op√©rateurs arithm√©tiques comme √† une **calculatrice int√©gr√©e** dans MongoDB qui vous permet de faire des op√©rations math√©matiques sur vos donn√©es sans avoir √† extraire les valeurs et les calculer dans votre application.

## √Ä Quoi Servent les Op√©rateurs Arithm√©tiques ?

### 1. **Calculs de Prix**
Calculer des totaux TTC, des remises, des marges, etc.

### 2. **Statistiques**
Calculer des moyennes, des pourcentages, des ratios.

### 3. **Transformations**
Convertir des unit√©s, normaliser des valeurs.

### 4. **Agr√©gations Complexes**
Cr√©er des formules m√©tier dans vos pipelines.

## Liste des Op√©rateurs Arithm√©tiques

MongoDB offre une riche biblioth√®que d'op√©rateurs arithm√©tiques :

### Op√©rateurs de Base

| Op√©rateur | Description | Exemple |
|-----------|-------------|---------|
| `$add` | Addition | `{ $add: [10, 5] }` ‚Üí 15 |
| `$subtract` | Soustraction | `{ $subtract: [10, 5] }` ‚Üí 5 |
| `$multiply` | Multiplication | `{ $multiply: [10, 5] }` ‚Üí 50 |
| `$divide` | Division | `{ $divide: [10, 5] }` ‚Üí 2 |
| `$mod` | Modulo (reste) | `{ $mod: [10, 3] }` ‚Üí 1 |

### Op√©rateurs de Transformation

| Op√©rateur | Description | Exemple |
|-----------|-------------|---------|
| `$abs` | Valeur absolue | `{ $abs: -5 }` ‚Üí 5 |
| `$ceil` | Arrondi sup√©rieur | `{ $ceil: 4.2 }` ‚Üí 5 |
| `$floor` | Arrondi inf√©rieur | `{ $floor: 4.8 }` ‚Üí 4 |
| `$round` | Arrondi au plus proche | `{ $round: [4.567, 2] }` ‚Üí 4.57 |
| `$trunc` | Tronquer (supprimer d√©cimales) | `{ $trunc: 4.9 }` ‚Üí 4 |

### Op√©rateurs Avanc√©s

| Op√©rateur | Description | Exemple |
|-----------|-------------|---------|
| `$pow` | Puissance | `{ $pow: [2, 3] }` ‚Üí 8 |
| `$sqrt` | Racine carr√©e | `{ $sqrt: 25 }` ‚Üí 5 |
| `$exp` | Exponentielle (e^x) | `{ $exp: 2 }` ‚Üí 7.389... |
| `$ln` | Logarithme naturel | `{ $ln: 10 }` ‚Üí 2.302... |
| `$log` | Logarithme (base personnalis√©e) | `{ $log: [100, 10] }` ‚Üí 2 |
| `$log10` | Logarithme base 10 | `{ $log10: 100 }` ‚Üí 2 |

## Op√©rateurs de Base en D√©tail

### $add : Addition

L'op√©rateur `$add` additionne plusieurs valeurs (au moins 2).

**Syntaxe** :
```javascript
{ $add: [expression1, expression2, ...] }
```

**Exemple 1 : Addition Simple**

```javascript
// Collection: produits
{ "_id": 1, "nom": "Ordinateur", "prixHT": 1000, "fraisLivraison": 50 }
```

Calculer le prix total :

```javascript
db.produits.aggregate([
  {
    $project: {
      nom: 1,
      prixHT: 1,
      fraisLivraison: 1,
      prixTotal: {
        $add: ["$prixHT", "$fraisLivraison"]
      }
    }
  }
])
```

**R√©sultat** :
```javascript
{
  "_id": 1,
  "nom": "Ordinateur",
  "prixHT": 1000,
  "fraisLivraison": 50,
  "prixTotal": 1050
}
```

**Exemple 2 : Addition Multiple**

```javascript
// Plusieurs valeurs √† additionner
{
  $project: {
    total: {
      $add: ["$montant1", "$montant2", "$montant3", "$montant4"]
    }
  }
}
```

**Exemple 3 : Addition avec Constantes**

```javascript
// Ajouter une constante
{
  $project: {
    prixAvecMajoration: {
      $add: ["$prix", 10]    // Ajouter 10‚Ç¨
    }
  }
}
```

**Particularit√©** : `$add` peut aussi additionner des dates (ajouter des millisecondes) :

```javascript
{
  $project: {
    dateFuture: {
      $add: ["$date", 7 * 24 * 60 * 60 * 1000]    // Ajouter 7 jours
    }
  }
}
```

### $subtract : Soustraction

L'op√©rateur `$subtract` soustrait deux valeurs.

**Syntaxe** :
```javascript
{ $subtract: [expression1, expression2] }
```

**R√©sultat** : expression1 - expression2

**Exemple 1 : Calculer une Marge**

```javascript
// Collection: produits
{ "_id": 1, "nom": "T√©l√©phone", "prixVente": 800, "prixAchat": 600 }
```

```javascript
db.produits.aggregate([
  {
    $project: {
      nom: 1,
      prixVente: 1,
      prixAchat: 1,
      marge: {
        $subtract: ["$prixVente", "$prixAchat"]
      }
    }
  }
])
```

**R√©sultat** :
```javascript
{
  "_id": 1,
  "nom": "T√©l√©phone",
  "prixVente": 800,
  "prixAchat": 600,
  "marge": 200
}
```

**Exemple 2 : Calculer une Dur√©e entre Dates**

```javascript
// Diff√©rence entre deux dates (en millisecondes)
{
  $project: {
    dureeMs: {
      $subtract: ["$dateFin", "$dateDebut"]
    },
    dureeJours: {
      $divide: [
        { $subtract: ["$dateFin", "$dateDebut"] },
        1000 * 60 * 60 * 24
      ]
    }
  }
}
```

**Exemple 3 : Remise Appliqu√©e**

```javascript
{
  $project: {
    prixApresRemise: {
      $subtract: ["$prixOriginal", "$montantRemise"]
    }
  }
}
```

### $multiply : Multiplication

L'op√©rateur `$multiply` multiplie plusieurs valeurs.

**Syntaxe** :
```javascript
{ $multiply: [expression1, expression2, ...] }
```

**Exemple 1 : Calculer un Total**

```javascript
// Collection: lignesCommande
{ "_id": 1, "produit": "Stylo", "quantite": 10, "prixUnitaire": 2.5 }
```

```javascript
db.lignesCommande.aggregate([
  {
    $project: {
      produit: 1,
      quantite: 1,
      prixUnitaire: 1,
      total: {
        $multiply: ["$quantite", "$prixUnitaire"]
      }
    }
  }
])
```

**R√©sultat** :
```javascript
{
  "_id": 1,
  "produit": "Stylo",
  "quantite": 10,
  "prixUnitaire": 2.5,
  "total": 25
}
```

**Exemple 2 : Calculer la TVA**

```javascript
{
  $project: {
    prixHT: 1,
    montantTVA: {
      $multiply: ["$prixHT", 0.20]    // TVA √† 20%
    }
  }
}
```

**Exemple 3 : Multiplication Multiple**

```javascript
// Surface d'un parall√©l√©pip√®de
{
  $project: {
    volume: {
      $multiply: ["$longueur", "$largeur", "$hauteur"]
    }
  }
}
```

**Exemple 4 : Calcul de Prix TTC**

```javascript
{
  $project: {
    prixHT: 1,
    prixTTC: {
      $multiply: ["$prixHT", 1.20]    // Prix HT √ó 1.20
    }
  }
}
```

### $divide : Division

L'op√©rateur `$divide` divise deux valeurs.

**Syntaxe** :
```javascript
{ $divide: [dividende, diviseur] }
```

**R√©sultat** : dividende √∑ diviseur

**Exemple 1 : Calculer un Prix Moyen**

```javascript
// Collection: commandes
{ "_id": 1, "totalVentes": 1500, "nombreProduits": 10 }
```

```javascript
db.commandes.aggregate([
  {
    $project: {
      totalVentes: 1,
      nombreProduits: 1,
      prixMoyen: {
        $divide: ["$totalVentes", "$nombreProduits"]
      }
    }
  }
])
```

**R√©sultat** :
```javascript
{
  "_id": 1,
  "totalVentes": 1500,
  "nombreProduits": 10,
  "prixMoyen": 150
}
```

**Exemple 2 : Calculer un Pourcentage**

```javascript
{
  $project: {
    tauxReussite: {
      $multiply: [
        { $divide: ["$reussites", "$tentatives"] },
        100
      ]
    }
  }
}
```

**Exemple 3 : Conversion d'Unit√©s**

```javascript
// Convertir des m√®tres en kilom√®tres
{
  $project: {
    distanceMetres: 1,
    distanceKm: {
      $divide: ["$distanceMetres", 1000]
    }
  }
}
```

‚ö†Ô∏è **Attention** : Division par z√©ro g√©n√®re une erreur ! Utilisez `$cond` pour g√©rer ce cas :

```javascript
{
  $project: {
    moyenne: {
      $cond: {
        if: { $eq: ["$nombre", 0] },
        then: 0,
        else: { $divide: ["$total", "$nombre"] }
      }
    }
  }
}
```

### $mod : Modulo (Reste)

L'op√©rateur `$mod` retourne le reste d'une division.

**Syntaxe** :
```javascript
{ $mod: [dividende, diviseur] }
```

**Exemple 1 : Nombre Pair ou Impair**

```javascript
db.nombres.aggregate([
  {
    $project: {
      nombre: 1,
      estPair: {
        $eq: [{ $mod: ["$nombre", 2] }, 0]
      }
    }
  }
])
```

**R√©sultat** :
```javascript
{ "nombre": 10, "estPair": true }   // 10 % 2 = 0
{ "nombre": 7, "estPair": false }   // 7 % 2 = 1
```

**Exemple 2 : Grouper par Tranches**

```javascript
// Grouper les √¢ges par tranches de 10 ans
{
  $project: {
    age: 1,
    tranche: {
      $subtract: [
        "$age",
        { $mod: ["$age", 10] }
      ]
    }
  }
}
// Age 27 ‚Üí Tranche 20, Age 35 ‚Üí Tranche 30
```

**Exemple 3 : Alterner des Couleurs (Zebra Striping)**

```javascript
{
  $project: {
    ligne: 1,
    couleur: {
      $cond: {
        if: { $eq: [{ $mod: ["$ligne", 2] }, 0] },
        then: "blanc",
        else: "gris"
      }
    }
  }
}
```

## Op√©rateurs d'Arrondi

### $abs : Valeur Absolue

Retourne la valeur absolue d'un nombre (toujours positive).

**Syntaxe** :
```javascript
{ $abs: <nombre> }
```

**Exemple** :

```javascript
{
  $project: {
    temperature: 1,
    temperatureAbsolue: { $abs: "$temperature" }
  }
}
```

**R√©sultat** :
```javascript
{ "temperature": -15, "temperatureAbsolue": 15 }
{ "temperature": 22, "temperatureAbsolue": 22 }
```

**Cas d'usage** : Calculer des √©carts, des diff√©rences :

```javascript
{
  $project: {
    ecart: {
      $abs: { $subtract: ["$valeurReelle", "$valeurCible"] }
    }
  }
}
```

### $ceil : Arrondi Sup√©rieur

Arrondit un nombre vers le haut (au prochain entier sup√©rieur).

**Syntaxe** :
```javascript
{ $ceil: <nombre> }
```

**Exemple** :

```javascript
{
  $project: {
    prix: 1,
    prixArrondi: { $ceil: "$prix" }
  }
}
```

**R√©sultat** :
```javascript
{ "prix": 19.99, "prixArrondi": 20 }
{ "prix": 20.01, "prixArrondi": 21 }
{ "prix": 20.00, "prixArrondi": 20 }
```

**Cas d'usage** : Calculer un nombre de pages, de bo√Ætes n√©cessaires :

```javascript
// Nombre de pages n√©cessaires
{
  $project: {
    nombrePages: {
      $ceil: { $divide: ["$totalItems", "$itemsParPage"] }
    }
  }
}
```

### $floor : Arrondi Inf√©rieur

Arrondit un nombre vers le bas (au prochain entier inf√©rieur).

**Syntaxe** :
```javascript
{ $floor: <nombre> }
```

**Exemple** :

```javascript
{
  $project: {
    note: 1,
    noteEntiere: { $floor: "$note" }
  }
}
```

**R√©sultat** :
```javascript
{ "note": 15.9, "noteEntiere": 15 }
{ "note": 15.1, "noteEntiere": 15 }
{ "note": 15.0, "noteEntiere": 15 }
```

### $round : Arrondi au Plus Proche

Arrondit un nombre au nombre de d√©cimales sp√©cifi√©.

**Syntaxe** :
```javascript
{ $round: [<nombre>, <decimales>] }
```

Si `decimales` n'est pas sp√©cifi√©, arrondit √† l'entier le plus proche.

**Exemple 1 : Arrondi √† l'Entier**

```javascript
{
  $project: {
    valeur: 1,
    arrondi: { $round: "$valeur" }
  }
}
```

**R√©sultat** :
```javascript
{ "valeur": 4.4, "arrondi": 4 }
{ "valeur": 4.5, "arrondi": 5 }    // 0.5 arrondit vers le haut
{ "valeur": 4.6, "arrondi": 5 }
```

**Exemple 2 : Arrondi √† 2 D√©cimales**

```javascript
{
  $project: {
    prix: 1,
    prixArrondi: { $round: ["$prix", 2] }
  }
}
```

**R√©sultat** :
```javascript
{ "prix": 19.99678, "prixArrondi": 20.00 }
{ "prix": 19.994, "prixArrondi": 19.99 }
{ "prix": 19.995, "prixArrondi": 20.00 }
```

**Exemple 3 : Arrondi √† 1 D√©cimale**

```javascript
{
  $project: {
    moyenne: { $round: [{ $avg: "$notes" }, 1] }
  }
}
```

### $trunc : Tronquer

Supprime les d√©cimales sans arrondir.

**Syntaxe** :
```javascript
{ $trunc: [<nombre>, <decimales>] }
```

**Exemple** :

```javascript
{
  $project: {
    valeur: 1,
    tronquee: { $trunc: "$valeur" }
  }
}
```

**R√©sultat** :
```javascript
{ "valeur": 4.9, "tronquee": 4 }
{ "valeur": -4.9, "tronquee": -4 }
```

**Diff√©rence avec $floor** :
- `$floor: -4.9` ‚Üí -5 (arrondi vers le bas)
- `$trunc: -4.9` ‚Üí -4 (supprime juste les d√©cimales)

## Op√©rateurs Avanc√©s

### $pow : Puissance

√âl√®ve un nombre √† une puissance.

**Syntaxe** :
```javascript
{ $pow: [<base>, <exposant>] }
```

**Exemple 1 : Carr√© et Cube**

```javascript
{
  $project: {
    nombre: 1,
    carre: { $pow: ["$nombre", 2] },
    cube: { $pow: ["$nombre", 3] }
  }
}
```

**R√©sultat** :
```javascript
{ "nombre": 5, "carre": 25, "cube": 125 }
```

**Exemple 2 : Calcul d'Int√©r√™ts Compos√©s**

```javascript
// Formule : Montant √ó (1 + taux)^ann√©es
{
  $project: {
    capitalInitial: 1,
    capitalFinal: {
      $multiply: [
        "$capitalInitial",
        { $pow: [{ $add: [1, "$tauxAnnuel"] }, "$annees"] }
      ]
    }
  }
}
```

**Exemple 3 : Surface et Volume**

```javascript
// Surface d'un cercle : œÄ √ó r¬≤
{
  $project: {
    rayon: 1,
    surface: {
      $multiply: [
        3.14159,
        { $pow: ["$rayon", 2] }
      ]
    }
  }
}
```

### $sqrt : Racine Carr√©e

Calcule la racine carr√©e d'un nombre.

**Syntaxe** :
```javascript
{ $sqrt: <nombre> }
```

**Exemple 1 : Racine Carr√©e Simple**

```javascript
{
  $project: {
    nombre: 1,
    racine: { $sqrt: "$nombre" }
  }
}
```

**R√©sultat** :
```javascript
{ "nombre": 25, "racine": 5 }
{ "nombre": 16, "racine": 4 }
```

**Exemple 2 : √âcart-Type**

```javascript
// Calcul simplifi√© de l'√©cart-type
{
  $project: {
    ecartType: {
      $sqrt: "$variance"
    }
  }
}
```

**Exemple 3 : Distance Euclidienne**

```javascript
// Distance entre deux points (x1,y1) et (x2,y2)
{
  $project: {
    distance: {
      $sqrt: {
        $add: [
          { $pow: [{ $subtract: ["$x2", "$x1"] }, 2] },
          { $pow: [{ $subtract: ["$y2", "$y1"] }, 2] }
        ]
      }
    }
  }
}
```

### $exp, $ln, $log, $log10 : Logarithmes et Exponentielles

Ces op√©rateurs sont utilis√©s pour des calculs math√©matiques avanc√©s.

**$exp** : Exponentielle (e^x)
```javascript
{ $exp: 2 }    // e^2 ‚âà 7.389
```

**$ln** : Logarithme naturel (base e)
```javascript
{ $ln: 10 }    // ln(10) ‚âà 2.302
```

**$log** : Logarithme avec base personnalis√©e
```javascript
{ $log: [100, 10] }    // log‚ÇÅ‚ÇÄ(100) = 2
```

**$log10** : Logarithme base 10
```javascript
{ $log10: 1000 }    // log‚ÇÅ‚ÇÄ(1000) = 3
```

**Exemple** : √âchelle logarithmique

```javascript
{
  $project: {
    valeur: 1,
    echelleLog: { $log10: "$valeur" }
  }
}
```

## Combinaison d'Op√©rateurs

Les op√©rateurs arithm√©tiques peuvent √™tre **imbriqu√©s** pour cr√©er des formules complexes.

### Exemple 1 : Prix TTC avec Remise

```javascript
// Prix final = (Prix HT √ó (1 - %remise)) √ó (1 + %TVA)
{
  $project: {
    produit: 1,
    prixHT: 1,
    prixFinal: {
      $multiply: [
        {
          $multiply: [
            "$prixHT",
            { $subtract: [1, "$pourcentageRemise"] }
          ]
        },
        { $add: [1, "$tauxTVA"] }
      ]
    }
  }
}
```

### Exemple 2 : Indice de Masse Corporelle (IMC)

```javascript
// IMC = poids / (taille¬≤)
{
  $project: {
    nom: 1,
    poids: 1,
    taille: 1,
    imc: {
      $round: [
        {
          $divide: [
            "$poids",
            { $pow: ["$taille", 2] }
          ]
        },
        1
      ]
    }
  }
}
```

### Exemple 3 : Marge en Pourcentage

```javascript
// Marge % = ((Prix vente - Prix achat) / Prix achat) √ó 100
{
  $project: {
    produit: 1,
    margePourcentage: {
      $round: [
        {
          $multiply: [
            {
              $divide: [
                { $subtract: ["$prixVente", "$prixAchat"] },
                "$prixAchat"
              ]
            },
            100
          ]
        },
        2
      ]
    }
  }
}
```

### Exemple 4 : Note Finale Pond√©r√©e

```javascript
// Note finale = (Examen √ó 60%) + (TP √ó 30%) + (Participation √ó 10%)
{
  $project: {
    etudiant: 1,
    noteFinaleCours: {
      $round: [
        {
          $add: [
            { $multiply: ["$noteExamen", 0.60] },
            { $multiply: ["$noteTP", 0.30] },
            { $multiply: ["$noteParticipation", 0.10] }
          ]
        },
        2
      ]
    }
  }
}
```

## Cas d'Usage Pratiques

### 1. E-commerce : Calcul de Prix

```javascript
db.produits.aggregate([
  {
    $project: {
      nom: 1,
      prixHT: 1,
      remise: 1,

      // Prix apr√®s remise
      prixApresRemise: {
        $multiply: [
          "$prixHT",
          { $subtract: [1, { $divide: ["$remise", 100] }] }
        ]
      },

      // Prix TTC
      prixTTC: {
        $multiply: [
          {
            $multiply: [
              "$prixHT",
              { $subtract: [1, { $divide: ["$remise", 100] }] }
            ]
          },
          1.20
        ]
      },

      // √âconomie r√©alis√©e
      economie: {
        $multiply: [
          "$prixHT",
          { $divide: ["$remise", 100] }
        ]
      }
    }
  }
])
```

### 2. Analyse Financi√®re : Ratios

```javascript
db.entreprises.aggregate([
  {
    $project: {
      nom: 1,

      // Ratio de liquidit√©
      ratioLiquidite: {
        $round: [
          { $divide: ["$actifsCourants", "$passifsCourants"] },
          2
        ]
      },

      // Marge nette
      margeNette: {
        $round: [
          {
            $multiply: [
              { $divide: ["$beneficeNet", "$chiffreAffaires"] },
              100
            ]
          },
          2
        ]
      },

      // Retour sur investissement (ROI)
      roi: {
        $round: [
          {
            $multiply: [
              {
                $divide: [
                  { $subtract: ["$gainInvestissement", "$coutInvestissement"] },
                  "$coutInvestissement"
                ]
              },
              100
            ]
          },
          2
        ]
      }
    }
  }
])
```

### 3. Statistiques : Normalisation

```javascript
// Normalisation Min-Max : (valeur - min) / (max - min)
db.donnees.aggregate([
  {
    $group: {
      _id: null,
      valeurs: { $push: "$$ROOT" },
      min: { $min: "$valeur" },
      max: { $max: "$valeur" }
    }
  },
  {
    $unwind: "$valeurs"
  },
  {
    $project: {
      _id: "$valeurs._id",
      valeurOriginale: "$valeurs.valeur",
      valeurNormalisee: {
        $divide: [
          { $subtract: ["$valeurs.valeur", "$min"] },
          { $subtract: ["$max", "$min"] }
        ]
      }
    }
  }
])
```

### 4. Conversion d'Unit√©s

```javascript
{
  $project: {
    nom: 1,

    // Temp√©rature : Celsius ‚Üí Fahrenheit
    tempF: {
      $add: [
        { $multiply: ["$tempC", 9/5] },
        32
      ]
    },

    // Distance : km ‚Üí miles
    distanceMiles: {
      $multiply: ["$distanceKm", 0.621371]
    },

    // Poids : kg ‚Üí livres
    poidsLivres: {
      $multiply: ["$poidsKg", 2.20462]
    },

    // Volume : litres ‚Üí gallons
    volumeGallons: {
      $multiply: ["$volumeLitres", 0.264172]
    }
  }
}
```

## Gestion des Erreurs et Valeurs Sp√©ciales

### Division par Z√©ro

‚ö†Ô∏è **Division par z√©ro g√©n√®re une erreur** et arr√™te le pipeline !

**Solution** : Utiliser `$cond` pour g√©rer le cas :

```javascript
{
  $project: {
    moyenne: {
      $cond: {
        if: { $eq: ["$diviseur", 0] },
        then: null,    // ou 0, ou une valeur par d√©faut
        else: { $divide: ["$dividende", "$diviseur"] }
      }
    }
  }
}
```

### Valeurs null

Les op√©rateurs arithm√©tiques avec `null` retournent `null` :

```javascript
{ $add: [10, null] }         // ‚Üí null
{ $multiply: [5, null] }     // ‚Üí null
```

**Solution** : Utiliser `$ifNull` :

```javascript
{
  $project: {
    total: {
      $add: [
        { $ifNull: ["$montant1", 0] },
        { $ifNull: ["$montant2", 0] }
      ]
    }
  }
}
```

### Racine Carr√©e de Nombre N√©gatif

‚ö†Ô∏è **$sqrt d'un nombre n√©gatif g√©n√®re une erreur** !

**Solution** : V√©rifier avant :

```javascript
{
  $project: {
    racine: {
      $cond: {
        if: { $gte: ["$nombre", 0] },
        then: { $sqrt: "$nombre" },
        else: null
      }
    }
  }
}
```

### Champs Manquants

Si un champ n'existe pas, il est trait√© comme `null` :

```javascript
// Si "bonus" n'existe pas
{
  $project: {
    total: { $add: ["$salaire", "$bonus"] }    // ‚Üí null si bonus n'existe pas
  }
}
```

**Solution** : Utiliser des valeurs par d√©faut :

```javascript
{
  $project: {
    total: {
      $add: [
        "$salaire",
        { $ifNull: ["$bonus", 0] }
      ]
    }
  }
}
```

## Performances et Optimisations

### 1. Calculs Constants

MongoDB optimise automatiquement les calculs constants :

```javascript
// MongoDB calcule 1.20 une seule fois
{
  $project: {
    prixTTC: { $multiply: ["$prixHT", 1.20] }
  }
}
```

### 2. Simplifier les Formules

```javascript
// ‚ùå COMPLEXE
{
  prixFinal: {
    $multiply: [
      { $divide: [{ $multiply: ["$prix", 100] }, 100] },
      1.20
    ]
  }
}

// ‚úÖ SIMPLIFI√â
{
  prixFinal: { $multiply: ["$prix", 1.20] }
}
```

### 3. √âviter les Calculs Inutiles

```javascript
// ‚ùå Calcule pour tous les documents
db.produits.aggregate([
  {
    $project: {
      prixCalcule: { $multiply: ["$prix", "$quantite"] }
    }
  },
  {
    $match: { categorie: "√âlectronique" }
  }
])

// ‚úÖ Filtre d'abord
db.produits.aggregate([
  {
    $match: { categorie: "√âlectronique" }
  },
  {
    $project: {
      prixCalcule: { $multiply: ["$prix", "$quantite"] }
    }
  }
])
```

### 4. Utiliser des Index

Les index n'aident pas directement les calculs, mais acc√©l√®rent les √©tapes pr√©c√©dentes ($match, $sort).

## Points Cl√©s √† Retenir

1. ‚úÖ **Op√©rateurs de base** : $add, $subtract, $multiply, $divide, $mod
2. ‚úÖ **Arrondi** : $ceil (‚Üë), $floor (‚Üì), $round (‚âà), $trunc (couper)
3. ‚úÖ **Valeur absolue** : $abs (toujours positif)
4. ‚úÖ **Puissance et racine** : $pow (x^n), $sqrt (‚àöx)
5. ‚úÖ **Combiner** : Les op√©rateurs peuvent √™tre imbriqu√©s
6. ‚ö†Ô∏è **Division par z√©ro** : Utiliser $cond pour √©viter les erreurs
7. ‚ö†Ô∏è **Valeurs null** : Utiliser $ifNull pour g√©rer les cas manquants
8. ‚úÖ **Round pour affichage** : Toujours arrondir les r√©sultats financiers
9. ‚ö° **Filtrer d'abord** : R√©duire le volume avant les calculs
10. ‚úÖ **Formules lisibles** : D√©couper les calculs complexes en √©tapes

## Exemple Complet : Tableau de Bord E-commerce

```javascript
// Analyse compl√®te des ventes avec calculs multiples
db.commandes.aggregate([
  {
    // 1. Filtrer l'ann√©e en cours
    $match: {
      date: { $gte: ISODate("2024-01-01") }
    }
  },
  {
    // 2. Calculer les m√©triques par commande
    $project: {
      numeroCommande: 1,
      client: 1,
      date: 1,

      // Montants
      montantHT: "$montant",
      montantTVA: {
        $multiply: ["$montant", 0.20]
      },
      montantTTC: {
        $multiply: ["$montant", 1.20]
      },

      // Remise appliqu√©e (si elle existe)
      remiseAppliquee: {
        $multiply: [
          "$montant",
          { $divide: [{ $ifNull: ["$pourcentageRemise", 0] }, 100] }
        ]
      },

      // Montant apr√®s remise
      montantApresRemise: {
        $multiply: [
          "$montant",
          {
            $subtract: [
              1,
              { $divide: [{ $ifNull: ["$pourcentageRemise", 0] }, 100] }
            ]
          }
        ]
      },

      // Frais de livraison gratuits si > 50‚Ç¨
      fraisLivraison: {
        $cond: {
          if: { $gte: ["$montant", 50] },
          then: 0,
          else: 5
        }
      },

      // Total final
      totalFinal: {
        $add: [
          {
            $multiply: [
              {
                $multiply: [
                  "$montant",
                  {
                    $subtract: [
                      1,
                      { $divide: [{ $ifNull: ["$pourcentageRemise", 0] }, 100] }
                    ]
                  }
                ]
              },
              1.20
            ]
          },
          {
            $cond: {
              if: { $gte: ["$montant", 50] },
              then: 0,
              else: 5
            }
          }
        ]
      },

      // √âconomies r√©alis√©es par le client
      economiesClient: {
        $round: [
          {
            $add: [
              {
                $multiply: [
                  "$montant",
                  { $divide: [{ $ifNull: ["$pourcentageRemise", 0] }, 100] }
                ]
              },
              {
                $cond: {
                  if: { $gte: ["$montant", 50] },
                  then: 5,
                  else: 0
                }
              }
            ]
          },
          2
        ]
      }
    }
  },
  {
    // 3. Trier par total d√©croissant
    $sort: { totalFinal: -1 }
  },
  {
    // 4. Limiter aux 100 meilleures commandes
    $limit: 100
  }
])
```

## Conclusion

Les op√©rateurs arithm√©tiques sont des outils **puissants et essentiels** pour :

- üßÆ **Calculer** des valeurs d√©riv√©es (totaux, moyennes, pourcentages)
- üí∞ **Traiter** des donn√©es financi√®res (prix, marges, remises)
- üìä **Cr√©er** des m√©triques et indicateurs
- üîÑ **Transformer** et normaliser des donn√©es
- üìê **Impl√©menter** des formules m√©tier complexes

La cl√© est de bien g√©rer les cas limites (division par z√©ro, valeurs null) et de structurer vos calculs de mani√®re lisible et performante. N'h√©sitez pas √† d√©couper les formules complexes en plusieurs √©tapes `$project` pour faciliter le d√©bogage et la maintenance.

---


‚è≠Ô∏è [Op√©rateurs de cha√Ænes](/06-framework-agregation/05.2-operateurs-chaines.md)
