üîù Retour au [Sommaire](/SOMMAIRE.md)

# 6.4.9 $redact

## Introduction

L'√©tape `$redact` est un op√©rateur avanc√© du framework d'agr√©gation MongoDB qui permet de **filtrer le contenu des documents** de mani√®re **r√©cursive** et **conditionnelle**. Il est particuli√®rement utile pour impl√©menter un **contr√¥le d'acc√®s au niveau des champs** et prot√©ger les donn√©es sensibles.

### L'Essentiel

- **Filtrage r√©cursif** : Examine chaque niveau d'un document (racine, sous-documents, tableaux)
- **Contr√¥le d'acc√®s** : Masque ou r√©v√®le des champs selon des conditions
- **Trois actions** : `$$DESCEND`, `$$PRUNE`, `$$KEEP`
- **S√©curit√©** : Id√©al pour prot√©ger les donn√©es sensibles

### Analogie Simple

Imaginez un **document confidentiel** avec diff√©rents niveaux de classification :
- **Public** : Tout le monde peut voir
- **Interne** : Seulement les employ√©s
- **Confidentiel** : Seulement les managers
- **Secret** : Seulement les directeurs

`$redact` c'est comme un **agent de s√©curit√©** qui parcourt le document et **masque les parties** auxquelles vous n'avez pas acc√®s, tout en vous montrant ce que vous pouvez voir.

---

## Pourquoi Utiliser $redact ?

`$redact` est essentiel pour :

1. **Contr√¥le d'acc√®s granulaire** : Au niveau du champ, pas seulement du document
2. **Protection des donn√©es sensibles** : Salaires, informations personnelles
3. **Filtrage conditionnel** : Bas√© sur des tags, niveaux, r√¥les
4. **Respect de la confidentialit√©** : RGPD, conformit√© r√©glementaire
5. **Multi-tenant** : Isoler les donn√©es entre clients
6. **Versions du contenu** : Afficher ou masquer selon l'√©tat

---

## Concept de Base

### Filtrage R√©cursif

`$redact` parcourt **chaque niveau** d'un document de mani√®re r√©cursive :
1. **Racine du document**
2. **Sous-documents imbriqu√©s**
3. **√âl√©ments de tableaux**
4. **Sous-documents dans les tableaux**
5. Et ainsi de suite...

√Ä chaque niveau, `$redact` **√©value une condition** et prend une **d√©cision** sur quoi faire.

### Les Trois Actions

| Action | Description | R√©sultat |
|--------|-------------|----------|
| **`$$DESCEND`** | Continue √† examiner les niveaux inf√©rieurs | Descend dans la structure |
| **`$$PRUNE`** | Supprime ce niveau et tout ce qu'il contient | Masque/Retire compl√®tement |
| **`$$KEEP`** | Conserve ce niveau et tout ce qu'il contient | Garde tout tel quel |

---

## Syntaxe

```javascript
{
  $redact: <expression>
}
```

L'expression doit retourner l'une des trois actions : `$$DESCEND`, `$$PRUNE`, ou `$$KEEP`.

### Utilisation Typique avec $cond

```javascript
{
  $redact: {
    $cond: {
      if: <condition>,
      then: <action_si_vrai>,
      else: <action_si_faux>
    }
  }
}
```

---

## Exemple Simple avec $$PRUNE et $$KEEP

### Donn√©es de D√©part

```javascript
db.employes.insertMany([
  {
    _id: 1,
    nom: "Alice",
    poste: "Manager",
    salaire: 75000,
    niveau_acces: "public",
    departement: {
      nom: "IT",
      budget: 500000,
      niveau_acces: "confidentiel"
    }
  },
  {
    _id: 2,
    nom: "Bob",
    poste: "D√©veloppeur",
    salaire: 55000,
    niveau_acces: "public",
    departement: {
      nom: "IT",
      budget: 500000,
      niveau_acces: "confidentiel"
    }
  }
])
```

### Application de $redact : Masquer les Donn√©es Confidentielles

```javascript
db.employes.aggregate([
  {
    $redact: {
      $cond: {
        if: { $eq: ["$niveau_acces", "confidentiel"] },
        then: "$$PRUNE",   // Masquer si confidentiel
        else: "$$DESCEND"  // Continuer √† examiner sinon
      }
    }
  }
])
```

### R√©sultat

```json
[
  {
    "_id": 1,
    "nom": "Alice",
    "poste": "Manager",
    "salaire": 75000,
    "niveau_acces": "public"
    // "departement" est MASQU√â (niveau_acces: "confidentiel")
  },
  {
    "_id": 2,
    "nom": "Bob",
    "poste": "D√©veloppeur",
    "salaire": 55000,
    "niveau_acces": "public"
    // "departement" est MASQU√â (niveau_acces: "confidentiel")
  }
]
```

### Observation

Le champ `departement` a √©t√© **compl√®tement supprim√©** car son `niveau_acces` √©tait "confidentiel".

---

## Comportement D√©taill√© des Actions

### $$DESCEND : Continuer l'Examen

`$$DESCEND` signifie : "Ce niveau est OK, **continue √† examiner** les niveaux inf√©rieurs".

#### Exemple

```javascript
{
  _id: 1,
  nom: "Alice",
  niveau_acces: "public",
  infos: {
    age: 30,
    niveau_acces: "public",
    salaire: {
      montant: 75000,
      niveau_acces: "confidentiel"
    }
  }
}
```

**Pipeline** :
```javascript
db.collection.aggregate([
  {
    $redact: {
      $cond: {
        if: { $eq: ["$niveau_acces", "confidentiel"] },
        then: "$$PRUNE",
        else: "$$DESCEND"
      }
    }
  }
])
```

**Parcours** :
1. **Racine** ‚Üí niveau_acces: "public" ‚Üí `$$DESCEND` (continue)
2. **infos** ‚Üí niveau_acces: "public" ‚Üí `$$DESCEND` (continue)
3. **salaire** ‚Üí niveau_acces: "confidentiel" ‚Üí `$$PRUNE` (supprim√©)

**R√©sultat** :
```json
{
  "_id": 1,
  "nom": "Alice",
  "niveau_acces": "public",
  "infos": {
    "age": 30,
    "niveau_acces": "public"
    // "salaire" est MASQU√â
  }
}
```

### $$PRUNE : Supprimer

`$$PRUNE` signifie : "**Supprime** ce niveau et **tout ce qu'il contient** (pas besoin d'aller plus loin)".

#### Caract√©ristiques

- Supprime le champ/sous-document actuel
- Ne descend **pas** dans les niveaux inf√©rieurs
- M√™me si certains sous-champs seraient autoris√©s, tout est supprim√©

### $$KEEP : Conserver

`$$KEEP` signifie : "**Garde** ce niveau et **tout ce qu'il contient** (pas besoin d'examiner plus loin)".

#### Caract√©ristiques

- Conserve tout le contenu, y compris les sous-niveaux
- Ne descend **pas** pour v√©rifier les niveaux inf√©rieurs
- Utile pour optimiser quand on sait que tout est autoris√©

#### Exemple

```javascript
{
  _id: 1,
  nom: "Alice",
  niveau_acces: "public",
  bio: {
    description: "Manager exp√©riment√©e",
    hobbies: ["lecture", "sport"],
    niveau_acces: "public"
  }
}
```

**Pipeline** :
```javascript
db.collection.aggregate([
  {
    $redact: {
      $cond: {
        if: { $eq: ["$niveau_acces", "public"] },
        then: "$$KEEP",      // Tout garder si public
        else: "$$PRUNE"
      }
    }
  }
])
```

**R√©sultat** : Le document **entier** est conserv√©, y compris tous les sous-champs de `bio`, sans les examiner individuellement.

---

## Contr√¥le d'Acc√®s Multi-Niveaux

### Exemple : Syst√®me de Classification

```javascript
db.documents.insertMany([
  {
    _id: 1,
    titre: "Rapport Annuel",
    classification: "public",
    contenu: {
      resume: "Bonne ann√©e fiscale",
      classification: "public"
    },
    finances: {
      revenus: 5000000,
      depenses: 3000000,
      classification: "interne"
    },
    strategies: {
      expansion: "March√©s √©mergents",
      classification: "confidentiel"
    }
  }
])
```

### Pipeline avec Hi√©rarchie d'Acc√®s

```javascript
// Variable : niveau d'acc√®s de l'utilisateur
const niveauUtilisateur = "interne"

// Hi√©rarchie : public < interne < confidentiel < secret
const hierarchie = {
  "public": 0,
  "interne": 1,
  "confidentiel": 2,
  "secret": 3
}

db.documents.aggregate([
  {
    $redact: {
      $cond: {
        if: {
          $lte: [
            {
              $switch: {
                branches: [
                  { case: { $eq: ["$classification", "public"] }, then: 0 },
                  { case: { $eq: ["$classification", "interne"] }, then: 1 },
                  { case: { $eq: ["$classification", "confidentiel"] }, then: 2 },
                  { case: { $eq: ["$classification", "secret"] }, then: 3 }
                ],
                default: 0
              }
            },
            hierarchie[niveauUtilisateur]
          ]
        },
        then: "$$DESCEND",
        else: "$$PRUNE"
      }
    }
  }
])
```

### R√©sultat (pour utilisateur "interne")

```json
{
  "_id": 1,
  "titre": "Rapport Annuel",
  "classification": "public",
  "contenu": {
    "resume": "Bonne ann√©e fiscale",
    "classification": "public"
  },
  "finances": {
    "revenus": 5000000,
    "depenses": 3000000,
    "classification": "interne"
  }
  // "strategies" est MASQU√â (confidentiel > interne)
}
```

---

## Utilisation avec des Tags

### Exemple : Filtrage par Tags

```javascript
db.articles.insertMany([
  {
    _id: 1,
    titre: "Article Public",
    contenu: "Contenu visible par tous",
    tags: ["public"],
    commentaires: [
      {
        auteur: "Alice",
        texte: "Excellent !",
        tags: ["public"]
      },
      {
        auteur: "Bob",
        texte: "Note interne : √† am√©liorer",
        tags: ["interne"]
      }
    ]
  }
])
```

### Pipeline : Afficher selon les Tags Autoris√©s

```javascript
// Tags autoris√©s pour l'utilisateur
const tagsAutorises = ["public"]

db.articles.aggregate([
  {
    $redact: {
      $cond: {
        if: {
          $gt: [
            {
              $size: {
                $setIntersection: ["$tags", tagsAutorises]
              }
            },
            0
          ]
        },
        then: "$$DESCEND",
        else: "$$PRUNE"
      }
    }
  }
])
```

**Explication** :
- `$setIntersection` trouve les tags communs entre le document et les tags autoris√©s
- Si la taille > 0, il y a au moins un tag autoris√© ‚Üí `$$DESCEND`
- Sinon ‚Üí `$$PRUNE`

### R√©sultat

```json
{
  "_id": 1,
  "titre": "Article Public",
  "contenu": "Contenu visible par tous",
  "tags": ["public"],
  "commentaires": [
    {
      "auteur": "Alice",
      "texte": "Excellent !",
      "tags": ["public"]
    }
    // Le commentaire de Bob est MASQU√â (tag "interne")
  ]
}
```

---

## Cas d'Usage : Multi-Tenant

### Exemple : Isoler les Donn√©es par Client

```javascript
db.donnees_clients.insertMany([
  {
    _id: 1,
    nom: "Document A",
    client_id: "client_001",
    contenu: "Donn√©es du client 001"
  },
  {
    _id: 2,
    nom: "Document B",
    client_id: "client_002",
    contenu: "Donn√©es du client 002"
  },
  {
    _id: 3,
    nom: "Document partag√©",
    clients: ["client_001", "client_002"],
    contenu: "Donn√©es partag√©es"
  }
])
```

### Pipeline : Filtrer par Client

```javascript
const clientActuel = "client_001"

db.donnees_clients.aggregate([
  {
    $redact: {
      $cond: {
        if: {
          $or: [
            { $eq: ["$client_id", clientActuel] },
            { $in: [clientActuel, { $ifNull: ["$clients", []] }] }
          ]
        },
        then: "$$KEEP",
        else: "$$PRUNE"
      }
    }
  }
])
```

### R√©sultat

```json
[
  {
    "_id": 1,
    "nom": "Document A",
    "client_id": "client_001",
    "contenu": "Donn√©es du client 001"
  },
  {
    "_id": 3,
    "nom": "Document partag√©",
    "clients": ["client_001", "client_002"],
    "contenu": "Donn√©es partag√©es"
  }
  // Document 2 est MASQU√â (appartient au client_002)
]
```

---

## Variables Syst√®me Disponibles

Dans `$redact`, vous avez acc√®s aux variables syst√®me MongoDB :

| Variable | Description |
|----------|-------------|
| `$$DESCEND` | Continuer √† descendre dans la hi√©rarchie |
| `$$PRUNE` | Supprimer ce niveau et ses enfants |
| `$$KEEP` | Garder ce niveau et tous ses enfants |
| `$$CURRENT` | Document/sous-document actuel |
| `$$ROOT` | Document racine complet |

### Exemple avec $$ROOT

```javascript
db.employes.aggregate([
  {
    $redact: {
      $cond: {
        // Acc√©der √† un champ du document racine
        if: { $eq: ["$$ROOT.role", "admin"] },
        then: "$$KEEP",     // Admin voit tout
        else: {
          $cond: {
            if: { $eq: ["$niveau_acces", "confidentiel"] },
            then: "$$PRUNE",
            else: "$$DESCEND"
          }
        }
      }
    }
  }
])
```

---

## Comparaison avec $project

### $project : S√©lection Explicite

```javascript
// Avec $project : On dit explicitement quoi garder
{
  $project: {
    nom: 1,
    poste: 1,
    salaire: 1
    // departement exclu
  }
}
```

**Limitations** :
- Doit lister tous les champs √† garder/exclure
- Difficile avec des structures imbriqu√©es complexes
- Pas de logique conditionnelle au niveau des sous-champs

### $redact : Filtrage Conditionnel R√©cursif

```javascript
// Avec $redact : On d√©finit des r√®gles
{
  $redact: {
    $cond: {
      if: { $eq: ["$niveau_acces", "confidentiel"] },
      then: "$$PRUNE",
      else: "$$DESCEND"
    }
  }
}
```

**Avantages** :
- R√®gles conditionnelles
- Traitement r√©cursif automatique
- Id√©al pour structures imbriqu√©es complexes

### Quand Utiliser Chacun

| Situation | Op√©rateur Recommand√© |
|-----------|----------------------|
| S√©lection simple de champs | ‚úÖ `$project` |
| Structure plate | ‚úÖ `$project` |
| Filtrage conditionnel | ‚úÖ `$redact` |
| Documents profond√©ment imbriqu√©s | ‚úÖ `$redact` |
| Contr√¥le d'acc√®s par niveau | ‚úÖ `$redact` |
| Tags de s√©curit√© | ‚úÖ `$redact` |

---

## Cas d'Usage Avanc√© : Versions de Document

### Exemple : Afficher selon l'√âtat de Publication

```javascript
db.articles.insertMany([
  {
    _id: 1,
    titre: "Mon Article",
    statut: "publie",
    contenu: {
      introduction: "Intro publique",
      statut: "publie"
    },
    brouillon: {
      notes: "√Ä revoir",
      statut: "brouillon"
    },
    interne: {
      commentaires_editeur: "Bon travail",
      statut: "interne"
    }
  }
])
```

### Pipeline : Vue Publique

```javascript
db.articles.aggregate([
  {
    $redact: {
      $cond: {
        if: { $eq: ["$statut", "publie"] },
        then: "$$DESCEND",
        else: "$$PRUNE"
      }
    }
  }
])
```

**R√©sultat** : Seuls les champs avec `statut: "publie"` sont visibles.

---

## Combinaison avec d'Autres √âtapes

### Exemple : Filtrer puis Redacter

```javascript
db.employes.aggregate([
  // √âtape 1 : Filtrer les employ√©s actifs
  {
    $match: {
      actif: true,
      departement: "IT"
    }
  },

  // √âtape 2 : Ajouter le r√¥le de l'utilisateur actuel
  {
    $addFields: {
      role_utilisateur: "employee"  // Variable externe
    }
  },

  // √âtape 3 : Redacter selon le r√¥le
  {
    $redact: {
      $cond: {
        if: { $eq: ["$role_utilisateur", "admin"] },
        then: "$$KEEP",  // Admin voit tout
        else: {
          $cond: {
            if: { $eq: ["$niveau_acces", "prive"] },
            then: "$$PRUNE",
            else: "$$DESCEND"
          }
        }
      }
    }
  },

  // √âtape 4 : Nettoyer le champ temporaire
  {
    $project: {
      role_utilisateur: 0
    }
  }
])
```

---

## Performances

### Impact

`$redact` peut √™tre **co√ªteux** car :
- Parcourt **r√©cursivement** chaque niveau du document
- √âvalue des conditions √† **chaque niveau**
- Peut traiter des structures **profond√©ment imbriqu√©es**

### Optimisations

#### 1. Filtrer Avant $redact

```javascript
// ‚úÖ Bon : R√©duire le volume avant
db.employes.aggregate([
  {
    $match: { departement: "IT", actif: true }  // Filtrer d'abord
  },
  {
    $redact: { /* ... */ }
  }
])
```

#### 2. Utiliser $$KEEP Quand Possible

```javascript
// Si on sait que tout un sous-arbre est autoris√©
{
  $redact: {
    $cond: {
      if: { $eq: ["$niveau_acces", "public"] },
      then: "$$KEEP",      // Arr√™te l'examen (optimisation)
      else: "$$DESCEND"
    }
  }
}
```

#### 3. Simplifier les Conditions

```javascript
// ‚ùå Complexe
{
  $redact: {
    $cond: {
      if: {
        $and: [
          { $or: [ /* ... */ ] },
          { $not: { /* ... */ } },
          // Tr√®s complexe
        ]
      },
      then: "$$DESCEND",
      else: "$$PRUNE"
    }
  }
}

// ‚úÖ Plus simple (si possible)
{
  $redact: {
    $cond: {
      if: { $eq: ["$visible", true] },
      then: "$$DESCEND",
      else: "$$PRUNE"
    }
  }
}
```

#### 4. Indexer les Champs de Filtrage Initial

```javascript
// Cr√©er un index sur les champs utilis√©s dans $match
db.employes.createIndex({ departement: 1, actif: 1 })
```

---

## Bonnes Pratiques

### 1. Ajouter des Champs de Contr√¥le d'Acc√®s

```javascript
// ‚úÖ Structure bien con√ßue
{
  _id: 1,
  nom: "Document",
  niveau_acces: "public",      // Champ de contr√¥le
  contenu: {
    section1: "...",
    niveau_acces: "public"
  },
  confidentiel: {
    donnees_sensibles: "...",
    niveau_acces: "confidentiel"
  }
}

// ‚ùå Pas de champs de contr√¥le
{
  _id: 1,
  nom: "Document",
  contenu: "...",
  confidentiel: "..."  // Comment savoir si c'est confidentiel ?
}
```

### 2. Documenter les Niveaux de S√©curit√©

```javascript
/**
 * Niveaux de s√©curit√© :
 * - "public" : Accessible √† tous
 * - "interne" : Employ√©s seulement
 * - "confidentiel" : Managers et au-dessus
 * - "secret" : Directeurs uniquement
 */
const niveauxSecurite = {
  public: 0,
  interne: 1,
  confidentiel: 2,
  secret: 3
}
```

### 3. Tester avec Diff√©rents Niveaux d'Acc√®s

```javascript
// Tester chaque niveau
const niveaux = ["public", "interne", "confidentiel", "secret"]

niveaux.forEach(niveau => {
  console.log(`Test avec niveau : ${niveau}`)
  const resultat = db.documents.aggregate([
    {
      $redact: {
        // Pipeline avec ce niveau
      }
    }
  ])
  console.log(resultat)
})
```

### 4. G√©rer les Champs Sans Tag

```javascript
{
  $redact: {
    $cond: {
      if: {
        $or: [
          { $not: { $ifNull: ["$niveau_acces", false] } },  // Pas de tag
          { $eq: ["$niveau_acces", "public"] }
        ]
      },
      then: "$$DESCEND",
      else: "$$PRUNE"
    }
  }
}
```

---

## Exemple Complet : Syst√®me de Gestion de Documents

```javascript
// Collection de documents avec classification multi-niveaux
db.documents_entreprise.insertMany([
  {
    _id: 1,
    titre: "Guide des Employ√©s",
    classification: "public",
    contenu: {
      introduction: {
        texte: "Bienvenue dans l'entreprise",
        classification: "public"
      },
      politiques: {
        conges: {
          texte: "Politique de cong√©s",
          classification: "interne"
        },
        salaires: {
          grilles: [
            { niveau: "Junior", fourchette: "30-40K", classification: "confidentiel" },
            { niveau: "Senior", fourchette: "50-70K", classification: "confidentiel" }
          ],
          classification: "confidentiel"
        }
      },
      strategies: {
        expansion: {
          texte: "Plans d'expansion 2025",
          classification: "secret"
        },
        classification: "secret"
      }
    }
  }
])

// Fonction de filtrage r√©utilisable
function filtrerParNiveau(niveauUtilisateur) {
  const hierarchie = {
    "public": 0,
    "interne": 1,
    "confidentiel": 2,
    "secret": 3
  }

  return db.documents_entreprise.aggregate([
    {
      $redact: {
        $cond: {
          if: {
            $lte: [
              {
                $switch: {
                  branches: [
                    { case: { $eq: ["$classification", "public"] }, then: 0 },
                    { case: { $eq: ["$classification", "interne"] }, then: 1 },
                    { case: { $eq: ["$classification", "confidentiel"] }, then: 2 },
                    { case: { $eq: ["$classification", "secret"] }, then: 3 }
                  ],
                  default: 0  // Par d√©faut : public
                }
              },
              hierarchie[niveauUtilisateur]
            ]
          },
          then: "$$DESCEND",
          else: "$$PRUNE"
        }
      }
    },
    {
      $addFields: {
        consulte_par: niveauUtilisateur,
        date_consultation: "$$NOW"
      }
    }
  ])
}

// Test avec diff√©rents niveaux
console.log("=== Vue Employ√© (interne) ===")
filtrerParNiveau("interne").forEach(printjson)

console.log("\n=== Vue Manager (confidentiel) ===")
filtrerParNiveau("confidentiel").forEach(printjson)

console.log("\n=== Vue Directeur (secret) ===")
filtrerParNiveau("secret").forEach(printjson)
```

**R√©sultat pour un employ√© (niveau "interne")** :
```json
{
  "_id": 1,
  "titre": "Guide des Employ√©s",
  "classification": "public",
  "contenu": {
    "introduction": {
      "texte": "Bienvenue dans l'entreprise",
      "classification": "public"
    },
    "politiques": {
      "conges": {
        "texte": "Politique de cong√©s",
        "classification": "interne"
      }
      // "salaires" MASQU√â (confidentiel)
    }
    // "strategies" MASQU√â (secret)
  },
  "consulte_par": "interne",
  "date_consultation": ISODate("2024-03-20T10:30:00Z")
}
```

---

## R√©sum√©

### Points Cl√©s

| Aspect | Description |
|--------|-------------|
| **Fonction** | Filtrage r√©cursif et conditionnel des documents |
| **Actions** | `$$DESCEND`, `$$PRUNE`, `$$KEEP` |
| **R√©cursivit√©** | Parcourt tous les niveaux du document automatiquement |
| **Usage principal** | Contr√¥le d'acc√®s, protection des donn√©es sensibles |
| **Diff√©rence avec $project** | Logique conditionnelle vs s√©lection explicite |

### Les Trois Actions en D√©tail

| Action | Quand l'Utiliser | Comportement |
|--------|------------------|--------------|
| **$$DESCEND** | "Ce niveau est OK, continue" | Examine les sous-niveaux |
| **$$PRUNE** | "Masque ce niveau" | Supprime tout (niveau + enfants) |
| **$$KEEP** | "Garde tout ce niveau" | Conserve tout (niveau + enfants) |

### Quand Utiliser $redact

‚úÖ **Utilisez $redact** pour :
- Contr√¥le d'acc√®s **granulaire** (par champ)
- Documents **profond√©ment imbriqu√©s**
- Filtrage bas√© sur des **tags de s√©curit√©**
- **Multi-tenant** (isolation des donn√©es)
- Protection des **donn√©es sensibles**
- Filtrage **conditionnel r√©cursif**

‚ùå **N'utilisez PAS $redact** si :
- Simple s√©lection de champs ‚Üí Utilisez `$project`
- Structure plate ‚Üí Utilisez `$project`
- Pas de logique conditionnelle ‚Üí Utilisez `$project`

---

## Conclusion

`$redact` est un outil **puissant** pour impl√©menter un contr√¥le d'acc√®s fin dans MongoDB. Il permet de masquer s√©lectivement des parties de documents selon des r√®gles de s√©curit√©, tout en parcourant automatiquement les structures imbriqu√©es complexes.

### √Ä Retenir

1. **$redact** parcourt **r√©cursivement** chaque niveau du document
2. Trois actions : **$$DESCEND** (continue), **$$PRUNE** (masque), **$$KEEP** (garde)
3. Id√©al pour le **contr√¥le d'acc√®s** au niveau des champs
4. N√©cessite des **champs de classification** dans vos documents
5. Plus **complexe** que $project mais beaucoup plus **flexible**
6. Peut √™tre **co√ªteux** sur des documents tr√®s imbriqu√©s
7. Utilisez `$$KEEP` pour **optimiser** quand tout est autoris√©

### Prochaines √âtapes

Dans les sections suivantes, nous explorerons :
- **$sample** : √âchantillonnage al√©atoire de documents
- **$unionWith** : Combiner les r√©sultats de plusieurs collections
- **Optimisation des pipelines** : Techniques avanc√©es de performance

---

**üìö R√©f√©rences**

- [Documentation officielle $redact](https://www.mongodb.com/docs/manual/reference/operator/aggregation/redact/)
- [Field Level Security](https://www.mongodb.com/docs/manual/core/security-field-level-encryption/)
- [Aggregation Pipeline](https://www.mongodb.com/docs/manual/core/aggregation-pipeline/)
- [System Variables](https://www.mongodb.com/docs/manual/reference/aggregation-variables/)

‚è≠Ô∏è [$sample](/06-framework-agregation/04.10-sample.md)
