üîù Retour au [Sommaire](/SOMMAIRE.md)

# 6.5.6 Accumulateurs - Calculs d'Agr√©gation

## Introduction

Les accumulateurs sont des **op√©rateurs sp√©ciaux** utilis√©s dans l'√©tape `$group` pour calculer des valeurs agr√©g√©es sur un ensemble de documents. Ils "accumulent" des valeurs au fur et √† mesure qu'ils parcourent les documents d'un groupe pour produire un r√©sultat unique.

Pensez aux accumulateurs comme √† des **calculatrices de groupe** qui prennent plusieurs valeurs et les combinent en une seule : une somme, une moyenne, une liste, etc.

## √Ä Quoi Servent les Accumulateurs ?

### 1. **Calculs Statistiques**
Calculer des sommes, moyennes, minimums, maximums.

### 2. **Comptage**
Compter le nombre de documents dans chaque groupe.

### 3. **Collection de Valeurs**
Rassembler toutes les valeurs d'un champ dans un tableau.

### 4. **S√©lection**
Obtenir la premi√®re ou derni√®re valeur d'un groupe.

### 5. **Analyse de Donn√©es**
Calculer des √©carts-types, des variances, etc.

## Diff√©rence : Accumulateurs vs Op√©rateurs Normaux

**Accumulateurs** (dans `$group`) :
- Op√®rent sur **plusieurs documents**
- Produisent **une valeur par groupe**
- Utilis√©s **uniquement dans $group**

**Op√©rateurs normaux** (dans `$project`) :
- Op√®rent sur **un seul document**
- Produisent **une valeur par document**
- Utilis√©s dans `$project`, `$addFields`, etc.

**Exemple de confusion courante** :

```javascript
// ‚ùå ERREUR : $sum utilis√© dans $project (contexte d'un seul document)
{
  $project: {
    total: { $sum: "$montant" }  // Ne fonctionne pas comme attendu !
  }
}

// ‚úÖ CORRECT : $sum dans $group (contexte de plusieurs documents)
{
  $group: {
    _id: "$client",
    total: { $sum: "$montant" }  // Additionne tous les montants du groupe
  }
}
```

## Liste des Accumulateurs

### Accumulateurs Num√©riques

| Accumulateur | Description | Exemple |
|--------------|-------------|---------|
| `$sum` | Somme des valeurs | Chiffre d'affaires total |
| `$avg` | Moyenne des valeurs | Note moyenne |
| `$min` | Valeur minimale | Prix le plus bas |
| `$max` | Valeur maximale | Prix le plus haut |
| `$count` | Compte les documents | Nombre de commandes |

### Accumulateurs de Collection

| Accumulateur | Description | Exemple |
|--------------|-------------|---------|
| `$push` | Cr√©e un tableau avec toutes les valeurs | Liste de tous les produits |
| `$addToSet` | Tableau de valeurs uniques | Tags uniques |

### Accumulateurs de S√©lection

| Accumulateur | Description | Exemple |
|--------------|-------------|---------|
| `$first` | Premi√®re valeur du groupe | Premier achat |
| `$last` | Derni√®re valeur du groupe | Dernier achat |

### Accumulateurs Statistiques

| Accumulateur | Description | Exemple |
|--------------|-------------|---------|
| `$stdDevPop` | √âcart-type population | Dispersion des notes |
| `$stdDevSamp` | √âcart-type √©chantillon | Dispersion √©chantillon |

## $sum : Addition

L'accumulateur le plus utilis√©. Il additionne toutes les valeurs d'un champ dans un groupe.

### Syntaxe

```javascript
{ $sum: <expression> }
```

**Deux usages principaux** :
1. `{ $sum: 1 }` : Compte le nombre de documents (comme un compteur)
2. `{ $sum: "$champ" }` : Additionne les valeurs du champ

### Exemples

**Exemple 1 : Compter les Documents**

```javascript
// Collection: commandes
{ "_id": 1, "client": "Alice", "montant": 150 }
{ "_id": 2, "client": "Alice", "montant": 75 }
{ "_id": 3, "client": "Bob", "montant": 200 }
{ "_id": 4, "client": "Bob", "montant": 50 }
```

Compter le nombre de commandes par client :

```javascript
db.commandes.aggregate([
  {
    $group: {
      _id: "$client",
      nombreCommandes: { $sum: 1 }  // Ajoute 1 pour chaque document
    }
  }
])
```

**R√©sultat** :
```javascript
[
  { "_id": "Alice", "nombreCommandes": 2 },
  { "_id": "Bob", "nombreCommandes": 2 }
]
```

**Exemple 2 : Additionner des Montants**

```javascript
db.commandes.aggregate([
  {
    $group: {
      _id: "$client",
      totalDepense: { $sum: "$montant" }  // Additionne les montants
    }
  }
])
```

**R√©sultat** :
```javascript
[
  { "_id": "Alice", "totalDepense": 225 },  // 150 + 75
  { "_id": "Bob", "totalDepense": 250 }     // 200 + 50
]
```

**Exemple 3 : Somme Conditionnelle**

```javascript
// Additionner uniquement les commandes valid√©es
db.commandes.aggregate([
  {
    $group: {
      _id: "$client",
      totalValide: {
        $sum: {
          $cond: [
            { $eq: ["$statut", "valid√©e"] },
            "$montant",
            0
          ]
        }
      }
    }
  }
])
```

**Exemple 4 : Combiner Comptage et Somme**

```javascript
db.ventes.aggregate([
  {
    $group: {
      _id: "$vendeur",
      nombreVentes: { $sum: 1 },
      chiffreAffaires: { $sum: "$montant" },
      quantiteTotale: { $sum: "$quantite" }
    }
  }
])
```

**R√©sultat** :
```javascript
[
  {
    "_id": "Jean",
    "nombreVentes": 15,
    "chiffreAffaires": 5280,
    "quantiteTotale": 127
  }
]
```

## $avg : Moyenne

Calcule la moyenne arithm√©tique des valeurs.

### Syntaxe

```javascript
{ $avg: <expression> }
```

**Important** : `$avg` ignore les valeurs `null` et les champs manquants.

### Exemples

**Exemple 1 : Note Moyenne**

```javascript
// Collection: examens
{ "_id": 1, "etudiant": "Alice", "matiere": "Maths", "note": 15 }
{ "_id": 2, "etudiant": "Alice", "matiere": "Fran√ßais", "note": 17 }
{ "_id": 3, "etudiant": "Bob", "matiere": "Maths", "note": 12 }
{ "_id": 4, "etudiant": "Bob", "matiere": "Fran√ßais", "note": 14 }
```

```javascript
db.examens.aggregate([
  {
    $group: {
      _id: "$etudiant",
      moyenneGenerale: { $avg: "$note" }
    }
  }
])
```

**R√©sultat** :
```javascript
[
  { "_id": "Alice", "moyenneGenerale": 16 },    // (15 + 17) / 2
  { "_id": "Bob", "moyenneGenerale": 13 }       // (12 + 14) / 2
]
```

**Exemple 2 : Panier Moyen**

```javascript
db.commandes.aggregate([
  {
    $group: {
      _id: "$client",
      nombreCommandes: { $sum: 1 },
      totalDepense: { $sum: "$montant" },
      panierMoyen: { $avg: "$montant" }
    }
  }
])
```

**Exemple 3 : Prix Moyen par Cat√©gorie**

```javascript
db.produits.aggregate([
  {
    $group: {
      _id: "$categorie",
      prixMoyen: { $avg: "$prix" },
      nombreProduits: { $sum: 1 }
    }
  },
  {
    $project: {
      _id: 0,
      categorie: "$_id",
      prixMoyen: { $round: ["$prixMoyen", 2] },
      nombreProduits: 1
    }
  }
])
```

**R√©sultat** :
```javascript
[
  { "categorie": "√âlectronique", "prixMoyen": 345.67, "nombreProduits": 23 },
  { "categorie": "Meuble", "prixMoyen": 189.50, "nombreProduits": 15 }
]
```

## $min et $max : Minimum et Maximum

Trouvent la valeur minimale ou maximale dans un groupe.

### Syntaxe

```javascript
{ $min: <expression> }
{ $max: <expression> }
```

### Exemples

**Exemple 1 : Plage de Prix**

```javascript
db.produits.aggregate([
  {
    $group: {
      _id: "$categorie",
      prixMin: { $min: "$prix" },
      prixMax: { $max: "$prix" },
      prixMoyen: { $avg: "$prix" }
    }
  }
])
```

**R√©sultat** :
```javascript
[
  {
    "_id": "√âlectronique",
    "prixMin": 25,
    "prixMax": 1200,
    "prixMoyen": 345.67
  }
]
```

**Exemple 2 : Dates Extr√™mes**

```javascript
db.transactions.aggregate([
  {
    $group: {
      _id: "$compte",
      premiereTransaction: { $min: "$date" },
      derniereTransaction: { $max: "$date" }
    }
  }
])
```

**Exemple 3 : Performance d'Employ√©s**

```javascript
db.ventes.aggregate([
  {
    $group: {
      _id: "$employe",
      meilleureVente: { $max: "$montant" },
      plusPetiteVente: { $min: "$montant" },
      moyenneVente: { $avg: "$montant" }
    }
  }
])
```

**Exemple 4 : Temp√©rature Journali√®re**

```javascript
db.mesures.aggregate([
  {
    $group: {
      _id: {
        $dateToString: { format: "%Y-%m-%d", date: "$date" }
      },
      tempMin: { $min: "$temperature" },
      tempMax: { $max: "$temperature" },
      tempMoyenne: { $avg: "$temperature" }
    }
  }
])
```

## $count : Comptage (MongoDB 5.0+)

Alternative plus moderne √† `{ $sum: 1 }` pour compter les documents.

### Syntaxe

```javascript
{ $count: {} }
```

### Exemples

**Exemple 1 : Compter les Commandes**

```javascript
db.commandes.aggregate([
  {
    $group: {
      _id: "$statut",
      nombre: { $count: {} }
    }
  }
])
```

**√âquivalent avec $sum** :
```javascript
{
  $group: {
    _id: "$statut",
    nombre: { $sum: 1 }
  }
}
```

**Note** : `$sum: 1` est plus universel et fonctionne sur toutes les versions de MongoDB.

## $push : Cr√©er un Tableau

Collecte toutes les valeurs d'un champ dans un tableau. **Garde les doublons**.

### Syntaxe

```javascript
{ $push: <expression> }
```

### Exemples

**Exemple 1 : Liste des Commandes**

```javascript
db.commandes.aggregate([
  {
    $group: {
      _id: "$client",
      numeroCommandes: { $push: "$numeroCommande" }
    }
  }
])
```

**R√©sultat** :
```javascript
[
  {
    "_id": "Alice",
    "numeroCommandes": ["CMD-001", "CMD-003", "CMD-007"]
  }
]
```

**Exemple 2 : Pousser des Objets**

```javascript
db.ventes.aggregate([
  {
    $group: {
      _id: "$produit",
      ventes: {
        $push: {
          date: "$date",
          montant: "$montant",
          client: "$client"
        }
      }
    }
  }
])
```

**R√©sultat** :
```javascript
[
  {
    "_id": "Laptop",
    "ventes": [
      { "date": ISODate("2024-01-15"), "montant": 1200, "client": "Alice" },
      { "date": ISODate("2024-02-03"), "montant": 1150, "client": "Bob" }
    ]
  }
]
```

**Exemple 3 : Liste des Noms**

```javascript
db.employes.aggregate([
  {
    $group: {
      _id: "$departement",
      employes: { $push: "$nom" },
      nombreEmployes: { $sum: 1 }
    }
  }
])
```

**Exemple 4 : Historique Chronologique**

```javascript
// Avec tri pr√©alable
db.transactions.aggregate([
  {
    $sort: { date: 1 }  // Important : trier d'abord
  },
  {
    $group: {
      _id: "$compte",
      historique: {
        $push: {
          date: "$date",
          type: "$type",
          montant: "$montant"
        }
      }
    }
  }
])
```

## $addToSet : Tableau de Valeurs Uniques

Comme `$push`, mais **supprime les doublons**.

### Syntaxe

```javascript
{ $addToSet: <expression> }
```

### Exemples

**Exemple 1 : Tags Uniques**

```javascript
// Collection: articles
{ "_id": 1, "auteur": "Alice", "tags": ["mongodb", "nosql"] }
{ "_id": 2, "auteur": "Alice", "tags": ["mongodb", "tutoriel"] }
{ "_id": 3, "auteur": "Alice", "tags": ["nosql", "base-de-donnees"] }
```

```javascript
db.articles.aggregate([
  { $unwind: "$tags" },
  {
    $group: {
      _id: "$auteur",
      tagsUniques: { $addToSet: "$tags" }
    }
  }
])
```

**R√©sultat** :
```javascript
[
  {
    "_id": "Alice",
    "tagsUniques": ["mongodb", "nosql", "tutoriel", "base-de-donnees"]
  }
]
```

**Exemple 2 : Clients Uniques par Produit**

```javascript
db.commandes.aggregate([
  {
    $group: {
      _id: "$produit",
      clientsUniques: { $addToSet: "$client" },
      nombreClientsUniques: { $sum: 1 }
    }
  }
])
```

**Exemple 3 : Cat√©gories Distinctes**

```javascript
db.produits.aggregate([
  {
    $group: {
      _id: "$marque",
      categories: { $addToSet: "$categorie" }
    }
  }
])
```

**Comparaison $push vs $addToSet** :

```javascript
// Donn√©es : ["a", "b", "a", "c", "b"]

// Avec $push
{ valeurs: ["a", "b", "a", "c", "b"] }  // Garde tout

// Avec $addToSet
{ valeurs: ["a", "b", "c"] }  // Valeurs uniques seulement
```

## $first et $last : Premi√®re et Derni√®re Valeur

S√©lectionnent la premi√®re ou derni√®re valeur rencontr√©e dans un groupe.

### Syntaxe

```javascript
{ $first: <expression> }
{ $last: <expression> }
```

‚ö†Ô∏è **IMPORTANT** : L'ordre d√©pend de l'ordre des documents dans le groupe. Utilisez **toujours `$sort`** avant si l'ordre est important.

### Exemples

**Exemple 1 : Premier et Dernier Achat**

```javascript
db.achats.aggregate([
  {
    $sort: { date: 1 }  // CRUCIAL : Trier par date
  },
  {
    $group: {
      _id: "$client",
      premierAchat: { $first: "$produit" },
      dernierAchat: { $last: "$produit" },
      premiereDate: { $first: "$date" },
      derniereDate: { $last: "$date" }
    }
  }
])
```

**R√©sultat** :
```javascript
[
  {
    "_id": "Alice",
    "premierAchat": "Livre",
    "dernierAchat": "Ordinateur",
    "premiereDate": ISODate("2023-01-15"),
    "derniereDate": ISODate("2024-03-10")
  }
]
```

**Exemple 2 : √âtat Initial vs Final**

```javascript
db.modifications.aggregate([
  {
    $sort: { timestamp: 1 }
  },
  {
    $group: {
      _id: "$document_id",
      valeurInitiale: { $first: "$valeur" },
      valeurFinale: { $last: "$valeur" },
      nombreModifications: { $sum: 1 }
    }
  }
])
```

**Exemple 3 : Meilleure et Pire Note**

```javascript
db.evaluations.aggregate([
  {
    $sort: { note: 1 }  // Du plus petit au plus grand
  },
  {
    $group: {
      _id: "$employe",
      pireNote: { $first: "$note" },      // Plus petite
      meilleureNote: { $last: "$note" }   // Plus grande
    }
  }
])
```

**Sans tri pr√©alable (dangereux)** :

```javascript
// ‚ùå MAUVAIS : Ordre al√©atoire
{
  $group: {
    _id: "$client",
    dernierAchat: { $last: "$produit" }  // Al√©atoire !
  }
}

// ‚úÖ BON : Trier d'abord
[
  { $sort: { date: 1 } },
  {
    $group: {
      _id: "$client",
      dernierAchat: { $last: "$produit" }  // Vraiment le dernier
    }
  }
]
```

## $stdDevPop et $stdDevSamp : √âcart-Type

Calculent l'√©cart-type (mesure de dispersion) des valeurs.

### Syntaxe

```javascript
{ $stdDevPop: <expression> }   // √âcart-type population
{ $stdDevSamp: <expression> }  // √âcart-type √©chantillon
```

**Diff√©rence** :
- `$stdDevPop` : Pour une population compl√®te (divise par N)
- `$stdDevSamp` : Pour un √©chantillon (divise par N-1)

### Exemples

**Exemple 1 : Dispersion des Notes**

```javascript
db.examens.aggregate([
  {
    $group: {
      _id: "$classe",
      moyenne: { $avg: "$note" },
      ecartType: { $stdDevPop: "$note" },
      min: { $min: "$note" },
      max: { $max: "$note" }
    }
  }
])
```

**R√©sultat** :
```javascript
[
  {
    "_id": "Classe A",
    "moyenne": 13.5,
    "ecartType": 2.8,  // Notes assez homog√®nes
    "min": 10,
    "max": 18
  },
  {
    "_id": "Classe B",
    "moyenne": 13.2,
    "ecartType": 4.5,  // Notes tr√®s dispers√©es
    "min": 5,
    "max": 20
  }
]
```

**Exemple 2 : Stabilit√© des Prix**

```javascript
db.prix_historique.aggregate([
  {
    $group: {
      _id: "$produit",
      prixMoyen: { $avg: "$prix" },
      volatilite: { $stdDevPop: "$prix" }
    }
  },
  {
    $project: {
      produit: "$_id",
      prixMoyen: { $round: ["$prixMoyen", 2] },
      volatilite: { $round: ["$volatilite", 2] },
      stabilite: {
        $switch: {
          branches: [
            { case: { $lt: ["$volatilite", 5] }, then: "Stable" },
            { case: { $lt: ["$volatilite", 15] }, then: "Mod√©r√©" }
          ],
          default: "Volatile"
        }
      }
    }
  }
])
```

## Cas d'Usage Pratiques

### 1. Dashboard Commercial Complet

```javascript
// Statistiques compl√®tes des ventes par vendeur
db.ventes.aggregate([
  {
    $match: {
      date: {
        $gte: ISODate("2024-01-01"),
        $lt: ISODate("2025-01-01")
      }
    }
  },
  {
    $group: {
      _id: "$vendeur",

      // Compteurs
      nombreVentes: { $sum: 1 },

      // Montants
      chiffreAffaires: { $sum: "$montant" },
      panierMoyen: { $avg: "$montant" },
      venteMini: { $min: "$montant" },
      venteMaxi: { $max: "$montant" },

      // Produits
      produitsVendus: { $push: "$produit" },
      produitsUniques: { $addToSet: "$produit" },

      // Clients
      clientsUniques: { $addToSet: "$client" }
    }
  },
  {
    $project: {
      _id: 0,
      vendeur: "$_id",

      // M√©triques de volume
      nombreVentes: 1,
      nombreProduitsUniques: { $size: "$produitsUniques" },
      nombreClientsUniques: { $size: "$clientsUniques" },

      // M√©triques financi√®res
      chiffreAffaires: { $round: ["$chiffreAffaires", 2] },
      panierMoyen: { $round: ["$panierMoyen", 2] },
      venteMini: 1,
      venteMaxi: 1,

      // Ratios
      caParClient: {
        $round: [
          { $divide: ["$chiffreAffaires", { $size: "$clientsUniques" }] },
          2
        ]
      },

      // Listes
      top5Produits: { $slice: ["$produitsVendus", 5] }
    }
  },
  {
    $sort: { chiffreAffaires: -1 }
  }
])
```

### 2. Analyse de Satisfaction Client

```javascript
// Analyser les notes par produit
db.avis.aggregate([
  {
    $group: {
      _id: "$produit",

      // Statistiques de base
      nombreAvis: { $sum: 1 },
      noteMoyenne: { $avg: "$note" },
      noteMin: { $min: "$note" },
      noteMax: { $max: "$note" },

      // Dispersion
      ecartType: { $stdDevPop: "$note" },

      // Distribution
      notes5Etoiles: {
        $sum: { $cond: [{ $eq: ["$note", 5] }, 1, 0] }
      },
      notes4Etoiles: {
        $sum: { $cond: [{ $eq: ["$note", 4] }, 1, 0] }
      },
      notes3Etoiles: {
        $sum: { $cond: [{ $eq: ["$note", 3] }, 1, 0] }
      },
      notes2Etoiles: {
        $sum: { $cond: [{ $eq: ["$note", 2] }, 1, 0] }
      },
      notes1Etoile: {
        $sum: { $cond: [{ $eq: ["$note", 1] }, 1, 0] }
      },

      // Commentaires
      commentaires: { $push: "$commentaire" }
    }
  },
  {
    $project: {
      _id: 0,
      produit: "$_id",
      nombreAvis: 1,
      noteMoyenne: { $round: ["$noteMoyenne", 1] },
      noteMin: 1,
      noteMax: 1,
      ecartType: { $round: ["$ecartType", 2] },

      // Pourcentages
      pourcentage5: {
        $round: [
          { $multiply: [{ $divide: ["$notes5Etoiles", "$nombreAvis"] }, 100] },
          1
        ]
      },
      pourcentage4: {
        $round: [
          { $multiply: [{ $divide: ["$notes4Etoiles", "$nombreAvis"] }, 100] },
          1
        ]
      },
      pourcentage3: {
        $round: [
          { $multiply: [{ $divide: ["$notes3Etoiles", "$nombreAvis"] }, 100] },
          1
        ]
      },
      pourcentage2: {
        $round: [
          { $multiply: [{ $divide: ["$notes2Etoiles", "$nombreAvis"] }, 100] },
          1
        ]
      },
      pourcentage1: {
        $round: [
          { $multiply: [{ $divide: ["$notes1Etoile", "$nombreAvis"] }, 100] },
          1
        ]
      },

      // √âvaluation globale
      evaluation: {
        $switch: {
          branches: [
            { case: { $gte: ["$noteMoyenne", 4.5] }, then: "Excellent ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê" },
            { case: { $gte: ["$noteMoyenne", 4.0] }, then: "Tr√®s bien ‚≠ê‚≠ê‚≠ê‚≠ê" },
            { case: { $gte: ["$noteMoyenne", 3.5] }, then: "Bien ‚≠ê‚≠ê‚≠ê" },
            { case: { $gte: ["$noteMoyenne", 3.0] }, then: "Moyen ‚≠ê‚≠ê" }
          ],
          default: "√Ä am√©liorer ‚≠ê"
        }
      },

      // Derniers commentaires
      derniers3Commentaires: { $slice: ["$commentaires", -3] }
    }
  },
  {
    $sort: { noteMoyenne: -1 }
  }
])
```

### 3. Analyse de Stock Multi-Entrep√¥ts

```javascript
// Statistiques de stock par produit
db.stock.aggregate([
  {
    $group: {
      _id: "$produit",

      // Localisation
      entrepots: { $addToSet: "$entrepot" },

      // Quantit√©s
      stockTotal: { $sum: "$quantite" },
      stockMin: { $min: "$quantite" },
      stockMax: { $max: "$quantite" },
      stockMoyen: { $avg: "$quantite" },

      // Valeur
      valeurTotale: {
        $sum: { $multiply: ["$quantite", "$prixUnitaire"] }
      },

      // D√©tails par entrep√¥t
      detailsEntrepots: {
        $push: {
          entrepot: "$entrepot",
          quantite: "$quantite",
          dateInventaire: "$dateInventaire"
        }
      }
    }
  },
  {
    $project: {
      _id: 0,
      produit: "$_id",
      nombreEntrepots: { $size: "$entrepots" },
      stockTotal: 1,
      stockMoyen: { $round: ["$stockMoyen", 0] },
      valeurTotale: { $round: ["$valeurTotale", 2] },

      // Alertes
      repartitionEquilibree: {
        $cond: {
          if: { $lte: [{ $subtract: ["$stockMax", "$stockMin"] }, 50] },
          then: "‚úì √âquilibr√©e",
          else: "‚ö†Ô∏è D√©s√©quilibr√©e"
        }
      },

      // Entrep√¥ts
      listeEntrepots: "$entrepots",
      detailsEntrepots: 1
    }
  },
  {
    $sort: { valeurTotale: -1 }
  }
])
```

### 4. Performance Temporelle

```javascript
// Analyser les ventes par p√©riode
db.ventes.aggregate([
  {
    $project: {
      date: 1,
      montant: 1,
      annee: { $year: "$date" },
      mois: { $month: "$date" },
      jourSemaine: { $isoDayOfWeek: "$date" }
    }
  },
  {
    $group: {
      _id: {
        annee: "$annee",
        mois: "$mois"
      },

      // Volume
      nombreVentes: { $sum: 1 },
      chiffreAffaires: { $sum: "$montant" },

      // Statistiques
      panierMoyen: { $avg: "$montant" },
      panierMin: { $min: "$montant" },
      panierMax: { $max: "$montant" },
      ecartType: { $stdDevPop: "$montant" },

      // Par jour de semaine
      ventesLundi: {
        $sum: { $cond: [{ $eq: ["$jourSemaine", 1] }, 1, 0] }
      },
      ventesMardi: {
        $sum: { $cond: [{ $eq: ["$jourSemaine", 2] }, 1, 0] }
      },
      ventesMercredi: {
        $sum: { $cond: [{ $eq: ["$jourSemaine", 3] }, 1, 0] }
      },
      ventesJeudi: {
        $sum: { $cond: [{ $eq: ["$jourSemaine", 4] }, 1, 0] }
      },
      ventesVendredi: {
        $sum: { $cond: [{ $eq: ["$jourSemaine", 5] }, 1, 0] }
      },
      ventesSamedi: {
        $sum: { $cond: [{ $eq: ["$jourSemaine", 6] }, 1, 0] }
      },
      ventesDimanche: {
        $sum: { $cond: [{ $eq: ["$jourSemaine", 7] }, 1, 0] }
      }
    }
  },
  {
    $project: {
      _id: 0,
      periode: {
        $concat: [
          { $toString: "$_id.mois" },
          "/",
          { $toString: "$_id.annee" }
        ]
      },
      nombreVentes: 1,
      chiffreAffaires: { $round: ["$chiffreAffaires", 2] },
      panierMoyen: { $round: ["$panierMoyen", 2] },

      // Jour le plus actif
      jourLePlusActif: {
        $switch: {
          branches: [
            { case: { $eq: [{ $max: ["$ventesLundi", "$ventesMardi", "$ventesMercredi", "$ventesJeudi", "$ventesVendredi", "$ventesSamedi", "$ventesDimanche"] }, "$ventesLundi"] }, then: "Lundi" },
            { case: { $eq: [{ $max: ["$ventesLundi", "$ventesMardi", "$ventesMercredi", "$ventesJeudi", "$ventesVendredi", "$ventesSamedi", "$ventesDimanche"] }, "$ventesMardi"] }, then: "Mardi" }
            // etc...
          ],
          default: "Variable"
        }
      }
    }
  },
  {
    $sort: {
      "_id.annee": 1,
      "_id.mois": 1
    }
  }
])
```

### 5. Cohort Analysis (Analyse de Cohorte)

```javascript
// Analyser les clients par mois d'inscription
db.clients.aggregate([
  {
    $project: {
      client: 1,
      moisInscription: {
        $dateToString: {
          format: "%Y-%m",
          date: "$dateInscription"
        }
      },
      totalAchats: 1,
      dernierAchat: 1
    }
  },
  {
    $group: {
      _id: "$moisInscription",

      // Taille de la cohorte
      nombreClients: { $sum: 1 },

      // Activit√©
      acheteurs: {
        $sum: { $cond: [{ $gt: ["$totalAchats", 0] }, 1, 0] }
      },

      // Montants
      chiffreAffairesTotal: { $sum: "$totalAchats" },
      caParClient: { $avg: "$totalAchats" },

      // Retention
      clientsActifs30j: {
        $sum: {
          $cond: [
            {
              $gte: [
                "$dernierAchat",
                { $subtract: [new Date(), 30 * 24 * 60 * 60 * 1000] }
              ]
            },
            1,
            0
          ]
        }
      }
    }
  },
  {
    $project: {
      _id: 0,
      cohorte: "$_id",
      nombreClients: 1,
      acheteurs: 1,

      // Taux de conversion
      tauxConversion: {
        $round: [
          { $multiply: [{ $divide: ["$acheteurs", "$nombreClients"] }, 100] },
          1
        ]
      },

      // CA
      chiffreAffairesTotal: { $round: ["$chiffreAffairesTotal", 2] },
      caParClient: { $round: ["$caParClient", 2] },

      // R√©tention
      tauxRetention30j: {
        $round: [
          { $multiply: [{ $divide: ["$clientsActifs30j", "$nombreClients"] }, 100] },
          1
        ]
      }
    }
  },
  {
    $sort: { cohorte: -1 }
  }
])
```

## Performances et Optimisations

### 1. Utiliser des Index

Les groupements sont plus rapides si les champs utilis√©s sont index√©s :

```javascript
// Cr√©er un index sur le champ de regroupement
db.commandes.createIndex({ client: 1 })

// Cette agr√©gation b√©n√©ficiera de l'index
db.commandes.aggregate([
  {
    $group: {
      _id: "$client",
      total: { $sum: "$montant" }
    }
  }
])
```

### 2. Filtrer Avant de Grouper

```javascript
// ‚ùå MOINS EFFICACE
db.ventes.aggregate([
  {
    $group: {
      _id: "$produit",
      total: { $sum: "$montant" }
    }
  },
  {
    $match: { total: { $gt: 1000 } }
  }
])

// ‚úÖ MIEUX : Filtrer d'abord si possible
db.ventes.aggregate([
  {
    $match: {
      date: { $gte: ISODate("2024-01-01") }
    }
  },
  {
    $group: {
      _id: "$produit",
      total: { $sum: "$montant" }
    }
  }
])
```

### 3. Limiter l'Utilisation de $push

`$push` peut cr√©er de tr√®s gros tableaux :

```javascript
// ‚ö†Ô∏è ATTENTION : Peut cr√©er des documents > 16 Mo
{
  $group: {
    _id: "$client",
    toutesLesCommandes: { $push: "$$ROOT" }  // Danger !
  }
}

// ‚úÖ MIEUX : Ne pousser que ce qui est n√©cessaire
{
  $group: {
    _id: "$client",
    numeroCommandes: { $push: "$numeroCommande" }
  }
}

// ‚úÖ OU : Utiliser $first/$last avec $sort et $limit
```

### 4. allowDiskUse pour Gros Volumes

```javascript
db.collection.aggregate(
  [
    {
      $group: {
        _id: "$field",
        total: { $sum: "$amount" }
      }
    }
  ],
  { allowDiskUse: true }  // Permet d'utiliser le disque si > 100 Mo
)
```

## Comparaison des Accumulateurs

| Besoin | Accumulateur | Remarque |
|--------|--------------|----------|
| Compter | `$sum: 1` ou `$count: {}` | $sum universel |
| Additionner | `$sum: "$champ"` | Ignore null |
| Moyenne | `$avg: "$champ"` | Ignore null |
| Min/Max | `$min/$max` | Garde null |
| Liste compl√®te | `$push` | Garde doublons |
| Liste unique | `$addToSet` | Supprime doublons |
| Premi√®re valeur | `$first` | Trier avant ! |
| Derni√®re valeur | `$last` | Trier avant ! |
| Dispersion | `$stdDevPop` | Statistiques |

## Points Cl√©s √† Retenir

1. ‚úÖ **Accumulateurs** = op√®rent sur plusieurs documents dans un groupe
2. ‚úÖ **$sum: 1** = compter, **$sum: "$champ"** = additionner
3. ‚úÖ **$avg** ignore les valeurs null
4. ‚úÖ **$push** garde les doublons, **$addToSet** les supprime
5. ‚úÖ **$first/$last** n√©cessitent un tri pr√©alable
6. ‚úÖ **$stdDevPop** mesure la dispersion
7. ‚ö†Ô∏è **Toujours filtrer avant** de grouper quand possible
8. ‚ö†Ô∏è **Attention aux gros tableaux** avec $push
9. üìä **Combiner plusieurs accumulateurs** pour analyses riches
10. ‚ö° **Index sur champs de regroupement** pour meilleures performances

## Conclusion

Les accumulateurs sont des outils **essentiels** pour :

- üìä **Calculer** des statistiques (sommes, moyennes, min/max)
- üî¢ **Compter** les documents par groupe
- üìã **Collecter** des valeurs dans des tableaux
- üéØ **S√©lectionner** les premi√®res/derni√®res valeurs
- üìà **Analyser** la dispersion des donn√©es
- üíº **Cr√©er** des rapports et dashboards

La ma√Ætrise des accumulateurs est fondamentale pour exploiter pleinement le framework d'agr√©gation de MongoDB. Ils permettent de transformer des millions de documents en insights actionables et de cr√©er des analyses complexes directement dans la base de donn√©es.

---


‚è≠Ô∏è [Optimisation des pipelines d'agr√©gation](/06-framework-agregation/06-optimisation-pipelines.md)
