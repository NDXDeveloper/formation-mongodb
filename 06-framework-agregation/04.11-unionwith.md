üîù Retour au [Sommaire](/SOMMAIRE.md)

# 6.4.11 $unionWith

## Introduction

L'√©tape `$unionWith` est un op√©rateur du framework d'agr√©gation MongoDB qui permet de **combiner les documents** de plusieurs collections en un seul flux de r√©sultats. C'est l'√©quivalent de l'op√©rateur SQL **UNION** : il fusionne les r√©sultats de diff√©rentes sources de donn√©es.

### L'Essentiel

- **Union de collections** : Combine les documents de plusieurs collections
- **Ajout vertical** : Empile les documents les uns apr√®s les autres
- **Pipeline optionnel** : Peut transformer les documents avant l'union
- **Pr√©serve les doublons** : Contrairement √† UNION DISTINCT en SQL

### Analogie Simple

Imaginez que vous avez **deux classeurs** de fiches clients :
- **Classeur A** : Clients de Paris (100 fiches)
- **Classeur B** : Clients de Lyon (80 fiches)

Vous voulez **toutes les fiches ensemble** pour faire une analyse globale. Vous prenez toutes les fiches du classeur A, puis toutes celles du classeur B, et vous les **empilez** dans une seule pile.

`$unionWith` fait exactement cela avec vos collections MongoDB : il **combine tous les documents** de plusieurs collections en un seul flux.

---

## Pourquoi Utiliser $unionWith ?

`$unionWith` est essentiel pour :

1. **Combiner des donn√©es similaires** : Collections s√©par√©es par p√©riode, r√©gion, type
2. **Vues unifi√©es** : Agr√©ger des donn√©es fragment√©es
3. **Analyses cross-collection** : Statistiques globales sur plusieurs sources
4. **Migration de donn√©es** : Fusionner des collections lors de refactoring
5. **Rapports consolid√©s** : Combiner des donn√©es de diff√©rentes sources
6. **Recherche multi-collections** : Chercher dans plusieurs collections simultan√©ment

---

## Diff√©rence avec $lookup

### $lookup : Jointure (Enrichissement Horizontal)

```javascript
// $lookup : JOINTURE (ajoute des champs)
// Commandes + informations clients
{
  $lookup: {
    from: "clients",
    localField: "client_id",
    foreignField: "_id",
    as: "client_info"
  }
}
```

**R√©sultat** : Chaque commande est **enrichie** avec les infos du client (largeur augmente).

### $unionWith : Union (Empilement Vertical)

```javascript
// $unionWith : UNION (empile les documents)
// Commandes 2023 + Commandes 2024
{
  $unionWith: {
    coll: "commandes_2024"
  }
}
```

**R√©sultat** : Tous les documents des deux collections sont **combin√©s** (hauteur augmente).

### Sch√©ma Visuel

```
$lookup (JOINTURE - Horizontal)
Collection A          Collection B
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Doc 1   ‚îÇ  +-----> ‚îÇ Info     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ Doc 2   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

R√©sultat : Doc 1 + Info, Doc 2

---

$unionWith (UNION - Vertical)
Collection A          Collection B
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Doc 1   ‚îÇ          ‚îÇ Doc 3    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§          ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Doc 2   ‚îÇ          ‚îÇ Doc 4    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

R√©sultat : Doc 1, Doc 2, Doc 3, Doc 4 (empil√©s)
```

---

## Syntaxe

### Syntaxe Simple

```javascript
{
  $unionWith: "<nom_collection>"
}
```

### Syntaxe Compl√®te

```javascript
{
  $unionWith: {
    coll: "<nom_collection>",
    pipeline: [ <etapes_agregation> ]
  }
}
```

### Param√®tres

| Param√®tre | Description | Type | Obligatoire |
|-----------|-------------|------|-------------|
| `coll` | Nom de la collection √† combiner | String | ‚úÖ Oui |
| `pipeline` | Pipeline d'agr√©gation √† appliquer sur la collection | Array | ‚ùå Non |

---

## Exemple Simple

### Donn√©es de D√©part

```javascript
// Collection : ventes_2023
db.ventes_2023.insertMany([
  { _id: 1, produit: "Laptop", montant: 899, date: ISODate("2023-06-15") },
  { _id: 2, produit: "Souris", montant: 29, date: ISODate("2023-08-20") },
  { _id: 3, produit: "Clavier", montant: 79, date: ISODate("2023-11-10") }
])

// Collection : ventes_2024
db.ventes_2024.insertMany([
  { _id: 4, produit: "√âcran", montant: 349, date: ISODate("2024-01-05") },
  { _id: 5, produit: "Webcam", montant: 89, date: ISODate("2024-02-12") },
  { _id: 6, produit: "Casque", montant: 129, date: ISODate("2024-03-18") }
])
```

### Application de $unionWith

Combinons toutes les ventes :

```javascript
db.ventes_2023.aggregate([
  {
    $unionWith: "ventes_2024"
  }
])
```

### R√©sultat

```json
[
  // Documents de ventes_2023
  { "_id": 1, "produit": "Laptop", "montant": 899, "date": ISODate("2023-06-15") },
  { "_id": 2, "produit": "Souris", "montant": 29, "date": ISODate("2023-08-20") },
  { "_id": 3, "produit": "Clavier", "montant": 79, "date": ISODate("2023-11-10") },

  // Documents de ventes_2024
  { "_id": 4, "produit": "√âcran", "montant": 349, "date": ISODate("2024-01-05") },
  { "_id": 5, "produit": "Webcam", "montant": 89, "date": ISODate("2024-02-12") },
  { "_id": 6, "produit": "Casque", "montant": 129, "date": ISODate("2024-03-18") }
]
```

### Observations

- Les 6 documents sont **combin√©s**
- L'ordre : d'abord ventes_2023, puis ventes_2024
- Aucune transformation, juste une **union simple**

---

## Union avec Pipeline

Vous pouvez **transformer** les documents de la collection cible avant l'union.

### Exemple : Filtrer et Projeter

```javascript
db.ventes_2023.aggregate([
  {
    $unionWith: {
      coll: "ventes_2024",
      pipeline: [
        // Filtrer : seulement les ventes > 100‚Ç¨
        {
          $match: {
            montant: { $gt: 100 }
          }
        },
        // Ajouter un champ
        {
          $addFields: {
            source: "2024"
          }
        }
      ]
    }
  }
])
```

### R√©sultat

```json
[
  // Tous les documents de ventes_2023 (non filtr√©s)
  { "_id": 1, "produit": "Laptop", "montant": 899, "date": ISODate("2023-06-15") },
  { "_id": 2, "produit": "Souris", "montant": 29, "date": ISODate("2023-08-20") },
  { "_id": 3, "produit": "Clavier", "montant": 79, "date": ISODate("2023-11-10") },

  // Documents de ventes_2024 FILTR√âS (montant > 100) avec champ "source"
  { "_id": 4, "produit": "√âcran", "montant": 349, "date": ISODate("2024-01-05"), "source": "2024" },
  { "_id": 6, "produit": "Casque", "montant": 129, "date": ISODate("2024-03-18"), "source": "2024" }
  // Webcam (89‚Ç¨) est EXCLU par le filtre
]
```

**Important** : Le pipeline s'applique **uniquement** aux documents de la collection sp√©cifi√©e dans `$unionWith`, pas √† la collection de d√©part.

---

## Multiples Unions

Vous pouvez combiner **plusieurs collections** en cha√Ænant les `$unionWith`.

### Exemple : Trois Collections

```javascript
// Ventes de 3 ann√©es
db.ventes_2022.insertMany([
  { _id: 101, produit: "Tablet", montant: 299, date: ISODate("2022-03-10") }
])

db.ventes_2023.insertMany([
  { _id: 201, produit: "Laptop", montant: 899, date: ISODate("2023-06-15") }
])

db.ventes_2024.insertMany([
  { _id: 301, produit: "√âcran", montant: 349, date: ISODate("2024-01-05") }
])

// Combiner les 3 ann√©es
db.ventes_2022.aggregate([
  {
    $unionWith: "ventes_2023"
  },
  {
    $unionWith: "ventes_2024"
  }
])
```

### R√©sultat

Tous les documents des 3 collections sont combin√©s dans l'ordre : 2022, puis 2023, puis 2024.

---

## Ordre des Documents

L'ordre des documents dans le r√©sultat est :
1. **Documents de la collection de d√©part** (dans leur ordre naturel)
2. **Documents de la premi√®re collection $unionWith**
3. **Documents de la deuxi√®me collection $unionWith** (si pr√©sente)
4. Et ainsi de suite...

### Trier Apr√®s l'Union

Pour un ordre sp√©cifique, ajoutez `$sort` **apr√®s** les `$unionWith` :

```javascript
db.ventes_2023.aggregate([
  {
    $unionWith: "ventes_2024"
  },
  // Trier par date (tous les documents combin√©s)
  {
    $sort: { date: 1 }
  }
])
```

---

## Gestion des Doublons

`$unionWith` **pr√©serve tous les documents**, y compris les doublons (comme SQL UNION ALL).

### Exemple avec Doublons

```javascript
// Collection A
db.collectionA.insertMany([
  { _id: 1, nom: "Alice", age: 30 },
  { _id: 2, nom: "Bob", age: 25 }
])

// Collection B (avec doublon de Bob)
db.collectionB.insertMany([
  { _id: 2, nom: "Bob", age: 25 },  // M√™me document que dans A
  { _id: 3, nom: "Charlie", age: 35 }
])

// Union
db.collectionA.aggregate([
  {
    $unionWith: "collectionB"
  }
])
```

### R√©sultat

```json
[
  { "_id": 1, "nom": "Alice", "age": 30 },
  { "_id": 2, "nom": "Bob", "age": 25 },
  { "_id": 2, "nom": "Bob", "age": 25 },  // DOUBLON pr√©sent
  { "_id": 3, "nom": "Charlie", "age": 35 }
]
```

### √âliminer les Doublons

Utilisez `$group` pour d√©dupliquer :

```javascript
db.collectionA.aggregate([
  {
    $unionWith: "collectionB"
  },
  // D√©dupliquer par _id
  {
    $group: {
      _id: "$_id",
      doc: { $first: "$$ROOT" }
    }
  },
  {
    $replaceRoot: { newRoot: "$doc" }
  }
])
```

---

## Cas d'Usage Courants

### 1. Combiner des Collections par P√©riode

```javascript
// Ventes de plusieurs ann√©es dans une seule analyse
db.ventes_2022.aggregate([
  // Ajouter l'ann√©e √† la collection de d√©part
  {
    $addFields: {
      annee: 2022
    }
  },
  // Combiner avec 2023
  {
    $unionWith: {
      coll: "ventes_2023",
      pipeline: [
        {
          $addFields: {
            annee: 2023
          }
        }
      ]
    }
  },
  // Combiner avec 2024
  {
    $unionWith: {
      coll: "ventes_2024",
      pipeline: [
        {
          $addFields: {
            annee: 2024
          }
        }
      ]
    }
  },
  // Analyser toutes les ventes
  {
    $group: {
      _id: "$annee",
      total_ventes: { $sum: 1 },
      ca_total: { $sum: "$montant" }
    }
  },
  {
    $sort: { _id: 1 }
  }
])
```

### 2. Recherche Multi-Collections

```javascript
// Chercher "laptop" dans plusieurs catalogues
db.catalogue_europe.aggregate([
  {
    $match: {
      nom: { $regex: /laptop/i }
    }
  },
  {
    $addFields: {
      region: "Europe"
    }
  },
  {
    $unionWith: {
      coll: "catalogue_amerique",
      pipeline: [
        {
          $match: {
            nom: { $regex: /laptop/i }
          }
        },
        {
          $addFields: {
            region: "Am√©rique"
          }
        }
      ]
    }
  },
  {
    $unionWith: {
      coll: "catalogue_asie",
      pipeline: [
        {
          $match: {
            nom: { $regex: /laptop/i }
          }
        },
        {
          $addFields: {
            region: "Asie"
          }
        }
      ]
    }
  }
])
```

### 3. Vue Unifi√©e de Diff√©rents Types

```javascript
// Combiner √©v√©nements de diff√©rents types
db.evenements_utilisateur.aggregate([
  // Connexions
  {
    $match: { type: "connexion" }
  },
  {
    $project: {
      utilisateur_id: 1,
      date: 1,
      type: 1,
      ip: "$adresse_ip"
    }
  },
  // Union avec achats
  {
    $unionWith: {
      coll: "achats",
      pipeline: [
        {
          $project: {
            utilisateur_id: "$client_id",
            date: "$date_achat",
            type: { $literal: "achat" },
            montant: 1
          }
        }
      ]
    }
  },
  // Union avec messages
  {
    $unionWith: {
      coll: "messages",
      pipeline: [
        {
          $project: {
            utilisateur_id: "$expediteur_id",
            date: "$date_envoi",
            type: { $literal: "message" },
            destinataire: "$destinataire_id"
          }
        }
      ]
    }
  },
  // Trier par date
  {
    $sort: { date: -1 }
  }
])
```

### 4. Consolidation de Donn√©es Fragment√©es

```javascript
// Donn√©es clients s√©par√©es par r√©gion
db.clients_paris.aggregate([
  {
    $addFields: {
      ville: "Paris"
    }
  },
  {
    $unionWith: {
      coll: "clients_lyon",
      pipeline: [
        {
          $addFields: {
            ville: "Lyon"
          }
        }
      ]
    }
  },
  {
    $unionWith: {
      coll: "clients_marseille",
      pipeline: [
        {
          $addFields: {
            ville: "Marseille"
          }
        }
      ]
    }
  },
  // Statistiques globales
  {
    $group: {
      _id: "$ville",
      nombre_clients: { $sum: 1 },
      age_moyen: { $avg: "$age" }
    }
  }
])
```

---

## Sch√©mas Structurels Diff√©rents

`$unionWith` fonctionne m√™me si les collections ont des **sch√©mas diff√©rents**.

### Exemple

```javascript
// Collection produits_electronique
db.produits_electronique.insertMany([
  {
    _id: 1,
    nom: "Laptop",
    prix: 899,
    garantie_mois: 24,
    specs: { ram: "16GB", cpu: "i7" }
  }
])

// Collection produits_mobilier (sch√©ma diff√©rent)
db.produits_mobilier.insertMany([
  {
    _id: 2,
    nom: "Bureau",
    prix: 299,
    dimensions: { longueur: 120, largeur: 60, hauteur: 75 },
    materiau: "Bois"
  }
])

// Union
db.produits_electronique.aggregate([
  {
    $unionWith: "produits_mobilier"
  }
])
```

### R√©sultat

```json
[
  {
    "_id": 1,
    "nom": "Laptop",
    "prix": 899,
    "garantie_mois": 24,
    "specs": { "ram": "16GB", "cpu": "i7" }
  },
  {
    "_id": 2,
    "nom": "Bureau",
    "prix": 299,
    "dimensions": { "longueur": 120, "largeur": 60, "hauteur": 75 },
    "materiau": "Bois"
  }
]
```

**Note** : Les champs manquants sont simplement absents (pas de valeur null ajout√©e).

### Normaliser les Sch√©mas avec Pipeline

```javascript
db.produits_electronique.aggregate([
  // Normaliser electronique
  {
    $addFields: {
      categorie: "√âlectronique",
      caracteristiques: "$specs"
    }
  },
  {
    $project: {
      specs: 0
    }
  },
  // Union avec mobilier (normalis√©)
  {
    $unionWith: {
      coll: "produits_mobilier",
      pipeline: [
        {
          $addFields: {
            categorie: "Mobilier",
            caracteristiques: {
              dimensions: "$dimensions",
              materiau: "$materiau"
            }
          }
        },
        {
          $project: {
            dimensions: 0,
            materiau: 0
          }
        }
      ]
    }
  }
])
```

---

## Combinaison avec d'Autres √âtapes

### Exemple : Pipeline Complet

```javascript
db.commandes_en_cours.aggregate([
  // √âtape 1 : Filtrer les commandes urgentes
  {
    $match: {
      priorite: "haute"
    }
  },

  // √âtape 2 : Ajouter un marqueur
  {
    $addFields: {
      statut: "en_cours",
      source_collection: "en_cours"
    }
  },

  // √âtape 3 : Combiner avec commandes termin√©es
  {
    $unionWith: {
      coll: "commandes_terminees",
      pipeline: [
        {
          $match: {
            date_fin: {
              $gte: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)  // 7 derniers jours
            }
          }
        },
        {
          $addFields: {
            statut: "terminee",
            source_collection: "terminees"
          }
        }
      ]
    }
  },

  // √âtape 4 : Enrichir avec infos client
  {
    $lookup: {
      from: "clients",
      localField: "client_id",
      foreignField: "_id",
      as: "client"
    }
  },

  // √âtape 5 : Grouper par statut
  {
    $group: {
      _id: "$statut",
      nombre: { $sum: 1 },
      montant_total: { $sum: "$montant" }
    }
  },

  // √âtape 6 : Trier
  {
    $sort: { montant_total: -1 }
  }
])
```

---

## Performances

### Impact

`$unionWith` peut √™tre **co√ªteux** car :
- Scanne **plusieurs collections**
- Combine potentiellement **beaucoup de documents**
- Pipeline optionnel ex√©cut√© sur chaque collection

### Optimisations

#### 1. Filtrer T√¥t avec $match

```javascript
// ‚úÖ Bon : Filtrer dans le pipeline
db.collection1.aggregate([
  {
    $match: { actif: true }  // Filtrer la collection de d√©part
  },
  {
    $unionWith: {
      coll: "collection2",
      pipeline: [
        {
          $match: { actif: true }  // Filtrer aussi la collection unie
        }
      ]
    }
  }
])
```

#### 2. Projeter T√¥t

```javascript
// R√©duire la taille des documents
db.collection1.aggregate([
  {
    $project: {
      champ1: 1,
      champ2: 1,
      champ3: 1
    }
  },
  {
    $unionWith: {
      coll: "collection2",
      pipeline: [
        {
          $project: {
            champ1: 1,
            champ2: 1,
            champ3: 1
          }
        }
      ]
    }
  }
])
```

#### 3. Indexer les Champs de Filtrage

```javascript
// Cr√©er des index sur les champs utilis√©s dans $match
db.collection1.createIndex({ actif: 1, date: 1 })
db.collection2.createIndex({ actif: 1, date: 1 })
```

#### 4. Limiter les Collections Unies

```javascript
// ‚ùå √âviter : Trop de collections
db.coll1.aggregate([
  { $unionWith: "coll2" },
  { $unionWith: "coll3" },
  { $unionWith: "coll4" },
  { $unionWith: "coll5" },
  { $unionWith: "coll6" },
  { $unionWith: "coll7" }  // Trop !
])

// ‚úÖ Mieux : Consolider d'abord ou limiter le nombre
```

---

## Limitations

### 1. M√™me Base de Donn√©es

`$unionWith` ne peut combiner que des collections de la **m√™me base de donn√©es**.

```javascript
// ‚ùå ERREUR : Collections de bases diff√©rentes
db.collection1.aggregate([
  {
    $unionWith: "autre_db.collection2"  // Ne fonctionne pas
  }
])
```

**Solution** : Utiliser la r√©plication ou copier les donn√©es.

### 2. Collections Shard√©es

`$unionWith` fonctionne avec des collections shard√©es, mais peut √™tre **moins performant**.

### 3. Pas de Garantie d'Ordre

Sans `$sort`, l'ordre des documents n'est **pas garanti** de mani√®re d√©terministe.

### 4. Transactions

`$unionWith` peut √™tre utilis√© dans des transactions, mais avec des **limitations de performance**.

---

## Bonnes Pratiques

### 1. Ajouter des Marqueurs de Source

```javascript
// ‚úÖ Bon : Identifier la source
db.collection1.aggregate([
  {
    $addFields: {
      source: "collection1"
    }
  },
  {
    $unionWith: {
      coll: "collection2",
      pipeline: [
        {
          $addFields: {
            source: "collection2"
          }
        }
      ]
    }
  }
])
```

### 2. Normaliser les Sch√©mas

```javascript
// ‚úÖ Bon : Harmoniser les champs
db.collection1.aggregate([
  {
    $project: {
      id: "$_id",
      nom: 1,
      valeur: "$montant",  // Renommer
      date: "$created_at"
    }
  },
  {
    $unionWith: {
      coll: "collection2",
      pipeline: [
        {
          $project: {
            id: "$_id",
            nom: "$name",      // Harmoniser
            valeur: "$amount",
            date: "$date_creation"
          }
        }
      ]
    }
  }
])
```

### 3. Filtrer Avant d'Unir

```javascript
// ‚úÖ Bon : R√©duire le volume
db.grande_collection1.aggregate([
  {
    $match: { annee: 2024 }
  },
  {
    $unionWith: {
      coll: "grande_collection2",
      pipeline: [
        {
          $match: { annee: 2024 }
        }
      ]
    }
  }
])
```

### 4. Documenter les Unions

```javascript
/**
 * Combine les ventes de 3 ann√©es pour analyse globale
 * Collections : ventes_2022, ventes_2023, ventes_2024
 * Normalisation : Ajout du champ "annee" √† chaque document
 */
db.ventes_2022.aggregate([
  // ...
])
```

---

## Exemple Complet : Syst√®me Multi-R√©gions

```javascript
// Contexte : E-commerce avec 3 bases r√©gionales
// On veut un rapport global des ventes

// Collection Europe
db.ventes_europe.insertMany([
  {
    _id: 1,
    produit: "Laptop",
    montant: 899,
    devise: "EUR",
    date: ISODate("2024-01-15"),
    pays: "France"
  },
  {
    _id: 2,
    produit: "Souris",
    montant: 29,
    devise: "EUR",
    date: ISODate("2024-01-20"),
    pays: "Allemagne"
  }
])

// Collection Am√©rique
db.ventes_amerique.insertMany([
  {
    _id: 3,
    product_name: "Laptop",  // Champ diff√©rent
    amount: 950,
    currency: "USD",
    sale_date: ISODate("2024-01-18"),
    country: "USA"
  }
])

// Collection Asie
db.ventes_asie.insertMany([
  {
    _id: 4,
    nom_produit: "√âcran",  // Champ diff√©rent
    prix: 35000,
    monnaie: "JPY",
    date_vente: ISODate("2024-01-22"),
    pays: "Japon"
  }
])

// Pipeline unifi√© avec normalisation
db.ventes_europe.aggregate([
  // Normaliser Europe
  {
    $addFields: {
      region: "Europe"
    }
  },
  {
    $project: {
      produit: 1,
      montant: 1,
      devise: 1,
      date: 1,
      pays: 1,
      region: 1
    }
  },

  // Union avec Am√©rique (normalisation)
  {
    $unionWith: {
      coll: "ventes_amerique",
      pipeline: [
        {
          $project: {
            produit: "$product_name",
            montant: "$amount",
            devise: "$currency",
            date: "$sale_date",
            pays: "$country",
            region: { $literal: "Am√©rique" }
          }
        }
      ]
    }
  },

  // Union avec Asie (normalisation + conversion)
  {
    $unionWith: {
      coll: "ventes_asie",
      pipeline: [
        {
          $project: {
            produit: "$nom_produit",
            montant: "$prix",
            devise: "$monnaie",
            date: "$date_vente",
            pays: "$pays",
            region: { $literal: "Asie" }
          }
        }
      ]
    }
  },

  // Convertir en EUR (taux simplifi√©s)
  {
    $addFields: {
      montant_eur: {
        $switch: {
          branches: [
            { case: { $eq: ["$devise", "EUR"] }, then: "$montant" },
            { case: { $eq: ["$devise", "USD"] }, then: { $multiply: ["$montant", 0.92] } },
            { case: { $eq: ["$devise", "JPY"] }, then: { $multiply: ["$montant", 0.0062] } }
          ],
          default: "$montant"
        }
      }
    }
  },

  // Analyses globales
  {
    $facet: {
      // Par r√©gion
      "par_region": [
        {
          $group: {
            _id: "$region",
            nombre_ventes: { $sum: 1 },
            ca_eur: { $sum: "$montant_eur" }
          }
        },
        {
          $sort: { ca_eur: -1 }
        }
      ],

      // Par produit
      "par_produit": [
        {
          $group: {
            _id: "$produit",
            nombre_ventes: { $sum: 1 },
            ca_eur: { $sum: "$montant_eur" },
            regions: { $addToSet: "$region" }
          }
        },
        {
          $sort: { ca_eur: -1 }
        }
      ],

      // Par pays (top 5)
      "top_pays": [
        {
          $group: {
            _id: "$pays",
            nombre_ventes: { $sum: 1 },
            ca_eur: { $sum: "$montant_eur" }
          }
        },
        {
          $sort: { ca_eur: -1 }
        },
        {
          $limit: 5
        }
      ],

      // Statistiques globales
      "global": [
        {
          $group: {
            _id: null,
            total_ventes: { $sum: 1 },
            ca_total_eur: { $sum: "$montant_eur" },
            vente_moyenne_eur: { $avg: "$montant_eur" },
            pays_uniques: { $addToSet: "$pays" },
            produits_uniques: { $addToSet: "$produit" }
          }
        },
        {
          $project: {
            _id: 0,
            total_ventes: 1,
            ca_total_eur: { $round: ["$ca_total_eur", 2] },
            vente_moyenne_eur: { $round: ["$vente_moyenne_eur", 2] },
            nombre_pays: { $size: "$pays_uniques" },
            nombre_produits: { $size: "$produits_uniques" }
          }
        }
      ]
    }
  }
])
```

**R√©sultat** :
```json
{
  "par_region": [
    { "_id": "Europe", "nombre_ventes": 2, "ca_eur": 928 },
    { "_id": "Am√©rique", "nombre_ventes": 1, "ca_eur": 874 },
    { "_id": "Asie", "nombre_ventes": 1, "ca_eur": 217 }
  ],
  "par_produit": [
    { "_id": "Laptop", "nombre_ventes": 2, "ca_eur": 1773, "regions": ["Europe", "Am√©rique"] },
    { "_id": "√âcran", "nombre_ventes": 1, "ca_eur": 217, "regions": ["Asie"] },
    { "_id": "Souris", "nombre_ventes": 1, "ca_eur": 29, "regions": ["Europe"] }
  ],
  "top_pays": [
    { "_id": "USA", "nombre_ventes": 1, "ca_eur": 874 },
    { "_id": "France", "nombre_ventes": 1, "ca_eur": 899 },
    { "_id": "Japon", "nombre_ventes": 1, "ca_eur": 217 },
    { "_id": "Allemagne", "nombre_ventes": 1, "ca_eur": 29 }
  ],
  "global": [
    {
      "total_ventes": 4,
      "ca_total_eur": 2019,
      "vente_moyenne_eur": 504.75,
      "nombre_pays": 4,
      "nombre_produits": 3
    }
  ]
}
```

---

## R√©sum√©

### Points Cl√©s

| Aspect | Description |
|--------|-------------|
| **Fonction** | Combine les documents de plusieurs collections |
| **Type d'union** | Verticale (empile les documents) |
| **Syntaxe** | `{ $unionWith: "collection" }` ou avec pipeline |
| **Doublons** | Pr√©serv√©s (comme SQL UNION ALL) |
| **Sch√©mas** | Peuvent √™tre diff√©rents |
| **Ordre** | Collection d√©part, puis collections unies |

### Comparaison $lookup vs $unionWith

| Aspect | $lookup | $unionWith |
|--------|---------|------------|
| **Op√©ration** | JOINTURE | UNION |
| **Direction** | ‚û°Ô∏è Horizontal (enrichit) | ‚¨áÔ∏è Vertical (empile) |
| **R√©sultat** | Documents enrichis | Documents combin√©s |
| **Champs** | Ajoute des champs | Combine des documents |
| **Doublons** | N/A | Pr√©serv√©s |

### Quand Utiliser $unionWith

‚úÖ **Utilisez $unionWith** pour :
- Combiner des **collections par p√©riode** (ann√©es, mois)
- **Recherche multi-collections**
- **Vues unifi√©es** de donn√©es fragment√©es
- **Rapports consolid√©s** multi-sources
- **Analyses cross-collection**
- Combiner des donn√©es de **m√™me type** mais s√©par√©es

‚ùå **N'utilisez PAS $unionWith** pour :
- **Enrichir** des documents ‚Üí Utilisez `$lookup`
- **Jointures** classiques ‚Üí Utilisez `$lookup`
- Collections de **bases diff√©rentes** ‚Üí Pas support√©

---

## Conclusion

`$unionWith` est un outil **puissant** pour combiner les documents de plusieurs collections dans MongoDB. Il est particuli√®rement utile quand vos donn√©es sont fragment√©es par p√©riode, r√©gion, ou type, et que vous voulez les analyser ensemble.

### √Ä Retenir

1. **$unionWith** **empile** les documents de plusieurs collections
2. C'est une **union verticale**, pas une jointure horizontale
3. Les **doublons sont pr√©serv√©s** (UNION ALL)
4. Peut avoir un **pipeline optionnel** pour transformer les donn√©es
5. Fonctionne m√™me avec des **sch√©mas diff√©rents**
6. **Filtrez t√¥t** pour de meilleures performances
7. **Normalisez** les sch√©mas pour faciliter l'analyse
8. Id√©al pour les **donn√©es fragment√©es**

### Prochaines √âtapes

Vous avez maintenant compl√©t√© tous les op√©rateurs avanc√©s du framework d'agr√©gation ! Dans les sections suivantes, vous pourrez explorer :
- **Optimisation des pipelines** : Techniques avanc√©es de performance
- **Patterns d'agr√©gation** : Cas d'usage avanc√©s et best practices
- **Agr√©gations temps r√©el** : Change streams et pipelines r√©actifs

---

**üìö R√©f√©rences**

- [Documentation officielle $unionWith](https://www.mongodb.com/docs/manual/reference/operator/aggregation/unionWith/)
- [Aggregation Pipeline](https://www.mongodb.com/docs/manual/core/aggregation-pipeline/)
- [SQL vs MongoDB Aggregation](https://www.mongodb.com/docs/manual/reference/sql-aggregation-comparison/)
- [Aggregation Pipeline Optimization](https://www.mongodb.com/docs/manual/core/aggregation-pipeline-optimization/)

‚è≠Ô∏è [Op√©rateurs d'agr√©gation](/06-framework-agregation/05-operateurs-agregation.md)
