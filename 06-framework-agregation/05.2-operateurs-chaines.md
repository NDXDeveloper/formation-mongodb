üîù Retour au [Sommaire](/SOMMAIRE.md)

# 6.5.2 Op√©rateurs de Cha√Ænes - Manipulation de Texte

## Introduction

Les op√©rateurs de cha√Ænes permettent de **manipuler du texte** dans vos pipelines d'agr√©gation MongoDB. Ils vous donnent la possibilit√© de transformer, extraire, combiner et analyser des donn√©es textuelles directement dans vos requ√™tes.

Pensez aux op√©rateurs de cha√Ænes comme √† une **bo√Æte √† outils textuelle** qui vous permet de traiter du texte sans avoir √† extraire les donn√©es et les manipuler dans votre application.

## √Ä Quoi Servent les Op√©rateurs de Cha√Ænes ?

### 1. **Formatage de Donn√©es**
Cr√©er des noms complets, formater des adresses, combiner des informations.

### 2. **Nettoyage de Donn√©es**
Supprimer des espaces, normaliser la casse, uniformiser les formats.

### 3. **Extraction d'Information**
Extraire des codes postaux, des domaines d'email, des sous-cha√Ænes sp√©cifiques.

### 4. **Recherche et Comparaison**
Trouver des positions, comparer des textes, v√©rifier des patterns.

## Liste des Op√©rateurs de Cha√Ænes

MongoDB offre une riche biblioth√®que d'op√©rateurs de cha√Ænes :

### Op√©rateurs de Base

| Op√©rateur | Description | Exemple |
|-----------|-------------|---------|
| `$concat` | Concat√®ne des cha√Ænes | `{ $concat: ["Bon", "jour"] }` ‚Üí "Bonjour" |
| `$toLower` | Convertit en minuscules | `{ $toLower: "HELLO" }` ‚Üí "hello" |
| `$toUpper` | Convertit en majuscules | `{ $toUpper: "hello" }` ‚Üí "HELLO" |
| `$substr` | Extrait une sous-cha√Æne | `{ $substr: ["MongoDB", 0, 5] }` ‚Üí "Mongo" |
| `$substrCP` | Extrait (UTF-8 safe) | `{ $substrCP: ["h√©llo", 0, 2] }` ‚Üí "h√©" |

### Op√©rateurs de Recherche

| Op√©rateur | Description | Exemple |
|-----------|-------------|---------|
| `$indexOfBytes` | Position d'une sous-cha√Æne | `{ $indexOfBytes: ["hello", "ll"] }` ‚Üí 2 |
| `$indexOfCP` | Position (UTF-8 safe) | `{ $indexOfCP: ["hello", "o"] }` ‚Üí 4 |
| `$strcasecmp` | Compare deux cha√Ænes | `{ $strcasecmp: ["A", "a"] }` ‚Üí 0 |

### Op√©rateurs de Longueur

| Op√©rateur | Description | Exemple |
|-----------|-------------|---------|
| `$strLenBytes` | Longueur en octets | `{ $strLenBytes: "hello" }` ‚Üí 5 |
| `$strLenCP` | Longueur en caract√®res | `{ $strLenCP: "h√©llo" }` ‚Üí 5 |

### Op√©rateurs de Nettoyage

| Op√©rateur | Description | Exemple |
|-----------|-------------|---------|
| `$trim` | Supprime espaces d√©but/fin | `{ $trim: { input: "  hi  " } }` ‚Üí "hi" |
| `$ltrim` | Supprime espaces √† gauche | `{ $ltrim: { input: "  hi" } }` ‚Üí "hi" |
| `$rtrim` | Supprime espaces √† droite | `{ $rtrim: { input: "hi  " } }` ‚Üí "hi" |

### Op√©rateurs Avanc√©s

| Op√©rateur | Description | Exemple |
|-----------|-------------|---------|
| `$split` | Divise une cha√Æne | `{ $split: ["a-b-c", "-"] }` ‚Üí ["a","b","c"] |
| `$replaceOne` | Remplace 1√®re occurrence | `{ $replaceOne: {input:"hi hi", find:"hi", replacement:"hello"} }` |
| `$replaceAll` | Remplace toutes | `{ $replaceAll: {input:"hi hi", find:"hi", replacement:"hello"} }` |

## Op√©rateurs de Base en D√©tail

### $concat : Concat√©nation

L'op√©rateur `$concat` combine plusieurs cha√Ænes en une seule.

**Syntaxe** :
```javascript
{ $concat: [<cha√Æne1>, <cha√Æne2>, ...] }
```

**Exemple 1 : Cr√©er un Nom Complet**

```javascript
// Collection: employes
{ "_id": 1, "prenom": "Marie", "nom": "Dupont" }
```

```javascript
db.employes.aggregate([
  {
    $project: {
      nomComplet: {
        $concat: ["$prenom", " ", "$nom"]
      }
    }
  }
])
```

**R√©sultat** :
```javascript
{
  "_id": 1,
  "nomComplet": "Marie Dupont"
}
```

**Exemple 2 : Formater une Adresse**

```javascript
// Collection: utilisateurs
{
  "_id": 1,
  "numero": "123",
  "rue": "Avenue des Champs",
  "ville": "Paris",
  "codePostal": "75008"
}
```

```javascript
db.utilisateurs.aggregate([
  {
    $project: {
      adresseComplete: {
        $concat: [
          "$numero",
          " ",
          "$rue",
          ", ",
          "$codePostal",
          " ",
          "$ville"
        ]
      }
    }
  }
])
```

**R√©sultat** :
```javascript
{
  "_id": 1,
  "adresseComplete": "123 Avenue des Champs, 75008 Paris"
}
```

**Exemple 3 : Cr√©er un Identifiant**

```javascript
// Cr√©er un code produit : CAT-ID-NOM
{
  $project: {
    codeProduit: {
      $concat: [
        { $toUpper: "$categorie" },
        "-",
        { $toString: "$_id" },
        "-",
        { $replaceAll: {
          input: { $toUpper: "$nom" },
          find: " ",
          replacement: "-"
        }}
      ]
    }
  }
}
// R√©sultat : "ELECTRONIQUE-123-ORDINATEUR-PORTABLE"
```

‚ö†Ô∏è **Important** : Si une des valeurs est `null`, le r√©sultat sera `null` :

```javascript
{ $concat: ["Hello", null, "World"] }  // ‚Üí null
```

**Solution** : Utiliser `$ifNull` :

```javascript
{
  $concat: [
    "$prenom",
    " ",
    { $ifNull: ["$nomMilieu", ""] },
    " ",
    "$nom"
  ]
}
```

### $toLower et $toUpper : Conversion de Casse

Ces op√©rateurs convertissent une cha√Æne en minuscules ou majuscules.

**Syntaxe** :
```javascript
{ $toLower: <cha√Æne> }
{ $toUpper: <cha√Æne> }
```

**Exemple 1 : Normalisation d'Email**

```javascript
db.utilisateurs.aggregate([
  {
    $project: {
      nom: 1,
      email: 1,
      emailNormalise: { $toLower: "$email" }
    }
  }
])
```

**R√©sultat** :
```javascript
{
  "_id": 1,
  "nom": "Dupont",
  "email": "Marie.Dupont@Example.COM",
  "emailNormalise": "marie.dupont@example.com"
}
```

**Exemple 2 : Initiales en Majuscules**

```javascript
{
  $project: {
    initiales: {
      $concat: [
        { $toUpper: { $substrCP: ["$prenom", 0, 1] } },
        ".",
        { $toUpper: { $substrCP: ["$nom", 0, 1] } },
        "."
      ]
    }
  }
}
// Marie Dupont ‚Üí "M.D."
```

**Exemple 3 : Codes Produits en Majuscules**

```javascript
{
  $project: {
    nom: 1,
    codeNormalise: { $toUpper: "$code" }
  }
}
```

**Cas d'usage** :
- Normalisation pour comparaisons insensibles √† la casse
- Formatage d'identifiants
- Nettoyage de donn√©es

### $substr et $substrCP : Extraction de Sous-cha√Ænes

Ces op√©rateurs extraient une partie d'une cha√Æne.

**Syntaxe** :
```javascript
{ $substr: [<cha√Æne>, <position>, <longueur>] }
{ $substrCP: [<cha√Æne>, <position>, <longueur>] }
```

**Diff√©rence** :
- `$substr` : Compte en **octets** (peut mal g√©rer les caract√®res accentu√©s)
- `$substrCP` : Compte en **points de code Unicode** (recommand√©)

**Exemple 1 : Extraire un Code Postal**

```javascript
// Extraire les 5 premiers caract√®res
{
  $project: {
    ville: 1,
    codePostal: { $substrCP: ["$adresse", 0, 5] }
  }
}
```

**Exemple 2 : Tronquer un Texte**

```javascript
// Cr√©er un extrait de 100 caract√®res
{
  $project: {
    titre: 1,
    extrait: {
      $concat: [
        { $substrCP: ["$contenu", 0, 100] },
        "..."
      ]
    }
  }
}
```

**Exemple 3 : Extraire une Extension de Fichier**

```javascript
// Extension = 3 derniers caract√®res
{
  $project: {
    nomFichier: 1,
    extension: {
      $substrCP: [
        "$nomFichier",
        { $subtract: [{ $strLenCP: "$nomFichier" }, 3] },
        3
      ]
    }
  }
}
// "document.pdf" ‚Üí "pdf"
```

**Utiliser -1 pour "jusqu'√† la fin"** :

```javascript
// Extraire du caract√®re 10 jusqu'√† la fin
{ $substrCP: ["$texte", 10, -1] }
```

### $strLenCP et $strLenBytes : Longueur de Cha√Æne

Ces op√©rateurs retournent la longueur d'une cha√Æne.

**Syntaxe** :
```javascript
{ $strLenCP: <cha√Æne> }      // Points de code (caract√®res)
{ $strLenBytes: <cha√Æne> }   // Octets
```

**Exemple 1 : Compter les Caract√®res**

```javascript
{
  $project: {
    texte: 1,
    nombreCaracteres: { $strLenCP: "$texte" }
  }
}
```

**R√©sultat** :
```javascript
{ "texte": "Bonjour", "nombreCaracteres": 7 }
{ "texte": "h√©llo", "nombreCaracteres": 5 }
```

**Exemple 2 : Filtrer par Longueur**

```javascript
// Ne garder que les descriptions de plus de 50 caract√®res
db.produits.aggregate([
  {
    $match: {
      $expr: {
        $gt: [{ $strLenCP: "$description" }, 50]
      }
    }
  }
])
```

**Exemple 3 : Validation de Mot de Passe**

```javascript
{
  $project: {
    email: 1,
    motDePasseValide: {
      $gte: [{ $strLenCP: "$motDePasse" }, 8]
    }
  }
}
```

**Diff√©rence strLenCP vs strLenBytes** :

```javascript
// "√©" en UTF-8 = 2 octets
{ $strLenCP: "caf√©" }      // ‚Üí 4 (4 caract√®res)
{ $strLenBytes: "caf√©" }   // ‚Üí 5 (5 octets : c-a-f-√©[2 octets])
```

**Recommandation** : Utilisez toujours `$strLenCP` pour compter les caract√®res.

## Op√©rateurs de Recherche

### $indexOfCP : Trouver la Position

L'op√©rateur `$indexOfCP` trouve la position d'une sous-cha√Æne.

**Syntaxe** :
```javascript
{ $indexOfCP: [<cha√Æne>, <recherche>, <debut>, <fin>] }
```

- `debut` et `fin` sont optionnels
- Retourne `-1` si non trouv√©
- Position commence √† 0

**Exemple 1 : Trouver le @**

```javascript
{
  $project: {
    email: 1,
    positionArobase: { $indexOfCP: ["$email", "@"] }
  }
}
```

**R√©sultat** :
```javascript
{ "email": "marie@example.com", "positionArobase": 5 }
```

**Exemple 2 : Extraire le Nom de Domaine**

```javascript
{
  $project: {
    email: 1,
    domaine: {
      $substrCP: [
        "$email",
        { $add: [{ $indexOfCP: ["$email", "@"] }, 1] },
        -1
      ]
    }
  }
}
// "marie@example.com" ‚Üí "example.com"
```

**Exemple 3 : V√©rifier si une Cha√Æne Contient**

```javascript
{
  $project: {
    description: 1,
    contientMongoDB: {
      $gte: [{ $indexOfCP: ["$description", "MongoDB"] }, 0]
    }
  }
}
// true si "MongoDB" est pr√©sent, false sinon
```

**Exemple 4 : Recherche dans une Plage**

```javascript
// Chercher "test" entre les positions 10 et 50
{
  $indexOfCP: ["$texte", "test", 10, 50]
}
```

### $strcasecmp : Comparer des Cha√Ænes

Compare deux cha√Ænes de mani√®re insensible √† la casse.

**Syntaxe** :
```javascript
{ $strcasecmp: [<cha√Æne1>, <cha√Æne2>] }
```

**R√©sultat** :
- `0` : Les cha√Ænes sont √©gales (ignorant la casse)
- `1` : cha√Æne1 > cha√Æne2
- `-1` : cha√Æne1 < cha√Æne2

**Exemple** :

```javascript
{
  $project: {
    comparaison: { $strcasecmp: ["$valeur1", "$valeur2"] }
  }
}
```

**R√©sultat** :
```javascript
{ $strcasecmp: ["hello", "HELLO"] }   // ‚Üí 0 (√©gales)
{ $strcasecmp: ["apple", "banana"] }  // ‚Üí -1 (apple < banana)
{ $strcasecmp: ["zebra", "apple"] }   // ‚Üí 1 (zebra > apple)
```

**Cas d'usage** : Tri ou filtrage insensible √† la casse :

```javascript
{
  $match: {
    $expr: {
      $eq: [{ $strcasecmp: ["$code", "ABC123"] }, 0]
    }
  }
}
// Correspond √† "abc123", "ABC123", "AbC123", etc.
```

## Op√©rateurs de Nettoyage

### $trim, $ltrim, $rtrim : Supprimer les Espaces

Ces op√©rateurs suppriment les espaces blancs.

**Syntaxe** :
```javascript
{ $trim: { input: <cha√Æne>, chars: <caract√®res_optionnels> } }
{ $ltrim: { input: <cha√Æne>, chars: <caract√®res_optionnels> } }
{ $rtrim: { input: <cha√Æne>, chars: <caract√®res_optionnels> } }
```

- `$trim` : Supprime au d√©but ET √† la fin
- `$ltrim` : Supprime √† gauche (Left)
- `$rtrim` : Supprime √† droite (Right)
- `chars` : Caract√®res √† supprimer (par d√©faut : espaces)

**Exemple 1 : Nettoyer des Donn√©es d'Entr√©e**

```javascript
db.utilisateurs.aggregate([
  {
    $project: {
      nomOriginal: "$nom",
      nomNettoye: { $trim: { input: "$nom" } }
    }
  }
])
```

**R√©sultat** :
```javascript
{
  "nomOriginal": "  Dupont  ",
  "nomNettoye": "Dupont"
}
```

**Exemple 2 : Supprimer des Caract√®res Sp√©cifiques**

```javascript
// Supprimer les tirets au d√©but et √† la fin
{
  $project: {
    code: { $trim: { input: "$code", chars: "-" } }
  }
}
// "---ABC---" ‚Üí "ABC"
```

**Exemple 3 : Nettoyer un CSV**

```javascript
// Donn√©es import√©es avec espaces parasites
{
  $project: {
    champ1: { $trim: { input: "$raw_champ1" } },
    champ2: { $trim: { input: "$raw_champ2" } },
    champ3: { $trim: { input: "$raw_champ3" } }
  }
}
```

**Exemple 4 : ltrim et rtrim**

```javascript
{
  $project: {
    gauche: { $ltrim: { input: "  hello  " } },    // ‚Üí "hello  "
    droite: { $rtrim: { input: "  hello  " } },    // ‚Üí "  hello"
    complet: { $trim: { input: "  hello  " } }     // ‚Üí "hello"
  }
}
```

## Op√©rateurs Avanc√©s

### $split : Diviser une Cha√Æne

L'op√©rateur `$split` divise une cha√Æne en tableau.

**Syntaxe** :
```javascript
{ $split: [<cha√Æne>, <d√©limiteur>] }
```

**Exemple 1 : Diviser un Nom Complet**

```javascript
{
  $project: {
    nomComplet: 1,
    parties: { $split: ["$nomComplet", " "] }
  }
}
```

**R√©sultat** :
```javascript
{
  "nomComplet": "Marie Anne Dupont",
  "parties": ["Marie", "Anne", "Dupont"]
}
```

**Exemple 2 : Extraire le Pr√©nom**

```javascript
{
  $project: {
    nomComplet: 1,
    prenom: {
      $arrayElemAt: [{ $split: ["$nomComplet", " "] }, 0]
    }
  }
}
// "Marie Dupont" ‚Üí "Marie"
```

**Exemple 3 : Diviser un Chemin de Fichier**

```javascript
{
  $project: {
    chemin: "/usr/local/bin/app.js",
    segments: { $split: ["$chemin", "/"] }
  }
}
// R√©sultat : ["", "usr", "local", "bin", "app.js"]
```

**Exemple 4 : Parsing de Tags**

```javascript
// Tags s√©par√©s par des virgules
{
  $project: {
    tagsString: "javascript,nodejs,mongodb",
    tagsArray: {
      $map: {
        input: { $split: ["$tagsString", ","] },
        as: "tag",
        in: { $trim: { input: "$$tag" } }  // Nettoyer les espaces
      }
    }
  }
}
```

### $replaceOne et $replaceAll : Remplacer du Texte

Ces op√©rateurs remplacent du texte dans une cha√Æne.

**Syntaxe** :
```javascript
{
  $replaceOne: {
    input: <cha√Æne>,
    find: <recherche>,
    replacement: <remplacement>
  }
}

{
  $replaceAll: {
    input: <cha√Æne>,
    find: <recherche>,
    replacement: <remplacement>
  }
}
```

**Diff√©rence** :
- `$replaceOne` : Remplace la **premi√®re** occurrence
- `$replaceAll` : Remplace **toutes** les occurrences

**Exemple 1 : Normaliser des S√©parateurs**

```javascript
{
  $project: {
    date: "2024-03-15",
    dateNormalisee: {
      $replaceAll: {
        input: "$date",
        find: "-",
        replacement: "/"
      }
    }
  }
}
// "2024-03-15" ‚Üí "2024/03/15"
```

**Exemple 2 : Masquer des Informations Sensibles**

```javascript
{
  $project: {
    numeroCartePartiel: {
      $concat: [
        { $replaceAll: {
          input: { $substrCP: ["$numeroCarte", 0, 12] },
          find: { $regexFind: { input: "$numeroCarte", regex: "." } },
          replacement: "*"
        }},
        { $substrCP: ["$numeroCarte", 12, -1] }
      ]
    }
  }
}
```

**Exemple 3 : Nettoyer des Espaces Multiples**

```javascript
// Remplacer espaces multiples par un seul
{
  $project: {
    texteNettoye: {
      $trim: {
        input: {
          $replaceAll: {
            input: "$texte",
            find: "  ",
            replacement: " "
          }
        }
      }
    }
  }
}
```

**Exemple 4 : Diff√©rence replaceOne vs replaceAll**

```javascript
{
  $project: {
    original: "hello hello hello",
    replaceOne: {
      $replaceOne: {
        input: "hello hello hello",
        find: "hello",
        replacement: "hi"
      }
    },
    replaceAll: {
      $replaceAll: {
        input: "hello hello hello",
        find: "hello",
        replacement: "hi"
      }
    }
  }
}
```

**R√©sultat** :
```javascript
{
  "original": "hello hello hello",
  "replaceOne": "hi hello hello",      // Premi√®re occurrence seulement
  "replaceAll": "hi hi hi"             // Toutes les occurrences
}
```

## Combinaison d'Op√©rateurs

Les op√©rateurs de cha√Ænes sont particuli√®rement puissants quand on les combine.

### Exemple 1 : Formater un Nom (Pr√©nom en minuscule sauf 1√®re lettre)

```javascript
{
  $project: {
    prenomOriginal: "$prenom",
    prenomFormate: {
      $concat: [
        { $toUpper: { $substrCP: ["$prenom", 0, 1] } },
        { $toLower: { $substrCP: ["$prenom", 1, -1] } }
      ]
    }
  }
}
// "MARIE" ‚Üí "Marie"
// "marie" ‚Üí "Marie"
// "mARIE" ‚Üí "Marie"
```

### Exemple 2 : Extraire le Pr√©nom et Nom depuis un Email

```javascript
{
  $project: {
    email: "marie.dupont@example.com",

    // Partie avant le @
    partieLocale: {
      $substrCP: [
        "$email",
        0,
        { $indexOfCP: ["$email", "@"] }
      ]
    },

    // Diviser par le point
    parties: {
      $split: [
        {
          $substrCP: [
            "$email",
            0,
            { $indexOfCP: ["$email", "@"] }
          ]
        },
        "."
      ]
    },

    // Formater
    prenom: {
      $concat: [
        {
          $toUpper: {
            $substrCP: [
              { $arrayElemAt: [
                { $split: [
                  { $substrCP: ["$email", 0, { $indexOfCP: ["$email", "@"] }] },
                  "."
                ]},
                0
              ]},
              0,
              1
            ]
          }
        },
        {
          $toLower: {
            $substrCP: [
              { $arrayElemAt: [
                { $split: [
                  { $substrCP: ["$email", 0, { $indexOfCP: ["$email", "@"] }] },
                  "."
                ]},
                0
              ]},
              1,
              -1
            ]
          }
        }
      ]
    }
  }
}
// "marie.dupont@example.com" ‚Üí "Marie"
```

### Exemple 3 : G√©n√©rer un Slug URL

```javascript
{
  $project: {
    titre: "Mon Article Super Cool !",
    slug: {
      $toLower: {
        $replaceAll: {
          input: {
            $replaceAll: {
              input: {
                $trim: { input: "$titre" }
              },
              find: " ",
              replacement: "-"
            }
          },
          find: "!",
          replacement: ""
        }
      }
    }
  }
}
// "Mon Article Super Cool !" ‚Üí "mon-article-super-cool"
```

### Exemple 4 : Masquer Partiellement un Email

```javascript
{
  $project: {
    email: 1,
    emailMasque: {
      $concat: [
        { $substrCP: ["$email", 0, 2] },    // 2 premiers caract√®res
        "***",
        {
          $substrCP: [
            "$email",
            { $indexOfCP: ["$email", "@"] },
            -1
          ]
        }
      ]
    }
  }
}
// "marie.dupont@example.com" ‚Üí "ma***@example.com"
```

## Cas d'Usage Pratiques

### 1. Nettoyage de Donn√©es Import√©es

```javascript
db.donneesBrutes.aggregate([
  {
    $project: {
      // Nettoyer et normaliser
      nom: {
        $trim: {
          input: {
            $toUpper: {
              $replaceAll: {
                input: "$nom_raw",
                find: "  ",
                replacement: " "
              }
            }
          }
        }
      },

      email: { $toLower: { $trim: { input: "$email_raw" } } },

      telephone: {
        $replaceAll: {
          input: { $trim: { input: "$telephone_raw" } },
          find: " ",
          replacement: ""
        }
      }
    }
  }
])
```

### 2. G√©n√©ration de Codes et Identifiants

```javascript
db.produits.aggregate([
  {
    $project: {
      nom: 1,
      categorie: 1,

      // Code produit : CAT-YYYY-XXX
      codeProduit: {
        $concat: [
          { $toUpper: { $substrCP: ["$categorie", 0, 3] } },
          "-",
          { $toString: { $year: new Date() } },
          "-",
          {
            $replaceAll: {
              input: {
                $toUpper: {
                  $substrCP: ["$nom", 0, 10]
                }
              },
              find: " ",
              replacement: "-"
            }
          }
        ]
      }
    }
  }
])
```

### 3. Extraction d'Information Structur√©e

```javascript
// Extraire ville et code postal depuis une adresse
db.adresses.aggregate([
  {
    $project: {
      adresseComplete: "123 Rue de Paris, 75001 Paris",

      // Trouver la derni√®re virgule
      positionVirgule: {
        $indexOfCP: ["$adresseComplete", ","]
      },

      // Extraire apr√®s la virgule
      villeCodePostal: {
        $trim: {
          input: {
            $substrCP: [
              "$adresseComplete",
              { $add: [{ $indexOfCP: ["$adresseComplete", ","] }, 1] },
              -1
            ]
          }
        }
      },

      // Extraire le code postal (5 premiers caract√®res)
      codePostal: {
        $substrCP: [
          {
            $trim: {
              input: {
                $substrCP: [
                  "$adresseComplete",
                  { $add: [{ $indexOfCP: ["$adresseComplete", ","] }, 1] },
                  -1
                ]
              }
            }
          },
          0,
          5
        ]
      },

      // Ville (apr√®s le code postal)
      ville: {
        $trim: {
          input: {
            $substrCP: [
              {
                $trim: {
                  input: {
                    $substrCP: [
                      "$adresseComplete",
                      { $add: [{ $indexOfCP: ["$adresseComplete", ","] }, 1] },
                      -1
                    ]
                  }
                }
              },
              6,
              -1
            ]
          }
        }
      }
    }
  }
])
```

### 4. Analyse de Contenu

```javascript
// Analyser des URLs
db.visiteurs.aggregate([
  {
    $project: {
      url: 1,

      // Extraire le domaine
      domaine: {
        $let: {
          vars: {
            sansProt: {
              $substrCP: [
                "$url",
                { $add: [{ $indexOfCP: ["$url", "://"] }, 3] },
                -1
              ]
            }
          },
          in: {
            $substrCP: [
              "$$sansProt",
              0,
              { $indexOfCP: ["$$sansProt", "/"] }
            ]
          }
        }
      },

      // Compter les segments de chemin
      nombreSegments: {
        $size: {
          $split: [
            {
              $substrCP: [
                "$url",
                { $indexOfCP: ["$url", "/", 8] },
                -1
              ]
            },
            "/"
          ]
        }
      }
    }
  }
])
```

### 5. Validation et V√©rification

```javascript
db.utilisateurs.aggregate([
  {
    $project: {
      email: 1,

      // V√©rifier format email basique
      emailValide: {
        $and: [
          // Contient un @
          { $gte: [{ $indexOfCP: ["$email", "@"] }, 0] },
          // @ n'est pas au d√©but
          { $gt: [{ $indexOfCP: ["$email", "@"] }, 0] },
          // Contient un . apr√®s le @
          {
            $gte: [
              {
                $indexOfCP: [
                  "$email",
                  ".",
                  { $indexOfCP: ["$email", "@"] }
                ]
              },
              0
            ]
          }
        ]
      },

      // Longueur du mot de passe OK
      motDePasseOK: {
        $gte: [{ $strLenCP: "$motDePasse" }, 8]
      }
    }
  }
])
```

## Gestion des Valeurs null et Manquantes

Les op√©rateurs de cha√Ænes retournent `null` si l'entr√©e est `null` :

```javascript
{ $concat: ["Hello", null] }           // ‚Üí null
{ $toUpper: null }                     // ‚Üí null
{ $substrCP: [null, 0, 5] }           // ‚Üí null
```

**Solution** : Utiliser `$ifNull` :

```javascript
{
  $project: {
    nomComplet: {
      $concat: [
        { $ifNull: ["$prenom", ""] },
        " ",
        { $ifNull: ["$nom", "ANONYME"] }
      ]
    }
  }
}
```

**Ou utiliser $cond** :

```javascript
{
  $project: {
    description: {
      $cond: {
        if: { $ne: ["$description", null] },
        then: { $toLower: "$description" },
        else: "Pas de description"
      }
    }
  }
}
```

## Performances et Optimisations

### 1. Op√©rations sur Cha√Ænes sont Co√ªteuses

Les manipulations de cha√Ænes sont plus lentes que les op√©rations num√©riques :

```javascript
// ‚ùå MOINS EFFICACE : Manipulation sur tous les documents
db.produits.aggregate([
  {
    $project: {
      nomFormate: {
        $concat: [
          { $toUpper: { $substrCP: ["$nom", 0, 1] } },
          { $toLower: { $substrCP: ["$nom", 1, -1] } }
        ]
      }
    }
  },
  {
    $match: { categorie: "√âlectronique" }
  }
])

// ‚úÖ MIEUX : Filtrer d'abord
db.produits.aggregate([
  {
    $match: { categorie: "√âlectronique" }
  },
  {
    $project: {
      nomFormate: {
        $concat: [
          { $toUpper: { $substrCP: ["$nom", 0, 1] } },
          { $toLower: { $substrCP: ["$nom", 1, -1] } }
        ]
      }
    }
  }
])
```

### 2. √âviter les Calculs R√©p√©t√©s

```javascript
// ‚ùå Calcule $indexOfCP trois fois
{
  $project: {
    partie1: {
      $substrCP: ["$texte", 0, { $indexOfCP: ["$texte", "-"] }]
    },
    partie2: {
      $substrCP: [
        "$texte",
        { $add: [{ $indexOfCP: ["$texte", "-"] }, 1] },
        -1
      ]
    }
  }
}

// ‚úÖ MIEUX : Utiliser $let pour calculer une fois
{
  $project: {
    $let: {
      vars: {
        pos: { $indexOfCP: ["$texte", "-"] }
      },
      in: {
        partie1: { $substrCP: ["$texte", 0, "$$pos"] },
        partie2: {
          $substrCP: ["$texte", { $add: ["$$pos", 1] }, -1]
        }
      }
    }
  }
}
```

### 3. Normaliser en Amont

Si possible, normalisez vos donn√©es lors de l'insertion plut√¥t que dans chaque requ√™te :

```javascript
// √Ä l'insertion
db.utilisateurs.insertOne({
  emailOriginal: "Marie.Dupont@EXAMPLE.com",
  email: "marie.dupont@example.com",  // D√©j√† normalis√©
  dateCreation: new Date()
})
```

### 4. Index sur Champs Transform√©s

Si vous filtrez souvent sur un champ transform√©, cr√©ez un champ calcul√© index√© :

```javascript
// Cr√©er un champ pour la recherche
db.produits.updateMany(
  {},
  [{
    $set: {
      nomRecherche: { $toLower: "$nom" }
    }
  }]
)

// Cr√©er un index
db.produits.createIndex({ nomRecherche: 1 })

// Recherche rapide
db.produits.find({ nomRecherche: "ordinateur" })
```

## Points Cl√©s √† Retenir

1. ‚úÖ **$concat** : Combine des cha√Ænes
2. ‚úÖ **$toLower / $toUpper** : Normalisation de casse
3. ‚úÖ **$substrCP** : Extraction (toujours CP, pas substr)
4. ‚úÖ **$strLenCP** : Longueur en caract√®res
5. ‚úÖ **$trim** : Nettoyer les espaces
6. ‚úÖ **$split** : Diviser en tableau
7. ‚úÖ **$replaceAll** : Remplacer du texte
8. ‚úÖ **$indexOfCP** : Trouver la position
9. ‚ö†Ô∏è **null** : Utiliser $ifNull pour g√©rer
10. ‚ö° **Performance** : Filtrer avant de transformer

## Exemple Complet : Nettoyage et Normalisation de Donn√©es

```javascript
// Pipeline complet de nettoyage de donn√©es clients
db.clientsImportes.aggregate([
  {
    // 1. Nettoyer et normaliser
    $project: {
      // Nom : Majuscule premi√®re lettre, reste en minuscule, trim
      nom: {
        $trim: {
          input: {
            $concat: [
              { $toUpper: { $substrCP: [{ $trim: { input: "$nom_raw" } }, 0, 1] } },
              { $toLower: { $substrCP: [{ $trim: { input: "$nom_raw" } }, 1, -1] } }
            ]
          }
        }
      },

      // Pr√©nom : idem
      prenom: {
        $trim: {
          input: {
            $concat: [
              { $toUpper: { $substrCP: [{ $trim: { input: "$prenom_raw" } }, 0, 1] } },
              { $toLower: { $substrCP: [{ $trim: { input: "$prenom_raw" } }, 1, -1] } }
            ]
          }
        }
      },

      // Email : minuscule, trim
      email: {
        $toLower: { $trim: { input: "$email_raw" } }
      },

      // T√©l√©phone : supprimer espaces et tirets
      telephone: {
        $replaceAll: {
          input: {
            $replaceAll: {
              input: { $trim: { input: "$telephone_raw" } },
              find: " ",
              replacement: ""
            }
          },
          find: "-",
          replacement: ""
        }
      },

      // Code postal : extraire 5 chiffres
      codePostal: {
        $substrCP: [
          { $trim: { input: "$codePostal_raw" } },
          0,
          5
        ]
      },

      // Ville : majuscules, trim
      ville: {
        $toUpper: { $trim: { input: "$ville_raw" } }
      },

      // Cr√©er un identifiant unique
      identifiant: {
        $toLower: {
          $concat: [
            { $substrCP: ["$prenom_raw", 0, 1] },
            { $substrCP: ["$nom_raw", 0, 3] },
            "-",
            { $substrCP: [{ $trim: { input: "$telephone_raw" } }, -4, 4] }
          ]
        }
      }
    }
  },
  {
    // 2. Valider les donn√©es
    $match: {
      // Email valide (contient @ et .)
      $expr: {
        $and: [
          { $gt: [{ $indexOfCP: ["$email", "@"] }, 0] },
          { $gt: [
            { $indexOfCP: ["$email", ".", { $indexOfCP: ["$email", "@"] }] },
            0
          ]}
        ]
      },
      // T√©l√©phone = 10 chiffres
      $expr: { $eq: [{ $strLenCP: "$telephone" }, 10] }
    }
  },
  {
    // 3. Sauvegarder dans une nouvelle collection
    $out: "clientsNettoyes"
  }
])
```

## Conclusion

Les op√©rateurs de cha√Ænes sont des outils **essentiels** pour :

- üßπ **Nettoyer** et normaliser vos donn√©es
- üî§ **Formater** des informations textuelles
- ‚úÇÔ∏è **Extraire** des sous-cha√Ænes et informations
- üîç **Rechercher** et analyser du contenu
- üîÑ **Transformer** des donn√©es pour l'affichage
- ‚úÖ **Valider** des formats de donn√©es

La cl√© est de bien g√©rer les cas limites (valeurs null, cha√Ænes vides) et d'optimiser vos pipelines en filtrant avant de transformer. Utilisez toujours les variantes `CP` (Code Point) pour un support correct des caract√®res Unicode.

---


‚è≠Ô∏è [Op√©rateurs de dates](/06-framework-agregation/05.3-operateurs-dates.md)
