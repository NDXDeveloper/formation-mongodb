üîù Retour au [Sommaire](/SOMMAIRE.md)

# 6.3.2 $project - Transformer et Fa√ßonner les Documents

## Introduction

L'√©tape `$project` est l'une des op√©rations les plus polyvalentes du framework d'agr√©gation MongoDB. Elle vous permet de **transformer la forme** de vos documents en s√©lectionnant, excluant, renommant des champs, ou m√™me en cr√©ant de nouveaux champs calcul√©s.

Pensez √† `$project` comme un **sculpteur** qui fa√ßonne vos documents : il peut garder certaines parties, en retirer d'autres, ou cr√©er de nouvelles formes √† partir des donn√©es existantes.

## √Ä Quoi Sert $project ?

### 1. **S√©lectionner les Champs**
Choisir quels champs inclure ou exclure dans les r√©sultats finaux.

### 2. **Renommer les Champs**
Donner de nouveaux noms plus explicites √† vos champs.

### 3. **Cr√©er de Nouveaux Champs**
Calculer de nouvelles valeurs √† partir de champs existants.

### 4. **Restructurer les Documents**
Modifier la structure hi√©rarchique de vos documents.

### 5. **Optimiser les Performances**
R√©duire la taille des documents en transit dans le pipeline.

## Syntaxe de Base

```javascript
{
  $project: {
    <champ1>: <1 ou 0 ou expression>,
    <champ2>: <1 ou 0 ou expression>,
    <nouveauChamp>: <expression>
  }
}
```

**Valeurs possibles** :
- `1` ou `true` : **Inclure** le champ
- `0` ou `false` : **Exclure** le champ
- `<expression>` : **Calculer** une nouvelle valeur

## R√®gle Importante : Inclusion vs Exclusion

‚ö†Ô∏è **Vous ne pouvez pas m√©langer inclusion et exclusion** (sauf pour `_id`) :

```javascript
// ‚ùå INTERDIT : m√©langer inclusion et exclusion
{
  $project: {
    nom: 1,        // inclusion
    prenom: 1,     // inclusion
    email: 0       // exclusion - ERREUR !
  }
}

// ‚úÖ CORRECT : uniquement des inclusions
{
  $project: {
    _id: 0,        // exception : _id peut √™tre exclu m√™me avec des inclusions
    nom: 1,
    prenom: 1
  }
}

// ‚úÖ CORRECT : uniquement des exclusions
{
  $project: {
    motDePasse: 0,
    numeroSecuriteSociale: 0
  }
}
```

## Exemples Progressifs

### Exemple 1 : Inclusion de Champs Sp√©cifiques

Imaginons une collection `employes` :

```javascript
// Collection: employes
{
  "_id": 1,
  "nom": "Dupont",
  "prenom": "Marie",
  "age": 32,
  "email": "marie.dupont@example.com",
  "salaire": 45000,
  "dateEmbauche": ISODate("2020-03-15"),
  "numeroSecuriteSociale": "1234567890123"
}
```

Pour ne garder que le nom, pr√©nom et email :

```javascript
db.employes.aggregate([
  {
    $project: {
      nom: 1,
      prenom: 1,
      email: 1
    }
  }
])
```

**R√©sultat** :
```javascript
{
  "_id": 1,                             // _id est inclus par d√©faut
  "nom": "Dupont",
  "prenom": "Marie",
  "email": "marie.dupont@example.com"
}
```

**Note** : Le champ `_id` est **toujours inclus par d√©faut**, m√™me si vous ne le sp√©cifiez pas.

### Exemple 2 : Exclure le Champ _id

Pour exclure le champ `_id` :

```javascript
db.employes.aggregate([
  {
    $project: {
      _id: 0,      // Exclusion explicite de _id
      nom: 1,
      prenom: 1,
      email: 1
    }
  }
])
```

**R√©sultat** :
```javascript
{
  "nom": "Dupont",
  "prenom": "Marie",
  "email": "marie.dupont@example.com"
}
```

### Exemple 3 : Exclusion de Champs Sensibles

Pour exclure des donn√©es sensibles et garder tout le reste :

```javascript
db.employes.aggregate([
  {
    $project: {
      salaire: 0,
      numeroSecuriteSociale: 0
    }
  }
])
```

**R√©sultat** :
```javascript
{
  "_id": 1,
  "nom": "Dupont",
  "prenom": "Marie",
  "age": 32,
  "email": "marie.dupont@example.com",
  "dateEmbauche": ISODate("2020-03-15")
  // salaire et numeroSecuriteSociale sont absents
}
```

### Exemple 4 : Renommer des Champs

Pour renommer un champ, utilisez la syntaxe `nouveauNom: "$ancienNom"` :

```javascript
db.employes.aggregate([
  {
    $project: {
      _id: 0,
      nomComplet: "$nom",           // Renommer "nom" en "nomComplet"
      pr√©nomEmploy√©: "$prenom",     // Renommer "prenom" en "pr√©nomEmploy√©"
      adresseEmail: "$email"        // Renommer "email" en "adresseEmail"
    }
  }
])
```

**R√©sultat** :
```javascript
{
  "nomComplet": "Dupont",
  "pr√©nomEmploy√©": "Marie",
  "adresseEmail": "marie.dupont@example.com"
}
```

**Note** : Le pr√©fixe `$` devant un nom de champ signifie "la valeur du champ".

### Exemple 5 : Cr√©er de Nouveaux Champs Calcul√©s

#### Calcul Simple

```javascript
// Collection: produits
{
  "_id": 1,
  "nom": "Ordinateur Portable",
  "prixHT": 800,
  "tauxTVA": 0.20
}
```

Calculer le prix TTC :

```javascript
db.produits.aggregate([
  {
    $project: {
      nom: 1,
      prixHT: 1,
      prixTTC: {
        $multiply: ["$prixHT", { $add: [1, "$tauxTVA"] }]
      }
    }
  }
])
```

**R√©sultat** :
```javascript
{
  "_id": 1,
  "nom": "Ordinateur Portable",
  "prixHT": 800,
  "prixTTC": 960        // 800 * (1 + 0.20) = 960
}
```

#### Op√©rations Arithm√©tiques

Voici les op√©rateurs arithm√©tiques disponibles :

| Op√©rateur | Description | Exemple |
|-----------|-------------|---------|
| `$add` | Addition | `{ $add: [10, 5] }` ‚Üí 15 |
| `$subtract` | Soustraction | `{ $subtract: [10, 5] }` ‚Üí 5 |
| `$multiply` | Multiplication | `{ $multiply: [10, 5] }` ‚Üí 50 |
| `$divide` | Division | `{ $divide: [10, 5] }` ‚Üí 2 |
| `$mod` | Modulo | `{ $mod: [10, 3] }` ‚Üí 1 |

### Exemple 6 : Concat√©nation de Cha√Ænes

```javascript
db.employes.aggregate([
  {
    $project: {
      _id: 0,
      identite: {
        $concat: ["$prenom", " ", "$nom"]
      },
      email: 1
    }
  }
])
```

**R√©sultat** :
```javascript
{
  "identite": "Marie Dupont",
  "email": "marie.dupont@example.com"
}
```

### Exemple 7 : Conversion de Cha√Ænes

#### Majuscules et Minuscules

```javascript
db.employes.aggregate([
  {
    $project: {
      nomMajuscule: { $toUpper: "$nom" },
      prenomMinuscule: { $toLower: "$prenom" }
    }
  }
])
```

**R√©sultat** :
```javascript
{
  "_id": 1,
  "nomMajuscule": "DUPONT",
  "prenomMinuscule": "marie"
}
```

### Exemple 8 : Extraction de Sous-Cha√Ænes

```javascript
db.employes.aggregate([
  {
    $project: {
      _id: 0,
      nom: 1,
      initialePrenom: { $substrCP: ["$prenom", 0, 1] }
    }
  }
])
```

**R√©sultat** :
```javascript
{
  "nom": "Dupont",
  "initialePrenom": "M"
}
```

### Exemple 9 : Manipulation de Dates

```javascript
db.employes.aggregate([
  {
    $project: {
      nom: 1,
      prenom: 1,
      anneeEmbauche: { $year: "$dateEmbauche" },
      moisEmbauche: { $month: "$dateEmbauche" },
      jourEmbauche: { $dayOfMonth: "$dateEmbauche" }
    }
  }
])
```

**R√©sultat** :
```javascript
{
  "_id": 1,
  "nom": "Dupont",
  "prenom": "Marie",
  "anneeEmbauche": 2020,
  "moisEmbauche": 3,
  "jourEmbauche": 15
}
```

#### Op√©rateurs de Date Courants

| Op√©rateur | Description | Exemple |
|-----------|-------------|---------|
| `$year` | Extrait l'ann√©e | `{ $year: "$date" }` |
| `$month` | Extrait le mois (1-12) | `{ $month: "$date" }` |
| `$dayOfMonth` | Extrait le jour (1-31) | `{ $dayOfMonth: "$date" }` |
| `$dayOfWeek` | Jour de la semaine (1-7) | `{ $dayOfWeek: "$date" }` |
| `$hour` | Extrait l'heure (0-23) | `{ $hour: "$date" }` |
| `$dateToString` | Formate une date | `{ $dateToString: { format: "%Y-%m-%d", date: "$date" } }` |

### Exemple 10 : Formatage de Date

```javascript
db.employes.aggregate([
  {
    $project: {
      nom: 1,
      dateEmbaucheFormatee: {
        $dateToString: {
          format: "%d/%m/%Y",
          date: "$dateEmbauche"
        }
      }
    }
  }
])
```

**R√©sultat** :
```javascript
{
  "_id": 1,
  "nom": "Dupont",
  "dateEmbaucheFormatee": "15/03/2020"
}
```

### Exemple 11 : Expressions Conditionnelles

Utiliser `$cond` pour des conditions if/else :

```javascript
// Collection: commandes
{
  "_id": 1,
  "montant": 150,
  "client": "Alice"
}
```

Ajouter une cat√©gorie selon le montant :

```javascript
db.commandes.aggregate([
  {
    $project: {
      client: 1,
      montant: 1,
      categorie: {
        $cond: {
          if: { $gte: ["$montant", 100] },
          then: "Premium",
          else: "Standard"
        }
      }
    }
  }
])
```

**R√©sultat** :
```javascript
{
  "_id": 1,
  "client": "Alice",
  "montant": 150,
  "categorie": "Premium"
}
```

### Exemple 12 : Conditions Multiples avec $switch

Pour des conditions plus complexes, utilisez `$switch` :

```javascript
db.commandes.aggregate([
  {
    $project: {
      client: 1,
      montant: 1,
      categorie: {
        $switch: {
          branches: [
            { case: { $lt: ["$montant", 50] }, then: "Bronze" },
            { case: { $lt: ["$montant", 100] }, then: "Argent" },
            { case: { $lt: ["$montant", 200] }, then: "Or" }
          ],
          default: "Platine"
        }
      }
    }
  }
])
```

### Exemple 13 : Travailler avec des Tableaux

#### Taille d'un Tableau

```javascript
// Collection: etudiants
{
  "_id": 1,
  "nom": "Alice",
  "notes": [15, 18, 12, 16]
}
```

Compter le nombre de notes :

```javascript
db.etudiants.aggregate([
  {
    $project: {
      nom: 1,
      nombreNotes: { $size: "$notes" }
    }
  }
])
```

**R√©sultat** :
```javascript
{
  "_id": 1,
  "nom": "Alice",
  "nombreNotes": 4
}
```

#### Premier et Dernier √âl√©ment

```javascript
db.etudiants.aggregate([
  {
    $project: {
      nom: 1,
      premiereNote: { $arrayElemAt: ["$notes", 0] },
      derniereNote: { $arrayElemAt: ["$notes", -1] }
    }
  }
])
```

**R√©sultat** :
```javascript
{
  "_id": 1,
  "nom": "Alice",
  "premiereNote": 15,
  "derniereNote": 16
}
```

### Exemple 14 : Restructurer des Documents Imbriqu√©s

#### Aplatir une Structure

```javascript
// Collection: utilisateurs
{
  "_id": 1,
  "nom": "Dupont",
  "adresse": {
    "rue": "5 rue de la Paix",
    "ville": "Paris",
    "codePostal": "75001"
  }
}
```

Remonter les champs d'adresse au niveau principal :

```javascript
db.utilisateurs.aggregate([
  {
    $project: {
      nom: 1,
      rue: "$adresse.rue",
      ville: "$adresse.ville",
      codePostal: "$adresse.codePostal"
    }
  }
])
```

**R√©sultat** :
```javascript
{
  "_id": 1,
  "nom": "Dupont",
  "rue": "5 rue de la Paix",
  "ville": "Paris",
  "codePostal": "75001"
}
```

#### Cr√©er une Structure Imbriqu√©e

```javascript
// √Ä partir de champs plats
{
  "_id": 1,
  "nom": "Dupont",
  "rue": "5 rue de la Paix",
  "ville": "Paris"
}
```

Cr√©er un objet imbriqu√© :

```javascript
db.utilisateurs.aggregate([
  {
    $project: {
      nom: 1,
      adresse: {
        rue: "$rue",
        ville: "$ville"
      }
    }
  }
])
```

**R√©sultat** :
```javascript
{
  "_id": 1,
  "nom": "Dupont",
  "adresse": {
    "rue": "5 rue de la Paix",
    "ville": "Paris"
  }
}
```

## Op√©rateurs Courants dans $project

### Op√©rateurs de Cha√Ænes

| Op√©rateur | Description | Exemple |
|-----------|-------------|---------|
| `$concat` | Concat√®ne des cha√Ænes | `{ $concat: ["$a", "-", "$b"] }` |
| `$toUpper` | Convertit en majuscules | `{ $toUpper: "$nom" }` |
| `$toLower` | Convertit en minuscules | `{ $toLower: "$nom" }` |
| `$substr` | Extrait une sous-cha√Æne | `{ $substr: ["$text", 0, 5] }` |
| `$substrCP` | Sous-cha√Æne (UTF-8 safe) | `{ $substrCP: ["$text", 0, 5] }` |
| `$strLenCP` | Longueur de la cha√Æne | `{ $strLenCP: "$text" }` |
| `$trim` | Supprime espaces d√©but/fin | `{ $trim: { input: "$text" } }` |

### Op√©rateurs Arithm√©tiques

| Op√©rateur | Description | Exemple |
|-----------|-------------|---------|
| `$add` | Addition | `{ $add: ["$a", "$b"] }` |
| `$subtract` | Soustraction | `{ $subtract: ["$a", "$b"] }` |
| `$multiply` | Multiplication | `{ $multiply: ["$a", "$b"] }` |
| `$divide` | Division | `{ $divide: ["$a", "$b"] }` |
| `$mod` | Modulo | `{ $mod: ["$a", "$b"] }` |
| `$abs` | Valeur absolue | `{ $abs: "$nombre" }` |
| `$ceil` | Arrondi sup√©rieur | `{ $ceil: "$nombre" }` |
| `$floor` | Arrondi inf√©rieur | `{ $floor: "$nombre" }` |
| `$round` | Arrondi au plus proche | `{ $round: ["$nombre", 2] }` |

### Op√©rateurs de Tableaux

| Op√©rateur | Description | Exemple |
|-----------|-------------|---------|
| `$size` | Taille du tableau | `{ $size: "$tableau" }` |
| `$arrayElemAt` | √âl√©ment √† l'index | `{ $arrayElemAt: ["$tab", 0] }` |
| `$slice` | Sous-tableau | `{ $slice: ["$tab", 5] }` |
| `$concatArrays` | Concat√®ne tableaux | `{ $concatArrays: ["$a", "$b"] }` |
| `$in` | Teste appartenance | `{ $in: ["value", "$array"] }` |

### Op√©rateurs Conditionnels

| Op√©rateur | Description | Exemple |
|-----------|-------------|---------|
| `$cond` | If/Then/Else | `{ $cond: [condition, true, false] }` |
| `$ifNull` | Valeur si null | `{ $ifNull: ["$field", "default"] }` |
| `$switch` | Multiple conditions | `{ $switch: { branches: [...] } }` |

### Op√©rateurs de Type

| Op√©rateur | Description | Exemple |
|-----------|-------------|---------|
| `$type` | Type de la valeur | `{ $type: "$field" }` |
| `$toString` | Convertit en cha√Æne | `{ $toString: "$nombre" }` |
| `$toInt` | Convertit en entier | `{ $toInt: "$texte" }` |
| `$toDouble` | Convertit en d√©cimal | `{ $toDouble: "$texte" }` |
| `$toDate` | Convertit en date | `{ $toDate: "$timestamp" }` |

## Cas d'Usage Pratiques

### 1. Masquer des Donn√©es Sensibles

```javascript
db.utilisateurs.aggregate([
  {
    $project: {
      nom: 1,
      email: 1,
      // Masquer le mot de passe
      motDePasse: 0,
      numeroSecuriteSociale: 0,
      // Afficher seulement les 4 derniers chiffres de la carte
      cartePartielle: { $substr: ["$numeroCarte", -4, 4] }
    }
  }
])
```

### 2. Calculer l'√Çge √† partir de la Date de Naissance

```javascript
db.personnes.aggregate([
  {
    $project: {
      nom: 1,
      dateNaissance: 1,
      age: {
        $subtract: [
          { $year: new Date() },
          { $year: "$dateNaissance" }
        ]
      }
    }
  }
])
```

### 3. Cr√©er un Nom Complet

```javascript
db.employes.aggregate([
  {
    $project: {
      _id: 0,
      nomComplet: {
        $concat: [
          { $toUpper: { $substrCP: ["$prenom", 0, 1] } },
          { $toLower: { $substrCP: ["$prenom", 1, -1] } },
          " ",
          { $toUpper: "$nom" }
        ]
      }
    }
  }
])
// R√©sultat : "Marie DUPONT"
```

### 4. Formater un Prix

```javascript
db.produits.aggregate([
  {
    $project: {
      nom: 1,
      prixFormate: {
        $concat: [
          { $toString: { $round: ["$prix", 2] } },
          " ‚Ç¨"
        ]
      }
    }
  }
])
```

### 5. Cr√©er un Statut Bas√© sur Plusieurs Conditions

```javascript
db.commandes.aggregate([
  {
    $project: {
      numeroCommande: 1,
      statut: {
        $switch: {
          branches: [
            {
              case: { $eq: ["$paiement", "re√ßu"] },
              then: "Confirm√©e"
            },
            {
              case: { $eq: ["$expedition", "envoy√©e"] },
              then: "En transit"
            },
            {
              case: { $eq: ["$livraison", "re√ßue"] },
              then: "Livr√©e"
            }
          ],
          default: "En attente"
        }
      }
    }
  }
])
```

## Performances et Optimisation

### 1. Projeter T√¥t dans le Pipeline

Utilisez `$project` t√¥t pour r√©duire la taille des documents :

```javascript
db.articles.aggregate([
  {
    $match: { categorie: "√âlectronique" }
  },
  {
    // Projeter juste apr√®s le match pour all√©ger les donn√©es
    $project: {
      titre: 1,
      prix: 1
      // On retire description, images, etc.
    }
  },
  {
    $sort: { prix: 1 }
  }
])
```

### 2. √âviter les Calculs Inutiles

Ne calculez que ce dont vous avez besoin :

```javascript
// ‚ùå Calcule beaucoup de choses inutiles
{
  $project: {
    champ1: { $multiply: [/* calcul complexe */] },
    champ2: { $add: [/* calcul complexe */] },
    // ... puis on n'utilise qu'un seul champ
  }
}

// ‚úÖ Ne calcule que le n√©cessaire
{
  $project: {
    champ1: { $multiply: [/* calcul complexe */] }
  }
}
```

### 3. Utiliser $addFields pour Ajouter sans Tout Red√©finir

Si vous voulez juste ajouter un champ sans red√©finir tout le document, utilisez `$addFields` (voir la section suivante) plut√¥t que `$project`.

## $project vs Projection dans find()

### Similitudes

```javascript
// Avec find()
db.collection.find(
  { statut: "actif" },
  { nom: 1, email: 1 }  // projection
)

// √âquivalent avec aggregate()
db.collection.aggregate([
  { $match: { statut: "actif" } },
  { $project: { nom: 1, email: 1 } }
])
```

### Diff√©rences

| Aspect | find() projection | $project |
|--------|-------------------|----------|
| **Calculs** | Limit√©s | Op√©rateurs riches |
| **Renommage** | Non | Oui |
| **Nouveaux champs** | Non | Oui |
| **Expressions** | Basiques | Avanc√©es |
| **Position** | Fin de requ√™te | Partout dans pipeline |

## $project vs $addFields

### $project
- **Remplace** le document entier
- Vous devez sp√©cifier tous les champs √† garder
- Utile pour une transformation compl√®te

```javascript
{
  $project: {
    nom: 1,
    nouveauChamp: "$ancien"
    // Tous les autres champs sont exclus
  }
}
```

### $addFields (ou $set)
- **Ajoute** des champs au document existant
- Garde automatiquement tous les champs existants
- Utile pour ajouter des champs calcul√©s

```javascript
{
  $addFields: {
    nouveauChamp: "$ancien"
    // Tous les autres champs sont conserv√©s automatiquement
  }
}
```

## Points Cl√©s √† Retenir

1. ‚úÖ **$project transforme la structure** de vos documents
2. ‚úÖ **Inclusion (1) ou exclusion (0)**, pas de m√©lange (sauf _id)
3. ‚úÖ **`$nomChamp`** pour r√©f√©rencer la valeur d'un champ
4. ‚úÖ **Op√©rateurs riches** pour calculs, dates, cha√Ænes, tableaux
5. ‚úÖ **Peut renommer** et cr√©er de nouveaux champs
6. ‚úÖ **Conditions avec $cond** et $switch
7. ‚úÖ **Projeter t√¥t** dans le pipeline pour meilleures performances
8. ‚úÖ **_id inclus par d√©faut** sauf exclusion explicite

## Exemple Complet : Pipeline Complexe

```javascript
// Analyser les ventes avec calculs et formatage
db.ventes.aggregate([
  {
    // 1. Filtrer les ventes de 2024
    $match: {
      date: {
        $gte: ISODate("2024-01-01"),
        $lt: ISODate("2025-01-01")
      }
    }
  },
  {
    // 2. Transformer et enrichir les donn√©es
    $project: {
      _id: 0,

      // Informations basiques
      reference: "$numeroVente",

      // Formatage du client
      client: {
        $concat: [
          { $toUpper: { $substrCP: ["$nomClient", 0, 1] } },
          { $substrCP: ["$nomClient", 1, -1] }
        ]
      },

      // Calculs financiers
      montantHT: "$montant",
      montantTTC: {
        $multiply: ["$montant", 1.20]
      },
      tva: {
        $multiply: ["$montant", 0.20]
      },

      // Formatage de la date
      dateVente: {
        $dateToString: {
          format: "%d/%m/%Y",
          date: "$date"
        }
      },

      // Cat√©gorisation
      categorie: {
        $switch: {
          branches: [
            { case: { $lt: ["$montant", 100] }, then: "Petite" },
            { case: { $lt: ["$montant", 500] }, then: "Moyenne" },
            { case: { $gte: ["$montant", 500] }, then: "Grande" }
          ],
          default: "Non class√©e"
        }
      },

      // Statut
      statutPaiement: {
        $cond: {
          if: { $eq: ["$paye", true] },
          then: "‚úì Pay√©",
          else: "‚úó En attente"
        }
      }
    }
  },
  {
    // 3. Trier par montant d√©croissant
    $sort: { montantTTC: -1 }
  },
  {
    // 4. Limiter aux 10 premi√®res
    $limit: 10
  }
])
```

## Conclusion

L'√©tape `$project` est un **outil de transformation puissant** qui vous permet de :

- üé® **Fa√ßonner** vos documents selon vos besoins
- üîß **Calculer** de nouvelles valeurs
- üè∑Ô∏è **Renommer** pour plus de clart√©
- üéØ **Optimiser** en r√©duisant la taille des donn√©es
- üîÑ **Restructurer** pour adapter √† votre logique m√©tier

Ma√Ætriser `$project` est essentiel pour cr√©er des pipelines d'agr√©gation efficaces et produire exactement les donn√©es dont votre application a besoin.

---


‚è≠Ô∏è [$group](/06-framework-agregation/03.3-group.md)
