üîù Retour au [Sommaire](/SOMMAIRE.md)

# 6.5.5 Op√©rateurs Conditionnels - Logique et D√©cisions

## Introduction

Les op√©rateurs conditionnels permettent d'impl√©menter de la **logique d√©cisionnelle** dans vos pipelines d'agr√©gation MongoDB. Ils vous donnent la possibilit√© de cr√©er des expressions "si...alors...sinon", de g√©rer les valeurs nulles, et de prendre des d√©cisions bas√©es sur des conditions complexes.

Pensez aux op√©rateurs conditionnels comme √† des **aiguilleurs** qui dirigent le flux de donn√©es selon diff√©rents chemins en fonction des conditions que vous d√©finissez.

## √Ä Quoi Servent les Op√©rateurs Conditionnels ?

### 1. **Logique If/Then/Else**
Ex√©cuter diff√©rentes actions selon une condition.

### 2. **Gestion des Valeurs Nulles**
Fournir des valeurs par d√©faut quand un champ est absent ou null.

### 3. **Cat√©gorisation**
Classer les documents dans diff√©rentes cat√©gories.

### 4. **Calculs Conditionnels**
Effectuer des calculs diff√©rents selon les cas.

### 5. **Validation**
V√©rifier des conditions et marquer les donn√©es en cons√©quence.

## Liste des Op√©rateurs Conditionnels

### Op√©rateurs Principaux

| Op√©rateur | Description | Usage |
|-----------|-------------|-------|
| `$cond` | If/Then/Else | Condition simple √† deux branches |
| `$ifNull` | Valeur par d√©faut si null | G√©rer les valeurs manquantes |
| `$switch` | Multiple conditions | Plusieurs cas comme un switch/case |

### Op√©rateurs de Comparaison (pour les conditions)

| Op√©rateur | Description | Exemple |
|-----------|-------------|---------|
| `$eq` | √âgal √† | `{ $eq: ["$age", 25] }` |
| `$ne` | Diff√©rent de | `{ $ne: ["$statut", "inactif"] }` |
| `$gt` | Sup√©rieur √† | `{ $gt: ["$prix", 100] }` |
| `$gte` | Sup√©rieur ou √©gal | `{ $gte: ["$score", 50] }` |
| `$lt` | Inf√©rieur √† | `{ $lt: ["$stock", 10] }` |
| `$lte` | Inf√©rieur ou √©gal | `{ $lte: ["$age", 18] }` |

### Op√©rateurs Logiques (pour combiner des conditions)

| Op√©rateur | Description | Exemple |
|-----------|-------------|---------|
| `$and` | ET logique | `{ $and: [cond1, cond2] }` |
| `$or` | OU logique | `{ $or: [cond1, cond2] }` |
| `$not` | NON logique | `{ $not: [condition] }` |

## L'Op√©rateur $cond : If/Then/Else

L'op√©rateur `$cond` est l'√©quivalent d'une instruction `if...else` en programmation.

### Syntaxe

Il existe deux syntaxes pour `$cond` :

**Syntaxe compl√®te (recommand√©e)** :
```javascript
{
  $cond: {
    if: <condition>,
    then: <expression_si_vrai>,
    else: <expression_si_faux>
  }
}
```

**Syntaxe abr√©g√©e** :
```javascript
{ $cond: [<condition>, <si_vrai>, <si_faux>] }
```

### Exemples Progressifs

**Exemple 1 : Cat√©gorie d'√Çge**

```javascript
// Collection: utilisateurs
{
  "_id": 1,
  "nom": "Alice",
  "age": 17
}
```

```javascript
db.utilisateurs.aggregate([
  {
    $project: {
      nom: 1,
      age: 1,
      categorie: {
        $cond: {
          if: { $gte: ["$age", 18] },
          then: "Majeur",
          else: "Mineur"
        }
      }
    }
  }
])
```

**R√©sultat** :
```javascript
{
  "_id": 1,
  "nom": "Alice",
  "age": 17,
  "categorie": "Mineur"
}
```

**Exemple 2 : Remise Conditionnelle**

```javascript
// Collection: produits
{
  "_id": 1,
  "nom": "Ordinateur",
  "prix": 1200,
  "enPromotion": true
}
```

```javascript
db.produits.aggregate([
  {
    $project: {
      nom: 1,
      prixOriginal: "$prix",
      prixFinal: {
        $cond: {
          if: { $eq: ["$enPromotion", true] },
          then: { $multiply: ["$prix", 0.80] },  // -20%
          else: "$prix"
        }
      }
    }
  }
])
```

**R√©sultat** :
```javascript
{
  "_id": 1,
  "nom": "Ordinateur",
  "prixOriginal": 1200,
  "prixFinal": 960  // 1200 * 0.80
}
```

**Exemple 3 : Stock Bas**

```javascript
db.produits.aggregate([
  {
    $project: {
      nom: 1,
      stock: 1,
      alerte: {
        $cond: {
          if: { $lt: ["$stock", 10] },
          then: "‚ö†Ô∏è Stock faible",
          else: "‚úì Stock OK"
        }
      }
    }
  }
])
```

**Exemple 4 : Calcul Conditionnel Complexe**

```javascript
// Collection: commandes
{
  "_id": 1,
  "montant": 150,
  "client": "premium"
}
```

Calculer les frais de livraison :
- Gratuit si montant > 50‚Ç¨ OU client premium
- 5‚Ç¨ sinon

```javascript
db.commandes.aggregate([
  {
    $project: {
      montant: 1,
      client: 1,
      fraisLivraison: {
        $cond: {
          if: {
            $or: [
              { $gte: ["$montant", 50] },
              { $eq: ["$client", "premium"] }
            ]
          },
          then: 0,
          else: 5
        }
      }
    }
  }
])
```

**Exemple 5 : Notation en Lettres**

```javascript
db.etudiants.aggregate([
  {
    $project: {
      nom: 1,
      note: 1,
      appreciation: {
        $cond: {
          if: { $gte: ["$note", 16] },
          then: "Excellent",
          else: {
            $cond: {
              if: { $gte: ["$note", 14] },
              then: "Tr√®s bien",
              else: {
                $cond: {
                  if: { $gte: ["$note", 12] },
                  then: "Bien",
                  else: {
                    $cond: {
                      if: { $gte: ["$note", 10] },
                      then: "Passable",
                      else: "Insuffisant"
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  }
])
```

‚ö†Ô∏è **Note** : Pour plusieurs conditions, `$switch` est plus lisible (voir section suivante).

## L'Op√©rateur $ifNull : Valeur par D√©faut

L'op√©rateur `$ifNull` fournit une valeur de remplacement si un champ est `null` ou n'existe pas.

### Syntaxe

```javascript
{ $ifNull: [<expression>, <valeur_si_null>] }
```

Si `expression` est `null` ou manquante, retourne `valeur_si_null`, sinon retourne `expression`.

### Exemples

**Exemple 1 : Email par D√©faut**

```javascript
// Collection: utilisateurs
{
  "_id": 1,
  "nom": "Alice",
  "email": null
}
{
  "_id": 2,
  "nom": "Bob",
  "email": "bob@example.com"
}
{
  "_id": 3,
  "nom": "Charlie"
  // Pas de champ email
}
```

```javascript
db.utilisateurs.aggregate([
  {
    $project: {
      nom: 1,
      emailAffiche: {
        $ifNull: ["$email", "non-renseign√©@example.com"]
      }
    }
  }
])
```

**R√©sultat** :
```javascript
{ "_id": 1, "nom": "Alice", "emailAffiche": "non-renseign√©@example.com" }
{ "_id": 2, "nom": "Bob", "emailAffiche": "bob@example.com" }
{ "_id": 3, "nom": "Charlie", "emailAffiche": "non-renseign√©@example.com" }
```

**Exemple 2 : T√©l√©phone Optionnel**

```javascript
{
  $project: {
    nom: 1,
    contact: {
      $ifNull: ["$telephone", "Non communiqu√©"]
    }
  }
}
```

**Exemple 3 : Valeur Num√©rique par D√©faut**

```javascript
// Calculer un total avec bonus optionnel
{
  $project: {
    employe: 1,
    salaireBase: 1,
    total: {
      $add: [
        "$salaireBase",
        { $ifNull: ["$bonus", 0] }  // 0 si pas de bonus
      ]
    }
  }
}
```

**Exemple 4 : Cha√Æner Plusieurs $ifNull**

```javascript
// Essayer plusieurs champs
{
  $project: {
    numeroContact: {
      $ifNull: [
        "$telephoneMobile",
        { $ifNull: ["$telephoneFixe", "Aucun num√©ro"] }
      ]
    }
  }
}
// Essaie mobile, puis fixe, puis "Aucun num√©ro"
```

**Exemple 5 : Avec Calculs**

```javascript
db.produits.aggregate([
  {
    $project: {
      nom: 1,
      prixAffiche: {
        $multiply: [
          { $ifNull: ["$prix", 0] },
          1.20  // Ajouter TVA
        ]
      }
    }
  }
])
```

## L'Op√©rateur $switch : Multiple Conditions

L'op√©rateur `$switch` est comme une instruction `switch/case` en programmation. Il permet de g√©rer plusieurs conditions de mani√®re plus lisible que des `$cond` imbriqu√©s.

### Syntaxe

```javascript
{
  $switch: {
    branches: [
      { case: <condition1>, then: <resultat1> },
      { case: <condition2>, then: <resultat2> },
      { case: <condition3>, then: <resultat3> },
      ...
    ],
    default: <resultat_par_defaut>  // Optionnel
  }
}
```

**Important** : Les conditions sont √©valu√©es dans l'ordre. La premi√®re condition vraie est ex√©cut√©e.

### Exemples

**Exemple 1 : Cat√©gories de Prix**

```javascript
db.produits.aggregate([
  {
    $project: {
      nom: 1,
      prix: 1,
      gamme: {
        $switch: {
          branches: [
            { case: { $lt: ["$prix", 50] }, then: "√âconomique" },
            { case: { $lt: ["$prix", 200] }, then: "Standard" },
            { case: { $lt: ["$prix", 500] }, then: "Premium" }
          ],
          default: "Luxe"
        }
      }
    }
  }
])
```

**R√©sultat** :
```javascript
{ "nom": "Souris", "prix": 25, "gamme": "√âconomique" }
{ "nom": "Clavier", "prix": 75, "gamme": "Standard" }
{ "nom": "√âcran", "prix": 350, "gamme": "Premium" }
{ "nom": "Ordinateur", "prix": 1200, "gamme": "Luxe" }
```

**Exemple 2 : Notes en Lettres (Version Lisible)**

```javascript
db.etudiants.aggregate([
  {
    $project: {
      nom: 1,
      note: 1,
      lettre: {
        $switch: {
          branches: [
            { case: { $gte: ["$note", 18] }, then: "A+" },
            { case: { $gte: ["$note", 16] }, then: "A" },
            { case: { $gte: ["$note", 14] }, then: "B" },
            { case: { $gte: ["$note", 12] }, then: "C" },
            { case: { $gte: ["$note", 10] }, then: "D" }
          ],
          default: "F"
        }
      }
    }
  }
])
```

**Exemple 3 : Statut de Commande**

```javascript
db.commandes.aggregate([
  {
    $project: {
      numeroCommande: 1,
      statut: 1,
      dateCommande: 1,
      message: {
        $switch: {
          branches: [
            {
              case: { $eq: ["$statut", "en_preparation"] },
              then: "Votre commande est en cours de pr√©paration"
            },
            {
              case: { $eq: ["$statut", "expediee"] },
              then: "Votre commande a √©t√© exp√©di√©e"
            },
            {
              case: { $eq: ["$statut", "livree"] },
              then: "Votre commande a √©t√© livr√©e"
            },
            {
              case: { $eq: ["$statut", "annulee"] },
              then: "Votre commande a √©t√© annul√©e"
            }
          ],
          default: "Statut inconnu"
        }
      }
    }
  }
])
```

**Exemple 4 : Jour de la Semaine en Fran√ßais**

```javascript
db.evenements.aggregate([
  {
    $project: {
      nom: 1,
      date: 1,
      jourSemaine: {
        $switch: {
          branches: [
            { case: { $eq: [{ $dayOfWeek: "$date" }, 1] }, then: "Dimanche" },
            { case: { $eq: [{ $dayOfWeek: "$date" }, 2] }, then: "Lundi" },
            { case: { $eq: [{ $dayOfWeek: "$date" }, 3] }, then: "Mardi" },
            { case: { $eq: [{ $dayOfWeek: "$date" }, 4] }, then: "Mercredi" },
            { case: { $eq: [{ $dayOfWeek: "$date" }, 5] }, then: "Jeudi" },
            { case: { $eq: [{ $dayOfWeek: "$date" }, 6] }, then: "Vendredi" },
            { case: { $eq: [{ $dayOfWeek: "$date" }, 7] }, then: "Samedi" }
          ],
          default: "Inconnu"
        }
      }
    }
  }
])
```

**Exemple 5 : Priorit√© selon Multiples Crit√®res**

```javascript
db.tickets.aggregate([
  {
    $project: {
      numero: 1,
      type: 1,
      anciennete: 1,
      priorite: {
        $switch: {
          branches: [
            // Critique = toujours prioritaire
            {
              case: { $eq: ["$type", "critique"] },
              then: "Urgent"
            },
            // Bug ancien = prioritaire
            {
              case: {
                $and: [
                  { $eq: ["$type", "bug"] },
                  { $gt: ["$anciennete", 7] }
                ]
              },
              then: "Prioritaire"
            },
            // Feature r√©cente = normal
            {
              case: { $eq: ["$type", "feature"] },
              then: "Normal"
            }
          ],
          default: "Basse"
        }
      }
    }
  }
])
```

## Combiner les Op√©rateurs Conditionnels

### $cond avec $ifNull

```javascript
{
  $project: {
    nom: 1,
    statut: {
      $cond: {
        if: { $gte: [{ $ifNull: ["$score", 0] }, 50] },
        then: "R√©ussi",
        else: "√âchou√©"
      }
    }
  }
}
```

### $switch avec $ifNull

```javascript
{
  $project: {
    categorie: {
      $switch: {
        branches: [
          {
            case: { $lt: [{ $ifNull: ["$age", 0] }, 18] },
            then: "Junior"
          },
          {
            case: { $lt: [{ $ifNull: ["$age", 0] }, 65] },
            then: "Adulte"
          }
        ],
        default: "Senior"
      }
    }
  }
}
```

### Conditions Complexes avec $and et $or

```javascript
{
  $project: {
    eligible: {
      $cond: {
        if: {
          $and: [
            { $gte: ["$age", 18] },
            { $lte: ["$age", 65] },
            {
              $or: [
                { $eq: ["$permis", true] },
                { $eq: ["$transport", "disponible"] }
              ]
            }
          ]
        },
        then: "Oui",
        else: "Non"
      }
    }
  }
}
```

## Cas d'Usage Pratiques

### 1. Syst√®me de Notation de Performance

```javascript
// √âvaluer la performance d'employ√©s
db.employes.aggregate([
  {
    $project: {
      nom: 1,
      ventesRealisees: 1,
      objectifVentes: 1,
      tauxAtteinte: {
        $multiply: [
          {
            $divide: [
              { $ifNull: ["$ventesRealisees", 0] },
              { $ifNull: ["$objectifVentes", 1] }
            ]
          },
          100
        ]
      }
    }
  },
  {
    $project: {
      nom: 1,
      ventesRealisees: 1,
      objectifVentes: 1,
      tauxAtteinte: { $round: ["$tauxAtteinte", 1] },
      evaluation: {
        $switch: {
          branches: [
            { case: { $gte: ["$tauxAtteinte", 120] }, then: "Exceptionnel ‚≠ê‚≠ê‚≠ê" },
            { case: { $gte: ["$tauxAtteinte", 100] }, then: "Excellent ‚≠ê‚≠ê" },
            { case: { $gte: ["$tauxAtteinte", 80] }, then: "Bon ‚≠ê" },
            { case: { $gte: ["$tauxAtteinte", 60] }, then: "Satisfaisant" }
          ],
          default: "√Ä am√©liorer"
        }
      },
      prime: {
        $cond: {
          if: { $gte: ["$tauxAtteinte", 100] },
          then: {
            $multiply: [
              { $subtract: ["$tauxAtteinte", 100] },
              10
            ]
          },
          else: 0
        }
      }
    }
  }
])
```

### 2. Gestion de Stock avec Alertes

```javascript
// Syst√®me d'alerte de stock
db.produits.aggregate([
  {
    $project: {
      nom: 1,
      stock: 1,
      stockMinimum: 1,
      statutStock: {
        $switch: {
          branches: [
            {
              case: { $eq: ["$stock", 0] },
              then: "üî¥ Rupture"
            },
            {
              case: { $lte: ["$stock", "$stockMinimum"] },
              then: "üü† Critique"
            },
            {
              case: { $lte: ["$stock", { $multiply: ["$stockMinimum", 2] }] },
              then: "üü° Attention"
            }
          ],
          default: "üü¢ OK"
        }
      },
      actionRecommandee: {
        $cond: {
          if: { $lte: ["$stock", "$stockMinimum"] },
          then: "Commander imm√©diatement",
          else: {
            $cond: {
              if: { $lte: ["$stock", { $multiply: ["$stockMinimum", 2] }] },
              then: "Pr√©voir commande",
              else: "Pas d'action n√©cessaire"
            }
          }
        }
      },
      quantiteACommander: {
        $cond: {
          if: { $lte: ["$stock", "$stockMinimum"] },
          then: {
            $subtract: [
              { $multiply: ["$stockMinimum", 3] },
              "$stock"
            ]
          },
          else: 0
        }
      }
    }
  }
])
```

### 3. Tarification Dynamique

```javascript
// Calculer le prix selon le profil client
db.commandes.aggregate([
  {
    $project: {
      client: 1,
      typeClient: 1,
      montantHT: 1,
      ancienneteJours: 1,

      // Remise selon le type de client
      tauxRemise: {
        $switch: {
          branches: [
            { case: { $eq: ["$typeClient", "vip"] }, then: 0.20 },
            { case: { $eq: ["$typeClient", "premium"] }, then: 0.15 },
            { case: { $eq: ["$typeClient", "standard"] }, then: 0.05 }
          ],
          default: 0
        }
      }
    }
  },
  {
    $project: {
      client: 1,
      typeClient: 1,
      montantHT: 1,
      tauxRemise: 1,

      // Bonus fid√©lit√©
      bonusFidelite: {
        $cond: {
          if: { $gte: ["$ancienneteJours", 365] },
          then: 0.05,
          else: 0
        }
      }
    }
  },
  {
    $project: {
      client: 1,
      typeClient: 1,
      montantHT: 1,
      remiseTotale: {
        $add: ["$tauxRemise", "$bonusFidelite"]
      },
      montantApresRemise: {
        $multiply: [
          "$montantHT",
          { $subtract: [1, { $add: ["$tauxRemise", "$bonusFidelite"] }] }
        ]
      },
      montantTTC: {
        $multiply: [
          {
            $multiply: [
              "$montantHT",
              { $subtract: [1, { $add: ["$tauxRemise", "$bonusFidelite"] }] }
            ]
          },
          1.20
        ]
      },
      economiesRealisees: {
        $multiply: [
          "$montantHT",
          { $add: ["$tauxRemise", "$bonusFidelite"] }
        ]
      }
    }
  }
])
```

### 4. Validation de Donn√©es

```javascript
// Valider des inscriptions utilisateur
db.inscriptions.aggregate([
  {
    $project: {
      nom: 1,
      email: 1,
      age: 1,
      telephone: 1,

      // Validation de l'email
      emailValide: {
        $and: [
          { $ne: ["$email", null] },
          { $gte: [{ $indexOfCP: ["$email", "@"] }, 0] },
          { $gte: [
            { $indexOfCP: ["$email", ".", { $indexOfCP: ["$email", "@"] }] },
            0
          ]}
        ]
      },

      // Validation de l'√¢ge
      ageValide: {
        $and: [
          { $ne: ["$age", null] },
          { $gte: ["$age", 18] },
          { $lte: ["$age", 120] }
        ]
      },

      // Validation du t√©l√©phone (10 chiffres)
      telephoneValide: {
        $cond: {
          if: { $ne: ["$telephone", null] },
          then: { $eq: [{ $strLenCP: "$telephone" }, 10] },
          else: false
        }
      }
    }
  },
  {
    $project: {
      nom: 1,
      email: 1,
      age: 1,
      telephone: 1,
      emailValide: 1,
      ageValide: 1,
      telephoneValide: 1,

      // Statut global
      inscriptionValide: {
        $and: [
          "$emailValide",
          "$ageValide",
          "$telephoneValide"
        ]
      },

      // Message d'erreur
      erreurs: {
        $switch: {
          branches: [
            {
              case: { $eq: ["$emailValide", false] },
              then: "Email invalide"
            },
            {
              case: { $eq: ["$ageValide", false] },
              then: "√Çge invalide (18-120 ans requis)"
            },
            {
              case: { $eq: ["$telephoneValide", false] },
              then: "T√©l√©phone invalide (10 chiffres requis)"
            }
          ],
          default: "Inscription valide ‚úì"
        }
      }
    }
  }
])
```

### 5. Calcul de Score Composite

```javascript
// Calculer un score bas√© sur plusieurs crit√®res
db.candidatures.aggregate([
  {
    $project: {
      candidat: 1,
      experience: 1,
      formation: 1,
      competences: 1,

      // Score exp√©rience (0-40 points)
      scoreExperience: {
        $switch: {
          branches: [
            { case: { $gte: ["$experience", 10] }, then: 40 },
            { case: { $gte: ["$experience", 5] }, then: 30 },
            { case: { $gte: ["$experience", 2] }, then: 20 }
          ],
          default: 10
        }
      },

      // Score formation (0-30 points)
      scoreFormation: {
        $switch: {
          branches: [
            { case: { $eq: ["$formation", "doctorat"] }, then: 30 },
            { case: { $eq: ["$formation", "master"] }, then: 25 },
            { case: { $eq: ["$formation", "licence"] }, then: 20 },
            { case: { $eq: ["$formation", "bac"] }, then: 15 }
          ],
          default: 10
        }
      },

      // Score comp√©tences (0-30 points)
      scoreCompetences: {
        $multiply: [
          { $size: { $ifNull: ["$competences", []] } },
          3
        ]
      }
    }
  },
  {
    $project: {
      candidat: 1,
      scoreExperience: 1,
      scoreFormation: 1,
      scoreCompetences: 1,

      // Score total
      scoreTotal: {
        $add: [
          "$scoreExperience",
          "$scoreFormation",
          { $min: ["$scoreCompetences", 30] }  // Max 30 pour comp√©tences
        ]
      }
    }
  },
  {
    $project: {
      candidat: 1,
      scoreTotal: 1,

      // D√©cision
      decision: {
        $switch: {
          branches: [
            { case: { $gte: ["$scoreTotal", 80] }, then: "Accept√© - Profil excellent" },
            { case: { $gte: ["$scoreTotal", 60] }, then: "Entretien recommand√©" },
            { case: { $gte: ["$scoreTotal", 40] }, then: "√Ä revoir" }
          ],
          default: "Refus√©"
        }
      }
    }
  },
  {
    $sort: { scoreTotal: -1 }
  }
])
```

## Op√©rateurs Logiques D√©taill√©s

### $and : ET Logique

Toutes les conditions doivent √™tre vraies.

```javascript
{
  $and: [
    { $gte: ["$age", 18] },
    { $lte: ["$age", 65] },
    { $eq: ["$actif", true] }
  ]
}
// Vrai si age entre 18 et 65 ET actif = true
```

### $or : OU Logique

Au moins une condition doit √™tre vraie.

```javascript
{
  $or: [
    { $eq: ["$typeClient", "vip"] },
    { $gte: ["$montantTotal", 1000] }
  ]
}
// Vrai si VIP OU montant >= 1000
```

### $not : NON Logique

Inverse une condition.

```javascript
{
  $not: [
    { $eq: ["$statut", "inactif"] }
  ]
}
// Vrai si statut n'est PAS "inactif"
```

**Note** : `$not` s'utilise g√©n√©ralement avec `$ne` qui est plus direct :
```javascript
{ $ne: ["$statut", "inactif"] }  // √âquivalent plus simple
```

## Gestion des Cas Limites

### Valeurs null dans les Conditions

```javascript
// ‚ùå Probl√®me : null dans une comparaison
{
  $cond: {
    if: { $gte: ["$age", 18] },  // Si age = null, condition = false
    then: "Majeur",
    else: "Mineur"
  }
}

// ‚úÖ Solution : G√©rer explicitement null
{
  $cond: {
    if: {
      $and: [
        { $ne: ["$age", null] },
        { $gte: ["$age", 18] }
      ]
    },
    then: "Majeur",
    else: {
      $cond: {
        if: { $eq: ["$age", null] },
        then: "√Çge non renseign√©",
        else: "Mineur"
      }
    }
  }
}
```

### Division par Z√©ro

```javascript
// ‚ùå Erreur si diviseur = 0
{
  $divide: ["$total", "$nombre"]
}

// ‚úÖ Protection contre division par z√©ro
{
  $cond: {
    if: { $eq: ["$nombre", 0] },
    then: 0,  // ou null, ou une autre valeur par d√©faut
    else: { $divide: ["$total", "$nombre"] }
  }
}
```

### Tableaux Vides

```javascript
// V√©rifier si un tableau n'est pas vide avant d'y acc√©der
{
  $cond: {
    if: { $gt: [{ $size: { $ifNull: ["$items", []] } }, 0] },
    then: { $first: "$items" },
    else: null
  }
}
```

## Performances et Optimisations

### 1. Ordre des Conditions dans $switch

Placez les conditions les plus fr√©quentes en premier :

```javascript
// ‚úÖ BON : Cas fr√©quent en premier
{
  $switch: {
    branches: [
      { case: { $eq: ["$statut", "actif"] }, then: "Traiter" },      // 80%
      { case: { $eq: ["$statut", "suspendu"] }, then: "V√©rifier" },  // 15%
      { case: { $eq: ["$statut", "ferm√©"] }, then: "Archiver" }      // 5%
    ]
  }
}
```

### 2. √âviter les Conditions Redondantes

```javascript
// ‚ùå REDONDANT
{
  $cond: {
    if: { $and: [{ $eq: ["$x", 1] }, { $eq: ["$x", 1] }] },
    then: "A",
    else: "B"
  }
}

// ‚úÖ SIMPLIFI√â
{
  $cond: {
    if: { $eq: ["$x", 1] },
    then: "A",
    else: "B"
  }
}
```

### 3. Court-Circuit avec $and et $or

MongoDB √©value `$and` et `$or` avec court-circuit :

```javascript
// Si la premi√®re condition est fausse, la seconde n'est pas √©valu√©e
{
  $and: [
    { $ne: ["$diviseur", 0] },           // V√©rifier d'abord
    { $gt: [{ $divide: [100, "$diviseur"] }, 10] }  // Puis calculer
  ]
}
```

### 4. Utiliser $ifNull pour Simplifier

```javascript
// ‚ùå COMPLEXE
{
  $cond: {
    if: { $ne: ["$bonus", null] },
    then: "$bonus",
    else: 0
  }
}

// ‚úÖ SIMPLE
{
  $ifNull: ["$bonus", 0]
}
```

## Comparaison : $cond vs $switch

### Quand Utiliser $cond

- 2 branches seulement (if/else)
- Conditions simples
- Lisibilit√© √©quivalente

```javascript
// BON usage de $cond
{
  $cond: {
    if: { $gte: ["$age", 18] },
    then: "Majeur",
    else: "Mineur"
  }
}
```

### Quand Utiliser $switch

- 3+ branches
- Am√©liore la lisibilit√©
- Multiples conditions √† tester

```javascript
// BON usage de $switch (au lieu de $cond imbriqu√©s)
{
  $switch: {
    branches: [
      { case: { $lt: ["$note", 10] }, then: "F" },
      { case: { $lt: ["$note", 12] }, then: "D" },
      { case: { $lt: ["$note", 14] }, then: "C" },
      { case: { $lt: ["$note", 16] }, then: "B" }
    ],
    default: "A"
  }
}
```

## Points Cl√©s √† Retenir

1. ‚úÖ **$cond** : If/then/else simple (2 branches)
2. ‚úÖ **$ifNull** : Valeur par d√©faut pour null
3. ‚úÖ **$switch** : Multiple conditions (3+ branches)
4. ‚úÖ **$and/$or** : Combiner des conditions
5. ‚úÖ **Ordre des conditions** : Plus fr√©quentes en premier dans $switch
6. ‚úÖ **G√©rer null** : Toujours avec $ifNull ou v√©rification explicite
7. ‚úÖ **Division par z√©ro** : Prot√©ger avec $cond
8. ‚úÖ **Lisibilit√©** : Pr√©f√©rer $switch aux $cond imbriqu√©s
9. ‚ö° **Court-circuit** : $and et $or s'arr√™tent √† la premi√®re d√©cision
10. üéØ **Simplicit√©** : Utiliser l'op√©rateur le plus simple pour le besoin

## Exemple Complet : Syst√®me de Scoring Client

```javascript
// Syst√®me complet d'analyse et scoring client
db.clients.aggregate([
  {
    $project: {
      nom: 1,
      email: 1,
      dateInscription: 1,
      nombreCommandes: 1,
      montantTotal: 1,
      dernierAchat: 1,

      // Anciennet√© en jours
      ancienneteJours: {
        $dateDiff: {
          startDate: "$dateInscription",
          endDate: new Date(),
          unit: "day"
        }
      },

      // Jours depuis dernier achat
      joursSanAchat: {
        $dateDiff: {
          startDate: { $ifNull: ["$dernierAchat", "$dateInscription"] },
          endDate: new Date(),
          unit: "day"
        }
      }
    }
  },
  {
    $project: {
      nom: 1,
      email: 1,
      nombreCommandes: 1,
      montantTotal: 1,
      ancienneteJours: 1,
      joursSanAchat: 1,

      // Score anciennet√© (0-30 points)
      scoreAnciennete: {
        $switch: {
          branches: [
            { case: { $gte: ["$ancienneteJours", 730] }, then: 30 },   // 2+ ans
            { case: { $gte: ["$ancienneteJours", 365] }, then: 20 },   // 1+ an
            { case: { $gte: ["$ancienneteJours", 180] }, then: 10 }    // 6+ mois
          ],
          default: 5
        }
      },

      // Score fr√©quence (0-30 points)
      scoreFrequence: {
        $switch: {
          branches: [
            { case: { $gte: ["$nombreCommandes", 50] }, then: 30 },
            { case: { $gte: ["$nombreCommandes", 20] }, then: 20 },
            { case: { $gte: ["$nombreCommandes", 10] }, then: 10 }
          ],
          default: 5
        }
      },

      // Score montant (0-30 points)
      scoreMontant: {
        $switch: {
          branches: [
            { case: { $gte: ["$montantTotal", 5000] }, then: 30 },
            { case: { $gte: ["$montantTotal", 2000] }, then: 20 },
            { case: { $gte: ["$montantTotal", 500] }, then: 10 }
          ],
          default: 5
        }
      },

      // P√©nalit√© inactivit√© (-10 points si > 90 jours)
      penaliteInactivite: {
        $cond: {
          if: { $gt: ["$joursSanAchat", 90] },
          then: -10,
          else: 0
        }
      }
    }
  },
  {
    $project: {
      nom: 1,
      email: 1,
      nombreCommandes: 1,
      montantTotal: { $round: ["$montantTotal", 2] },
      joursSanAchat: 1,

      // Score total
      scoreTotal: {
        $add: [
          "$scoreAnciennete",
          "$scoreFrequence",
          "$scoreMontant",
          "$penaliteInactivite"
        ]
      },

      // D√©tail des scores
      detail: {
        anciennete: "$scoreAnciennete",
        frequence: "$scoreFrequence",
        montant: "$scoreMontant",
        penalite: "$penaliteInactivite"
      }
    }
  },
  {
    $project: {
      nom: 1,
      email: 1,
      nombreCommandes: 1,
      montantTotal: 1,
      joursSanAchat: 1,
      scoreTotal: 1,
      detail: 1,

      // Cat√©gorie client
      categorie: {
        $switch: {
          branches: [
            { case: { $gte: ["$scoreTotal", 80] }, then: "VIP ‚≠ê‚≠ê‚≠ê" },
            { case: { $gte: ["$scoreTotal", 60] }, then: "Premium ‚≠ê‚≠ê" },
            { case: { $gte: ["$scoreTotal", 40] }, then: "Standard ‚≠ê" }
          ],
          default: "Basique"
        }
      },

      // Statut activit√©
      statutActivite: {
        $switch: {
          branches: [
            { case: { $lte: ["$joursSanAchat", 30] }, then: "üü¢ Actif" },
            { case: { $lte: ["$joursSanAchat", 90] }, then: "üü° Peu actif" },
            { case: { $lte: ["$joursSanAchat", 180] }, then: "üü† Inactif" }
          ],
          default: "üî¥ Perdu"
        }
      },

      // Action recommand√©e
      actionRecommandee: {
        $switch: {
          branches: [
            {
              case: {
                $and: [
                  { $gte: ["$scoreTotal", 60] },
                  { $gt: ["$joursSanAchat", 90] }
                ]
              },
              then: "üéÅ Offre de r√©activation premium"
            },
            {
              case: { $gte: ["$scoreTotal", 80] },
              then: "üåü Programme VIP - avantages exclusifs"
            },
            {
              case: {
                $and: [
                  { $lt: ["$nombreCommandes", 5] },
                  { $lte: ["$joursSanAchat", 30] }
                ]
              },
              then: "üìß Email de bienvenue et promotion"
            },
            {
              case: { $gt: ["$joursSanAchat", 180] },
              then: "üíå Campagne de reconqu√™te"
            }
          ],
          default: "‚úì Suivi standard"
        }
      },

      // Remise sugg√©r√©e
      remiseSuggeree: {
        $switch: {
          branches: [
            { case: { $gte: ["$scoreTotal", 80] }, then: 20 },
            { case: { $gte: ["$scoreTotal", 60] }, then: 15 },
            { case: { $gte: ["$scoreTotal", 40] }, then: 10 },
            {
              case: { $gt: ["$joursSanAchat", 90] },
              then: 25  // Grosse remise pour r√©activation
            }
          ],
          default: 5
        }
      }
    }
  },
  {
    $sort: { scoreTotal: -1 }
  }
])
```

## Conclusion

Les op√©rateurs conditionnels sont des outils **essentiels** pour :

- üéØ **Impl√©menter** de la logique m√©tier complexe
- üîÄ **Prendre des d√©cisions** bas√©es sur les donn√©es
- üè∑Ô∏è **Cat√©goriser** et classifier automatiquement
- üõ°Ô∏è **Valider** et nettoyer les donn√©es
- üí∞ **Calculer** des valeurs conditionnelles
- üé® **Personnaliser** l'affichage et les r√©sultats

La cl√© est de choisir le bon op√©rateur pour chaque situation : `$cond` pour les cas simples, `$switch` pour les multiples branches, et `$ifNull` pour g√©rer les valeurs manquantes. Combin√©s avec les op√©rateurs logiques (`$and`, `$or`), ils permettent d'impl√©menter pratiquement n'importe quelle logique d√©cisionnelle directement dans vos pipelines d'agr√©gation.

---


‚è≠Ô∏è [Accumulateurs](/06-framework-agregation/05.6-accumulateurs.md)
