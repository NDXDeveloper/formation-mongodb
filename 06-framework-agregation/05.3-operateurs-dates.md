üîù Retour au [Sommaire](/SOMMAIRE.md)

# 6.5.3 Op√©rateurs de Dates - Manipulation Temporelle

## Introduction

Les op√©rateurs de dates permettent de **manipuler et extraire des informations temporelles** dans vos pipelines d'agr√©gation MongoDB. Ils vous donnent la possibilit√© de travailler avec des dates, extraire des composants (ann√©e, mois, jour), calculer des dur√©es, et formater l'affichage.

Pensez aux op√©rateurs de dates comme √† un **calendrier intelligent** qui peut r√©pondre √† des questions comme "Quelle est l'ann√©e ?", "Combien de jours se sont √©coul√©s ?", "Quelle est la date dans 30 jours ?", etc.

## √Ä Quoi Servent les Op√©rateurs de Dates ?

### 1. **Extraction d'Information**
Obtenir l'ann√©e, le mois, le jour, l'heure d'une date.

### 2. **Calculs Temporels**
Calculer des dur√©es, ajouter ou soustraire du temps.

### 3. **Formatage**
Afficher des dates dans diff√©rents formats lisibles.

### 4. **Analyse Temporelle**
Grouper par p√©riode, analyser les tendances temporelles.

### 5. **Validation**
V√©rifier si une date est dans une plage donn√©e.

## Type Date dans MongoDB

MongoDB stocke les dates comme des objets `ISODate` en **millisecondes depuis l'epoch Unix** (1er janvier 1970 00:00:00 UTC).

**Exemple** :
```javascript
ISODate("2024-03-15T14:30:00Z")
// Z = UTC (temps universel coordonn√©)
```

**Cr√©er une date** :
```javascript
// Date actuelle
new Date()

// Date sp√©cifique
ISODate("2024-12-25T00:00:00Z")

// Depuis un timestamp
new Date(1672531200000)
```

## Liste des Op√©rateurs de Dates

### Op√©rateurs d'Extraction

| Op√©rateur | Description | Exemple | R√©sultat |
|-----------|-------------|---------|----------|
| `$year` | Ann√©e | `{ $year: date }` | 2024 |
| `$month` | Mois (1-12) | `{ $month: date }` | 3 |
| `$dayOfMonth` | Jour du mois (1-31) | `{ $dayOfMonth: date }` | 15 |
| `$dayOfWeek` | Jour de la semaine (1-7) | `{ $dayOfWeek: date }` | 5 (Jeudi) |
| `$dayOfYear` | Jour de l'ann√©e (1-366) | `{ $dayOfYear: date }` | 75 |
| `$hour` | Heure (0-23) | `{ $hour: date }` | 14 |
| `$minute` | Minute (0-59) | `{ $minute: date }` | 30 |
| `$second` | Seconde (0-59) | `{ $second: date }` | 0 |
| `$millisecond` | Milliseconde (0-999) | `{ $millisecond: date }` | 0 |
| `$week` | Semaine de l'ann√©e (0-53) | `{ $week: date }` | 11 |
| `$isoWeek` | Semaine ISO (1-53) | `{ $isoWeek: date }` | 11 |
| `$isoWeekYear` | Ann√©e ISO | `{ $isoWeekYear: date }` | 2024 |
| `$isoDayOfWeek` | Jour ISO (1-7, 1=lundi) | `{ $isoDayOfWeek: date }` | 4 |

### Op√©rateurs de Formatage

| Op√©rateur | Description | Exemple |
|-----------|-------------|---------|
| `$dateToString` | Convertit date en cha√Æne | Format personnalis√© |
| `$dateFromString` | Convertit cha√Æne en date | Parse des dates |
| `$toString` | Convertit en cha√Æne ISO | Format ISO standard |

### Op√©rateurs de Calcul

| Op√©rateur | Description | Exemple |
|-----------|-------------|---------|
| `$dateAdd` | Ajoute une dur√©e | Ajouter 7 jours |
| `$dateSubtract` | Soustrait une dur√©e | Retirer 1 mois |
| `$dateDiff` | Diff√©rence entre dates | Dur√©e en jours |
| `$dateTrunc` | Tronque √† une unit√© | D√©but du mois |

### Op√©rateurs de Comparaison

Les dates peuvent √™tre compar√©es avec les op√©rateurs standards : `$eq`, `$ne`, `$gt`, `$gte`, `$lt`, `$lte`

## Op√©rateurs d'Extraction en D√©tail

### Extraction des Composants de Date

**Exemple de base** :

```javascript
// Collection: evenements
{
  "_id": 1,
  "nom": "Conf√©rence MongoDB",
  "date": ISODate("2024-03-15T14:30:00Z")
}
```

Extraire tous les composants :

```javascript
db.evenements.aggregate([
  {
    $project: {
      nom: 1,
      date: 1,
      annee: { $year: "$date" },
      mois: { $month: "$date" },
      jour: { $dayOfMonth: "$date" },
      jourSemaine: { $dayOfWeek: "$date" },
      heure: { $hour: "$date" },
      minute: { $minute: "$date" }
    }
  }
])
```

**R√©sultat** :
```javascript
{
  "_id": 1,
  "nom": "Conf√©rence MongoDB",
  "date": ISODate("2024-03-15T14:30:00Z"),
  "annee": 2024,
  "mois": 3,
  "jour": 15,
  "jourSemaine": 6,      // 1=Dimanche, 7=Samedi
  "heure": 14,
  "minute": 30
}
```

### $year : Extraire l'Ann√©e

```javascript
{
  $project: {
    date: 1,
    annee: { $year: "$date" }
  }
}
```

**Cas d'usage** : Grouper par ann√©e

```javascript
db.ventes.aggregate([
  {
    $group: {
      _id: { $year: "$date" },
      chiffreAffaires: { $sum: "$montant" }
    }
  },
  {
    $sort: { _id: 1 }
  }
])
```

### $month : Extraire le Mois

Retourne un nombre de 1 (janvier) √† 12 (d√©cembre).

```javascript
{
  $project: {
    date: 1,
    mois: { $month: "$date" },
    nomMois: {
      $switch: {
        branches: [
          { case: { $eq: [{ $month: "$date" }, 1] }, then: "Janvier" },
          { case: { $eq: [{ $month: "$date" }, 2] }, then: "F√©vrier" },
          { case: { $eq: [{ $month: "$date" }, 3] }, then: "Mars" },
          { case: { $eq: [{ $month: "$date" }, 4] }, then: "Avril" },
          { case: { $eq: [{ $month: "$date" }, 5] }, then: "Mai" },
          { case: { $eq: [{ $month: "$date" }, 6] }, then: "Juin" },
          { case: { $eq: [{ $month: "$date" }, 7] }, then: "Juillet" },
          { case: { $eq: [{ $month: "$date" }, 8] }, then: "Ao√ªt" },
          { case: { $eq: [{ $month: "$date" }, 9] }, then: "Septembre" },
          { case: { $eq: [{ $month: "$date" }, 10] }, then: "Octobre" },
          { case: { $eq: [{ $month: "$date" }, 11] }, then: "Novembre" },
          { case: { $eq: [{ $month: "$date" }, 12] }, then: "D√©cembre" }
        ],
        default: "Inconnu"
      }
    }
  }
}
```

**Cas d'usage** : Grouper par mois

```javascript
db.commandes.aggregate([
  {
    $group: {
      _id: {
        annee: { $year: "$date" },
        mois: { $month: "$date" }
      },
      totalVentes: { $sum: "$montant" }
    }
  },
  {
    $sort: {
      "_id.annee": 1,
      "_id.mois": 1
    }
  }
])
```

### $dayOfMonth : Jour du Mois

Retourne un nombre de 1 √† 31.

```javascript
{
  $project: {
    date: 1,
    jour: { $dayOfMonth: "$date" }
  }
}
```

### $dayOfWeek : Jour de la Semaine

Retourne un nombre de 1 (dimanche) √† 7 (samedi).

‚ö†Ô∏è **Attention** : 1 = Dimanche (syst√®me US), pas lundi !

```javascript
{
  $project: {
    date: 1,
    jourSemaine: { $dayOfWeek: "$date" },
    nomJour: {
      $switch: {
        branches: [
          { case: { $eq: [{ $dayOfWeek: "$date" }, 1] }, then: "Dimanche" },
          { case: { $eq: [{ $dayOfWeek: "$date" }, 2] }, then: "Lundi" },
          { case: { $eq: [{ $dayOfWeek: "$date" }, 3] }, then: "Mardi" },
          { case: { $eq: [{ $dayOfWeek: "$date" }, 4] }, then: "Mercredi" },
          { case: { $eq: [{ $dayOfWeek: "$date" }, 5] }, then: "Jeudi" },
          { case: { $eq: [{ $dayOfWeek: "$date" }, 6] }, then: "Vendredi" },
          { case: { $eq: [{ $dayOfWeek: "$date" }, 7] }, then: "Samedi" }
        ],
        default: "Inconnu"
      }
    }
  }
}
```

**Cas d'usage** : Analyser les ventes par jour de la semaine

```javascript
db.ventes.aggregate([
  {
    $group: {
      _id: { $dayOfWeek: "$date" },
      totalVentes: { $sum: "$montant" },
      nombreVentes: { $sum: 1 }
    }
  },
  {
    $project: {
      jourSemaine: "$_id",
      totalVentes: 1,
      nombreVentes: 1,
      moyenneParVente: { $divide: ["$totalVentes", "$nombreVentes"] }
    }
  },
  {
    $sort: { jourSemaine: 1 }
  }
])
```

### $isoDayOfWeek : Jour ISO

Retourne un nombre de 1 (lundi) √† 7 (dimanche).

C'est la version **europ√©enne** o√π la semaine commence le lundi.

```javascript
{
  $project: {
    date: 1,
    jourISO: { $isoDayOfWeek: "$date" }  // 1=Lundi, 7=Dimanche
  }
}
```

### $hour, $minute, $second : Extraire l'Heure

```javascript
{
  $project: {
    date: 1,
    heure: { $hour: "$date" },
    minute: { $minute: "$date" },
    seconde: { $second: "$date" },
    heureComplete: {
      $concat: [
        { $toString: { $hour: "$date" } },
        "h",
        { $toString: { $minute: "$date" } }
      ]
    }
  }
}
// R√©sultat : "14h30"
```

**Cas d'usage** : Analyser les pics de trafic par heure

```javascript
db.visites.aggregate([
  {
    $group: {
      _id: { $hour: "$dateVisite" },
      nombreVisites: { $sum: 1 }
    }
  },
  {
    $sort: { nombreVisites: -1 }
  },
  {
    $limit: 5  // Top 5 des heures de pointe
  }
])
```

## Op√©rateurs de Formatage

### $dateToString : Formater une Date

L'op√©rateur le plus utilis√© pour afficher des dates de mani√®re lisible.

**Syntaxe** :
```javascript
{
  $dateToString: {
    format: "<format>",
    date: <expression_date>,
    timezone: "<timezone>",      // Optionnel
    onNull: <expression>          // Optionnel
  }
}
```

**Codes de format** :

| Code | Description | Exemple |
|------|-------------|---------|
| `%Y` | Ann√©e (4 chiffres) | 2024 |
| `%m` | Mois (01-12) | 03 |
| `%d` | Jour (01-31) | 15 |
| `%H` | Heure 24h (00-23) | 14 |
| `%M` | Minute (00-59) | 30 |
| `%S` | Seconde (00-59) | 00 |
| `%L` | Milliseconde (000-999) | 000 |
| `%u` | Jour semaine ISO (1-7) | 5 |
| `%w` | Jour semaine (0-6) | 5 |
| `%U` | Semaine ann√©e (00-53) | 11 |
| `%V` | Semaine ISO (01-53) | 11 |
| `%G` | Ann√©e ISO | 2024 |
| `%z` | Fuseau UTC offset | +0100 |
| `%Z` | Nom du fuseau | CET |
| `%%` | Caract√®re % litt√©ral | % |

**Exemple 1 : Format Fran√ßais Standard**

```javascript
{
  $project: {
    dateISO: "$date",
    dateFR: {
      $dateToString: {
        format: "%d/%m/%Y",
        date: "$date"
      }
    }
  }
}
```

**R√©sultat** :
```javascript
{
  "dateISO": ISODate("2024-03-15T14:30:00Z"),
  "dateFR": "15/03/2024"
}
```

**Exemple 2 : Date et Heure Compl√®te**

```javascript
{
  $project: {
    dateComplete: {
      $dateToString: {
        format: "%d/%m/%Y √† %Hh%M",
        date: "$date"
      }
    }
  }
}
// R√©sultat : "15/03/2024 √† 14h30"
```

**Exemple 3 : Format ISO**

```javascript
{
  $project: {
    dateISO: {
      $dateToString: {
        format: "%Y-%m-%dT%H:%M:%S.%LZ",
        date: "$date"
      }
    }
  }
}
// R√©sultat : "2024-03-15T14:30:00.000Z"
```

**Exemple 4 : Format Personnalis√©**

```javascript
{
  $project: {
    dateTexte: {
      $dateToString: {
        format: "Le %d/%m/%Y √† %H:%M:%S",
        date: "$date"
      }
    }
  }
}
// R√©sultat : "Le 15/03/2024 √† 14:30:00"
```

**Exemple 5 : G√©rer les Valeurs null**

```javascript
{
  $project: {
    dateFormatee: {
      $dateToString: {
        format: "%d/%m/%Y",
        date: "$date",
        onNull: "Date non disponible"
      }
    }
  }
}
```

### $dateFromString : Parser une Date

Convertit une cha√Æne en date.

**Syntaxe** :
```javascript
{
  $dateFromString: {
    dateString: "<cha√Æne>",
    format: "<format>",        // Optionnel
    timezone: "<timezone>",    // Optionnel
    onError: <expression>,     // Optionnel
    onNull: <expression>       // Optionnel
  }
}
```

**Exemple 1 : Parser Format Standard**

```javascript
{
  $project: {
    dateTexte: "2024-03-15",
    dateObjet: {
      $dateFromString: {
        dateString: "$dateTexte"
      }
    }
  }
}
```

**Exemple 2 : Parser avec Format Personnalis√©**

```javascript
{
  $project: {
    dateTexte: "15/03/2024",
    dateObjet: {
      $dateFromString: {
        dateString: "$dateTexte",
        format: "%d/%m/%Y"
      }
    }
  }
}
```

**Exemple 3 : G√©rer les Erreurs**

```javascript
{
  $project: {
    dateObjet: {
      $dateFromString: {
        dateString: "$dateTexte",
        format: "%d/%m/%Y",
        onError: null,
        onNull: new Date()  // Date actuelle si null
      }
    }
  }
}
```

## Op√©rateurs de Calcul

### $dateAdd : Ajouter une Dur√©e

Ajoute une dur√©e √† une date.

**Syntaxe** :
```javascript
{
  $dateAdd: {
    startDate: <date>,
    unit: "<unit√©>",
    amount: <nombre>,
    timezone: "<timezone>"  // Optionnel
  }
}
```

**Unit√©s disponibles** : `"year"`, `"month"`, `"week"`, `"day"`, `"hour"`, `"minute"`, `"second"`, `"millisecond"`

**Exemple 1 : Ajouter des Jours**

```javascript
{
  $project: {
    dateCommande: "$date",
    dateLivraisonEstimee: {
      $dateAdd: {
        startDate: "$date",
        unit: "day",
        amount: 7
      }
    }
  }
}
```

**Exemple 2 : Ajouter des Mois**

```javascript
{
  $project: {
    dateAchat: "$date",
    finGarantie: {
      $dateAdd: {
        startDate: "$date",
        unit: "month",
        amount: 24  // Garantie 2 ans
      }
    }
  }
}
```

**Exemple 3 : Calculer une Date d'√âch√©ance**

```javascript
db.abonnements.aggregate([
  {
    $project: {
      client: 1,
      dateDebut: 1,
      dureeJours: 1,
      dateExpiration: {
        $dateAdd: {
          startDate: "$dateDebut",
          unit: "day",
          amount: "$dureeJours"
        }
      },
      estActif: {
        $lte: [new Date(), {
          $dateAdd: {
            startDate: "$dateDebut",
            unit: "day",
            amount: "$dureeJours"
          }
        }]
      }
    }
  }
])
```

### $dateSubtract : Soustraire une Dur√©e

Soustrait une dur√©e d'une date.

**Syntaxe** :
```javascript
{
  $dateSubtract: {
    startDate: <date>,
    unit: "<unit√©>",
    amount: <nombre>,
    timezone: "<timezone>"  // Optionnel
  }
}
```

**Exemple 1 : Date il y a N Jours**

```javascript
{
  $project: {
    aujourdHui: new Date(),
    ilYa30Jours: {
      $dateSubtract: {
        startDate: new Date(),
        unit: "day",
        amount: 30
      }
    }
  }
}
```

**Exemple 2 : D√©but du Mois Pr√©c√©dent**

```javascript
{
  $project: {
    moisPrecedent: {
      $dateSubtract: {
        startDate: new Date(),
        unit: "month",
        amount: 1
      }
    }
  }
}
```

### $dateDiff : Diff√©rence entre Dates

Calcule la diff√©rence entre deux dates.

**Syntaxe** :
```javascript
{
  $dateDiff: {
    startDate: <date1>,
    endDate: <date2>,
    unit: "<unit√©>",
    timezone: "<timezone>",  // Optionnel
    startOfWeek: "monday"    // Optionnel
  }
}
```

**Exemple 1 : Nombre de Jours**

```javascript
{
  $project: {
    dateCommande: "$dateCommande",
    dateLivraison: "$dateLivraison",
    delaiJours: {
      $dateDiff: {
        startDate: "$dateCommande",
        endDate: "$dateLivraison",
        unit: "day"
      }
    }
  }
}
```

**Exemple 2 : √Çge en Ann√©es**

```javascript
{
  $project: {
    nom: 1,
    dateNaissance: 1,
    age: {
      $dateDiff: {
        startDate: "$dateNaissance",
        endDate: new Date(),
        unit: "year"
      }
    }
  }
}
```

**Exemple 3 : Anciennet√© d'un Employ√©**

```javascript
db.employes.aggregate([
  {
    $project: {
      nom: 1,
      dateEmbauche: 1,
      ancienneteAnnees: {
        $dateDiff: {
          startDate: "$dateEmbauche",
          endDate: new Date(),
          unit: "year"
        }
      },
      ancienneteMois: {
        $dateDiff: {
          startDate: "$dateEmbauche",
          endDate: new Date(),
          unit: "month"
        }
      },
      ancienneteJours: {
        $dateDiff: {
          startDate: "$dateEmbauche",
          endDate: new Date(),
          unit: "day"
        }
      }
    }
  }
])
```

### $dateTrunc : Tronquer une Date

Tronque une date √† une unit√© sp√©cifique (d√©but de la p√©riode).

**Syntaxe** :
```javascript
{
  $dateTrunc: {
    date: <date>,
    unit: "<unit√©>",
    binSize: <nombre>,        // Optionnel
    timezone: "<timezone>",   // Optionnel
    startOfWeek: "monday"     // Optionnel
  }
}
```

**Exemple 1 : D√©but du Mois**

```javascript
{
  $project: {
    date: "$date",
    debutMois: {
      $dateTrunc: {
        date: "$date",
        unit: "month"
      }
    }
  }
}
// 2024-03-15 ‚Üí 2024-03-01T00:00:00Z
```

**Exemple 2 : D√©but de la Semaine**

```javascript
{
  $project: {
    date: "$date",
    debutSemaine: {
      $dateTrunc: {
        date: "$date",
        unit: "week",
        startOfWeek: "monday"
      }
    }
  }
}
```

**Exemple 3 : D√©but de l'Ann√©e**

```javascript
{
  $project: {
    date: "$date",
    debutAnnee: {
      $dateTrunc: {
        date: "$date",
        unit: "year"
      }
    }
  }
}
// 2024-03-15 ‚Üí 2024-01-01T00:00:00Z
```

**Cas d'usage** : Grouper par p√©riode

```javascript
// Grouper les ventes par semaine
db.ventes.aggregate([
  {
    $project: {
      montant: 1,
      debutSemaine: {
        $dateTrunc: {
          date: "$date",
          unit: "week"
        }
      }
    }
  },
  {
    $group: {
      _id: "$debutSemaine",
      totalVentes: { $sum: "$montant" }
    }
  },
  {
    $sort: { _id: 1 }
  }
])
```

## Calculs avec Dates

### Dur√©e entre Deux Dates (M√©thode Alternative)

Avec `$subtract` (retourne millisecondes) :

```javascript
{
  $project: {
    dateDebut: "$dateCommande",
    dateFin: "$dateLivraison",

    // Dur√©e en millisecondes
    dureeMs: {
      $subtract: ["$dateLivraison", "$dateCommande"]
    },

    // Convertir en jours
    dureeJours: {
      $divide: [
        { $subtract: ["$dateLivraison", "$dateCommande"] },
        1000 * 60 * 60 * 24
      ]
    },

    // Convertir en heures
    dureeHeures: {
      $divide: [
        { $subtract: ["$dateLivraison", "$dateCommande"] },
        1000 * 60 * 60
      ]
    }
  }
}
```

### Ajouter du Temps (M√©thode Alternative)

Avec `$add` :

```javascript
{
  $project: {
    dateDepart: "$date",

    // Ajouter 7 jours (en millisecondes)
    dans7Jours: {
      $add: ["$date", 7 * 24 * 60 * 60 * 1000]
    },

    // Ajouter 2 heures
    dans2Heures: {
      $add: ["$date", 2 * 60 * 60 * 1000]
    }
  }
}
```

## Cas d'Usage Pratiques

### 1. Analyse des Ventes par P√©riode

```javascript
// Ventes mensuelles de l'ann√©e en cours
db.ventes.aggregate([
  {
    $match: {
      date: {
        $gte: new Date(new Date().getFullYear(), 0, 1),
        $lt: new Date(new Date().getFullYear() + 1, 0, 1)
      }
    }
  },
  {
    $group: {
      _id: {
        annee: { $year: "$date" },
        mois: { $month: "$date" }
      },
      chiffreAffaires: { $sum: "$montant" },
      nombreVentes: { $sum: 1 }
    }
  },
  {
    $project: {
      _id: 0,
      periode: {
        $concat: [
          { $toString: "$_id.mois" },
          "/",
          { $toString: "$_id.annee" }
        ]
      },
      chiffreAffaires: { $round: ["$chiffreAffaires", 2] },
      nombreVentes: 1,
      panierMoyen: {
        $round: [
          { $divide: ["$chiffreAffaires", "$nombreVentes"] },
          2
        ]
      }
    }
  },
  {
    $sort: {
      "_id.annee": 1,
      "_id.mois": 1
    }
  }
])
```

### 2. Tableau de Bord en Temps R√©el

```javascript
// M√©triques des derni√®res 24h, 7 jours, 30 jours
db.evenements.aggregate([
  {
    $facet: {
      // Derni√®res 24 heures
      derniere24h: [
        {
          $match: {
            date: {
              $gte: {
                $dateSubtract: {
                  startDate: new Date(),
                  unit: "hour",
                  amount: 24
                }
              }
            }
          }
        },
        {
          $count: "total"
        }
      ],

      // 7 derniers jours
      derniers7Jours: [
        {
          $match: {
            date: {
              $gte: {
                $dateSubtract: {
                  startDate: new Date(),
                  unit: "day",
                  amount: 7
                }
              }
            }
          }
        },
        {
          $count: "total"
        }
      ],

      // 30 derniers jours
      derniers30Jours: [
        {
          $match: {
            date: {
              $gte: {
                $dateSubtract: {
                  startDate: new Date(),
                  unit: "day",
                  amount: 30
                }
              }
            }
          }
        },
        {
          $count: "total"
        }
      ]
    }
  },
  {
    $project: {
      derniere24h: { $arrayElemAt: ["$derniere24h.total", 0] },
      derniers7Jours: { $arrayElemAt: ["$derniers7Jours.total", 0] },
      derniers30Jours: { $arrayElemAt: ["$derniers30Jours.total", 0] }
    }
  }
])
```

### 3. Gestion des Abonnements

```javascript
// V√©rifier les abonnements qui expirent bient√¥t
db.abonnements.aggregate([
  {
    $project: {
      client: 1,
      dateDebut: 1,
      dureeJours: 1,

      // Date d'expiration
      dateExpiration: {
        $dateAdd: {
          startDate: "$dateDebut",
          unit: "day",
          amount: "$dureeJours"
        }
      },

      // Jours restants
      joursRestants: {
        $dateDiff: {
          startDate: new Date(),
          endDate: {
            $dateAdd: {
              startDate: "$dateDebut",
              unit: "day",
              amount: "$dureeJours"
            }
          },
          unit: "day"
        }
      }
    }
  },
  {
    $match: {
      joursRestants: { $gte: 0, $lte: 30 }  // Expire dans 30 jours
    }
  },
  {
    $project: {
      client: 1,
      dateExpiration: {
        $dateToString: {
          format: "%d/%m/%Y",
          date: "$dateExpiration"
        }
      },
      joursRestants: 1,
      urgence: {
        $switch: {
          branches: [
            { case: { $lte: ["$joursRestants", 7] }, then: "Urgent" },
            { case: { $lte: ["$joursRestants", 15] }, then: "Bient√¥t" },
            { case: { $lte: ["$joursRestants", 30] }, then: "√Ä surveiller" }
          ],
          default: "OK"
        }
      }
    }
  },
  {
    $sort: { joursRestants: 1 }
  }
])
```

### 4. Rapport d'Activit√© Hebdomadaire

```javascript
// Activit√© par jour de la semaine
db.activites.aggregate([
  {
    $match: {
      date: {
        $gte: {
          $dateSubtract: {
            startDate: new Date(),
            unit: "week",
            amount: 4  // 4 derni√®res semaines
          }
        }
      }
    }
  },
  {
    $group: {
      _id: { $isoDayOfWeek: "$date" },  // 1=Lundi, 7=Dimanche
      nombreActivites: { $sum: 1 },
      dureeTotal: { $sum: "$duree" }
    }
  },
  {
    $project: {
      _id: 0,
      jourSemaine: {
        $switch: {
          branches: [
            { case: { $eq: ["$_id", 1] }, then: "Lundi" },
            { case: { $eq: ["$_id", 2] }, then: "Mardi" },
            { case: { $eq: ["$_id", 3] }, then: "Mercredi" },
            { case: { $eq: ["$_id", 4] }, then: "Jeudi" },
            { case: { $eq: ["$_id", 5] }, then: "Vendredi" },
            { case: { $eq: ["$_id", 6] }, then: "Samedi" },
            { case: { $eq: ["$_id", 7] }, then: "Dimanche" }
          ]
        }
      },
      nombreActivites: 1,
      dureeTotal: 1,
      dureeMoyenne: {
        $round: [
          { $divide: ["$dureeTotal", "$nombreActivites"] },
          1
        ]
      }
    }
  },
  {
    $sort: { _id: 1 }
  }
])
```

### 5. Analyse Temporelle des Performances

```javascript
// Comparer performance par tranches horaires
db.transactions.aggregate([
  {
    $project: {
      montant: 1,
      heure: { $hour: "$date" },
      trancheHoraire: {
        $switch: {
          branches: [
            { case: { $lt: [{ $hour: "$date" }, 6] }, then: "Nuit (0-6h)" },
            { case: { $lt: [{ $hour: "$date" }, 12] }, then: "Matin (6-12h)" },
            { case: { $lt: [{ $hour: "$date" }, 18] }, then: "Apr√®s-midi (12-18h)" },
            { case: { $gte: [{ $hour: "$date" }, 18] }, then: "Soir√©e (18-24h)" }
          ],
          default: "Inconnu"
        }
      }
    }
  },
  {
    $group: {
      _id: "$trancheHoraire",
      chiffreAffaires: { $sum: "$montant" },
      nombreTransactions: { $sum: 1 }
    }
  },
  {
    $project: {
      _id: 0,
      tranche: "$_id",
      chiffreAffaires: { $round: ["$chiffreAffaires", 2] },
      nombreTransactions: 1,
      ticketMoyen: {
        $round: [
          { $divide: ["$chiffreAffaires", "$nombreTransactions"] },
          2
        ]
      }
    }
  }
])
```

## Fuseaux Horaires

MongoDB stocke toutes les dates en **UTC**. Pour travailler avec des fuseaux horaires locaux :

### Sp√©cifier un Fuseau Horaire

```javascript
{
  $dateToString: {
    format: "%d/%m/%Y %H:%M",
    date: "$date",
    timezone: "Europe/Paris"  // CET/CEST
  }
}
```

**Exemples de fuseaux** :
- `"UTC"` : Temps universel
- `"Europe/Paris"` : Paris (CET/CEST)
- `"America/New_York"` : New York (EST/EDT)
- `"Asia/Tokyo"` : Tokyo (JST)
- `"+02:00"` : Offset personnalis√©

### Convertir entre Fuseaux

```javascript
{
  $project: {
    dateUTC: "$date",
    dateParis: {
      $dateToString: {
        format: "%Y-%m-%d %H:%M:%S",
        date: "$date",
        timezone: "Europe/Paris"
      }
    },
    dateNewYork: {
      $dateToString: {
        format: "%Y-%m-%d %H:%M:%S",
        date: "$date",
        timezone: "America/New_York"
      }
    },
    dateTokyo: {
      $dateToString: {
        format: "%Y-%m-%d %H:%M:%S",
        date: "$date",
        timezone: "Asia/Tokyo"
      }
    }
  }
}
```

## Gestion des Erreurs et Valeurs Sp√©ciales

### Valeurs null

Les op√©rateurs de date retournent `null` si l'entr√©e est `null` :

```javascript
{ $year: null }              // ‚Üí null
{ $dateToString: { format: "%Y", date: null } }  // ‚Üí null (ou utiliser onNull)
```

**Solution** :

```javascript
{
  $project: {
    dateFormatee: {
      $cond: {
        if: { $ne: ["$date", null] },
        then: {
          $dateToString: {
            format: "%d/%m/%Y",
            date: "$date"
          }
        },
        else: "Date non disponible"
      }
    }
  }
}
```

Ou avec `onNull` :

```javascript
{
  $dateToString: {
    format: "%d/%m/%Y",
    date: "$date",
    onNull: "Non sp√©cifi√©"
  }
}
```

### Dates Invalides

```javascript
// Parser une date invalide
{
  $dateFromString: {
    dateString: "$dateTexte",
    format: "%d/%m/%Y",
    onError: null  // ou new Date() ou "Format invalide"
  }
}
```

## Performances et Optimisations

### 1. Index sur les Champs de Date

Cr√©ez des index sur les champs de date fr√©quemment utilis√©s :

```javascript
db.commandes.createIndex({ date: -1 })  // Index d√©croissant
```

### 2. Filtrer Avant d'Extraire

```javascript
// ‚ùå MOINS EFFICACE
db.ventes.aggregate([
  {
    $project: {
      annee: { $year: "$date" },
      montant: 1
    }
  },
  {
    $match: { annee: 2024 }
  }
])

// ‚úÖ MIEUX
db.ventes.aggregate([
  {
    $match: {
      date: {
        $gte: ISODate("2024-01-01"),
        $lt: ISODate("2025-01-01")
      }
    }
  },
  {
    $project: {
      annee: { $year: "$date" },
      montant: 1
    }
  }
])
```

### 3. √âviter les Calculs R√©p√©t√©s

```javascript
// ‚ùå Calcule $year trois fois
{
  $project: {
    estAnneeEnCours: { $eq: [{ $year: "$date" }, 2024] },
    annee: { $year: "$date" },
    anneePrecedente: { $subtract: [{ $year: "$date" }, 1] }
  }
}

// ‚úÖ MIEUX avec $let
{
  $project: {
    $let: {
      vars: {
        annee: { $year: "$date" }
      },
      in: {
        estAnneeEnCours: { $eq: ["$$annee", 2024] },
        annee: "$$annee",
        anneePrecedente: { $subtract: ["$$annee", 1] }
      }
    }
  }
}
```

### 4. Utiliser dateTrunc pour Grouper

```javascript
// ‚úÖ Utiliser $dateTrunc pour grouper efficacement
db.ventes.aggregate([
  {
    $group: {
      _id: {
        $dateTrunc: {
          date: "$date",
          unit: "day"
        }
      },
      totalVentes: { $sum: "$montant" }
    }
  }
])
```

## Points Cl√©s √† Retenir

1. ‚úÖ **MongoDB stocke en UTC** - Les dates sont en temps universel
2. ‚úÖ **Extraction** : $year, $month, $day, $hour, etc.
3. ‚úÖ **Formatage** : $dateToString avec codes de format
4. ‚úÖ **Calculs** : $dateAdd, $dateSubtract, $dateDiff
5. ‚úÖ **Tronquer** : $dateTrunc pour d√©but de p√©riode
6. ‚úÖ **Parsing** : $dateFromString pour convertir cha√Ænes
7. ‚úÖ **Fuseaux** : Sp√©cifier timezone dans les op√©rateurs
8. ‚ö†Ô∏è **null** : G√©rer avec onNull ou $cond
9. ‚ö° **Performance** : Cr√©er des index, filtrer avant extraire
10. üåç **ISO** : Pr√©f√©rer $isoDayOfWeek (1=lundi) √† $dayOfWeek (1=dimanche)

## Exemple Complet : Rapport d'Activit√© Mensuel

```javascript
// G√©n√©rer un rapport complet des ventes mensuelles
db.ventes.aggregate([
  {
    // 1. Filtrer l'ann√©e en cours
    $match: {
      date: {
        $gte: new Date(new Date().getFullYear(), 0, 1),
        $lt: new Date(new Date().getFullYear() + 1, 0, 1)
      }
    }
  },
  {
    // 2. Enrichir avec informations temporelles
    $project: {
      montant: 1,
      quantite: 1,
      date: 1,
      annee: { $year: "$date" },
      mois: { $month: "$date" },
      nomMois: {
        $arrayElemAt: [
          ["Janvier", "F√©vrier", "Mars", "Avril", "Mai", "Juin",
           "Juillet", "Ao√ªt", "Septembre", "Octobre", "Novembre", "D√©cembre"],
          { $subtract: [{ $month: "$date" }, 1] }
        ]
      },
      jourSemaine: { $isoDayOfWeek: "$date" },
      heure: { $hour: "$date" },
      debutMois: {
        $dateTrunc: {
          date: "$date",
          unit: "month"
        }
      }
    }
  },
  {
    // 3. Grouper par mois
    $group: {
      _id: {
        annee: "$annee",
        mois: "$mois",
        nomMois: "$nomMois",
        debutMois: "$debutMois"
      },
      chiffreAffaires: { $sum: "$montant" },
      quantiteTotale: { $sum: "$quantite" },
      nombreVentes: { $sum: 1 },
      montantMin: { $min: "$montant" },
      montantMax: { $max: "$montant" }
    }
  },
  {
    // 4. Calculer les m√©triques
    $project: {
      _id: 0,
      periode: "$_id.nomMois",
      annee: "$_id.annee",
      dateDebut: {
        $dateToString: {
          format: "%d/%m/%Y",
          date: "$_id.debutMois"
        }
      },
      chiffreAffaires: { $round: ["$chiffreAffaires", 2] },
      quantiteTotale: 1,
      nombreVentes: 1,
      panierMoyen: {
        $round: [
          { $divide: ["$chiffreAffaires", "$nombreVentes"] },
          2
        ]
      },
      montantMin: { $round: ["$montantMin", 2] },
      montantMax: { $round: ["$montantMax", 2] },

      // Objectif mensuel
      objectifAtteint: {
        $gte: ["$chiffreAffaires", 50000]
      },

      // Performance
      performance: {
        $concat: [
          { $toString: {
            $round: [
              { $multiply: [
                { $divide: ["$chiffreAffaires", 50000] },
                100
              ]},
              1
            ]
          }},
          "%"
        ]
      }
    }
  },
  {
    // 5. Trier chronologiquement
    $sort: {
      annee: 1,
      "_id.mois": 1
    }
  },
  {
    // 6. Ajouter des statistiques globales
    $group: {
      _id: null,
      mois: { $push: "$$ROOT" },
      totalAnnuel: { $sum: "$chiffreAffaires" },
      moyenneMensuelle: { $avg: "$chiffreAffaires" }
    }
  },
  {
    $project: {
      _id: 0,
      mois: 1,
      resume: {
        totalAnnuel: { $round: ["$totalAnnuel", 2] },
        moyenneMensuelle: { $round: ["$moyenneMensuelle", 2] },
        objectifAnnuel: 600000,
        tauxRealisation: {
          $concat: [
            { $toString: {
              $round: [
                { $multiply: [
                  { $divide: ["$totalAnnuel", 600000] },
                  100
                ]},
                1
              ]
            }},
            "%"
          ]
        }
      }
    }
  }
])
```

## Conclusion

Les op√©rateurs de dates sont des outils **puissants et essentiels** pour :

- üìÖ **Extraire** des composants temporels (ann√©e, mois, jour, heure)
- üé® **Formater** des dates pour l'affichage
- ‚è±Ô∏è **Calculer** des dur√©es et diff√©rences
- üìä **Analyser** des donn√©es temporelles
- üåç **G√©rer** les fuseaux horaires
- üìà **Grouper** par p√©riodes (jour, semaine, mois, ann√©e)

La ma√Ætrise des op√©rateurs de dates est fondamentale pour toute analyse temporelle dans MongoDB. Ils permettent de r√©pondre √† des questions m√©tier complexes comme "Quel est notre meilleur jour de la semaine ?", "Quelles sont les tendances mensuelles ?", "Qui sont les clients fid√®les ?", etc.

---


‚è≠Ô∏è [Op√©rateurs de tableaux](/06-framework-agregation/05.4-operateurs-tableaux.md)
